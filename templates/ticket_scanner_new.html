{% extends "base.html" %}

{% block title %}Lottery Ticket Scanner | Snap Lotto{% endblock %}

{% block additional_head %}
<style>
    .ticket-scanner-container {
        max-width: 700px;
        margin: 0 auto;
    }
    
    /* Clean, modern interface */
    .ticket-card {
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        border: none;
        overflow: hidden;
    }
    
    /* Info callout */
    .info-callout {
        background-color: #e1f5fe;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
        border-left: 4px solid #03a9f4;
    }
    
    /* Drop area styling */
    .ticket-drop-area {
        border: 2px dashed #dee2e6;
        border-radius: 8px;
        padding: 30px;
        text-align: center;
        background-color: #f8f9fa;
        cursor: pointer;
        transition: all 0.3s;
        margin-bottom: 20px;
    }
    
    .ticket-drop-area:hover, .ticket-drop-area.highlight {
        border-color: #0d6efd;
        background-color: rgba(13, 110, 253, 0.05);
    }
    
    /* Button styling */
    .btn-scan {
        padding: 12px 30px;
        font-size: 18px;
        border-radius: 8px;
    }
    
    /* Ticket preview */
    .ticket-preview {
        max-width: 100%;
        max-height: 300px;
        margin: 20px 0;
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    
    /* Form elements */
    .form-label {
        font-weight: 500;
    }
    
    .form-control, .form-select {
        padding: 10px 15px;
        border-radius: 8px;
    }
    
    /* Advertisement overlays */
    .ad-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.98);
        z-index: 9999;
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 20px;
        overflow: hidden; /* Prevent scrolling while overlay is active */
    }
    
    /* Make the View Results button more prominent */
    #view-results-btn {
        padding: 12px 30px;
        font-size: 18px;
        animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }
    
    /* Add additional styling for the results ad content */
    .results-ad-content {
        width: 100%;
        max-width: 600px;
        margin: 0 auto;
        background-color: white;
        border-radius: 12px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        padding: 30px;
        text-align: center;
    }
    
    .ad-container {
        width: 100%;
        max-width: 500px;
        margin: 20px 0;
    }
    
    .ad-placeholder {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 30px;
        text-align: center;
        min-height: 200px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }
    
    /* Scanner loading */
    #scanner-loading {
        display: none;
    }
    
    /* Optional note */
    .optional-note {
        font-size: 0.9rem;
        color: #6c757d;
        margin-left: 5px;
    }
</style>
{% endblock %}

{% block content %}
<!-- Ad overlay - Loading screen -->
<div id="ad-overlay-loading" class="ad-overlay">
    <h4 class="mb-4">Processing your ticket...</h4>
    <div class="ad-container">
        <div class="ad-placeholder">
            <i class="fas fa-ad mb-2 fa-2x text-primary"></i>
            <p class="mb-1">Advertisement</p>
            <p class="text-muted small mt-2">Advertisement helps keep this service free!</p>
        </div>
    </div>
    <div class="mt-4 text-center" style="max-width: 500px; margin: 0 auto;">
        <div class="spinner-border text-primary mb-3" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <div id="scan-progress">
            <h5 class="mb-3">Analyzing your ticket...</h5>
            
            <!-- Progress steps -->
            <div class="steps-container mb-4">
                <div class="step active" id="step-1">
                    <div class="step-circle">1</div>
                    <div class="step-text">Reading Ticket</div>
                </div>
                <div class="step" id="step-2">
                    <div class="step-circle">2</div>
                    <div class="step-text">Identifying Game</div>
                </div>
                <div class="step" id="step-3">
                    <div class="step-circle">3</div>
                    <div class="step-text">Checking Numbers</div>
                </div>
                <div class="step" id="step-4">
                    <div class="step-circle">4</div>
                    <div class="step-text">Calculating Prize</div>
                </div>
            </div>
            
            <div class="progress mb-3" style="height: 10px;">
                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                     id="scan-progress-bar" role="progressbar" style="width: 25%"></div>
            </div>
            <p id="scan-step-text" class="text-muted">Uploading and analyzing your ticket image...</p>
        </div>
    </div>
</div>

<!-- Ad overlay - Results screen (fixed position) -->
<div id="ad-overlay-results" class="ad-overlay">
    <div class="results-ad-content">
        <h4 class="mb-4">Your Results Are Ready!</h4>
        <div class="ad-container">
            <div class="ad-placeholder">
                <i class="fas fa-ad mb-2 fa-2x text-primary"></i>
                <p class="mb-1">Advertisement</p>
                <small class="text-muted">Support from ads keeps this service free</small>
            </div>
        </div>
        <button class="btn btn-success px-4 py-3 mt-4 pulse-btn" id="view-results-btn">
            <i class="fas fa-check-circle me-2"></i> View My Results
        </button>
    </div>
</div>

<div class="container py-4">
    <div class="row mb-4">
        <div class="col-12 text-center">
            <h2 class="fw-bold">Lottery Ticket Scanner</h2>
            <p class="text-muted">Check if your lottery ticket has won a prize</p>
            <div class="slogan-banner mt-2">
                <span class="slogan-text">Snap, Scan and Win = Phusha Phanda Play</span>
            </div>
        </div>
    </div>

    <div class="ticket-scanner-container">
        <div class="ticket-card card">
            <div class="card-body p-4">
                <div class="info-callout mb-4">
                    <i class="fa fa-info-circle me-2"></i> 
                    Take a clear photo of your lottery ticket, making sure all numbers are visible.
                </div>

                <form id="ticket-form" action="/scan-ticket" method="post" enctype="multipart/form-data">
                    {{ form.hidden_tag() }}
                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label for="lottery-type" class="form-label">
                                Game Type
                                <span class="optional-note">(Optional - AI will detect)</span>
                            </label>
                            <select class="form-select" id="lottery-type" name="lottery_type">
                                <option value="">Auto-detect from ticket</option>
                                <option value="Lotto">Lotto</option>
                                <option value="Lotto Plus 1">Lotto Plus 1</option>
                                <option value="Lotto Plus 2">Lotto Plus 2</option>
                                <option value="Powerball">Powerball</option>
                                <option value="Powerball Plus">Powerball Plus</option>
                                <option value="Daily Lotto">Daily Lotto</option>
                            </select>
                        </div>
                        
                        <div class="col-md-6">
                            <label for="draw-number" class="form-label">
                                Draw Number
                                <span class="optional-note">(Optional)</span>
                            </label>
                            <input type="text" class="form-control" id="draw-number" name="draw_number" 
                                placeholder="Leave blank for latest draw">
                        </div>
                    </div>

                    <div class="ticket-drop-area" id="drop-area">
                        <i class="fa fa-upload fa-2x mb-3 text-primary"></i>
                        <h5>Drag and drop your ticket image here</h5>
                        <p class="text-muted">or</p>
                        <input type="file" id="ticket-image" name="ticket_image" accept="image/*" class="d-none">
                        <button type="button" id="file-select-btn" class="btn btn-primary px-4">
                            Select Image
                        </button>
                    </div>

                    <div id="preview-container" class="text-center d-none">
                        <h6 class="mb-3">Ticket Preview</h6>
                        <img id="ticket-preview" class="ticket-preview img-fluid" src="">
                        <div class="mt-3">
                            <button type="button" id="remove-image" class="btn btn-sm btn-outline-danger">
                                <i class="fa fa-times"></i> Remove
                            </button>
                        </div>
                    </div>

                    <div class="text-center mt-4">
                        <button type="submit" id="scan-button" class="btn btn-success btn-scan">
                            <i class="fa fa-search me-2"></i> Scan Ticket
                        </button>
                        <div id="scanner-loading" class="mt-3">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p>Scanning your ticket...</p>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Results section will display after scanning -->
        <div id="results-container" class="results-container mt-4 d-none">
            <div class="card ticket-card">
                <div class="card-body p-4">
                    <h3 class="mb-4 text-center">Scan Results</h3>
                    
                    <div id="error-message" class="alert alert-danger d-none">
                        <i class="fa fa-exclamation-triangle me-2"></i>
                        <span id="error-text"></span>
                    </div>
                    
                    <div id="success-content" class="d-none">
                        <div class="card mb-4">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0" id="ticket-info-title">Ticket Information</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <p><strong>Lottery Type:</strong> <span id="result-lottery-type"></span></p>
                                        <p><strong>Draw Number:</strong> <span id="result-draw-number"></span></p>
                                        <p><strong>Draw Date:</strong> <span id="result-draw-date"></span></p>
                                        
                                        <div id="detected-info" class="mt-3 small">
                                            <p class="text-muted mb-1"><i class="fas fa-search-plus me-1"></i> <strong>AI Detected Information:</strong></p>
                                            <p class="mb-1"><strong>Game Type:</strong> <span id="detected-game-type"></span></p>
                                            <p class="mb-1"><strong>Draw Number:</strong> <span id="detected-draw-number"></span></p>
                                            <p class="mb-1"><strong>Draw Date:</strong> <span id="detected-draw-date"></span></p>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <p><strong>Your Numbers:</strong></p>
                                        <div id="ticket-numbers" class="mb-3"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card mb-4">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0">Winning Numbers</h5>
                            </div>
                            <div class="card-body">
                                <div id="winning-numbers" class="mb-3"></div>
                                
                                <div class="mt-4">
                                    <p><strong>Matched Numbers:</strong> <span id="matched-count" class="badge bg-success">0</span></p>
                                    <div id="matched-numbers"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="prize-container" class="d-none">
                            <div class="card prize-card">
                                <div class="card-header bg-warning">
                                    <h5 class="mb-0"><i class="fa fa-trophy me-2"></i> Winner!</h5>
                                </div>
                                <div class="card-body">
                                    <h4 class="text-success mb-3 text-center">Congratulations!</h4>
                                    <p class="lead text-center">You've won a prize in <span id="prize-lottery-type"></span> Draw <span id="prize-draw-number"></span>!</p>
                                    <div class="row mt-4">
                                        <div class="col-md-6">
                                            <p><strong>Division:</strong> <span id="prize-division"></span></p>
                                            <p><strong>Match Type:</strong> <span id="prize-match-type"></span></p>
                                        </div>
                                        <div class="col-md-6 text-center">
                                            <div class="p-3 bg-light rounded">
                                                <p class="mb-1">Prize Amount:</p>
                                                <h3 class="text-success"><span id="prize-amount"></span></h3>
                                            </div>
                                        </div>
                                    </div>
                                    <p class="small text-muted mt-4 text-center">Visit the official South African National Lottery website or an authorized retailer to claim your prize.</p>
                                </div>
                            </div>
                        </div>
                        
                        <div id="no-prize-container" class="d-none">
                            <div class="card">
                                <div class="card-header bg-secondary text-white">
                                    <h5 class="mb-0">Result</h5>
                                </div>
                                <div class="card-body text-center p-4">
                                    <i class="fa fa-times-circle fa-3x text-muted mb-3"></i>
                                    <h4 class="text-muted mb-3">No Prize This Time</h4>
                                    <p>Sorry, your ticket did not win a prize in this draw.</p>
                                    <p>Better luck next time!</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="text-center mt-4">
                            <button id="scan-new-ticket" class="btn btn-primary">
                                <i class="fa fa-redo me-2"></i> Scan Another Ticket
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block additional_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const dropArea = document.getElementById('drop-area');
        const fileInput = document.getElementById('ticket-image');
        const fileSelectBtn = document.getElementById('file-select-btn');
        const previewContainer = document.getElementById('preview-container');
        const ticketPreview = document.getElementById('ticket-preview');
        const removeImageBtn = document.getElementById('remove-image');
        const scanButton = document.getElementById('scan-button');
        const ticketForm = document.getElementById('ticket-form');
        const lotteryTypeSelect = document.getElementById('lottery-type');
        const loadingIndicator = document.getElementById('scanner-loading');
        const resultsContainer = document.getElementById('results-container');
        const scanNewTicketBtn = document.getElementById('scan-new-ticket');
        
        // Initialize scan button state
        setTimeout(() => {
            updateScanButton();
        }, 500);
        
        // File selection via button
        fileSelectBtn.addEventListener('click', () => {
            fileInput.click();
        });
        
        // File selection change
        fileInput.addEventListener('change', handleFileSelect);
        
        // Drag and drop events
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, preventDefaults, false);
        });
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, highlight, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, unhighlight, false);
        });
        
        function highlight() {
            dropArea.classList.add('highlight');
        }
        
        function unhighlight() {
            dropArea.classList.remove('highlight');
        }
        
        dropArea.addEventListener('drop', handleDrop, false);
        
        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            
            if (files.length > 0) {
                fileInput.files = files;
                handleFileSelect();
            }
        }
        
        function handleFileSelect() {
            const file = fileInput.files[0];
            
            if (file) {
                // Check if file is an image
                if (!file.type.match('image.*')) {
                    alert('Please select an image file');
                    fileInput.value = ''; // Clear the file input
                    return;
                }
                
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    ticketPreview.src = e.target.result;
                    previewContainer.classList.remove('d-none');
                    // Update scan button state
                    updateScanButton();
                }
                
                reader.onerror = function() {
                    alert('Error reading the image file. Please try a different image.');
                    fileInput.value = ''; // Clear the file input on error
                    updateScanButton();
                }
                
                reader.readAsDataURL(file);
            } else {
                previewContainer.classList.add('d-none');
                updateScanButton();
            }
        }
        
        removeImageBtn.addEventListener('click', function() {
            ticketPreview.src = '';
            fileInput.value = '';
            previewContainer.classList.add('d-none');
            updateScanButton();
        });
        
        lotteryTypeSelect.addEventListener('change', updateScanButton);
        
        // Add a direct click handler for the scan button
        scanButton.addEventListener('click', function(e) {
            if (fileInput.files.length) {
                e.preventDefault();
                processTicketWithAds();
            }
        });
        
        // Scan new ticket button
        if (scanNewTicketBtn) {
            scanNewTicketBtn.addEventListener('click', function() {
                // Hide results and reset the form
                resultsContainer.classList.add('d-none');
                ticketForm.reset();
                previewContainer.classList.add('d-none');
                updateScanButton();
                
                // Scroll back to top of scanner
                window.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
            });
        }
        
        function updateScanButton() {
            // Enable button if image is selected
            scanButton.disabled = !fileInput.files.length;
        }
        
        // Function to handle showing ads and processing the ticket
        function processTicketWithAds() {
            // Show loading indicator
            loadingIndicator.style.display = 'block';
            // Disable the scan button while processing
            scanButton.disabled = true;
            
            // Show ad loading overlay
            const adOverlayLoading = document.getElementById('ad-overlay-loading');
            adOverlayLoading.style.display = 'flex';
            
            // Create form data for later use
            const formData = new FormData(ticketForm);
            
            // Load ad in the loading overlay then process the ticket
            console.log('Showing processing ad for 5+ seconds');
            
            // Simulate a multi-step process for visual interest during ad viewing
            // Will process the ticket after steps complete (at least 30 seconds)
            simulateProcessingSteps(formData);
        }
        
        // Simulate processing steps to make ad viewing time more engaging
        function simulateProcessingSteps(formData) {
            const progressBar = document.getElementById('scan-progress-bar');
            const stepText = document.getElementById('scan-step-text');
            
            // Create more steps to extend the processing time to 30 seconds
            const steps = [
                { 
                    text: "Initializing ticket scanning process...", 
                    progress: 10,
                    activeStep: 1
                },
                { 
                    text: "Uploading and analyzing your ticket image...", 
                    progress: 20,
                    activeStep: 1
                },
                { 
                    text: "Processing image with optical character recognition...", 
                    progress: 30,
                    activeStep: 1
                },
                { 
                    text: "Using AI to identify game type...", 
                    progress: 40,
                    activeStep: 2
                },
                { 
                    text: "Extracting draw information and date...", 
                    progress: 50,
                    activeStep: 2
                },
                { 
                    text: "Detecting your selected lottery numbers...", 
                    progress: 60,
                    activeStep: 3
                },
                { 
                    text: "Retrieving latest draw results from database...", 
                    progress: 70,
                    activeStep: 3
                },
                { 
                    text: "Matching your numbers against winning combinations...", 
                    progress: 80,
                    activeStep: 4
                },
                { 
                    text: "Calculating potential prize information...", 
                    progress: 90,
                    activeStep: 4
                },
                { 
                    text: "Preparing your results...", 
                    progress: 95,
                    activeStep: 4
                },
                { 
                    text: "Results ready! Finishing up...", 
                    progress: 100,
                    activeStep: 4
                }
            ];
            
            let currentStep = 0;
            let ticketData = null;
            let ticketProcessed = false;
            
            // Start processing the ticket in the background while showing ads
            // This way, results will be ready when the ad finishes
            fetch('/scan-ticket', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                console.log('Ticket processing completed in background. Data ready:', data);
                ticketData = data;
                ticketProcessed = true;
            })
            .catch(error => {
                console.error('Error processing ticket:', error);
                ticketProcessed = true;
                ticketData = { error: "An error occurred while scanning your ticket. Please try again." };
            });
            
            const interval = setInterval(() => {
                if (currentStep < steps.length) {
                    const step = steps[currentStep];
                    
                    // Update step text and progress bar
                    stepText.textContent = step.text;
                    progressBar.style.width = step.progress + '%';
                    
                    // Update step indicators
                    const allSteps = document.querySelectorAll('.step');
                    allSteps.forEach((stepEl, index) => {
                        // Reset all steps
                        stepEl.classList.remove('active', 'completed');
                        
                        // Mark completed steps
                        if (index + 1 < step.activeStep) {
                            stepEl.classList.add('completed');
                        }
                        // Mark active step
                        else if (index + 1 === step.activeStep) {
                            stepEl.classList.add('active');
                        }
                    });
                    
                    currentStep++;
                } else {
                    clearInterval(interval);
                    
                    // Hide loading overlay
                    const adOverlayLoading = document.getElementById('ad-overlay-loading');
                    adOverlayLoading.style.display = 'none';
                    
                    // Wait for ticket processing to complete if it hasn't already
                    const waitForTicketData = () => {
                        if (ticketProcessed) {
                            showResultsOverlay(ticketData);
                        } else {
                            setTimeout(waitForTicketData, 500);
                        }
                    };
                    
                    waitForTicketData();
                }
            }, 3000); // Change steps every 3 seconds for a total of 33 seconds (11 steps)
        }
        
        // Show the results overlay with data
        function showResultsOverlay(data) {
            // Show results ad overlay
            const adOverlayResults = document.getElementById('ad-overlay-results');
            adOverlayResults.style.display = 'flex';
            
            console.log('Showing results interstitial ad');
            
            // Setup view results button
            const viewResultsBtn = document.getElementById('view-results-btn');
            viewResultsBtn.onclick = function() {
                console.log('View Results button clicked!');
                adOverlayResults.style.display = 'none';
                displayResults(data);
            };
            
            // Do not automatically close the ad - let the user click the button
            // This ensures the ad stays visible for maximum exposure
            
            // Hide loading indicator and re-enable scan button
            const loadingIndicator = document.getElementById('scanner-loading');
            loadingIndicator.style.display = 'none';
            scanButton.disabled = false;
            console.log("Scan completed - button enabled");
        }
        
        // Function to process the ticket after ad is shown
        function processTicket(formData) {
            console.log('Processing ticket with formData content:', Array.from(formData.entries()));
            
            // Send request with debugging
            fetch('/scan-ticket', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                console.log('Response status:', response.status);
                console.log('Response headers:', [...response.headers.entries()]);
                return response.json();
            })
            .then(data => {
                console.log('Success data received:', data);
                
                // Hide loading overlay
                const adOverlayLoading = document.getElementById('ad-overlay-loading');
                adOverlayLoading.style.display = 'none';
                
                // Show results ad overlay
                const adOverlayResults = document.getElementById('ad-overlay-results');
                adOverlayResults.style.display = 'flex';
                
                console.log('Showing results interstitial ad');
                
                // Setup view results button
                const viewResultsBtn = document.getElementById('view-results-btn');
                viewResultsBtn.onclick = function() {
                    console.log('View Results button clicked!');
                    console.log('Data to display:', data);
                    adOverlayResults.style.display = 'none';
                    displayResults(data);
                };
                
                // Do not automatically close the ad - let the user click the button
                // This ensures the ad stays visible for maximum exposure
            })
            .catch(error => {
                console.error('Error:', error);
                // Hide ad loading overlay
                const adOverlayLoading = document.getElementById('ad-overlay-loading');
                adOverlayLoading.style.display = 'none';
                showError('An error occurred while scanning your ticket. Please try again.');
            })
            .finally(() => {
                // Hide loading indicator
                loadingIndicator.style.display = 'none';
                scanButton.disabled = false;
                console.log("Scan completed - button enabled");
            });
        }
        
        function displayResults(data) {
            console.log('Displaying results:', data);
            
            // Show results container
            resultsContainer.classList.remove('d-none');
            
            // Hide error message by default
            document.getElementById('error-message').classList.add('d-none');
            
            if (data.error) {
                console.error('Error from backend:', data.error);
                showError(data.error);
                return;
            }
            
            // Show success content
            const successContent = document.getElementById('success-content');
            successContent.classList.remove('d-none');
            
            // Populate ticket info
            document.getElementById('result-lottery-type').textContent = data.lottery_type;
            document.getElementById('result-draw-number').textContent = data.draw_number;
            document.getElementById('result-draw-date').textContent = data.draw_date;
            
            // Populate detected information from OCR if available
            if (data.ticket_info) {
                document.getElementById('detected-game-type').textContent = data.ticket_info.detected_game_type || 'Unknown';
                document.getElementById('detected-draw-number').textContent = data.ticket_info.detected_draw_number || 'Unknown';
                document.getElementById('detected-draw-date').textContent = data.ticket_info.detected_draw_date || 'Unknown';
            } else {
                document.getElementById('detected-info').classList.add('d-none');
            }
            
            // Display ticket numbers
            const ticketNumbersContainer = document.getElementById('ticket-numbers');
            ticketNumbersContainer.innerHTML = '';
            
            data.ticket_numbers.forEach(num => {
                const ball = document.createElement('span');
                ball.classList.add('lottery-ball');
                
                // Add color classes in sequence
                if (ticketNumbersContainer.children.length % 4 === 0) {
                    ball.classList.add('lottery-ball-red');
                } else if (ticketNumbersContainer.children.length % 4 === 1) {
                    ball.classList.add('lottery-ball-yellow');
                } else if (ticketNumbersContainer.children.length % 4 === 2) {
                    ball.classList.add('lottery-ball-green');
                } else {
                    ball.classList.add('lottery-ball-blue');
                }
                
                ball.textContent = num;
                ticketNumbersContainer.appendChild(ball);
            });
            
            // Display winning numbers
            const winningNumbersContainer = document.getElementById('winning-numbers');
            winningNumbersContainer.innerHTML = '';
            
            data.winning_numbers.forEach(num => {
                const ball = document.createElement('span');
                ball.classList.add('lottery-ball');
                
                // Add color classes in sequence
                if (winningNumbersContainer.children.length % 4 === 0) {
                    ball.classList.add('lottery-ball-red');
                } else if (winningNumbersContainer.children.length % 4 === 1) {
                    ball.classList.add('lottery-ball-yellow');
                } else if (winningNumbersContainer.children.length % 4 === 2) {
                    ball.classList.add('lottery-ball-green');
                } else {
                    ball.classList.add('lottery-ball-blue');
                }
                
                ball.textContent = num;
                winningNumbersContainer.appendChild(ball);
            });
            
            // Add bonus balls if available
            if (data.bonus_numbers && data.bonus_numbers.length > 0) {
                const plusSpan = document.createElement('span');
                plusSpan.classList.add('mx-2');
                plusSpan.textContent = '+';
                winningNumbersContainer.appendChild(plusSpan);
                
                data.bonus_numbers.forEach(num => {
                    const ball = document.createElement('span');
                    ball.classList.add('lottery-ball', 'lottery-ball-blue', 'lottery-ball-bonus');
                    ball.textContent = num;
                    winningNumbersContainer.appendChild(ball);
                });
            }
            
            // Display matched numbers
            document.getElementById('matched-count').textContent = data.matched_numbers.length;
            
            const matchedNumbersContainer = document.getElementById('matched-numbers');
            matchedNumbersContainer.innerHTML = '';
            
            if (data.matched_numbers.length > 0) {
                data.matched_numbers.forEach(num => {
                    const ball = document.createElement('span');
                    ball.classList.add('lottery-ball', 'ball-matched');
                    
                    // Add color classes in sequence
                    if (matchedNumbersContainer.children.length % 4 === 0) {
                        ball.classList.add('lottery-ball-red');
                    } else if (matchedNumbersContainer.children.length % 4 === 1) {
                        ball.classList.add('lottery-ball-yellow');
                    } else if (matchedNumbersContainer.children.length % 4 === 2) {
                        ball.classList.add('lottery-ball-green');
                    } else {
                        ball.classList.add('lottery-ball-blue');
                    }
                    
                    ball.textContent = num;
                    matchedNumbersContainer.appendChild(ball);
                });
            } else {
                matchedNumbersContainer.innerHTML = '<p>No matching numbers found.</p>';
            }
            
            // Display prize information if any
            const prizeContainer = document.getElementById('prize-container');
            const noPrizeContainer = document.getElementById('no-prize-container');
            
            if (data.has_prize) {
                prizeContainer.classList.remove('d-none');
                noPrizeContainer.classList.add('d-none');
                
                document.getElementById('prize-lottery-type').textContent = data.lottery_type;
                document.getElementById('prize-draw-number').textContent = data.draw_number;
                document.getElementById('prize-division').textContent = data.prize_info.division;
                document.getElementById('prize-match-type').textContent = data.prize_info.match_type;
                document.getElementById('prize-amount').textContent = data.prize_info.prize_amount;
            } else {
                prizeContainer.classList.add('d-none');
                noPrizeContainer.classList.remove('d-none');
            }
            
            // Scroll to results
            resultsContainer.scrollIntoView({ behavior: 'smooth' });
        }
        
        function showError(message) {
            const errorMessage = document.getElementById('error-message');
            const errorText = document.getElementById('error-text');
            const successContent = document.getElementById('success-content');
            
            errorText.textContent = message;
            errorMessage.classList.remove('d-none');
            successContent.classList.add('d-none');
        }
    });
</script>
{% endblock %}