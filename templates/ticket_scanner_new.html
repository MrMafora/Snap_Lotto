{% extends "base.html" %}

{% block title %}Lottery Ticket Scanner | Snap Lotto{% endblock %}

{% block additional_head %}
<style>
    .ticket-scanner-container {
        max-width: 700px;
        margin: 0 auto;
    }
    
    /* Clean, modern interface */
    .ticket-card {
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        border: none;
        overflow: hidden;
    }
    
    /* Info callout */
    .info-callout {
        background-color: #e1f5fe;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
        border-left: 4px solid #03a9f4;
    }
    
    /* Drop area styling */
    .ticket-drop-area {
        border: 2px dashed #dee2e6;
        border-radius: 8px;
        padding: 30px;
        text-align: center;
        background-color: #f8f9fa;
        cursor: pointer;
        transition: all 0.3s;
        margin-bottom: 20px;
    }
    
    .ticket-drop-area:hover, .ticket-drop-area.highlight {
        border-color: #0d6efd;
        background-color: rgba(13, 110, 253, 0.05);
    }
    
    /* Button styling */
    .btn-scan {
        padding: 12px 30px;
        font-size: 18px;
        border-radius: 8px;
    }
    
    /* Ticket preview */
    .ticket-preview {
        max-width: 100%;
        max-height: 300px;
        margin: 20px 0;
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    
    /* Form elements */
    .form-label {
        font-weight: 500;
    }
    
    .form-control, .form-select {
        padding: 10px 15px;
        border-radius: 8px;
    }
    
    /* Advertisement overlays - with CRITICAL display properties - DO NOT CHANGE */
    .ad-overlay {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        width: 100% !important;
        height: 100% !important;
        background-color: rgba(0, 0, 0, 0.95) !important;
        z-index: 2147483647 !important; /* Maximum possible z-index value */
        /* display is set inline on the element */
        flex-direction: column !important;
        align-items: center !important;
        justify-content: center !important;
        padding: 20px !important;
        opacity: 1 !important;
        visibility: visible !important;
        pointer-events: auto !important;
        transition: none !important; /* Prevent transitions from interfering */
        overflow: hidden !important; /* Prevent scrolling while overlay is active */
        opacity: 1 !important;
        visibility: visible !important;
        transition: none !important; /* Remove transition for immediate appearance */
    }
    
    /* Make the View Results button more prominent */
    #view-results-btn {
        padding: 12px 30px;
        font-size: 18px;
        animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }
    
    /* Add additional styling for the results ad content */
    .results-ad-content {
        width: 100%;
        max-width: 600px;
        margin: 0 auto;
        background-color: white;
        border-radius: 12px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        padding: 30px;
        text-align: center;
    }
    
    .ad-container {
        width: 100%;
        max-width: 500px;
        margin: 20px 0;
    }
    
    .ad-placeholder {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 30px;
        text-align: center;
        min-height: 200px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }
    
    /* Scanner loading */
    #scanner-loading {
        display: none;
    }
    
    /* Optional note */
    .optional-note {
        font-size: 0.9rem;
        color: #6c757d;
        margin-left: 5px;
    }
</style>
{% endblock %}

{% block content %}
<!-- Ad overlay - Loading screen (pre-initialized with correct visibility properties) -->
<div id="ad-overlay-loading" class="ad-overlay" style="display: none; opacity: 1; visibility: visible; z-index: 2147483647; position: fixed !important; top: 0 !important; left: 0 !important; width: 100% !important; height: 100% !important; background-color: rgba(0, 0, 0, 0.95) !important; color: white !important; text-align: center !important; padding: 30px !important;">
    <h4 class="mb-4 text-white">Processing your ticket...</h4>
    <!-- VISIBLE ADVERTISEMENT PLACEHOLDER -->
    <div class="ad-container" style="margin: 0 auto; background-color: #f8f9fa; border-radius: 10px; padding: 20px; max-width: 350px;">
        <div id="ad-container-loader" style="width: 300px; margin: 0 auto;">
            <!-- Highly visible ad placeholder -->
            <div style="width: 300px; height: 250px; background-color: #f8f9fa; border: 3px solid #0d6efd; border-radius: 10px; display: flex; flex-direction: column; justify-content: center; align-items: center; margin: 0 auto; box-shadow: 0 4px 12px rgba(0,0,0,0.2);">
                <div style="font-size: 24px; margin-bottom: 10px; color: #0d6efd;">
                    <i class="fas fa-ad"></i>
                </div>
                <div style="font-weight: bold; font-size: 18px; color: #212529; margin-bottom: 5px;">
                    Advertisement
                </div>
                <div style="color: #6c757d; font-size: 14px; text-align: center; padding: 0 20px;">
                    This placeholder helps keep the service free
                </div>
                <div style="margin-top: 20px; display: flex; gap: 10px;">
                    <div style="width: 12px; height: 12px; background-color: #dc3545; border-radius: 50%;"></div>
                    <div style="width: 12px; height: 12px; background-color: #ffc107; border-radius: 50%;"></div>
                    <div style="width: 12px; height: 12px; background-color: #198754; border-radius: 50%;"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="mt-4 text-center" style="max-width: 500px; margin: 0 auto;">
        <div class="spinner-border text-primary mb-3" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <div id="scan-progress">
            <h5 class="mb-3">Analyzing your ticket...</h5>
            
            <!-- Progress steps -->
            <div class="steps-container mb-4">
                <div class="step active" id="step-1">
                    <div class="step-circle">1</div>
                    <div class="step-text">Reading Ticket</div>
                </div>
                <div class="step" id="step-2">
                    <div class="step-circle">2</div>
                    <div class="step-text">Identifying Game</div>
                </div>
                <div class="step" id="step-3">
                    <div class="step-circle">3</div>
                    <div class="step-text">Checking Numbers</div>
                </div>
                <div class="step" id="step-4">
                    <div class="step-circle">4</div>
                    <div class="step-text">Calculating Prize</div>
                </div>
            </div>
            
            <div class="progress mb-3" style="height: 10px;">
                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                     id="scan-progress-bar" role="progressbar" style="width: 25%"></div>
            </div>
            <p id="scan-step-text" class="text-muted">Uploading and analyzing your ticket image...</p>
        </div>
    </div>
</div>

<!-- Ad overlay - Results screen (fixed position, pre-initialized with critical visibility styles) -->
<div id="ad-overlay-results" class="ad-overlay" style="display: none; opacity: 1; visibility: visible; z-index: 2147483647; position: fixed !important; top: 0 !important; left: 0 !important; width: 100% !important; height: 100% !important; background-color: rgba(0, 0, 0, 0.95) !important; color: white !important; text-align: center !important; padding: 30px !important;">
    <div class="results-ad-content" style="max-width: 500px; margin: 0 auto;">
        <h4 class="mb-4 text-white">Your Results Are Ready!</h4>
        <!-- VISIBLE ADVERTISEMENT PLACEHOLDER -->
        <div class="ad-container" style="margin: 0 auto; background-color: #f8f9fa; border-radius: 10px; padding: 20px; max-width: 350px;">
            <div id="ad-container-interstitial" style="width: 300px; margin: 0 auto;">
                <!-- Highly visible ad placeholder -->
                <div style="width: 300px; height: 250px; background-color: #f8f9fa; border: 3px solid #198754; border-radius: 10px; display: flex; flex-direction: column; justify-content: center; align-items: center; margin: 0 auto; box-shadow: 0 4px 12px rgba(0,0,0,0.2);">
                    <div style="font-size: 24px; margin-bottom: 10px; color: #198754;">
                        <i class="fas fa-ad"></i>
                    </div>
                    <div style="font-weight: bold; font-size: 18px; color: #212529; margin-bottom: 5px;">
                        Advertisement
                    </div>
                    <div style="color: #6c757d; font-size: 14px; text-align: center; padding: 0 20px;">
                        Support from ads keeps this service free
                    </div>
                    <div style="margin-top: 20px; display: flex; gap: 10px;">
                        <div style="width: 12px; height: 12px; background-color: #dc3545; border-radius: 50%;"></div>
                        <div style="width: 12px; height: 12px; background-color: #ffc107; border-radius: 50%;"></div>
                        <div style="width: 12px; height: 12px; background-color: #198754; border-radius: 50%;"></div>
                    </div>
                </div>
            </div>
        </div>
        <button class="btn btn-success px-4 py-3 mt-4 pulse-btn" id="view-results-btn">
            <i class="fas fa-check-circle me-2"></i> View My Results
        </button>
    </div>
</div>

<div class="container py-4">
    <div class="row mb-4">
        <div class="col-12 text-center">
            <h2 class="fw-bold">Lottery Ticket Scanner</h2>
            <p class="text-muted">Check if your lottery ticket has won a prize</p>
            <div class="slogan-banner mt-3 mb-2">
                <span class="slogan-text">Snap, Scan and Win = Phusha Phanda Play</span>
            </div>
        </div>
    </div>

    <div class="ticket-scanner-container">
        <div class="ticket-card card">
            <div class="card-body p-4">
                <div class="info-callout mb-4">
                    <i class="fa fa-info-circle me-2"></i> 
                    Take a clear photo of your lottery ticket, making sure all numbers are visible.
                </div>

                <form id="ticket-form" action="/scan-ticket" method="post" enctype="multipart/form-data">
                    {{ form.hidden_tag() }}
                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label for="lottery-type" class="form-label">
                                Game Type
                                <span class="optional-note">(Optional - AI will detect)</span>
                            </label>
                            <select class="form-select" id="lottery-type" name="lottery_type">
                                <option value="">Auto-detect from ticket</option>
                                <option value="Lotto">Lotto</option>
                                <option value="Lotto Plus 1">Lotto Plus 1</option>
                                <option value="Lotto Plus 2">Lotto Plus 2</option>
                                <option value="Powerball">Powerball</option>
                                <option value="Powerball Plus">Powerball Plus</option>
                                <option value="Daily Lotto">Daily Lotto</option>
                            </select>
                        </div>
                        
                        <div class="col-md-6">
                            <label for="draw-number" class="form-label">
                                Draw Number
                                <span class="optional-note">(Optional)</span>
                            </label>
                            <input type="text" class="form-control" id="draw-number" name="draw_number" 
                                placeholder="Leave blank for latest draw">
                        </div>
                    </div>

                    <div class="ticket-drop-area" id="drop-area">
                        <i class="fa fa-upload fa-2x mb-3 text-primary"></i>
                        <h5>Drag and drop your ticket image here</h5>
                        <p class="text-muted">or</p>
                        <input type="file" id="ticket-image" name="ticket_image" accept="image/*" class="d-none">
                        <button type="button" id="file-select-btn" class="btn btn-primary px-4">
                            Select Image
                        </button>
                    </div>

                    <div id="preview-container" class="text-center d-none">
                        <h6 class="mb-3">Ticket Preview</h6>
                        <img id="ticket-preview" class="ticket-preview img-fluid" src="">
                        <div class="mt-3">
                            <button type="button" id="remove-image" class="btn btn-sm btn-outline-danger">
                                <i class="fa fa-times"></i> Remove
                            </button>
                        </div>
                    </div>

                    <!-- INLINE AD CONTAINER - Always visible before submission -->
                    <div class="ad-inline-container mt-4 mb-4 text-center" style="background-color: #f8f9fa; border: 2px solid #0d6efd; border-radius: 10px; padding: 15px; max-width: 400px; margin: 0 auto;">
                        <div style="margin-bottom: 10px; color: #6c757d;">Advertisement</div>
                        <div style="width: 300px; height: 100px; background-color: #ffffff; border: 2px dashed #0d6efd; border-radius: 5px; display: flex; flex-direction: column; justify-content: center; align-items: center; margin: 0 auto;">
                            <div style="font-size: 24px; color: #0d6efd;"><i class="fas fa-ad"></i></div>
                            <div style="color: #6c757d; font-size: 12px; text-align: center; padding: 5px;">Support from ads keeps this service free</div>
                        </div>
                    </div>
                    
                    <div class="text-center mt-4">
                        <button type="submit" id="scan-button" class="btn btn-success btn-scan" onclick="if(this.form.querySelector('#ticket-image').files.length) { 
                            // Display a direct inline ad before scanning
                            const adElement = document.createElement('div');
                            adElement.className = 'direct-ad-display';
                            adElement.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 320px; background-color: white; border: 5px solid #dc3545; border-radius: 15px; padding: 20px; z-index: 999999; box-shadow: 0 0 50px rgba(0,0,0,0.5);';
                            adElement.innerHTML = '<div style=\"text-align: center;\"><div style=\"font-size: 30px; margin-bottom: 15px; color: #dc3545;\"><i class=\"fas fa-ad\"></i></div><div style=\"font-weight: bold; font-size: 20px; margin-bottom: 10px;\">Advertisement</div><div style=\"margin: 15px 0; padding: 10px; background-color: #f8f9fa; border-radius: 8px;\">This advertisement helps keep this service completely free!</div><div style=\"margin-top: 20px;\"><button id=\"close-ad-btn\" class=\"btn btn-outline-primary\">Continue to Results</button></div></div>';
                            document.body.appendChild(adElement);
                            
                            // Create overlay behind the ad
                            const overlay = document.createElement('div');
                            overlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); z-index: 999998;';
                            document.body.appendChild(overlay);
                            
                            console.log('Created direct inline ad element');
                            
                            // Add event listener to close button with a delay
                            setTimeout(() => {
                                const closeBtn = document.getElementById('close-ad-btn');
                                if (closeBtn) {
                                    closeBtn.addEventListener('click', function() {
                                        adElement.remove();
                                        overlay.remove();
                                    });
                                }
                            }, 100);
                        }">
                            <i class="fa fa-search me-2"></i> Scan Ticket
                        </button>
                        <div id="scanner-loading" class="mt-3">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p>Scanning your ticket...</p>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Results section will display after scanning -->
        <div id="results-container" class="results-container mt-4 d-none">
            <div class="card ticket-card">
                <div class="card-body p-4">
                    <h3 class="mb-4 text-center">Scan Results</h3>
                    
                    <div id="error-message" class="d-none">
                        <div class="card mb-4">
                            <div class="card-header bg-warning text-white">
                                <h5 class="mb-0"><i class="fas fa-exclamation-circle me-2"></i>Information</h5>
                            </div>
                            <div class="card-body">
                                <div id="error-text"></div>
                                <div class="mt-3 text-center">
                                    <button id="scan-another-btn" class="btn btn-outline-primary mt-2">
                                        <i class="fas fa-redo me-2"></i>Scan Another Ticket
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="success-content" class="d-none">
                        <!-- RESULTS PAGE ADVERTISEMENT BANNER -->
                        <div class="ad-banner mb-4" style="background-color: #dc3545; border-radius: 10px; padding: 15px; text-align: center; color: white; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
                            <div style="font-size: 18px; margin-bottom: 5px;"><i class="fas fa-ad mr-2"></i> ADVERTISEMENT</div>
                            <div style="font-size: 24px; font-weight: bold; margin-bottom: 10px;">PLAY THE LOTTERY ONLINE!</div>
                            <div style="background-color: white; padding: 10px; border-radius: 8px; margin: 0 auto; max-width: 500px;">
                                <div style="display: flex; justify-content: space-around; align-items: center; flex-wrap: wrap;">
                                    <div style="text-align: center; padding: 10px; color: #333;">
                                        <div style="font-size: 36px; color: #ffc107;"><i class="fas fa-ticket-alt"></i></div>
                                        <div>Buy Tickets</div>
                                    </div>
                                    <div style="text-align: center; padding: 10px; color: #333;">
                                        <div style="font-size: 36px; color: #28a745;"><i class="fas fa-sync-alt"></i></div>
                                        <div>Play Regularly</div>
                                    </div>
                                    <div style="text-align: center; padding: 10px; color: #333;">
                                        <div style="font-size: 36px; color: #17a2b8;"><i class="fas fa-trophy"></i></div>
                                        <div>Win Prizes</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card mb-4">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0" id="ticket-info-title">Ticket Information</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <p><strong>Lottery Type:</strong> <span id="result-lottery-type"></span></p>
                                        <p><strong>Draw Number:</strong> <span id="result-draw-number"></span></p>
                                        <p><strong>Draw Date:</strong> <span id="result-draw-date"></span></p>
                                        
                                        <div id="detected-info" class="mt-3 small">
                                            <p class="text-muted mb-1"><i class="fas fa-search-plus me-1"></i> <strong>AI Detected Information:</strong></p>
                                            <p class="mb-1"><strong>Game Type:</strong> <span id="detected-game-type"></span></p>
                                            <p class="mb-1"><strong>Draw Number:</strong> <span id="detected-draw-number"></span></p>
                                            <p class="mb-1"><strong>Draw Date:</strong> <span id="detected-draw-date"></span></p>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <p><strong>Your Numbers:</strong></p>
                                        <div id="ticket-numbers" class="mb-3"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card mb-4">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0">Winning Numbers</h5>
                            </div>
                            <div class="card-body">
                                <div id="winning-numbers" class="mb-3"></div>
                                
                                <div class="mt-4">
                                    <p><strong>Matched Numbers:</strong> <span id="matched-count" class="badge bg-success">0</span></p>
                                    <div id="matched-numbers"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="prize-container" class="d-none">
                            <div class="card prize-card">
                                <div class="card-header bg-warning">
                                    <h5 class="mb-0"><i class="fa fa-trophy me-2"></i> Winner!</h5>
                                </div>
                                <div class="card-body">
                                    <h4 class="text-success mb-3 text-center">Congratulations!</h4>
                                    <p class="lead text-center">You've won a prize in <span id="prize-lottery-type"></span> Draw <span id="prize-draw-number"></span>!</p>
                                    <div class="row mt-4">
                                        <div class="col-md-6">
                                            <p><strong>Division:</strong> <span id="prize-division"></span></p>
                                            <p><strong>Match Type:</strong> <span id="prize-match-type"></span></p>
                                        </div>
                                        <div class="col-md-6 text-center">
                                            <div class="p-3 bg-light rounded">
                                                <p class="mb-1">Prize Amount:</p>
                                                <h3 class="text-success"><span id="prize-amount"></span></h3>
                                            </div>
                                        </div>
                                    </div>
                                    <p class="small text-muted mt-4 text-center">Visit the official South African National Lottery website or an authorized retailer to claim your prize.</p>
                                </div>
                            </div>
                        </div>
                        
                        <div id="no-prize-container" class="d-none">
                            <div class="card">
                                <div class="card-header bg-secondary text-white">
                                    <h5 class="mb-0">Result</h5>
                                </div>
                                <div class="card-body text-center p-4">
                                    <i class="fa fa-times-circle fa-3x text-muted mb-3"></i>
                                    <h4 class="text-muted mb-3">No Prize This Time</h4>
                                    <p>Sorry, your ticket did not win a prize in this draw.</p>
                                    <p>Better luck next time!</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="text-center mt-4">
                            <button id="scan-new-ticket" class="btn btn-primary">
                                <i class="fa fa-redo me-2"></i> Scan Another Ticket
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block additional_scripts %}
<script>
    // Define the AdManager object using object pattern assignment
    // This prevents the "Identifier AdManager has already been declared" error
    window.AdManager = window.AdManager || {
            // Make sure init exists even if external script fails
            init: function() {
                console.log("AdManager initialized from ticket_scanner_new.html");
            },
            
            showLoadingAd: function() {
                // Show loading overlay during ticket processing
                const adOverlayLoading = document.getElementById('ad-overlay-loading');
                if (adOverlayLoading) {
                    // Make sure overlay is fully visible immediately
                    adOverlayLoading.style.display = 'flex';
                    adOverlayLoading.style.opacity = '1';
                    adOverlayLoading.style.visibility = 'visible';
                    adOverlayLoading.style.zIndex = '9999';
                    document.body.style.overflow = 'hidden';
                    console.log("AdManager: Loading overlay shown");
                } else {
                    console.error("AdManager: Loading overlay element not found");
                }
            },
            
            hideLoadingAd: function() {
                // Hide loading overlay after ticket processing
                const adOverlayLoading = document.getElementById('ad-overlay-loading');
                if (adOverlayLoading) {
                    adOverlayLoading.style.display = 'none';
                    document.body.style.overflow = 'auto';
                    console.log("AdManager: Loading overlay hidden");
                }
            },
            
            showInterstitialAd: function() {
                // Show interstitial ad after results are ready
                const adOverlayResults = document.getElementById('ad-overlay-results');
                if (adOverlayResults) {
                    // Make sure overlay is fully visible immediately
                    adOverlayResults.style.display = 'flex';
                    adOverlayResults.style.opacity = '1';
                    adOverlayResults.style.visibility = 'visible';
                    adOverlayResults.style.zIndex = '9999';
                    document.body.style.overflow = 'hidden';
                    console.log("AdManager: Interstitial overlay shown");
                } else {
                    console.error("AdManager: Interstitial overlay element not found");
                }
            },
            
            hideInterstitialAd: function() {
                // Hide interstitial ad when user wants to see results
                const adOverlayResults = document.getElementById('ad-overlay-results');
                if (adOverlayResults) {
                    adOverlayResults.style.display = 'none';
                    document.body.style.overflow = 'auto';
                    console.log("AdManager: Interstitial overlay hidden");
                }
            }
        };
        console.log("AdManager initialized");

    // Direct DOM utility function to immediately show any overlay
    /**
     * Lightweight overlay display function optimized for performance
     * Displays ad overlay with minimal blocking operations
     * @param {string} id - ID of the overlay element to show
     * @returns {boolean} - Whether overlay was successfully displayed
     */
    function showOverlay(id) {
        // Ultra-barebones version with no additional processing that might block
        try {
            document.getElementById(id).style.display = 'flex';
            console.log(`Overlay ${id} displayed with ultra-barebones approach`);
            return true;
        } catch (e) {
            console.error('Error in showOverlay:', e);
            return false;
        }
    }
    
    // CRITICAL: Preload function to prepare overlay elements for immediate display
    function preloadOverlayElements() {
        // Get references to overlay elements
        const loadingOverlay = document.getElementById('ad-overlay-loading');
        const resultsOverlay = document.getElementById('ad-overlay-results');
        
        // Prepare overlay elements with all required properties but keep them hidden
        [loadingOverlay, resultsOverlay].forEach(overlay => {
            if (overlay) {
                // Pre-configure all properties except display
                overlay.style.position = 'fixed';
                overlay.style.top = '0';
                overlay.style.left = '0';
                overlay.style.width = '100%';
                overlay.style.height = '100%';
                overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.95)';
                overlay.style.zIndex = '2147483647';
                overlay.style.opacity = '1';
                overlay.style.visibility = 'visible';
                overlay.style.transition = 'none';
                
                // Set appropriate ARIA attributes for accessibility
                overlay.setAttribute('aria-modal', 'true');
                overlay.setAttribute('role', 'dialog');
                
                // Create a clone and append it to the body to ensure it's in the DOM
                const clone = overlay.cloneNode(true);
                clone.style.display = 'none';
                document.body.appendChild(clone);
                
                console.log(`Overlay ${overlay.id} preloaded for immediate display`);
            }
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        const dropArea = document.getElementById('drop-area');
        const fileInput = document.getElementById('ticket-image');
        const fileSelectBtn = document.getElementById('file-select-btn');
        const previewContainer = document.getElementById('preview-container');
        const ticketPreview = document.getElementById('ticket-preview');
        const removeImageBtn = document.getElementById('remove-image');
        const scanButton = document.getElementById('scan-button');
        const ticketForm = document.getElementById('ticket-form');
        const lotteryTypeSelect = document.getElementById('lottery-type');
        const loadingIndicator = document.getElementById('scanner-loading');
        const resultsContainer = document.getElementById('results-container');
        const scanNewTicketBtn = document.getElementById('scan-new-ticket');
        
        // CRITICAL: Preload overlay elements to ensure they're ready for immediate display
        preloadOverlayElements();
        
        // Get references to the overlay elements
        const adOverlayLoading = document.getElementById('ad-overlay-loading');
        const adOverlayResults = document.getElementById('ad-overlay-results');
        
        // Initialize scan button state
        setTimeout(() => {
            updateScanButton();
        }, 500);
        
        // File selection via button
        fileSelectBtn.addEventListener('click', () => {
            fileInput.click();
        });
        
        // File selection change
        fileInput.addEventListener('change', handleFileSelect);
        
        // Drag and drop events
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, preventDefaults, false);
        });
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, highlight, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, unhighlight, false);
        });
        
        function highlight() {
            dropArea.classList.add('highlight');
        }
        
        function unhighlight() {
            dropArea.classList.remove('highlight');
        }
        
        dropArea.addEventListener('drop', handleDrop, false);
        
        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            
            if (files.length > 0) {
                fileInput.files = files;
                handleFileSelect();
            }
        }
        
        function handleFileSelect() {
            const file = fileInput.files[0];
            
            if (file) {
                // Check if file is an image
                if (!file.type.match('image.*')) {
                    alert('Please select an image file');
                    fileInput.value = ''; // Clear the file input
                    return;
                }
                
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    ticketPreview.src = e.target.result;
                    previewContainer.classList.remove('d-none');
                    // Update scan button state
                    updateScanButton();
                }
                
                reader.onerror = function() {
                    alert('Error reading the image file. Please try a different image.');
                    fileInput.value = ''; // Clear the file input on error
                    updateScanButton();
                }
                
                reader.readAsDataURL(file);
            } else {
                previewContainer.classList.add('d-none');
                updateScanButton();
            }
        }
        
        removeImageBtn.addEventListener('click', function() {
            ticketPreview.src = '';
            fileInput.value = '';
            previewContainer.classList.add('d-none');
            updateScanButton();
        });
        
        lotteryTypeSelect.addEventListener('change', updateScanButton);
        
        // Handle form submission with immediate overlay display
        ticketForm.addEventListener('submit', function(e) {
            if (fileInput.files.length) {
                e.preventDefault();
                
                // CRITICAL: Use our direct showOverlay function first
                if (showOverlay('ad-overlay-loading')) {
                    console.log("Form submit: Ad overlay shown directly using showOverlay function");
                } else {
                    console.error("CRITICAL ERROR: Could not find ad-overlay-loading element!");
                }
                
                // Then process the ticket
                processTicketWithAds();
            }
        });
        
        // Add a click handler for the scan button with overlay display
        scanButton.addEventListener('click', function(e) {
            if (fileInput.files.length) {
                e.preventDefault();
                
                // CRITICAL: Use our direct showOverlay function first
                if (showOverlay('ad-overlay-loading')) {
                    console.log("Scan button: Ad overlay shown directly using showOverlay function");
                } else {
                    console.error("CRITICAL ERROR: Could not find ad-overlay-loading element!");
                }
                
                // Process the ticket using our ad-safe process
                processTicketWithAds();
            }
        });
        
        // Scan new ticket button (success case)
        if (scanNewTicketBtn) {
            scanNewTicketBtn.addEventListener('click', function() {
                resetScannerForm();
            });
        }
        
        // Scan another button (error case)
        const scanAnotherBtn = document.getElementById('scan-another-btn');
        if (scanAnotherBtn) {
            scanAnotherBtn.addEventListener('click', function() {
                resetScannerForm();
            });
        }
        
        // Common function to reset the scanner form
        function resetScannerForm() {
            // Hide results and reset the form
            resultsContainer.classList.add('d-none');
            ticketForm.reset();
            previewContainer.classList.add('d-none');
            updateScanButton();
            
            // Scroll back to top of scanner
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }
        
        function updateScanButton() {
            // Enable button if image is selected
            scanButton.disabled = !fileInput.files.length;
        }
        
        // Function to handle showing ads and processing the ticket - LIGHTWEIGHT VERSION
        function processTicketWithAds() {
            console.log('Starting new ultra-reliable processTicketWithAds');
            
            // --- STEP 1: Show Overlay Immediately (highest priority) ---
            // Use the absolute minimum required code to make overlay visible
            const adOverlayLoading = document.getElementById('ad-overlay-loading');
            if (adOverlayLoading) {
                // Just set display to flex - fastest possible operation
                adOverlayLoading.style.display = 'flex';
                console.log('Overlay display:flex set (step 1 - minimal reliable approach)');
            } else {
                console.error('CRITICAL ERROR: ad-overlay-loading element not found!');
            }
            
            // --- STEP 2: Prepare Form Data (do this early) ---
            let formData;
            try {
                formData = new FormData(ticketForm);
                console.log('Form data prepared successfully');
            } catch (e) {
                console.error('Error preparing form data:', e);
                showError('Error preparing ticket data. Please try again.');
                return;
            }
            
            // --- STEP 3: Defer UI Updates ---
            // Use setTimeout to allow the browser to render the overlay first
            setTimeout(() => {
                try {
                    // Apply additional styling to ensure overlay is fully visible
                    if (adOverlayLoading) {
                        document.body.style.overflow = 'hidden'; // Prevent scrolling
                        adOverlayLoading.style.opacity = '1';
                        adOverlayLoading.style.visibility = 'visible';
                        adOverlayLoading.style.zIndex = '2147483647';
                    }
                    
                    // Also use AdManager as a backup approach
                    try {
                        window.AdManager.showLoadingAd();
                        console.log('AdManager.showLoadingAd called successfully');
                    } catch (adError) {
                        console.warn('Non-critical error with AdManager:', adError);
                    }
                    
                    // Disable scan button and show loading indicator
                    scanButton.disabled = true;
                    loadingIndicator.style.display = 'block';
                    
                    // Proceed to simulation in next animation frame
                    requestAnimationFrame(() => {
                        // Start the simulated processing
                        simulateProcessingSteps(formData);
                    });
                } catch (e) {
                    console.error('Error in deferred overlay processing:', e);
                    // If something fails here, still try to process the ticket
                    simulateProcessingSteps(formData);
                }
            }, 0);
        }
        
        // Simulate processing steps to make ad viewing time more engaging
        function simulateProcessingSteps(formData) {
            const progressBar = document.getElementById('scan-progress-bar');
            const stepText = document.getElementById('scan-step-text');
            
            // Create more steps to extend the processing time to 15 seconds
            const steps = [
                { 
                    text: "Initializing ticket scanning process...", 
                    progress: 10,
                    activeStep: 1
                },
                { 
                    text: "Uploading and analyzing your ticket image...", 
                    progress: 25,
                    activeStep: 1
                },
                { 
                    text: "Using AI to identify game type...", 
                    progress: 40,
                    activeStep: 2
                },
                { 
                    text: "Extracting draw information and date...", 
                    progress: 60,
                    activeStep: 2
                },
                { 
                    text: "Detecting your selected lottery numbers...", 
                    progress: 75,
                    activeStep: 3
                },
                { 
                    text: "Matching your numbers against winning combinations...", 
                    progress: 90,
                    activeStep: 4
                },
                { 
                    text: "Results ready! Finishing up...", 
                    progress: 100,
                    activeStep: 4
                }
            ];
            
            let currentStep = 0;
            let ticketData = null;
            let ticketProcessed = false;
            
            // Start processing the ticket in the background while showing ads
            // This way, results will be ready when the ad finishes
            fetch('/scan-ticket', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                console.log('Ticket processing completed in background. Data ready:', data);
                ticketData = data;
                ticketProcessed = true;
            })
            .catch(error => {
                console.error('Error processing ticket:', error);
                ticketProcessed = true;
                ticketData = { error: "An error occurred while scanning your ticket. Please try again." };
            });
            
            const interval = setInterval(() => {
                if (currentStep < steps.length) {
                    const step = steps[currentStep];
                    
                    // Update step text and progress bar
                    stepText.textContent = step.text;
                    progressBar.style.width = step.progress + '%';
                    
                    // Update step indicators
                    const allSteps = document.querySelectorAll('.step');
                    allSteps.forEach((stepEl, index) => {
                        // Reset all steps
                        stepEl.classList.remove('active', 'completed');
                        
                        // Mark completed steps
                        if (index + 1 < step.activeStep) {
                            stepEl.classList.add('completed');
                        }
                        // Mark active step
                        else if (index + 1 === step.activeStep) {
                            stepEl.classList.add('active');
                        }
                    });
                    
                    currentStep++;
                } else {
                    clearInterval(interval);
                    
                    // Hide loading overlay using window.AdManager for consistency
                    window.AdManager.hideLoadingAd();
                    
                    // Wait for ticket processing to complete if it hasn't already
                    const waitForTicketData = () => {
                        if (ticketProcessed) {
                            showResultsOverlay(ticketData);
                        } else {
                            setTimeout(waitForTicketData, 500);
                        }
                    };
                    
                    waitForTicketData();
                }
            }, 2000); // Change steps every 2 seconds for a total of 14 seconds (7 steps)
        }
        
        // Show the results overlay with data
        function showResultsOverlay(data) {
            console.log('Immediately showing results overlay');
            
            try {
                // First use our utility function for immediate display
                if (showOverlay('ad-overlay-results')) {
                    console.log('Results overlay immediately shown via showOverlay utility');
                } else {
                    // Fallback: directly manipulate the DOM to ensure the results overlay is shown
                    const adOverlayResults = document.getElementById('ad-overlay-results');
                    if (adOverlayResults) {
                        // Force show the results overlay element directly
                        adOverlayResults.style.display = 'flex';
                        adOverlayResults.style.opacity = '1';
                        adOverlayResults.style.visibility = 'visible';
                        adOverlayResults.style.zIndex = '99999';
                        document.body.style.overflow = 'hidden';
                        console.log('Results overlay directly shown via fallback method');
                    }
                }
                
                // Also use AdManager as backup
                window.AdManager.showInterstitialAd();
                console.log('Showing results interstitial ad via AdManager');
            } catch (e) {
                console.error('Error showing results overlay:', e);
            }
            
            // Setup view results button
            const viewResultsBtn = document.getElementById('view-results-btn');
            if (viewResultsBtn) {
                viewResultsBtn.onclick = function() {
                    console.log('View Results button clicked!');
                    window.AdManager.hideInterstitialAd();
                    displayResults(data);
                };
            }
            
            // Auto-close the overlay after 2 seconds to ensure users see results
            setTimeout(function() {
                console.log('Auto-displaying results after delay');
                window.AdManager.hideInterstitialAd();
                displayResults(data);
            }, 2000);
            
            // Hide loading indicator and re-enable scan button
            const loadingIndicator = document.getElementById('scanner-loading');
            if (loadingIndicator) {
                loadingIndicator.style.display = 'none';
            }
            scanButton.disabled = false;
            console.log("Scan completed - button enabled");
        }
        
        // Function to process the ticket after ad is shown - legacy function kept for compatibility
        function processTicket(formData) {
            console.log('Legacy processTicket called - redirecting to improved implementation');
            
            // Use our better approach instead - this is just a compatibility wrapper
            // that redirects to the more reliable implementation
            if (!formData) {
                // If no formData was provided, create it from the form
                formData = new FormData(ticketForm);
            }
            
            // Call our improved implementation
            processTicketWithAds();
            
            // This function is kept only for backwards compatibility with any existing code
            // The real implementation is now in processTicketWithAds()
        }
        
        function displayResults(data) {
            console.log('Displaying results:', data);
            
            // Force enable scrolling on document body and html
            document.body.style.overflow = 'auto';
            document.body.style.position = 'static';
            document.body.style.width = '';
            document.body.style.height = '';
            document.documentElement.style.overflow = 'auto';
            document.documentElement.style.position = 'static';
            
            // Re-enable zooming
            const viewportMeta = document.querySelector('meta[name="viewport"]');
            if (viewportMeta) {
                viewportMeta.content = 'width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes';
            }
            
            // Force update body and viewport
            setTimeout(function() {
                window.scrollTo(0, 0);
                window.scrollTo(0, 1);
            }, 100);
            
            // Show results container
            resultsContainer.classList.remove('d-none');
            
            // Hide error message by default
            document.getElementById('error-message').classList.add('d-none');
            
            if (data.error) {
                console.error('Error from backend:', data.error);
                showError(data.error);
                return;
            }
            
            // Show success content
            const successContent = document.getElementById('success-content');
            successContent.classList.remove('d-none');
            
            // Populate ticket info
            document.getElementById('result-lottery-type').textContent = data.lottery_type;
            document.getElementById('result-draw-number').textContent = data.draw_number;
            document.getElementById('result-draw-date').textContent = data.draw_date;
            
            // Populate detected information from OCR if available
            if (data.ticket_info) {
                document.getElementById('detected-game-type').textContent = data.ticket_info.detected_game_type || 'Unknown';
                document.getElementById('detected-draw-number').textContent = data.ticket_info.detected_draw_number || 'Unknown';
                document.getElementById('detected-draw-date').textContent = data.ticket_info.detected_draw_date || 'Unknown';
            } else {
                document.getElementById('detected-info').classList.add('d-none');
            }
            
            // Display ticket numbers
            const ticketNumbersContainer = document.getElementById('ticket-numbers');
            ticketNumbersContainer.innerHTML = '';
            
            // Check if we have raw_selected_numbers in the ticket_info (multiple rows)
            if (data.ticket_info && data.ticket_info.raw_selected_numbers) {
                // Create a heading for multiple rows
                const heading = document.createElement('h5');
                heading.classList.add('mb-3');
                heading.textContent = 'Your ticket contains multiple rows:';
                ticketNumbersContainer.appendChild(heading);
                
                // Iterate through each row and create a separate container
                Object.entries(data.ticket_info.raw_selected_numbers).forEach(([rowName, numbers]) => {
                    // Create row container
                    const rowContainer = document.createElement('div');
                    rowContainer.classList.add('mb-3');
                    
                    // Add row label
                    const rowLabel = document.createElement('div');
                    rowLabel.classList.add('fw-bold', 'mb-1');
                    rowLabel.textContent = rowName + ':';
                    rowContainer.appendChild(rowLabel);
                    
                    // Add numbers for this row
                    const ballsContainer = document.createElement('div');
                    ballsContainer.classList.add('d-flex', 'flex-wrap', 'gap-1', 'mb-3');
                    
                    numbers.forEach(num => {
                        const ball = document.createElement('span');
                        ball.classList.add('lottery-ball');
                        
                        // Add color classes in sequence
                        if (ballsContainer.children.length % 4 === 0) {
                            ball.classList.add('lottery-ball-red');
                        } else if (ballsContainer.children.length % 4 === 1) {
                            ball.classList.add('lottery-ball-yellow');
                        } else if (ballsContainer.children.length % 4 === 2) {
                            ball.classList.add('lottery-ball-green');
                        } else {
                            ball.classList.add('lottery-ball-blue');
                        }
                        
                        ball.textContent = num;
                        ballsContainer.appendChild(ball);
                    });
                    
                    rowContainer.appendChild(ballsContainer);
                    ticketNumbersContainer.appendChild(rowContainer);
                });
            } else {
                // Simple display of all ticket numbers in one row
                data.ticket_numbers.forEach(num => {
                    const ball = document.createElement('span');
                    ball.classList.add('lottery-ball');
                    
                    // Add color classes in sequence
                    if (ticketNumbersContainer.children.length % 4 === 0) {
                        ball.classList.add('lottery-ball-red');
                    } else if (ticketNumbersContainer.children.length % 4 === 1) {
                        ball.classList.add('lottery-ball-yellow');
                    } else if (ticketNumbersContainer.children.length % 4 === 2) {
                        ball.classList.add('lottery-ball-green');
                    } else {
                        ball.classList.add('lottery-ball-blue');
                    }
                    
                    ball.textContent = num;
                    ticketNumbersContainer.appendChild(ball);
                });
            }
            
            // Display winning numbers
            const winningNumbersContainer = document.getElementById('winning-numbers');
            winningNumbersContainer.innerHTML = '';
            
            data.winning_numbers.forEach(num => {
                const ball = document.createElement('span');
                ball.classList.add('lottery-ball');
                
                // Add color classes in sequence
                if (winningNumbersContainer.children.length % 4 === 0) {
                    ball.classList.add('lottery-ball-red');
                } else if (winningNumbersContainer.children.length % 4 === 1) {
                    ball.classList.add('lottery-ball-yellow');
                } else if (winningNumbersContainer.children.length % 4 === 2) {
                    ball.classList.add('lottery-ball-green');
                } else {
                    ball.classList.add('lottery-ball-blue');
                }
                
                ball.textContent = num;
                winningNumbersContainer.appendChild(ball);
            });
            
            // Add bonus balls if available
            if (data.bonus_numbers && data.bonus_numbers.length > 0) {
                const plusSpan = document.createElement('span');
                plusSpan.classList.add('mx-2');
                plusSpan.textContent = '+';
                winningNumbersContainer.appendChild(plusSpan);
                
                data.bonus_numbers.forEach(num => {
                    const ball = document.createElement('span');
                    ball.classList.add('lottery-ball', 'lottery-ball-blue', 'lottery-ball-bonus');
                    ball.textContent = num;
                    winningNumbersContainer.appendChild(ball);
                });
            }
            
            // Display matched numbers
            document.getElementById('matched-count').textContent = data.matched_numbers.length;
            
            const matchedNumbersContainer = document.getElementById('matched-numbers');
            matchedNumbersContainer.innerHTML = '';
            
            // Check if we have specific rows with matches
            if (data.rows_with_matches && data.rows_with_matches.length > 0) {
                // Create a heading for matched rows
                const heading = document.createElement('h5');
                heading.classList.add('mb-3');
                heading.textContent = 'Numbers matched in these rows:';
                matchedNumbersContainer.appendChild(heading);
                
                // For each row with matches, show the row name and matched numbers
                data.rows_with_matches.forEach(rowMatch => {
                    // Create row container
                    const rowContainer = document.createElement('div');
                    rowContainer.classList.add('mb-3', 'p-2', 'border', 'rounded');
                    
                    // Add special bg color based on match count
                    if (rowMatch.matched_numbers.length >= 3) {
                        rowContainer.classList.add('bg-success', 'bg-opacity-25', 'border-success');
                    } else if (rowMatch.matched_numbers.length > 0) {
                        rowContainer.classList.add('bg-warning', 'bg-opacity-25');
                    } else {
                        rowContainer.classList.add('bg-dark', 'bg-opacity-10');
                    }
                    
                    // Add row label with match count
                    const rowLabel = document.createElement('div');
                    rowLabel.classList.add('fw-bold', 'mb-1', 'd-flex', 'justify-content-between', 'align-items-center');
                    
                    // Create label and potential prize indicator 
                    const labelText = document.createElement('span');
                    labelText.textContent = `${rowMatch.row}: ${rowMatch.matched_numbers.length} match${rowMatch.matched_numbers.length !== 1 ? 'es' : ''}`;
                    rowLabel.appendChild(labelText);
                    
                    // Add visual indicator for potential prize (3+ matches)
                    if (rowMatch.matched_numbers.length >= 3) {
                        const prizeIndicator = document.createElement('span');
                        prizeIndicator.classList.add('badge', 'bg-success', 'ms-2');
                        prizeIndicator.innerHTML = '<i class="fas fa-trophy me-1"></i> Potential Prize!';
                        rowLabel.appendChild(prizeIndicator);
                    }
                    rowContainer.appendChild(rowLabel);
                    
                    // Add numbers container
                    const ballsContainer = document.createElement('div');
                    ballsContainer.classList.add('d-flex', 'flex-wrap', 'gap-1', 'align-items-center');
                    
                    // First add all the numbers in the row
                    const numbersLabel = document.createElement('span');
                    numbersLabel.classList.add('me-2');
                    numbersLabel.textContent = 'Row numbers:';
                    ballsContainer.appendChild(numbersLabel);
                    
                    rowMatch.numbers.forEach(num => {
                        const ball = document.createElement('span');
                        ball.classList.add('lottery-ball');
                        
                        // Add color classes in sequence
                        if (ballsContainer.children.length % 4 === 0) {
                            ball.classList.add('lottery-ball-red');
                        } else if (ballsContainer.children.length % 4 === 1) {
                            ball.classList.add('lottery-ball-yellow');
                        } else if (ballsContainer.children.length % 4 === 2) {
                            ball.classList.add('lottery-ball-green');
                        } else {
                            ball.classList.add('lottery-ball-blue');
                        }
                        
                        // Set the number
                        ball.textContent = num;
                        
                        // Highlight matched numbers with a special class - do this after setting text
                        if (rowMatch.matched_numbers.includes(num)) {
                            ball.classList.add('ball-matched', 'border-glow');
                            
                            // Create a separate element for the checkmark to overlay on top
                            const checkOverlay = document.createElement('div');
                            checkOverlay.classList.add('check-overlay');
                            checkOverlay.innerHTML = '<i class="fas fa-check"></i>';
                            ball.appendChild(checkOverlay);
                        }
                        ballsContainer.appendChild(ball);
                    });
                    
                    rowContainer.appendChild(ballsContainer);
                    matchedNumbersContainer.appendChild(rowContainer);
                });
            } else if (data.matched_numbers.length > 0) {
                // Fall back to simple matched numbers display
                data.matched_numbers.forEach(num => {
                    const ball = document.createElement('span');
                    ball.classList.add('lottery-ball', 'ball-matched');
                    
                    // Add color classes in sequence
                    if (matchedNumbersContainer.children.length % 4 === 0) {
                        ball.classList.add('lottery-ball-red');
                    } else if (matchedNumbersContainer.children.length % 4 === 1) {
                        ball.classList.add('lottery-ball-yellow');
                    } else if (matchedNumbersContainer.children.length % 4 === 2) {
                        ball.classList.add('lottery-ball-green');
                    } else {
                        ball.classList.add('lottery-ball-blue');
                    }
                    
                    ball.textContent = num;
                    matchedNumbersContainer.appendChild(ball);
                });
            } else {
                matchedNumbersContainer.innerHTML = '<p>No matching numbers found.</p>';
            }
            
            // Display prize information if any
            const prizeContainer = document.getElementById('prize-container');
            const noPrizeContainer = document.getElementById('no-prize-container');
            
            if (data.has_prize) {
                prizeContainer.classList.remove('d-none');
                noPrizeContainer.classList.add('d-none');
                
                document.getElementById('prize-lottery-type').textContent = data.lottery_type;
                document.getElementById('prize-draw-number').textContent = data.draw_number;
                document.getElementById('prize-division').textContent = data.prize_info.division;
                document.getElementById('prize-match-type').textContent = data.prize_info.match_type;
                document.getElementById('prize-amount').textContent = data.prize_info.prize_amount;
            } else {
                prizeContainer.classList.add('d-none');
                noPrizeContainer.classList.remove('d-none');
            }
            
            // Scroll to results
            resultsContainer.scrollIntoView({ behavior: 'smooth' });
        }
        
        function showError(message) {
            console.log('SHOWING ERROR:', message);
            
            // First, make sure results overlay is hidden
            try {
                window.AdManager.hideInterstitialAd();
                window.AdManager.hideLoadingAd();
                
                const adOverlayLoading = document.getElementById('ad-overlay-loading');
                const adOverlayResults = document.getElementById('ad-overlay-results');
                
                if (adOverlayLoading) adOverlayLoading.style.display = 'none';
                if (adOverlayResults) adOverlayResults.style.display = 'none';
            } catch (e) {
                console.warn('Non-critical error hiding overlays:', e);
            }
            
            // Get DOM elements
            const errorMessage = document.getElementById('error-message');
            const errorText = document.getElementById('error-text');
            const successContent = document.getElementById('success-content');
            const resultsContainer = document.getElementById('results-container');
            
            // Always reset body scrolling and styles
            document.body.style.overflow = 'auto';
            document.body.style.position = 'static';
            document.body.style.width = '';
            document.body.style.height = '';
            document.documentElement.style.overflow = 'auto';
            document.documentElement.style.position = 'static';
            
            // Re-enable zooming for accessibility
            const viewportMeta = document.querySelector('meta[name="viewport"]');
            if (viewportMeta) {
                viewportMeta.content = 'width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes';
            }
            
            // Scroll to top of page
            setTimeout(function() {
                window.scrollTo(0, 0);
            }, 100);
            
            // Make sure results container is visible
            if (resultsContainer) {
                resultsContainer.classList.remove('d-none');
            }
            
            // Hide success content if it exists
            if (successContent) {
                successContent.classList.add('d-none');
            }
            
            // Prepare error message - add formatting as needed
            let formattedMessage = message || "An unknown error occurred. Please try again.";
            
            // Check for future draw message
            if (message.includes("future draw")) {
                formattedMessage = `<div class="mb-3">
                    <i class="fas fa-calendar-alt me-2 text-warning"></i> 
                    <strong>Future Draw:</strong> ${message}
                </div>
                <div class="small text-muted">Please check back after the draw date to see if you've won!</div>`;
            } 
            // Check for no results found message
            else if (message.includes("No results found")) {
                formattedMessage = `<div class="mb-3">
                    <i class="fas fa-search me-2 text-danger"></i> 
                    <strong>No Results Available:</strong> ${message}
                </div>
                <div class="small text-muted">We're constantly updating our database with new lottery results. Please try again later.</div>`;
            }
            // Generic error message
            else {
                formattedMessage = `<div class="mb-3">
                    <i class="fas fa-exclamation-triangle me-2 text-warning"></i> 
                    ${message}
                </div>`;
            }
            
            // Use innerHTML to support formatted messages with HTML
            errorText.innerHTML = formattedMessage;
            errorMessage.classList.remove('d-none');
            successContent.classList.add('d-none');
            
            // Scroll to the error message
            errorMessage.scrollIntoView({ behavior: 'smooth' });
        }
    });
</script>
{% endblock %}