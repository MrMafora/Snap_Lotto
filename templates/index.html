{% extends "base.html" %}

{% block title %}Snap Lotto | South Africa's #1 PowerBall & Daily Lotto Ticket Scanner App{% endblock %}

{% block meta_description %}Snap Lotto - South Africa's ONLY PowerBall & Daily Lotto ticket scanner app. The ONLY app with official Ithuba Lotto,
PowerBall &
Daily Lotto data,
Snap Scan and Win = Phanda Phusha Play. Scan tickets instantly to check if you've won.{% endblock %}

{% block meta_keywords %}Snap Lotto, PowerBall South Africa, Daily Lotto South Africa, Ithuba official data, PowerBall scanner South Africa, Daily Lotto scanner, PowerBall winning numbers, Daily Lotto results, official Ithuba results{% endblock %}

{% block og_title %}Snap Lotto | South Africa's #1 Lottery Ticket Scanner & Results App{% endblock %}
{% block og_description %}The ONLY app with official Ithuba Lotto, PowerBall & Daily Lotto data, Snap Scan and Win = Phanda Phusha Play. Scan tickets instantly to check if you've won!{% endblock %}

{% block twitter_title %}Snap Lotto | South Africa's #1 Lottery Ticket Scanner & Results App{% endblock %}
{% block twitter_description %}The ONLY app with official Ithuba Lotto, PowerBall & Daily Lotto data, Snap Scan and Win = Phanda Phusha Play. Scan tickets instantly to check if you've won!{% endblock %}

{% block head_content %}
<!-- Structured Data for SEO -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "WebSite",
  "name": "Snap Lotto",
  "alternateName": ["SA PowerBall App", "South African Daily Lotto Scanner", "Official Ithuba Results App"],
  "url": "https://www.snaplotto.co.za/",
  "potentialAction": {
    "@type": "SearchAction",
    "target": "https://www.snaplotto.co.za/results?search={search_term}",
    "query-input": "required name=search_term"
  },
  "description": "South Africa's #1 PowerBall and Daily Lotto scanner app. The ONLY app with official Ithuba Lotto, PowerBall & Daily Lotto data, Snap Scan and Win = Phanda Phusha Play."
}
</script>

<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Organization",
  "name": "Snap Lotto",
  "legalName": "Snap Lotto South Africa",
  "url": "https://www.snaplotto.co.za/",
  "logo": "https://www.snaplotto.co.za/static/img/snap-lotto-social.jpg",
  "foundingDate": "2024",
  "founders": [
    {
      "@type": "Person",
      "name": "Snap Lotto Team"
    }
  ],
  "address": {
    "@type": "PostalAddress",
    "addressCountry": "ZA"
  },
  "contactPoint": {
    "@type": "ContactPoint",
    "contactType": "customer service",
    "email": "info@snaplotto.co.za"
  },
  "sameAs": [
    "https://www.facebook.com/snaplotto/",
    "https://twitter.com/snaplotto",
    "https://www.instagram.com/snaplotto/"
  ],
  "slogan": "The ONLY app with official Ithuba Lotto,\nPowerBall &\nDaily Lotto data,\nSnap Scan and Win = Phanda Phusha Play",
  "description": "South Africa's #1 PowerBall and Daily Lotto scanner app. The ONLY app with official Ithuba Lotto, PowerBall & Daily Lotto data, Snap Scan and Win = Phanda Phusha Play."
}
</script>

<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "ItemList",
  "itemListElement": [
    {% for result in results %}
    {
      "@type": "ListItem",
      "position": {{ loop.index }},
      "item": {
        "@type": "Game",
        "name": "{{ result.lottery_type }}",
        "description": "{{ result.lottery_type }} draw {{ result.draw_number }} on {{ result.draw_date.strftime('%Y-%m-%d') }}",
        "playMode": "SinglePlayer",
        "applicationCategory": "Game",
        "genre": "Lottery"
      }
    }{% if not loop.last %},{% endif %}
    {% endfor %}
  ]
}
</script>

<style>
    /* Styling for analytics charts */
    .bg-danger { background-color: #e03237 !important; }
    .bg-warning { background-color: #ffe11d !important; }
    .bg-success { background-color: #19a03a !important; }
    .bg-info { background-color: #67c6ed !important; }
    
    /* Bar chart styling */
    .chart-container {
        border-bottom: 1px solid #ddd;
        border-left: 1px solid #ddd;
    }
    
    .chart-y-axis {
        font-size: 10px;
        color: #666;
    }
    
    .bar-column {
        padding: 0 2px;
        cursor: pointer;
    }
    
    .bar {
        border-top-left-radius: 3px;
        border-top-right-radius: 3px;
    }
    
    /* Interactive elements */
    .interactive-bar {
        transition: all 0.2s ease;
        border-top-left-radius: 3px;
        border-top-right-radius: 3px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .interactive-bar:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    /* Pie chart interactive elements */
    .pie-segment {
        transition: opacity 0.2s ease;
        cursor: pointer;
    }
    
    .legend-item {
        transition: all 0.2s ease;
        cursor: pointer;
        padding: 2px 0;
    }
    
    .legend-item:hover {
        transform: translateX(2px);
    }
    
    /* Tooltip styling */
    .chart-tooltip {
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        animation: fadeIn 0.2s ease;
        pointer-events: none;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    /* Make charts responsive on mobile */
    @media (max-width: 768px) {
        .flex-container {
            flex-direction: column;
        }
        
        .frequency-chart-container,
        .winners-chart-container {
            width: 100%;
            margin-bottom: 20px;
        }
    }
    
    /* Card styling to ensure equal height */
    .equal-height-row {
        display: flex;
        flex-wrap: wrap;
    }
    
    .equal-height-row > div {
        display: flex;
    }
    
    .equal-height-row .card {
        width: 100%;
        display: flex;
        flex-direction: column;
    }
    
    .equal-height-row .card-body.results-body {
        padding: 0;
        display: flex;
        flex-direction: column;
    }
    
    .equal-height-row .card-body.scanner-body {
        display: flex;
        align-items: center;
    }
</style>
{% endblock %}

{% block content %}


<div class="row equal-height-row">
    <div class="col-lg-6">
        <div class="card mb-4">
            <div class="card-header lottery-header">
                <h5 class="card-title mb-0">LATEST LOTTERY RESULTS</h5>
            </div>
            <div class="card-body results-body">
                <div class="table-responsive flex-grow-1">
                    <table class="table table-lottery table-striped mb-0">
                        <thead>
                            <tr>
                                <th class="ps-2 py-2">GAME TYPE</th>
                                <th class="py-2">DRAW</th>
                                <th class="py-2">DATE</th>
                                <th class="py-2">NUMBERS</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for result in results %}
                            <tr>
                                <td class="ps-2 py-1">
                                    {% if 'Lotto Plus' in result.lottery_type %}
                                        <span class="game-type-badge game-type-lotto">{{ result.lottery_type }}</span>
                                    {% elif 'Powerball' in result.lottery_type %}
                                        <span class="game-type-badge game-type-powerball">{{ result.lottery_type }}</span>
                                    {% elif 'Daily' in result.lottery_type %}
                                        <span class="game-type-badge game-type-daily">{{ result.lottery_type }}</span>
                                    {% else %}
                                        <span class="game-type-badge game-type-lotto">{{ result.lottery_type }}</span>
                                    {% endif %}
                                </td>
                                <td class="py-1"><strong>{{ result.draw_number }}</strong></td>
                                <td class="py-1 text-nowrap">{{ result.draw_date.strftime('%Y-%m-%d') }}</td>
                                <td class="py-1">
                                    <div class="numbers-container">
                                        {% for num in result.get_numbers_list() %}
                                            {% set ball_class = 'lottery-ball lottery-ball-sm ' %}
                                            
                                            {% if loop.index0 % 4 == 0 %}
                                                {% set ball_class = ball_class + 'lottery-ball-red' %}
                                            {% elif loop.index0 % 4 == 1 %}
                                                {% set ball_class = ball_class + 'lottery-ball-yellow' %}
                                            {% elif loop.index0 % 4 == 2 %}
                                                {% set ball_class = ball_class + 'lottery-ball-green' %}
                                            {% else %}
                                                {% set ball_class = ball_class + 'lottery-ball-blue' %}
                                            {% endif %}
                                            
                                            <div class="lottery-ball-container">
                                                <span class="{{ ball_class }}">
                                                    <span class="number">{{ num }}</span>
                                                </span>
                                            </div>
                                        {% endfor %}
                                        {% if result.bonus_numbers %}
                                            <div class="mx-1 d-flex align-items-center">+</div>
                                            {% for num in result.get_bonus_numbers_list() %}
                                                <div class="lottery-ball-container">
                                                    <span class="lottery-ball lottery-ball-sm lottery-ball-yellow lottery-ball-bonus">
                                                        <span class="number">{{ num }}</span>
                                                    </span>
                                                </div>
                                            {% endfor %}
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="text-center py-2 border-top mt-auto">
                    <a href="{{ url_for('results') }}" class="btn btn-lottery-primary btn-sm">
                        <i class="fas fa-search me-1"></i> View All Results
                    </a>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="card mb-4">
            <div class="card-header lottery-header">
                <h5 class="card-title mb-0">CHECK YOUR TICKET</h5>
            </div>
            <div class="card-body scanner-body">
                <div class="text-center py-2 w-100">
                    <div class="d-flex align-items-center justify-content-center flex-column">
                        <i class="fas fa-ticket-alt fa-3x text-primary mb-3"></i>
                        <h4 class="mb-2">Scan Your Lottery Ticket</h4>
                        <p class="mb-1">Have a lottery ticket? Check if you've won instantly!</p>
                        <p class="small mb-3">Simply upload a photo of your ticket and our system will check it against the latest results.</p>
                        <div class="slogan-banner mb-3">
                            <span class="slogan-text">The ONLY app with official Ithuba Lotto,
PowerBall &
Daily Lotto data,
Snap Scan and Win = Phanda Phusha Play</span>
                        </div>
                        <a href="{{ url_for('ticket_scanner') }}" class="btn btn-lottery-primary">
                            <i class="fas fa-qrcode me-2"></i> Scan Your Ticket Now
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card mb-4 data-analytics-preview">
    <div class="card-header lottery-header d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">DATA ANALYTICS PREVIEW</h5>
        <!-- Time period and lottery type selector -->
        <div class="dropdown">
            <button class="btn btn-sm btn-outline-lottery dropdown-toggle" type="button" id="dataFilterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="fas fa-filter me-1"></i> Filter Data
            </button>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dataFilterDropdown">
                <li><h6 class="dropdown-header">Lottery Type</h6></li>
                <li><a class="dropdown-item active" href="#" data-lottery-type="all">All Types</a></li>
                <li><a class="dropdown-item" href="#" data-lottery-type="Lotto">Lotto</a></li>
                <li><a class="dropdown-item" href="#" data-lottery-type="Lotto Plus 1">Lotto Plus 1</a></li>
                <li><a class="dropdown-item" href="#" data-lottery-type="Lotto Plus 2">Lotto Plus 2</a></li>
                <li><a class="dropdown-item" href="#" data-lottery-type="Powerball">Powerball</a></li>
                <li><a class="dropdown-item" href="#" data-lottery-type="Powerball Plus">Powerball Plus</a></li>
                <li><a class="dropdown-item" href="#" data-lottery-type="Daily Lotto">Daily Lotto</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><h6 class="dropdown-header">Time Period</h6></li>
                <li><a class="dropdown-item active" href="#" data-time-period="all">All Time</a></li>
                <li><a class="dropdown-item" href="#" data-time-period="30">Last 30 Days</a></li>
                <li><a class="dropdown-item" href="#" data-time-period="90">Last 90 Days</a></li>
                <li><a class="dropdown-item" href="#" data-time-period="365">Last Year</a></li>
            </ul>
        </div>
    </div>
    <div class="card-body">
        <!-- Currently selected filters -->
        <div class="selected-filters mb-3">
            <span class="badge bg-lottery me-2 current-lottery-type">All Lottery Types</span>
            <span class="badge bg-lottery me-2 current-time-period">All Time</span>
            <button class="btn btn-sm btn-link text-decoration-none reset-filters" type="button">
                <i class="fas fa-undo-alt me-1"></i>Reset
            </button>
        </div>
        
        <div class="row">
            <!-- Flex container that adjusts to mobile -->
            <div class="flex-container">
                <!-- Left chart: Most Frequent Numbers -->
                <div class="frequency-chart-container">
                    <h6 class="mb-2 d-flex justify-content-between">
                        <span>Most Frequent Numbers</span>
                        <span class="chart-loading d-none"><i class="fas fa-spinner fa-spin"></i></span>
                    </h6>
                    <!-- SVG bar chart with perfect alignment between bars and numbers -->
                    <div class="bar-chart-container" style="position: relative; width: 100%; height: 170px;">
                        <!-- Y-axis labels with dynamic values based on data range -->
                        <div class="y-axis-labels" style="position: absolute; left: 0; top: 5px; bottom: 40px; width: 30px;">
                            {% if frequent_numbers %}
                                {% set max_frequency = frequent_numbers[0][1] if frequent_numbers|length > 0 else 1 %}
                                {% set step = (max_frequency / 5)|round(0, 'ceil')|int %}
                                {% if step < 1 %}{% set step = 1 %}{% endif %}
                                
                                <div style="position: absolute; top: 0%; right: 5px; font-size: 11px; color: #666;">{{ max_frequency }}</div>
                                <div style="position: absolute; top: 20%; right: 5px; font-size: 11px; color: #666;">{{ (max_frequency - step)|int }}</div>
                                <div style="position: absolute; top: 40%; right: 5px; font-size: 11px; color: #666;">{{ (max_frequency - (step*2))|int }}</div>
                                <div style="position: absolute; top: 60%; right: 5px; font-size: 11px; color: #666;">{{ (max_frequency - (step*3))|int }}</div>
                                <div style="position: absolute; top: 80%; right: 5px; font-size: 11px; color: #666;">{{ (max_frequency - (step*4))|int }}</div>
                                <div style="position: absolute; bottom: 0; right: 5px; font-size: 11px; color: #666;">0</div>
                            {% else %}
                                <div style="position: absolute; top: 0%; right: 5px; font-size: 11px; color: #666;">16</div>
                                <div style="position: absolute; top: 20%; right: 5px; font-size: 11px; color: #666;">12</div>
                                <div style="position: absolute; top: 40%; right: 5px; font-size: 11px; color: #666;">9</div>
                                <div style="position: absolute; top: 60%; right: 5px; font-size: 11px; color: #666;">6</div>
                                <div style="position: absolute; top: 80%; right: 5px; font-size: 11px; color: #666;">3</div>
                                <div style="position: absolute; bottom: 0; right: 5px; font-size: 11px; color: #666;">0</div>
                            {% endif %}
                        </div>
                        
                        <!-- Chart area with grid lines -->
                        <div class="chart-grid" style="position: absolute; left: 30px; right: 0; top: 5px; bottom: 40px; border-bottom: 1px solid #ddd; border-left: 1px solid #ddd;">
                            <!-- Horizontal grid lines -->
                            <div style="position: absolute; left: 0; right: 0; top: 20%; height: 1px; background-color: rgba(0,0,0,0.05);"></div>
                            <div style="position: absolute; left: 0; right: 0; top: 40%; height: 1px; background-color: rgba(0,0,0,0.05);"></div>
                            <div style="position: absolute; left: 0; right: 0; top: 60%; height: 1px; background-color: rgba(0,0,0,0.05);"></div>
                            <div style="position: absolute; left: 0; right: 0; top: 80%; height: 1px; background-color: rgba(0,0,0,0.05);"></div>
                            
                            <!-- Bar chart with exact positioning using dynamic data -->
                            <div class="frequency-bars" style="display: flex; justify-content: space-around; height: 100%; width: 100%;">
                                {% if frequent_numbers %}
                                    {% set max_height = 90 %}
                                    {% set max_frequency = frequent_numbers[0][1] if frequent_numbers|length > 0 else 1 %}
                                    {% for number, frequency in frequent_numbers %}
                                        <!-- Calculate height based on frequency relative to max -->
                                        {% set bar_height = (frequency / max_frequency * max_height)|int %}
                                        {% if bar_height < 5 %}{% set bar_height = 5 %}{% endif %}
                                        
                                        <!-- Assign color based on position -->
                                        {% set colors = ['#e03237', '#ffe11d', '#19a03a', '#67c6ed'] %}
                                        {% set color_index = loop.index0 % 4 %}
                                        
                                        <div style="display: flex; flex-direction: column-reverse; align-items: center; width: 9%; height: 100%;" 
                                            class="bar-column" 
                                            data-bs-toggle="tooltip"
                                            data-bs-placement="top"
                                            data-bs-title="Number {{ number }} appeared {{ frequency }} times">
                                            <!-- Frequency at top of bar -->
                                            <div style="position: relative; width: 80%; height: {{ bar_height }}%;" class="interactive-bar-container">
                                                <div class="interactive-bar" style="position: absolute; bottom: 0; left: 0; right: 0; height: 100%; background-color: {{ colors[color_index] }}; border-top-left-radius: 3px; border-top-right-radius: 3px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                                </div>
                                                <span style="position: absolute; top: -15px; left: 50%; transform: translateX(-50%); font-size: 9px; color: #666; white-space: nowrap;">{{ frequency }}</span>
                                            </div>
                                        </div>
                                    {% endfor %}
                                {% else %}
                                    <!-- Fallback if no data available -->
                                    <div class="text-center w-100 d-flex align-items-center justify-content-center">
                                        <p class="text-muted mb-0">No frequency data available</p>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- X-axis labels in separate section below the chart -->
                        <div style="position: absolute; left: 30px; right: 0; bottom: 0; height: 30px; display: flex; justify-content: space-around; padding: 5px 0;">
                            {% if frequent_numbers %}
                                {% for number, frequency in frequent_numbers %}
                                    <div style="font-size: 11px; text-align: center; width: 9%; font-weight: bold; color: #333;">{{ number }}</div>
                                {% endfor %}
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Right chart: Winners By Division -->
                <div class="winners-chart-container">
                    <h6 class="mb-2 d-flex justify-content-between">
                        <span>Winners By Division</span>
                        <span class="chart-loading d-none"><i class="fas fa-spinner fa-spin"></i></span>
                    </h6>
                    <!-- Chart container with pie chart and legend side by side -->
                    <div class="chart-legend-container">
                        <!-- Pie chart with responsive width using dynamic data -->
                        <div class="pie-chart-container">
                            {% if division_stats %}
                                <!-- Calculate total for percentage -->
                                {% set total_winners = 0 %}
                                {% for div_num, winners in division_stats.items() %}
                                    {% set total_winners = total_winners + winners %}
                                {% endfor %}
                                
                                <!-- Interactive pie chart with enhanced division data -->
                                <svg width="100%" height="100%" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid meet" class="interactive-pie">
                                    <!-- Base circle with subtle shadow -->
                                    <filter id="dropShadow">
                                        <feDropShadow dx="0" dy="1" stdDeviation="1" flood-color="#000" flood-opacity="0.2"/>
                                    </filter>
                                    <circle cx="50" cy="50" r="40" fill="#f8f9fa" filter="url(#dropShadow)" />
                                    
                                    <!-- Division segments with data attributes and enhanced styling -->
                                    {% set colors_map = {'1': '#e03237', '2': '#ffe11d', '3': '#19a03a', '4': '#67c6ed', '5': '#6c757d'} %}
                                    
                                    <!-- Each segment has an exact position in the pie chart, creating 5 equal divisions -->
                                    {% set positions = [
                                        {'div': '1', 'path': 'M50,50 L90,50 A40,40 0 0,1 72,85 Z'}, 
                                        {'div': '2', 'path': 'M50,50 L72,85 A40,40 0 0,1 28,85 Z'}, 
                                        {'div': '3', 'path': 'M50,50 L28,85 A40,40 0 0,1 10,50 Z'}, 
                                        {'div': '4', 'path': 'M50,50 L10,50 A40,40 0 0,1 50,10 Z'},
                                        {'div': '5', 'path': 'M50,50 L50,10 A40,40 0 0,1 90,50 Z'}
                                    ] %}
                                    
                                    {% for pos in positions %}
                                        {% set div_num = pos.div %}
                                        {% set winners = division_stats.get(div_num|int, 0) %}
                                        {% set percentage = (winners / total_winners * 100)|round(1) if total_winners > 0 else 0 %}
                                        {% set color = colors_map.get(div_num, '#6c757d') %}
                                        
                                        <path 
                                            d="{{ pos.path }}" 
                                            fill="{{ color }}" 
                                            class="pie-segment" 
                                            data-division="{{ div_num }}" 
                                            data-winners="{{ winners }}"
                                            data-percentage="{{ percentage }}"
                                            data-bs-toggle="tooltip"
                                            data-bs-title="Division {{ div_num }}: {{ winners|int }} winners ({{ percentage }}%)"
                                        ></path>
                                        
                                        <!-- Add percentage label within segment if it's a significant portion -->
                                        {% if percentage >= 15 %}
                                            <!-- Calculate position for text based on segment position -->
                                            {% set text_positions = {
                                                '1': {'x': 70, 'y': 65},
                                                '2': {'x': 50, 'y': 75},
                                                '3': {'x': 30, 'y': 65},
                                                '4': {'x': 35, 'y': 35},
                                                '5': {'x': 65, 'y': 35}
                                            } %}
                                            
                                            <text x="{{ text_positions[div_num]['x'] }}" 
                                                 y="{{ text_positions[div_num]['y'] }}" 
                                                 text-anchor="middle" 
                                                 dominant-baseline="middle" 
                                                 fill="white" 
                                                 font-size="8"
                                                 font-weight="bold"
                                                 class="segment-text">
                                                {{ percentage }}%
                                            </text>
                                        {% endif %}
                                    {% endfor %}
                                    
                                    <!-- Center circle with total count -->
                                    <circle cx="50" cy="50" r="20" fill="white" stroke="#ddd" stroke-width="1" />
                                    <text x="50" y="45" text-anchor="middle" dominant-baseline="middle" fill="#333" font-size="7" font-weight="bold">
                                        Total Winners
                                    </text>
                                    <text x="50" y="55" text-anchor="middle" dominant-baseline="middle" fill="#333" font-size="9" font-weight="bold">
                                        {{ total_winners|int }}
                                    </text>
                                </svg>
                            {% else %}
                                <svg width="100%" height="100%" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid meet">
                                    <circle cx="50" cy="50" r="40" fill="#f8f9fa" />
                                    <text x="50" y="50" text-anchor="middle" dominant-baseline="middle" fill="#6c757d" font-size="6">No data</text>
                                </svg>
                            {% endif %}
                        </div>
                        
                        <!-- Enhanced legend with vertical layout and better visual indicators -->
                        <div class="legend-container">
                            {% if division_stats %}
                                {% set total_winners = 0 %}
                                {% for div_num, winners in division_stats.items() %}
                                    {% set total_winners = total_winners + winners %}
                                {% endfor %}
                                
                                {% set colors = {'1': 'legend-color-red', '2': 'legend-color-yellow', '3': 'legend-color-green', '4': 'legend-color-blue', '5': 'legend-color-default'} %}
                                
                                {% for div_num, winners in division_stats.items()|sort %}
                                    {% set class_name = colors.get(div_num|string, 'legend-color-default') %}
                                    {% set percentage = (winners / total_winners * 100)|round(1) if total_winners > 0 else 0 %}
                                    
                                    <div class="legend-item d-flex align-items-center" 
                                         data-division="{{ div_num }}" 
                                         data-winners="{{ winners }}"
                                         data-percentage="{{ percentage }}"
                                         data-bs-toggle="tooltip" 
                                         data-bs-placement="right"
                                         data-bs-title="Division {{ div_num }}: {{ winners|int }} winners ({{ percentage }}% of total)">
                                        
                                        <span class="legend-color {{ class_name }} me-2"></span>
                                        <div class="d-flex flex-column">
                                            <strong class="mb-0">Division {{ div_num }}</strong> 
                                            <small class="text-muted">{{ winners|int }} winners ({{ percentage }}%)</small>
                                        </div>
                                    </div>
                                {% endfor %}
                            {% else %}
                                <!-- Fallback if no division data -->
                                <div class="legend-item">No division data available</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="text-center mt-3">
            <a href="{{ url_for('visualizations') }}" class="btn btn-lottery-primary">
                <i class="fas fa-chart-bar me-1"></i> View Full Analytics Dashboard
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Add interactive chart functionality -->
<script>
// Function to highlight a pie segment by division number
function highlightPieSegment(division) {
    const pieSegments = document.querySelectorAll('.pie-segment');
    
    // Dim all segments first
    pieSegments.forEach(segment => {
        segment.style.opacity = '0.5';
    });
    
    // Highlight the matching segment
    pieSegments.forEach(segment => {
        if (segment.getAttribute('data-division') === division) {
            segment.style.opacity = '1';
            segment.style.transform = 'scale(1.03)';
            segment.style.transformOrigin = 'center';
            segment.style.transition = 'all 0.2s ease';
            
            // Create tooltip with data
            const winners = segment.getAttribute('data-winners');
            const percentage = segment.getAttribute('data-percentage');
            
            const tooltip = document.createElement('div');
            tooltip.className = 'chart-tooltip pie-tooltip';
            tooltip.innerHTML = `Division ${division}<br>${winners} winners<br>${percentage}% of total`;
            tooltip.style.position = 'absolute';
            tooltip.style.backgroundColor = 'rgba(0,0,0,0.8)';
            tooltip.style.color = 'white';
            tooltip.style.padding = '5px 10px';
            tooltip.style.borderRadius = '4px';
            tooltip.style.fontSize = '12px';
            tooltip.style.zIndex = '1000';
            
            // Position tooltip near the center of the pie chart
            const pieChart = document.querySelector('.interactive-pie');
            const rect = pieChart.getBoundingClientRect();
            tooltip.style.left = (rect.left + rect.width/2 - 60) + 'px';
            tooltip.style.top = (rect.top + rect.height/2 - 40) + 'px';
            
            document.body.appendChild(tooltip);
        }
    });
}

// Function to reset all pie segments to normal
function resetPieSegments() {
    const pieSegments = document.querySelectorAll('.pie-segment');
    pieSegments.forEach(segment => {
        segment.style.opacity = '1';
        segment.style.transform = 'scale(1)';
    });
    
    // Remove any tooltips
    const tooltips = document.querySelectorAll('.pie-tooltip');
    tooltips.forEach(tooltip => tooltip.remove());
}

// Function to fetch chart data via AJAX
function fetchChartData(lotteryType, timePeriod) {
    // Build the API URL with query parameters
    const apiUrl = `/api/lottery-analysis/frequency?lottery_type=${lotteryType === 'all' ? '' : lotteryType}&days=${timePeriod}`;
    
    // Fetch data from the API
    fetch(apiUrl)
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            // Update the charts with the new data
            updateCharts(data);
            
            // Hide loading indicators
            document.querySelectorAll('.chart-loading').forEach(indicator => {
                indicator.classList.add('d-none');
            });
        })
        .catch(error => {
            console.error('Error fetching chart data:', error);
            
            // Hide loading indicators even on error
            document.querySelectorAll('.chart-loading').forEach(indicator => {
                indicator.classList.add('d-none');
            });
            
            // Show an error message
            alert('Error loading chart data. Please try again later.');
        });
}

// Function to update charts with new data
function updateCharts(data) {
    // Check if we have valid data
    if (!data || typeof data !== 'object') {
        console.error('Invalid chart data received');
        return;
    }
    
    // Update frequency chart
    updateFrequencyChart(data);
    
    // Update division statistics chart
    updateDivisionChart(data);
}

// Function to update the frequency chart
function updateFrequencyChart(data) {
    // Get the bar chart container
    const barChartContainer = document.querySelector('.bar-chart-container');
    if (!barChartContainer) return;
    
    // We need to get the lottery type with the most data
    let selectedLotteryType = null;
    let maxFrequencyData = [];
    
    // Find the lottery type with the most data
    for (const lotteryType in data) {
        if (data[lotteryType] && data[lotteryType].frequency && data[lotteryType].frequency.length > maxFrequencyData.length) {
            maxFrequencyData = data[lotteryType].frequency;
            selectedLotteryType = lotteryType;
        }
    }
    
    // If we have no data, show a message and return
    if (!selectedLotteryType) {
        barChartContainer.innerHTML = '<div class="text-center my-5">No frequency data available for the selected filters.</div>';
        return;
    }
    
    // Get the top numbers for this lottery type
    const topNumbers = data[selectedLotteryType].top_numbers;
    
    // If no top numbers, show a message and return
    if (!topNumbers || !topNumbers.length) {
        barChartContainer.innerHTML = '<div class="text-center my-5">No frequency data available for the selected filters.</div>';
        return;
    }
    
    // Create the SVG content for the bar chart
    let svgContent = '';
    
    // Calculate the maximum frequency from the top numbers data
    let maxFrequency = 0;
    topNumbers.forEach(item => {
        if (item && item.length >= 2) {
            maxFrequency = Math.max(maxFrequency, item[1]);
        }
    });
    
    // Use exact maximum frequency for the y-axis (no padding)
    const yAxisMax = maxFrequency; 
    const yAxisStep = Math.ceil(yAxisMax / 4); // 4 steps on y-axis
    
    // Add y-axis labels with actual frequency values
    svgContent += `
        <div class="y-axis-labels" style="position: absolute; left: 0; top: 5px; bottom: 40px; width: 30px;">
            <div class="chart-y-axis" style="position: absolute; top: 0;">${yAxisMax}</div>
            <div class="chart-y-axis" style="position: absolute; top: 25%;">${Math.max(0, Math.round(yAxisMax - yAxisStep))}</div>
            <div class="chart-y-axis" style="position: absolute; top: 50%;">${Math.max(0, Math.round(yAxisMax - 2*yAxisStep))}</div>
            <div class="chart-y-axis" style="position: absolute; top: 75%;">${Math.max(0, Math.round(yAxisMax - 3*yAxisStep))}</div>
            <div class="chart-y-axis" style="position: absolute; bottom: 0;">0</div>
        </div>`;
    
    // Add the main chart area with grid lines
    svgContent += `
        <div class="chart-container d-flex align-items-end" style="position: absolute; left: 30px; top: 5px; right: 5px; bottom: 40px;">
            <!-- Horizontal grid lines -->
            <div style="position: absolute; top: 0; left: 0; right: 0; height: 1px; background-color: #eee;"></div>
            <div style="position: absolute; top: 25%; left: 0; right: 0; height: 1px; background-color: #eee;"></div>
            <div style="position: absolute; top: 50%; left: 0; right: 0; height: 1px; background-color: #eee;"></div>
            <div style="position: absolute; top: 75%; left: 0; right: 0; height: 1px; background-color: #eee;"></div>
            <div style="position: absolute; bottom: 0; left: 0; right: 0; height: 1px; background-color: #ddd;"></div>
            
            <!-- Bar columns -->
            <div class="d-flex justify-content-between align-items-end w-100 h-100">`;
    
    // Use the top numbers data to display the bars in order of frequency (highest first)
    for (let i = 0; i < Math.min(10, topNumbers.length); i++) {
        if (!topNumbers[i] || topNumbers[i].length < 2) continue;
        
        const number = topNumbers[i][0]; // The lottery number
        const frequency = topNumbers[i][1]; // How many times it appeared
        
        // Calculate exact percentage (if max is 7, and this is 7, it's 100%)
        // If max is 7 and this is 3, it's (3/7)*100 = 42.85%
        const percentage = ((frequency / yAxisMax) * 100); 
        const height = `${percentage}%`;
        
        // Determine color class based on ranking (1st, 2nd, 3rd, etc.)
        let colorClass = '';
        if (i === 0) colorClass = 'bg-danger'; // First place (highest frequency)
        else if (i === 1) colorClass = 'bg-warning'; // Second place
        else if (i === 2) colorClass = 'bg-success'; // Third place
        else colorClass = 'bg-info'; // Others
        
        // Add the bar
        svgContent += `
            <div class="bar-column text-center" style="flex: 1">
                <div class="interactive-bar ${colorClass} bar d-flex align-items-center justify-content-center" 
                    style="height: ${height}; min-height: 20px;" 
                    data-number="${number}" 
                    data-frequency="${frequency}">
                    <span style="color: white; font-size: 10px; font-weight: bold;">${frequency}</span>
                </div>
                <div class="mt-1 small fw-bold">${number}</div>
            </div>`;
    }
    
    // Close the bars container and chart container
    svgContent += `
            </div>
        </div>`;
    
    // Add title with the lottery type
    svgContent += `
        <div class="text-center" style="position: absolute; bottom: 0; left: 0; right: 0; height: 20px;">
            <small class="text-muted">${selectedLotteryType} Frequency</small>
        </div>`;
    
    // Add top winners display
    svgContent += `
        <div style="position: absolute; top: 10px; right: 10px; background-color: rgba(255,255,255,0.8); padding: 5px; border-radius: 4px; font-size: 11px;">
            <div><strong>Top Numbers:</strong></div>`;
    
    // Add each top number
    topNumbers.slice(0, 5).forEach(([number, freq]) => {
        svgContent += `<div># ${number}: ${freq} times</div>`;
    });
    
    svgContent += `</div>`;
    
    // Update the container with the new chart
    barChartContainer.innerHTML = svgContent;
    
    // Add event listeners to the new bars
    const bars = barChartContainer.querySelectorAll('.interactive-bar');
    bars.forEach(bar => {
        bar.addEventListener('mouseover', function() {
            // Scale up the bar slightly on hover
            this.style.transform = 'scaleY(1.05)';
            this.style.transition = 'transform 0.2s';
            
            // Create a tooltip
            const number = this.getAttribute('data-number');
            const frequency = this.getAttribute('data-frequency');
            
            // Display info in a floating tooltip
            const tooltip = document.createElement('div');
            tooltip.className = 'chart-tooltip';
            tooltip.innerHTML = `Number ${number}<br>Appeared ${frequency} times`;
            tooltip.style.position = 'absolute';
            tooltip.style.backgroundColor = 'rgba(0,0,0,0.8)';
            tooltip.style.color = 'white';
            tooltip.style.padding = '5px 10px';
            tooltip.style.borderRadius = '4px';
            tooltip.style.fontSize = '12px';
            tooltip.style.zIndex = '1000';
            
            // Position tooltip above the bar
            const rect = this.getBoundingClientRect();
            tooltip.style.left = rect.left + 'px';
            tooltip.style.top = (rect.top - 40) + 'px';
            
            document.body.appendChild(tooltip);
            this.setAttribute('data-tooltip-id', Date.now());
        });
        
        bar.addEventListener('mouseout', function() {
            // Return to normal size
            this.style.transform = 'scaleY(1)';
            
            // Remove any tooltips
            const tooltipId = this.getAttribute('data-tooltip-id');
            if (tooltipId) {
                const tooltips = document.querySelectorAll('.chart-tooltip');
                tooltips.forEach(tooltip => tooltip.remove());
            }
        });
    });
}

// Function to update the division statistics chart (pie chart)
function updateDivisionChart(data) {
    // Implementation for division chart update
    // This would be similar to the frequency chart update but for division data
    // We'll leave this as a placeholder for now
}

document.addEventListener('DOMContentLoaded', function() {
    // Initialize Bootstrap tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
    })
    
    // Load initial chart data
    fetchChartData('all', 'all');
    
    // Filter functionality
    const lotteryTypeFilters = document.querySelectorAll('a[data-lottery-type]');
    const timePeriodFilters = document.querySelectorAll('a[data-time-period]');
    const resetFiltersBtn = document.querySelector('.reset-filters');
    const currentLotteryType = document.querySelector('.current-lottery-type');
    const currentTimePeriod = document.querySelector('.current-time-period');
    const loadingIndicators = document.querySelectorAll('.chart-loading');
    
    // Filter selection handlers
    lotteryTypeFilters.forEach(filter => {
        filter.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Update active state
            lotteryTypeFilters.forEach(f => f.classList.remove('active'));
            this.classList.add('active');
            
            // Update displayed filter
            const lotteryType = this.dataset.lotteryType;
            currentLotteryType.textContent = lotteryType === 'all' ? 'All Lottery Types' : lotteryType;
            
            // Show loading state
            loadingIndicators.forEach(indicator => indicator.classList.remove('d-none'));
            
            // Get currently selected time period
            const timePeriod = document.querySelector('.current-time-period').textContent.trim();
            let daysParam = 'all';
            if (timePeriod === 'Last 30 Days') daysParam = '30';
            else if (timePeriod === 'Last 90 Days') daysParam = '90';
            else if (timePeriod === 'Last Year') daysParam = '365';
            
            // Fetch updated data via AJAX
            fetchChartData(lotteryType, daysParam);
        });
    });
    
    timePeriodFilters.forEach(filter => {
        filter.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Update active state
            timePeriodFilters.forEach(f => f.classList.remove('active'));
            this.classList.add('active');
            
            // Update displayed filter
            const timePeriod = this.dataset.timePeriod;
            currentTimePeriod.textContent = timePeriod === 'all' ? 'All Time' : 
                                          timePeriod === '30' ? 'Last 30 Days' : 
                                          timePeriod === '90' ? 'Last 90 Days' : 'Last Year';
            
            // Show loading state
            loadingIndicators.forEach(indicator => indicator.classList.remove('d-none'));
            
            // Get currently selected lottery type
            const lotteryType = document.querySelector('.current-lottery-type').textContent.trim() === 'All Lottery Types' ? 
                'all' : document.querySelector('.current-lottery-type').textContent.trim();
            
            // Fetch updated data via AJAX
            fetchChartData(lotteryType, timePeriod);
        });
    });
    
    // Reset filters
    resetFiltersBtn.addEventListener('click', function() {
        // Reset active states
        lotteryTypeFilters.forEach(f => {
            f.classList.remove('active');
            if (f.dataset.lotteryType === 'all') f.classList.add('active');
        });
        
        timePeriodFilters.forEach(f => {
            f.classList.remove('active');
            if (f.dataset.timePeriod === 'all') f.classList.add('active');
        });
        
        // Reset displayed filters
        currentLotteryType.textContent = 'All Lottery Types';
        currentTimePeriod.textContent = 'All Time';
        
        // Show loading state
        loadingIndicators.forEach(indicator => indicator.classList.remove('d-none'));
        
        // Fetch data for all lottery types and all time periods
        fetchChartData('all', 'all');
    });
    
    // Add hover effects for bar chart
    const bars = document.querySelectorAll('.interactive-bar');
    bars.forEach(bar => {
        bar.addEventListener('mouseover', function() {
            // Scale up the bar slightly on hover
            this.style.transform = 'scaleY(1.05)';
            this.style.transition = 'transform 0.2s';
            
            // Create a tooltip
            const number = this.getAttribute('data-number');
            const frequency = this.getAttribute('data-frequency');
            
            // Display info in a floating tooltip
            const tooltip = document.createElement('div');
            tooltip.className = 'chart-tooltip';
            tooltip.innerHTML = `Number ${number}<br>Appeared ${frequency} times`;
            tooltip.style.position = 'absolute';
            tooltip.style.backgroundColor = 'rgba(0,0,0,0.8)';
            tooltip.style.color = 'white';
            tooltip.style.padding = '5px 10px';
            tooltip.style.borderRadius = '4px';
            tooltip.style.fontSize = '12px';
            tooltip.style.zIndex = '1000';
            
            // Position tooltip above the bar
            const rect = this.getBoundingClientRect();
            tooltip.style.left = rect.left + 'px';
            tooltip.style.top = (rect.top - 40) + 'px';
            
            document.body.appendChild(tooltip);
            this.setAttribute('data-tooltip-id', Date.now());
        });
        
        bar.addEventListener('mouseout', function() {
            // Return to normal size
            this.style.transform = 'scaleY(1)';
            
            // Remove any tooltips
            const tooltipId = this.getAttribute('data-tooltip-id');
            if (tooltipId) {
                const tooltips = document.querySelectorAll('.chart-tooltip');
                tooltips.forEach(tooltip => tooltip.remove());
            }
        });
    });
    
    // Make pie chart segments highlight on hover
    const pieSegments = document.querySelectorAll('.pie-segment');
    pieSegments.forEach(segment => {
        segment.addEventListener('mouseover', function() {
            // Highlight the segment by calling our function
            const division = this.getAttribute('data-division');
            highlightPieSegment(division);
            
            // Also highlight the legend item
            const legendItems = document.querySelectorAll('.legend-item');
            legendItems.forEach(item => {
                if (item.getAttribute('data-division') === division) {
                    item.style.fontWeight = 'bold';
                    item.style.backgroundColor = 'rgba(0,0,0,0.05)';
                }
            });
        });
        
        segment.addEventListener('mouseout', function() {
            // Reset segments and remove highlights
            resetPieSegments();
            
            // Reset legend items
            const legendItems = document.querySelectorAll('.legend-item');
            legendItems.forEach(item => {
                item.style.fontWeight = 'normal';
                item.style.backgroundColor = 'transparent';
            });
        });
    });
});
</script>
{% endblock %}
