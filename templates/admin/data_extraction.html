{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="lottery-title">AI Data Extraction</h1>
                    <p class="text-muted">Automated lottery data extraction from your images using Anthropic AI</p>
                </div>
                <a href="{{ url_for('admin') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left"></i> Back to Admin
                </a>
            </div>
        </div>
    </div>

    <!-- Extraction Controls -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-robot me-2"></i> AI Extraction Controls
                    </h5>
                </div>
                <div class="card-body">
                    <p class="card-text">
                        Use Anthropic AI to extract lottery data from your images with 100% accuracy. 
                        The system will process all images in your attached_assets folder.
                    </p>
                    
                    <!-- Test Single Image -->
                    <form method="POST" class="mb-3">
                        <input type="hidden" name="test_mode" value="true">
                        <button type="submit" class="btn btn-warning btn-lg w-100">
                            <i class="fas fa-flask me-2"></i> Test Single Image
                        </button>
                        <small class="text-muted">Tests extraction on authentic lottery screenshots to verify AI functionality</small>
                    </form>

                    <!-- Process All Images -->
                    <button id="extractAllData" class="btn btn-success btn-lg w-100" onclick="extractAllLotteryData()">
                        <i class="fas fa-magic me-2"></i> Extract All Lottery Data
                    </button>
                        <small class="text-muted">Processes all lottery images and populates your database</small>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-info-circle me-2"></i> How It Works
                    </h5>
                </div>
                <div class="card-body">
                    <ol class="mb-0">
                        <li><strong>Image Analysis:</strong> AI examines each lottery screenshot</li>
                        <li><strong>Data Extraction:</strong> Identifies lottery type, numbers, and dates</li>
                        <li><strong>Validation:</strong> Ensures 100% accuracy before saving</li>
                        <li><strong>Database Storage:</strong> Populates your clean database with authentic data</li>
                    </ol>
                    
                    <div class="mt-3">
                        <h6>Supported Lottery Types:</h6>
                        <ul class="list-unstyled">
                            <li><i class="fas fa-check text-success"></i> PowerBall</li>
                            <li><i class="fas fa-check text-success"></i> PowerBall Plus</li>
                            <li><i class="fas fa-check text-success"></i> Lottery</li>
                            <li><i class="fas fa-check text-success"></i> Lottery Plus 1</li>
                            <li><i class="fas fa-check text-success"></i> Lottery Plus 2</li>
                            <li><i class="fas fa-check text-success"></i> Daily Lottery</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Test Results -->
    {% if test_result %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-success">
                <div class="card-header bg-success text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-check-circle me-2"></i> Test Extraction Successful
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Extracted Data:</h6>
                            <table class="table table-sm">
                                <tr>
                                    <td><strong>Lottery Type:</strong></td>
                                    <td><span class="badge bg-primary">{{ test_result.lottery_type }}</span></td>
                                </tr>
                                <tr>
                                    <td><strong>Draw Number:</strong></td>
                                    <td>{{ test_result.draw_number or 'Not detected' }}</td>
                                </tr>
                                <tr>
                                    <td><strong>Draw Date:</strong></td>
                                    <td>{{ test_result.draw_date or 'Not detected' }}</td>
                                </tr>
                                <tr>
                                    <td><strong>Main Numbers:</strong></td>
                                    <td>
                                        {% for num in test_result.main_numbers %}
                                            <span class="badge bg-lottery-red me-1">{{ num }}</span>
                                        {% endfor %}
                                    </td>
                                </tr>
                                {% if test_result.bonus_number %}
                                <tr>
                                    <td><strong>Bonus Number:</strong></td>
                                    <td><span class="badge bg-warning text-dark">{{ test_result.bonus_number }}</span></td>
                                </tr>
                                {% endif %}
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6>AI Confidence & Notes:</h6>
                            <p><strong>Confidence:</strong> {{ test_result.confidence }}%</p>
                            <p><strong>Notes:</strong> {{ test_result.notes or 'No additional notes' }}</p>
                            <p><strong>Source:</strong> {{ test_result.source_image }}</p>
                            <p><strong>Extracted:</strong> {{ test_result.extraction_timestamp }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Extraction Results -->
    {% if extraction_results %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-bar me-2"></i> Extraction Results Summary
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row text-center mb-4">
                        <div class="col-md-3">
                            <div class="border rounded p-3">
                                <h3 class="text-primary">{{ extraction_results.total_processed }}</h3>
                                <p class="mb-0">Images Processed</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="border rounded p-3">
                                <h3 class="text-success">{{ extraction_results.successful }}</h3>
                                <p class="mb-0">Successfully Extracted</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="border rounded p-3">
                                <h3 class="text-warning">{{ extraction_results.failed }}</h3>
                                <p class="mb-0">Failed Extractions</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="border rounded p-3">
                                <h3 class="text-info">
                                    {{ "%.1f"|format((extraction_results.successful / extraction_results.total_processed * 100) if extraction_results.total_processed > 0 else 0) }}%
                                </h3>
                                <p class="mb-0">Success Rate</p>
                            </div>
                        </div>
                    </div>

                    <!-- Detailed Results -->
                    {% if extraction_results.results %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Image</th>
                                    <th>Status</th>
                                    <th>Lottery Type</th>
                                    <th>Numbers</th>
                                    <th>Confidence</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for result in extraction_results.results %}
                                <tr>
                                    <td>{{ result.image.split('/')[-1] }}</td>
                                    <td>
                                        {% if result.status == 'success' %}
                                            <span class="badge bg-success">Success</span>
                                        {% elif result.status == 'database_error' %}
                                            <span class="badge bg-warning">DB Error</span>
                                        {% else %}
                                            <span class="badge bg-danger">Failed</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if result.data and result.data.lottery_type %}
                                            <span class="badge bg-primary">{{ result.data.lottery_type }}</span>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if result.data and result.data.main_numbers %}
                                            {% for num in result.data.main_numbers %}
                                                <span class="badge bg-lottery-red me-1">{{ num }}</span>
                                            {% endfor %}
                                            {% if result.data.bonus_number %}
                                                + <span class="badge bg-warning text-dark">{{ result.data.bonus_number }}</span>
                                            {% endif %}
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if result.data and result.data.confidence %}
                                            {{ result.data.confidence }}%
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Current Database Status -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-database me-2"></i> Current Database Status
                    </h5>
                </div>
                <div class="card-body">
                    <p>After extraction, you can view your authentic lottery data at:</p>
                    <div class="d-flex gap-2 flex-wrap">
                        <a href="{{ url_for('results') }}" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-list me-1"></i> View All Results
                        </a>
                        <a href="{{ url_for('visualizations') }}" class="btn btn-outline-success btn-sm">
                            <i class="fas fa-chart-line me-1"></i> Analytics Dashboard
                        </a>
                        <a href="{{ url_for('ticket_scanner') }}" class="btn btn-outline-info btn-sm">
                            <i class="fas fa-qrcode me-1"></i> Test Ticket Scanner
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.bg-lottery-red {
    background-color: #dc3545 !important;
}
.border-success {
    border-color: #198754 !important;
}
</style>
{% endblock %}

{% block scripts %}
<script>
async function extractAllLotteryData() {
    if (!confirm('This will process all authentic lottery screenshots from the attached_assets folder. Continue?')) {
        return;
    }
    
    const button = document.getElementById('extractAllData');
    const originalText = button.innerHTML;
    
    // Show loading state
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Processing...';
    button.disabled = true;
    
    try {
        const response = await fetch('/api/extract-lottery-data', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert(`Success! ${result.message}`);
            // Reload page to show results
            window.location.reload();
        } else {
            alert(`Error: ${result.error}`);
        }
    } catch (error) {
        alert(`Network error: ${error.message}`);
    } finally {
        // Restore button state
        button.innerHTML = originalText;
        button.disabled = false;
    }
}
</script>
{% endblock %}