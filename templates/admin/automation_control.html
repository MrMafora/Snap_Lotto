{% extends "base.html" %}

{% block title %}Automation Control Center | Snap Lotto{% endblock %}

{% block head_content %}
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<style>
    /* Ensure gallery container is properly scrollable */
    html, body {
        height: 100%;
        overflow-y: auto !important;
    }
    
    .gallery-container {
        overflow-y: visible !important;
    }
    
    /* Fix for image containers preventing scroll */
    .gallery-image-container {
        pointer-events: auto;
    }
    
    .gallery-image-container img {
        pointer-events: auto;
    }
    
    .automation-step {
        transition: all 0.3s ease;
    }
    
    .automation-step:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .step-number {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: white;
        margin-right: 15px;
    }
    
    .bg-lottery-red {
        background-color: #dc3545 !important;
    }
</style>
<script>
    // Fix for scrolling issues on page
    document.addEventListener('DOMContentLoaded', function() {
        // Remove any scroll-blocking event listeners
        document.addEventListener('wheel', function(event) {
            event.stopPropagation();
        }, true);
        
        // Ensure images don't capture scroll events and prevent dragging
        const galleryImages = document.querySelectorAll('.gallery-image-container img');
        galleryImages.forEach(img => {
            // Prevent wheel events from being captured
            img.addEventListener('wheel', function(event) {
                event.stopPropagation();
            }, false);
            
            // Prevent dragging which can interfere with scrolling
            img.setAttribute('draggable', 'false');
            img.addEventListener('dragstart', function(event) {
                event.preventDefault();
            });
            
            // Ensure pointer events work properly
            img.style.pointerEvents = 'auto';
        });
        
        // Add prevention for any other event handlers that might block scrolling
        document.body.style.overflowY = 'scroll';
        document.documentElement.style.overflowY = 'scroll';
    });
</script>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header lottery-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="card-title mb-0">AUTOMATION CONTROL CENTER</h4>
                            <p class="mb-0 text-muted">Complete lottery data automation with manual controls</p>
                        </div>
                        <a href="{{ url_for('admin') }}" class="btn btn-sm btn-outline-dark">
                            <i class="fas fa-arrow-left me-1"></i> Back to Dashboard
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Complete Automation Workflow -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-primary">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-magic me-2"></i> Complete Automated Workflow
                    </h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i> 
                        Run the complete daily automation: Clear â†’ Capture â†’ AI Process â†’ Database Update â†’ Clean Up
                        <br><small class="text-muted">Note: If website capture fails, you can manually upload screenshots using the Upload section below</small>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-8">
                            <h6>What this does:</h6>
                            <ol>
                                <li>Clears old screenshots from the system</li>
                                <li>Captures fresh lottery data from official websites</li>
                                <li>Uses AI to extract authentic lottery numbers</li>
                                <li>Updates your database with real results</li>
                            </ol>
                        </div>
                        <div class="col-md-4">
                            <button id="runCompleteWorkflow" class="btn btn-success btn-lg w-100 mb-3" onclick="runCompleteAutomation()">
                                <i class="fas fa-play me-2"></i> Run Complete Workflow
                            </button>
                            
                            <!-- Progress Display -->
                            <div id="automationProgress" class="d-none">
                                <div class="progress mb-3">
                                    <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                                </div>
                                <div id="currentStep" class="text-center small mb-2">Starting automation...</div>
                                <div id="stepDetails" class="text-center small text-muted"></div>
                            </div>
                            
                            <div class="text-center">
                                <small class="text-muted">This may take 5-10 minutes to complete</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Lottery Group Selection -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header lottery-header">
                    <h5 class="card-title mb-0">LOTTERY GROUP SELECTION</h5>
                    <p class="mb-0 text-muted">Choose which lottery groups to process based on South African draw schedule</p>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <div class="card border-primary">
                                <div class="card-body text-center">
                                    <h6 class="card-title text-primary">Group 1: Lottery</h6>
                                    <p class="small">Lotto, Lotto Plus 1, Lotto Plus 2</p>
                                    <p class="small text-muted"><strong>Draw Days:</strong> Wednesday & Saturday</p>
                                    <button class="btn btn-sm btn-primary" onclick="selectGroup('group1')">Select Group 1</button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card border-success">
                                <div class="card-body text-center">
                                    <h6 class="card-title text-success">Group 2: PowerBall</h6>
                                    <p class="small">PowerBall, PowerBall Plus</p>
                                    <p class="small text-muted"><strong>Draw Days:</strong> Tuesday & Friday</p>
                                    <button class="btn btn-sm btn-success" onclick="selectGroup('group2')">Select Group 2</button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card border-warning">
                                <div class="card-body text-center">
                                    <h6 class="card-title text-warning">Group 3: Daily</h6>
                                    <p class="small">Daily Lotto</p>
                                    <p class="small text-muted"><strong>Draw Days:</strong> Every Day</p>
                                    <button class="btn btn-sm btn-warning" onclick="selectGroup('group3')">Select Group 3</button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card border-danger">
                                <div class="card-body text-center">
                                    <h6 class="card-title text-danger">Group 4: All</h6>
                                    <p class="small">All Lottery Types</p>
                                    <p class="small text-muted"><strong>Process:</strong> Complete Coverage</p>
                                    <button class="btn btn-sm btn-danger" onclick="selectGroup('all')">Select All Groups</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>Smart Scheduling:</strong> The automated system runs daily at 1:00 AM and automatically processes only the lottery groups that have draws scheduled for that day.
                                <br><strong>Manual Control:</strong> You can override this and run any group manually using the controls below.
                            </div>
                            <div id="selected-group-info" class="alert alert-secondary d-none">
                                <i class="fas fa-check-circle me-2"></i>
                                <span id="selected-group-text">No group selected</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Individual Automation Steps -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header lottery-header">
                    <h5 class="card-title mb-0">MANUAL STEP CONTROLS</h5>
                    <p class="mb-0 text-muted">Run individual parts of the automation process</p>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- Step 1: Clear Old Screenshots -->
                        <div class="col-md-6 mb-4">
                            <div class="card automation-step h-100">
                                <div class="card-header bg-warning text-dark">
                                    <div class="d-flex align-items-center">
                                        <div class="step-number bg-dark">1</div>
                                        <h6 class="mb-0">Clear Old Screenshots</h6>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <p>Remove old screenshot files to make space for fresh captures</p>
                                    
                                    <!-- Progress indicator for this step -->
                                    <div id="cleanup-progress" class="d-none mb-3">
                                        <div class="progress">
                                            <div class="progress-bar progress-bar-striped progress-bar-animated bg-warning" role="progressbar" style="width: 100%"></div>
                                        </div>
                                        <small class="text-muted">Clearing old screenshots...</small>
                                    </div>
                                    
                                    <form action="/admin/run-automation-step" method="POST" onsubmit="showStepProgress('cleanup'); return true;">
                                        <input type="hidden" name="step" value="cleanup">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() if csrf_token else '' }}">
                                        <button type="submit" class="btn btn-warning w-100" id="cleanup-btn">
                                            <i class="fas fa-broom me-2"></i> Clear Old Screenshots
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <!-- Step 2: Capture Fresh Screenshots -->
                        <div class="col-md-6 mb-4">
                            <div class="card automation-step h-100">
                                <div class="card-header bg-info text-white">
                                    <div class="d-flex align-items-center">
                                        <div class="step-number bg-dark">2</div>
                                        <h6 class="mb-0">Capture Fresh Screenshots</h6>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <p>Take new screenshots from official lottery websites</p>
                                    
                                    <!-- Progress indicator for this step -->
                                    <div id="capture-progress" class="d-none mb-3">
                                        <div class="progress">
                                            <div class="progress-bar progress-bar-striped progress-bar-animated bg-info" role="progressbar" style="width: 100%"></div>
                                        </div>
                                        <small class="text-muted">Capturing screenshots from lottery websites...</small>
                                    </div>
                                    
                                    <form action="/admin/run-automation-step" method="POST" onsubmit="showStepProgress('capture'); return true;">
                                        <input type="hidden" name="step" value="capture">
                                        <input type="hidden" name="groups" id="capture-groups" value="">
                                        <button type="submit" class="btn btn-info w-100" id="capture-btn">
                                            <i class="fas fa-camera me-2"></i> Capture Screenshots
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <!-- Step 3: AI Data Processing -->
                        <div class="col-md-6 mb-4">
                            <div class="card automation-step h-100">
                                <div class="card-header bg-success text-white">
                                    <div class="d-flex align-items-center">
                                        <div class="step-number bg-dark">3</div>
                                        <h6 class="mb-0">AI Data Processing</h6>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <p>Use AI to extract lottery data from captured screenshots</p>
                                    
                                    <!-- Progress indicator for this step -->
                                    <div id="ai_process-progress" class="d-none mb-3">
                                        <div class="progress">
                                            <div class="progress-bar progress-bar-striped progress-bar-animated bg-success" role="progressbar" style="width: 100%"></div>
                                        </div>
                                        <small class="text-muted">Validating screenshots and processing with AI...</small>
                                    </div>
                                    
                                    <!-- Prerequisites notice -->
                                    <div class="alert alert-info alert-sm mb-3">
                                        <i class="fas fa-info-circle me-1"></i>
                                        <strong>Prerequisites:</strong> This step requires fresh screenshots from steps 1 & 2
                                    </div>
                                    
                                    <form action="/admin/run-automation-step" method="POST" onsubmit="showStepProgress('ai_process'); return true;">
                                        <input type="hidden" name="step" value="ai_process">
                                        <button type="submit" class="btn btn-success w-100" id="ai_process-btn">
                                            <i class="fas fa-robot me-2"></i> Process with AI
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <!-- Step 4: Database Update -->
                        <div class="col-md-6 mb-4">
                            <div class="card automation-step h-100">
                                <div class="card-header bg-primary text-white">
                                    <div class="d-flex align-items-center">
                                        <div class="step-number bg-dark">4</div>
                                        <h6 class="mb-0">Database Update</h6>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <p>Save extracted lottery data to your database</p>
                                    
                                    <!-- Progress indicator for this step -->
                                    <div id="database_update-progress" class="d-none mb-3">
                                        <div class="progress">
                                            <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary" role="progressbar" style="width: 100%"></div>
                                        </div>
                                        <small class="text-muted">Updating database with lottery results...</small>
                                    </div>
                                    
                                    <!-- Prerequisites notice -->
                                    <div class="alert alert-info alert-sm mb-3">
                                        <i class="fas fa-info-circle me-1"></i>
                                        <strong>Prerequisites:</strong> This step requires completed AI processing from step 3
                                    </div>
                                    
                                    <form action="/admin/run-automation-step" method="POST" onsubmit="showStepProgress('database_update'); return true;">
                                        <input type="hidden" name="step" value="update">
                                        <button type="submit" class="btn btn-primary w-100" id="database_update-btn">
                                            <i class="fas fa-database me-2"></i> Update Database
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Testing Section -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-flask me-2"></i> AI Testing & Validation
                    </h5>
                </div>
                <div class="card-body">
                    <p>Test AI extraction on authentic lottery screenshots to verify functionality</p>
                    
                    <!-- Test Single Image -->
                    <form method="POST" action="{{ url_for('test_ai_extraction') }}" class="mb-3">
                        <input type="hidden" name="test_mode" value="true">
                        <button type="submit" class="btn btn-warning w-100">
                            <i class="fas fa-flask me-2"></i> Test AI on Sample Image
                        </button>
                    </form>
                    <small class="text-muted">Tests extraction accuracy on authentic lottery screenshots</small>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-download me-2"></i> Export Tools
                    </h5>
                </div>
                <div class="card-body">
                    <p>Download templates and export screenshot archives</p>
                    
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('export_template') }}" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-file-excel me-1"></i> Download Excel Template
                        </a>
                        <a href="{{ url_for('export_screenshots_zip') }}" class="btn btn-outline-success btn-sm">
                            <i class="fas fa-file-archive me-1"></i> Export All Screenshots
                        </a>
                        <a href="{{ url_for('export_combined_zip') }}" class="btn btn-outline-info btn-sm">
                            <i class="fas fa-download me-1"></i> Combined Download
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Status and Results -->
    {% if automation_status %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-{{ 'success' if automation_status.success else 'danger' }}">
                <div class="card-header bg-{{ 'success' if automation_status.success else 'danger' }} text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-{{ 'check-circle' if automation_status.success else 'exclamation-circle' }} me-2"></i> 
                        Automation Status
                    </h5>
                </div>
                <div class="card-body">
                    <p><strong>{{ automation_status.message }}</strong></p>
                    {% if automation_status.details %}
                    <div class="mt-3">
                        <h6>Details:</h6>
                        <pre class="bg-light p-3 rounded">{{ automation_status.details }}</pre>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Test Results -->
    {% if test_result %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-success">
                <div class="card-header bg-success text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-check-circle me-2"></i> AI Test Results
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Extracted Data:</h6>
                            <table class="table table-sm">
                                <tr>
                                    <td><strong>Lottery Type:</strong></td>
                                    <td><span class="badge bg-primary">{{ test_result.lottery_type }}</span></td>
                                </tr>
                                <tr>
                                    <td><strong>Draw Number:</strong></td>
                                    <td>{{ test_result.draw_number or 'Not detected' }}</td>
                                </tr>
                                <tr>
                                    <td><strong>Draw Date:</strong></td>
                                    <td>{{ test_result.draw_date or 'Not detected' }}</td>
                                </tr>
                                <tr>
                                    <td><strong>Main Numbers:</strong></td>
                                    <td>
                                        {% for num in test_result.main_numbers %}
                                            <span class="badge bg-lottery-red me-1">{{ num }}</span>
                                        {% endfor %}
                                    </td>
                                </tr>
                                {% if test_result.bonus_number %}
                                <tr>
                                    <td><strong>Bonus Number:</strong></td>
                                    <td><span class="badge bg-warning text-dark">{{ test_result.bonus_number }}</span></td>
                                </tr>
                                {% endif %}
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6>AI Confidence & Notes:</h6>
                            <p><strong>Confidence:</strong> {{ test_result.confidence }}%</p>
                            <p><strong>Notes:</strong> {{ test_result.notes or 'No additional notes' }}</p>
                            <p><strong>Source:</strong> {{ test_result.source_image }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Screenshot Gallery -->
    <div class="row">
        <div class="col-md-12 mb-4">
            <div class="card">
                <div class="card-header lottery-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">SCREENSHOT GALLERY</h5>
                        <div>
                            <form action="{{ url_for('sync_all_screenshots') }}" method="POST" class="d-inline">
                                <button type="submit" class="btn btn-sm btn-warning">
                                    <i class="fas fa-sync me-1"></i> Sync All
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <p>Browse and manage individual screenshots</p>
                    
                    <div class="row gallery-container">
                        {% for screenshot in screenshots %}
                        <div class="col-md-4 mb-4">
                            <div class="card h-100 gallery-card" style="user-select: none;">
                                <div class="gallery-image-container">
                                    <a href="{{ url_for('view_screenshot', screenshot_id=screenshot.id) }}" target="_blank">
                                        <img src="{{ url_for('view_screenshot', screenshot_id=screenshot.id) }}" 
                                             alt="{{ screenshot.lottery_type }} screenshot"
                                             class="img-fluid">
                                    </a>
                                </div>
                                <div class="card-body d-flex flex-column">
                                    <h6 class="card-title">{{ screenshot.lottery_type }}</h6>
                                    <p class="card-text">
                                        <small class="text-muted">
                                            {{ screenshot.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}
                                        </small>
                                    </p>
                                    <div class="mt-auto">
                                        <div class="d-flex justify-content-between gap-1 mb-2">
                                            <a href="{{ url_for('view_screenshot', screenshot_id=screenshot.id) }}" 
                                               class="btn btn-sm btn-primary flex-fill" 
                                               download>
                                                <i class="fas fa-download me-1"></i> Download
                                            </a>
                                            {% if screenshot.zoomed_path %}
                                            <a href="{{ url_for('view_zoomed_screenshot', screenshot_id=screenshot.id) }}" 
                                               class="btn btn-sm btn-secondary flex-fill" 
                                               target="_blank">
                                                <i class="fas fa-search-plus me-1"></i> Zoomed
                                            </a>
                                            {% endif %}
                                        </div>
                                        <form action="{{ url_for('sync_single_screenshot', screenshot_id=screenshot.id) }}" method="POST">
                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() if csrf_token else '' }}">
                                            <button type="submit" class="btn btn-sm btn-warning w-100">
                                                <i class="fas fa-sync me-1"></i> Resync
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% else %}
                        <div class="col-12">
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-circle me-2"></i> No screenshots available. Run "Capture Screenshots" to get started.
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Quick Access Navigation -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-external-link-alt me-2"></i> Quick Access
                    </h5>
                </div>
                <div class="card-body">
                    <p>Access your lottery data and tools</p>
                    <div class="d-flex gap-2 flex-wrap">
                        <a href="{{ url_for('results') }}" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-list me-1"></i> View All Results
                        </a>
                        <a href="{{ url_for('visualizations') }}" class="btn btn-outline-success btn-sm">
                            <i class="fas fa-chart-line me-1"></i> Analytics Dashboard
                        </a>
                        <a href="{{ url_for('ticket_scanner') }}" class="btn btn-outline-info btn-sm">
                            <i class="fas fa-qrcode me-1"></i> Ticket Scanner
                        </a>
                        <a href="{{ url_for('admin') }}" class="btn btn-outline-warning btn-sm">
                            <i class="fas fa-clock me-1"></i> Daily Scheduler
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Global variable to store selected lottery group
let selectedGroup = null;

function selectGroup(groupId) {
    selectedGroup = groupId;
    
    // Update the UI to show selected group
    const infoDiv = document.getElementById('selected-group-info');
    const textSpan = document.getElementById('selected-group-text');
    
    const groupNames = {
        'group1': 'Group 1: Lottery (Lotto, Lotto Plus 1, Lotto Plus 2) - Wed & Sat',
        'group2': 'Group 2: PowerBall (PowerBall, PowerBall Plus) - Tue & Fri', 
        'group3': 'Group 3: Daily Lottery (Daily Lotto) - Every Day',
        'all': 'Group 4: All Lottery Types - Complete Coverage'
    };
    
    textSpan.textContent = `Selected: ${groupNames[groupId]}`;
    infoDiv.classList.remove('d-none');
    infoDiv.classList.remove('alert-secondary', 'alert-success', 'alert-warning', 'alert-primary', 'alert-danger');
    
    // Color code based on group
    if (groupId === 'group1') {
        infoDiv.classList.add('alert-primary');
    } else if (groupId === 'group2') {
        infoDiv.classList.add('alert-success');
    } else if (groupId === 'group3') {
        infoDiv.classList.add('alert-warning');
    } else if (groupId === 'all') {
        infoDiv.classList.add('alert-danger');
    }
    
    // Update the hidden input field for capture step
    const captureGroupsInput = document.getElementById('capture-groups');
    if (captureGroupsInput) {
        captureGroupsInput.value = groupId;
    }
    
    // Highlight selected button
    document.querySelectorAll('.card button').forEach(btn => {
        btn.classList.remove('btn-outline-primary', 'btn-outline-success', 'btn-outline-warning', 'btn-outline-danger');
        if (btn.textContent.includes('Group 1')) {
            btn.classList.add('btn-primary');
        } else if (btn.textContent.includes('Group 2')) {
            btn.classList.add('btn-success');
        } else if (btn.textContent.includes('Group 3')) {
            btn.classList.add('btn-warning');
        } else if (btn.textContent.includes('All Groups')) {
            btn.classList.add('btn-danger');
        }
    });
    
    // Highlight the selected group button
    event.target.classList.remove('btn-primary', 'btn-success', 'btn-warning', 'btn-danger');
    if (groupId === 'group1') {
        event.target.classList.add('btn-outline-primary');
    } else if (groupId === 'group2') {
        event.target.classList.add('btn-outline-success');
    } else if (groupId === 'group3') {
        event.target.classList.add('btn-outline-warning');
    } else if (groupId === 'all') {
        event.target.classList.add('btn-outline-danger');
    }
}

async function runCompleteAutomation() {
    const button = document.getElementById('runCompleteWorkflow');
    const progressDiv = document.getElementById('automationProgress');
    const progressBar = document.getElementById('progressBar');
    const currentStep = document.getElementById('currentStep');
    const stepDetails = document.getElementById('stepDetails');
    
    // Show progress and disable button
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Running...';
    progressDiv.classList.remove('d-none');
    
    // Simulate step-by-step progress for better UX
    const steps = [
        { name: 'Clearing old screenshots', progress: 25 },
        { name: 'Capturing fresh screenshots', progress: 50 },
        { name: 'Processing with AI', progress: 75 },
        { name: 'Updating database', progress: 100 }
    ];
    
    try {
        // Start the complete workflow
        currentStep.textContent = 'Starting complete automation workflow...';
        stepDetails.textContent = 'Initializing...';
        progressBar.style.width = '10%';
        
        // Use GET request to bypass CSRF
        const response = await fetch('/admin/run-complete-workflow-direct?' + new Date().getTime(), {
            method: 'GET',
            headers: {
                'Accept': 'application/json'
            }
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Workflow failed');
        }
        
        const result = await response.json();
        
        // Check if automation is running in background mode
        if (result.background_mode) {
            // Background execution - show immediate feedback
            currentStep.textContent = 'âœ… Automation Started Successfully!';
            stepDetails.innerHTML = `
                <div class="alert alert-success mt-3">
                    <strong>ðŸš€ Automation is running in the background!</strong><br>
                    This process will take approximately ${result.estimated_completion || '3-5 minutes'}.<br><br>
                    <strong>What's happening:</strong><br>
                    â€¢ Clearing old screenshots<br>
                    â€¢ Capturing 6 fresh lottery screenshots<br>
                    â€¢ AI processing with Google Gemini 2.5 Pro<br>
                    â€¢ Updating database with new results<br><br>
                    <strong>ðŸ“Œ Refresh this page in 3-5 minutes to see the new lottery results!</strong>
                </div>
            `;
            progressBar.style.width = '100%';
            progressBar.classList.remove('progress-bar-striped', 'progress-bar-animated');
            progressBar.classList.add('bg-success');
            
            // Re-enable button after showing message
            setTimeout(() => {
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-play me-2"></i> Run Complete Workflow';
            }, 3000);
            
            return; // Exit early for background mode
        }
        
        // Original synchronous flow (fallback)
        // Simulate progress updates for better UX
        for (let i = 0; i < steps.length; i++) {
            const step = steps[i];
            currentStep.textContent = `Step ${i + 1}/4: ${step.name}`;
            stepDetails.textContent = 'Processing...';
            progressBar.style.width = `${step.progress}%`;
            await new Promise(resolve => setTimeout(resolve, 800));
            stepDetails.textContent = 'Completed successfully';
        }
        
        if (result.status === 'success') {
            // Complete success
            currentStep.textContent = 'Automation completed successfully!';
            stepDetails.textContent = `${result.new_results || 0} new lottery results captured! Redirecting to homepage...`;
            progressBar.classList.remove('progress-bar-striped', 'progress-bar-animated');
            progressBar.classList.add('bg-success');
            
            // Show success details
            if (result.new_results > 0) {
                stepDetails.textContent = `ðŸŽ¯ ${result.new_results} new lottery results found and saved! Redirecting to homepage...`;
            } else {
                stepDetails.textContent = 'All lottery data is current. Redirecting to homepage...';
            }
            
            // Redirect to homepage to show updated results
            setTimeout(() => {
                window.location.href = '/';
            }, 2000);
        } else if (result.status === 'partial_failure') {
            // Partial success - some issues but data may have been captured
            currentStep.textContent = 'Automation completed with some issues';
            stepDetails.textContent = result.message + ' Redirecting to homepage...';
            progressBar.classList.remove('progress-bar-striped', 'progress-bar-animated');
            progressBar.classList.add('bg-warning');
            
            // Still redirect to show any captured data
            setTimeout(() => {
                window.location.href = '/';
            }, 3000);
        } else {
            throw new Error(result.message || 'Workflow failed');
        }
        
    } catch (error) {
        // Error handling
        currentStep.textContent = 'Automation failed';
        stepDetails.textContent = error.message;
        progressBar.classList.remove('progress-bar-striped', 'progress-bar-animated');
        progressBar.classList.add('bg-danger');
        
        // Re-enable button after error
        setTimeout(() => {
            button.disabled = false;
            button.innerHTML = '<i class="fas fa-play me-2"></i> Run Complete Workflow';
            progressDiv.classList.add('d-none');
            progressBar.style.width = '0%';
            progressBar.classList.remove('bg-danger', 'bg-success');
            progressBar.classList.add('progress-bar-striped', 'progress-bar-animated');
        }, 5000);
    }
}

// Add progress indicators to individual step buttons
function addStepButtonProgress(button, stepName) {
    const originalHTML = button.innerHTML;
    
    button.addEventListener('click', function(e) {
        e.preventDefault();
        
        // Show loading state
        button.disabled = true;
        button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Processing...';
        
        // Submit the form
        const form = button.closest('form');
        if (form) {
            fetch(form.action, {
                method: 'POST',
                body: new FormData(form)
            }).then(response => {
                if (response.ok) {
                    // Success - reload to show results
                    window.location.reload();
                } else {
                    // Error - restore button
                    button.disabled = false;
                    button.innerHTML = originalHTML;
                    alert('Step failed. Please try again.');
                }
            }).catch(error => {
                // Network error - restore button
                button.disabled = false;
                button.innerHTML = originalHTML;
                alert('Network error. Please try again.');
            });
        }
    });
}

// Initialize step button progress on page load - DISABLED to prevent conflicts
// document.addEventListener('DOMContentLoaded', function() {
//     // Add progress to individual step buttons
//     const stepButtons = document.querySelectorAll('form[action*="run-automation-step"] button');
//     stepButtons.forEach(button => {
//         const stepName = button.textContent.trim();
//         addStepButtonProgress(button, stepName);
//     });
// });

// Function to show progress for individual steps
function showStepProgress(stepName) {
    console.log('showStepProgress called for:', stepName);
    const progressDiv = document.getElementById(stepName + '-progress');
    const button = document.getElementById(stepName + '-btn');
    
    console.log('Progress div:', progressDiv);
    console.log('Button:', button);
    
    if (progressDiv && button) {
        // Show progress bar immediately
        progressDiv.classList.remove('d-none');
        console.log('Progress bar shown for:', stepName);
        
        // Disable and update button
        button.disabled = true;
        button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Processing...';
        
        // Add visual feedback
        button.classList.add('disabled');
        console.log('Button updated for:', stepName);
    } else {
        console.error('Could not find elements for step:', stepName);
    }
}

// Enhanced step button progress handler
function addStepButtonProgress(button, stepName) {
    button.addEventListener('click', function(e) {
        // Show immediate visual feedback
        this.disabled = true;
        this.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> ' + stepName + '...';
        
        // Add loading class
        this.classList.add('disabled');
        
        // Re-enable after a delay if not handled by server response
        setTimeout(() => {
            if (this.disabled) {
                this.disabled = false;
                this.classList.remove('disabled');
                this.innerHTML = this.getAttribute('data-original-text') || stepName;
            }
        }, 120000); // 2 minute timeout for individual steps
    });
    
    // Store original text
    button.setAttribute('data-original-text', button.innerHTML);
}
</script>
{% endblock %}