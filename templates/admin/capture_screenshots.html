{% extends "base.html" %}

{% block title %}Capture Screenshots | Snap Lotto Admin{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header lottery-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h4 class="card-title mb-0">CAPTURE SCREENSHOTS</h4>
                    <a href="{{ url_for('admin') }}" class="btn btn-sm btn-outline-light">
                        <i class="fas fa-arrow-left me-1"></i> Back to Dashboard
                    </a>
                </div>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i> Capture screenshots from lottery websites using Puppeteer. Select which lottery types to capture or capture all at once.
                </div>
                
                <div class="mb-4">
                    <h5>Select Lottery Types</h5>
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="selectAll">
                                <label class="form-check-label" for="selectAll">
                                    <strong>Select/Deselect All</strong>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="mb-3">History Pages</h6>
                            {% for url in lottery_urls %}
                                {% if 'history' in url.type %}
                                <div class="form-check mb-2">
                                    <input class="form-check-input lottery-type" type="checkbox" id="{{ url.type }}" value="{{ url.type }}" checked>
                                    <label class="form-check-label" for="{{ url.type }}">
                                        {{ url.type|replace('_', ' ')|title }}
                                        <small class="text-muted d-block">{{ url.url }}</small>
                                    </label>
                                </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                        
                        <div class="col-md-6">
                            <h6 class="mb-3">Results Pages</h6>
                            {% for url in lottery_urls %}
                                {% if 'results' in url.type %}
                                <div class="form-check mb-2">
                                    <input class="form-check-input lottery-type" type="checkbox" id="{{ url.type }}" value="{{ url.type }}" checked>
                                    <label class="form-check-label" for="{{ url.type }}">
                                        {{ url.type|replace('_', ' ')|title }}
                                        <small class="text-muted d-block">{{ url.url }}</small>
                                    </label>
                                </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                </div>
                
                <div class="form-check mb-4">
                    <input class="form-check-input" type="checkbox" id="updateDatabase" checked>
                    <label class="form-check-label" for="updateDatabase">
                        Update database with captured screenshots
                    </label>
                </div>
                
                <div class="d-grid gap-2 d-md-flex">
                    <button type="button" id="captureBtn" class="btn btn-primary">
                        <i class="fas fa-camera me-1"></i> Capture Selected Screenshots
                    </button>
                    <a href="{{ url_for('puppeteer.sync_screenshots') }}" class="btn btn-success">
                        <i class="fas fa-sync me-1"></i> Quick Sync All
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Progress Card -->
<div class="row mb-4 d-none" id="progressSection">
    <div class="col-12">
        <div class="card">
            <div class="card-header lottery-header">
                <h4 class="card-title mb-0">CAPTURE PROGRESS</h4>
            </div>
            <div class="card-body">
                <div class="progress mb-3">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" id="captureProgress" role="progressbar" style="width: 0%"></div>
                </div>
                
                <div id="progressStatus" class="text-center mb-3">
                    Initializing...
                </div>
                
                <div id="progressDetails" class="mt-4">
                    <h5>Details</h5>
                    <div class="table-responsive">
                        <table class="table table-striped table-bordered">
                            <thead>
                                <tr>
                                    <th>Lottery Type</th>
                                    <th>Status</th>
                                    <th>Details</th>
                                </tr>
                            </thead>
                            <tbody id="progressTable">
                                <!-- Progress details will be added here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Select/deselect all checkbox
    const selectAllCheckbox = document.getElementById('selectAll');
    const lotteryTypeCheckboxes = document.querySelectorAll('.lottery-type');
    
    // Set the "Select All" checkbox to checked by default
    selectAllCheckbox.checked = true;
    
    selectAllCheckbox.addEventListener('change', function() {
        const isChecked = this.checked;
        lotteryTypeCheckboxes.forEach(checkbox => {
            checkbox.checked = isChecked;
        });
    });
    
    // Update "Select All" checkbox when individual checkboxes change
    lotteryTypeCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const allChecked = Array.from(lotteryTypeCheckboxes).every(cb => cb.checked);
            const anyChecked = Array.from(lotteryTypeCheckboxes).some(cb => cb.checked);
            
            selectAllCheckbox.checked = allChecked;
            selectAllCheckbox.indeterminate = anyChecked && !allChecked;
        });
    });
    
    // Capture button click handler
    const captureBtn = document.getElementById('captureBtn');
    captureBtn.addEventListener('click', startCapture);
    
    function startCapture() {
        // Get selected lottery types
        const selectedTypes = [];
        lotteryTypeCheckboxes.forEach(checkbox => {
            if (checkbox.checked) {
                selectedTypes.push(checkbox.value);
            }
        });
        
        if (selectedTypes.length === 0) {
            alert('Please select at least one lottery type.');
            return;
        }
        
        // Get database update preference
        const updateDb = document.getElementById('updateDatabase').checked;
        
        // Show progress section
        document.getElementById('progressSection').classList.remove('d-none');
        document.getElementById('progressStatus').textContent = 'Starting capture process...';
        document.getElementById('progressTable').innerHTML = '';
        document.getElementById('captureProgress').style.width = '0%';
        
        // Disable capture button
        captureBtn.disabled = true;
        captureBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Capturing...';
        
        // Send request to the server
        fetch('{{ url_for("puppeteer.capture_screenshots_api") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() }}'
            },
            body: JSON.stringify({
                types: selectedTypes,
                update_db: updateDb
            })
        })
        .then(response => response.json())
        .then(data => {
            // Update progress to 100%
            document.getElementById('captureProgress').style.width = '100%';
            
            // Update status
            if (data.status === 'success') {
                document.getElementById('progressStatus').innerHTML = 
                    `<div class="alert alert-success">
                        <i class="fas fa-check-circle me-2"></i> ${data.message}
                    </div>`;
            } else {
                document.getElementById('progressStatus').innerHTML = 
                    `<div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle me-2"></i> ${data.message}
                    </div>`;
            }
            
            // Update details table
            const tableBody = document.getElementById('progressTable');
            tableBody.innerHTML = '';
            
            for (const [type, result] of Object.entries(data.results)) {
                const row = document.createElement('tr');
                
                const typeCell = document.createElement('td');
                typeCell.textContent = type.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                
                const statusCell = document.createElement('td');
                if (result.status === 'success') {
                    statusCell.innerHTML = '<span class="badge bg-success">Success</span>';
                } else {
                    statusCell.innerHTML = '<span class="badge bg-danger">Failed</span>';
                }
                
                const detailsCell = document.createElement('td');
                if (result.status === 'success') {
                    detailsCell.innerHTML = `
                        <div><small>Path: ${result.path}</small></div>
                        <div><small>HTML: ${result.html_path}</small></div>
                    `;
                } else {
                    detailsCell.innerHTML = `<div class="text-danger"><small>${result.message}</small></div>`;
                }
                
                row.appendChild(typeCell);
                row.appendChild(statusCell);
                row.appendChild(detailsCell);
                tableBody.appendChild(row);
            }
            
            // Add database update info if applicable
            if (updateDb && data.database_update) {
                const dbRow = document.createElement('tr');
                
                const typeCell = document.createElement('td');
                typeCell.innerHTML = '<strong>Database Update</strong>';
                
                const statusCell = document.createElement('td');
                if (data.database_update.updated) {
                    statusCell.innerHTML = '<span class="badge bg-success">Success</span>';
                } else {
                    statusCell.innerHTML = '<span class="badge bg-danger">Failed</span>';
                }
                
                const detailsCell = document.createElement('td');
                if (data.database_update.updated) {
                    detailsCell.innerHTML = `
                        <div><small>Updates: ${data.database_update.updates}</small></div>
                        <div><small>New records: ${data.database_update.creates}</small></div>
                    `;
                } else {
                    detailsCell.innerHTML = `<div class="text-danger"><small>${data.database_update.error || 'Unknown error'}</small></div>`;
                }
                
                dbRow.appendChild(typeCell);
                dbRow.appendChild(statusCell);
                dbRow.appendChild(detailsCell);
                tableBody.appendChild(dbRow);
            }
            
            // Re-enable capture button
            captureBtn.disabled = false;
            captureBtn.innerHTML = '<i class="fas fa-camera me-1"></i> Capture Selected Screenshots';
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('progressStatus').innerHTML = 
                `<div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle me-2"></i> Error: ${error.message}
                </div>`;
            
            // Re-enable capture button
            captureBtn.disabled = false;
            captureBtn.innerHTML = '<i class="fas fa-camera me-1"></i> Capture Selected Screenshots';
        });
    }
});
</script>
{% endblock %}