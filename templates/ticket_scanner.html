{% extends "base.html" %}

{% block title %}South African Lottery Scanner{% endblock %}

{% block content %}
<div class="container py-3">
    <div class="row mb-3">
        <div class="col-12">
            <h1 class="d-flex align-items-center">
                <i class="fa fa-ticket-alt me-2"></i> South African Lottery Scanner
            </h1>
            <p class="lead mb-2">Upload any SA lottery ticket - PowerBall, Lotto, Daily Lotto & more!</p>
            <p class="mb-3"><a href="/scanner-landing" class="text-decoration-none"><i class="fas fa-arrow-left me-1"></i> Back to Scanner Info</a></p>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="ticket-scanner-container">
                        <div class="alert alert-info py-2 small">
                            <i class="fa fa-info-circle me-1"></i> Take a clear photo of your lottery ticket, making sure all numbers are visible.
                        </div>

                        <form id="ticket-form">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            
                            <div class="mb-2">
                                <label for="lottery-type" class="form-label small">Select Lottery Type (Optional - AI will detect)</label>
                                <select class="form-select form-select-sm" id="lottery-type" name="lottery_type">
                                    <option value="">Auto-detect from ticket</option>
                                    <option value="Lottery">Lottery</option>
                                    <option value="Lottery Plus 1">Lottery Plus 1</option>
                                    <option value="Lottery Plus 2">Lottery Plus 2</option>
                                    <option value="Powerball">Powerball</option>
                                    <option value="Powerball Plus">Powerball Plus</option>
                                    <option value="Daily Lottery">Daily Lottery</option>
                                </select>
                            </div>

                            <div class="mb-2">
                                <label for="draw-number" class="form-label small">Draw Number (optional)</label>
                                <input type="text" class="form-control form-control-sm" id="draw-number" name="draw_number" 
                                    placeholder="Leave blank to check latest draw">
                            </div>

                            <div class="ticket-drop-area" id="drop-area">
                                <div class="mb-2">
                                    <i class="fa fa-upload fa-2x mb-2"></i>
                                    <h5 class="mb-2">Drag and drop your ticket image here</h5>
                                    <p class="mb-2">or</p>
                                    <input type="file" id="ticket-image" name="ticket_image" accept="image/*" class="d-none">
                                    <button type="button" id="file-select-btn" class="btn btn-primary">Select Image</button>
                                </div>
                            </div>

                            <div id="preview-container" class="text-center d-none">
                                <h6>Preview</h6>
                                <img id="ticket-preview" class="ticket-preview img-fluid rounded" src="">
                                <div class="mt-2">
                                    <button type="button" id="remove-image" class="btn btn-sm btn-outline-danger">
                                        <i class="fa fa-times"></i> Remove
                                    </button>
                                </div>
                            </div>

                            <div class="text-center mt-4">
                                <button type="submit" id="scan-button" class="btn btn-success btn-lg">
                                    <i class="fa fa-search me-2"></i> Scan Ticket
                                </button>
                                <div id="scanner-loading" class="mt-3" style="display: none;">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p>Scanning your ticket...</p>
                                </div>
                            </div>
                        </form>

                        <div id="results-container" class="results-container d-none mt-4">
                            <hr>
                            <h3 class="mb-3 text-center">Scanning Results</h3>
                            
                            <div id="error-message" class="alert alert-danger d-none">
                                <i class="fa fa-exclamation-triangle me-2"></i>
                                <span id="error-text"></span>
                            </div>
                            
                            <div id="success-content" class="d-none">
                                <div class="card mb-4">
                                    <div class="card-header bg-light">
                                        <h5 class="mb-0" id="ticket-info-title">Your Ticket</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <p><strong>Lottery Type:</strong> <span id="detected-lottery-type"></span></p>
                                                <p><strong>Draw Date:</strong> <span id="detected-draw-date"></span></p>
                                                <p><strong>Draw Number:</strong> <span id="detected-draw-number"></span></p>
                                            </div>
                                            <div class="col-md-6">
                                                <p><strong>Your Numbers:</strong></p>
                                                <div id="ticket-numbers" class="numbers-display"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0" id="results-title">Results</h5>
                                    </div>
                                    <div class="card-body">
                                        <div id="winning-info"></div>
                                        <div id="prize-info" class="mt-3"></div>
                                    </div>
                                </div>

                                <div class="text-center mt-3">
                                    <button type="button" id="scan-another" class="btn btn-outline-primary">
                                        <i class="fa fa-camera me-2"></i> Scan Another Ticket
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Get DOM elements
    const ticketForm = document.getElementById('ticket-form');
    const fileInput = document.getElementById('ticket-image');
    const fileSelectBtn = document.getElementById('file-select-btn');
    const previewContainer = document.getElementById('preview-container');
    const ticketPreview = document.getElementById('ticket-preview');
    const removeImageBtn = document.getElementById('remove-image');
    const scanButton = document.getElementById('scan-button');
    const loadingIndicator = document.getElementById('scanner-loading');
    const resultsContainer = document.getElementById('results-container');
    const dropArea = document.getElementById('drop-area');
    const scanAnotherBtn = document.getElementById('scan-another');

    // File selection
    fileSelectBtn.addEventListener('click', function() {
        fileInput.click();
    });

    // Handle file selection
    fileInput.addEventListener('change', function() {
        handleFileSelection(this.files[0]);
    });

    // Handle drag and drop
    dropArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        dropArea.classList.add('drag-over');
    });

    dropArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        dropArea.classList.remove('drag-over');
    });

    dropArea.addEventListener('drop', function(e) {
        e.preventDefault();
        dropArea.classList.remove('drag-over');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            handleFileSelection(files[0]);
        }
    });

    // Remove image
    removeImageBtn.addEventListener('click', function() {
        resetForm();
    });

    // Scan another ticket
    scanAnotherBtn.addEventListener('click', function() {
        resetForm();
        resultsContainer.classList.add('d-none');
    });

    // Form submission
    ticketForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Check if file is selected
        if (!fileInput.files.length) {
            showError('Please select a ticket image first.');
            return;
        }

        // Show loading
        loadingIndicator.style.display = 'block';
        scanButton.disabled = true;
        
        // Clear previous results
        clearResults();
        
        // Submit form
        const formData = new FormData(ticketForm);
        
        fetch('/process-ticket', {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            if (!response.ok) {
                return response.text().then(text => {
                    throw new Error('Server error: ' + response.status + ' - ' + text);
                });
            }
            return response.json();
        })
        .then(data => {
            // Hide loading
            loadingIndicator.style.display = 'none';
            scanButton.disabled = false;
            
            if (!data.success) {
                showError(data.error || 'Failed to process ticket. Please try again.');
                return;
            }
            
            // Display results
            displayResults(data);
        })
        .catch(error => {
            console.error('Error processing ticket:', error);
            loadingIndicator.style.display = 'none';
            scanButton.disabled = false;
            showError('Error processing ticket: ' + error.message);
        });
    });

    // Helper functions
    function handleFileSelection(file) {
        if (!file) return;
        
        if (!file.type.startsWith('image/')) {
            showError('Please select a valid image file.');
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            ticketPreview.src = e.target.result;
            previewContainer.classList.remove('d-none');
            clearResults();
        };
        reader.readAsDataURL(file);
    }

    function resetForm() {
        fileInput.value = '';
        ticketPreview.src = '';
        previewContainer.classList.add('d-none');
        clearResults();
    }

    function clearResults() {
        resultsContainer.classList.add('d-none');
        document.getElementById('error-message').classList.add('d-none');
        document.getElementById('success-content').classList.add('d-none');
    }

    function showError(message) {
        document.getElementById('error-text').textContent = message;
        document.getElementById('error-message').classList.remove('d-none');
        document.getElementById('success-content').classList.add('d-none');
        resultsContainer.classList.remove('d-none');
    }

    function displayResults(data) {
        console.log('Displaying ticket results:', data);
        
        // Show the main results container
        const resultsContainer = document.getElementById('results-container');
        const successContent = document.getElementById('success-content');
        
        if (resultsContainer) {
            resultsContainer.classList.remove('d-none');
        }
        if (successContent) {
            successContent.classList.remove('d-none');
        }
        
        // Display ticket info
        document.getElementById('detected-lottery-type').textContent = data.lottery_type || 'Not detected';
        document.getElementById('detected-draw-date').textContent = data.draw_date || 'Not detected';
        document.getElementById('detected-draw-number').textContent = data.draw_number || 'Not detected';
        
        // Display ticket numbers - show all lines if available
        const numbersContainer = document.getElementById('ticket-numbers');
        numbersContainer.innerHTML = '';
        
        if (data.all_lines && data.all_lines.length > 0) {
            // Show all lines - data.all_lines contains arrays of numbers directly
            data.all_lines.forEach((lineNumbers, index) => {
                const lineDiv = document.createElement('div');
                lineDiv.className = 'mb-3';
                
                const lineTitle = document.createElement('div');
                lineTitle.innerHTML = `<strong>Line ${index + 1} Numbers:</strong>`;
                lineTitle.className = 'mb-2';
                lineDiv.appendChild(lineTitle);
                
                // Create container for lottery balls
                const ballsContainer = document.createElement('div');
                ballsContainer.className = 'd-flex flex-wrap gap-2 mb-2';
                
                // Add main numbers as lottery balls with colors
                lineNumbers.forEach((num, numIndex) => {
                    const ballElement = document.createElement('div');
                    
                    // Assign colors based on number position for variety
                    const colors = ['lottery-ball-red', 'lottery-ball-blue', 'lottery-ball-green', 'lottery-ball-yellow'];
                    const colorClass = colors[numIndex % colors.length];
                    
                    ballElement.className = `lottery-ball ${colorClass} me-1 mb-1`;
                    ballElement.textContent = num;
                    ballsContainer.appendChild(ballElement);
                });
                
                lineDiv.appendChild(ballsContainer);
                
                // Add PowerBall number for this line if available
                const powerballNum = data.all_powerball && data.all_powerball[index] ? data.all_powerball[index] : data.powerball_number;
                
                if (powerballNum) {
                    const powerballTitle = document.createElement('div');
                    powerballTitle.innerHTML = `<strong>PowerBall:</strong>`;
                    powerballTitle.className = 'mb-2';
                    lineDiv.appendChild(powerballTitle);
                    
                    const powerballContainer = document.createElement('div');
                    powerballContainer.className = 'd-flex flex-wrap gap-2';
                    
                    const powerballBall = document.createElement('div');
                    powerballBall.className = 'lottery-ball lottery-ball-red me-1 mb-1';
                    powerballBall.style.border = '3px solid #ffd700';
                    powerballBall.textContent = powerballNum;
                    powerballContainer.appendChild(powerballBall);
                    
                    lineDiv.appendChild(powerballContainer);
                }
                
                numbersContainer.appendChild(lineDiv);
            });
        } else if (data.ticket_numbers && data.ticket_numbers.length > 0) {
            // Fallback to single line display
            data.ticket_numbers.forEach(num => {
                const span = document.createElement('span');
                span.className = 'badge bg-primary me-1';
                span.textContent = num;
                numbersContainer.appendChild(span);
            });
            
            // Add PowerBall number if available
            if (data.powerball_number && data.powerball_number !== 'Not detected') {
                const powerballSpan = document.createElement('span');
                powerballSpan.className = 'badge bg-warning text-dark me-1';
                powerballSpan.textContent = `PowerBall: ${data.powerball_number}`;
                numbersContainer.appendChild(powerballSpan);
            }
        }
        
        // Display results
        const winningInfo = document.getElementById('winning-info');
        const prizeInfo = document.getElementById('prize-info');
        
        if (data.is_winner) {
            winningInfo.innerHTML = '<div class="alert alert-success"><i class="fa fa-trophy me-2"></i>Congratulations! You have a winning ticket!</div>';
            prizeInfo.innerHTML = '<p><strong>Prize:</strong> ' + (data.prize_amount || 'Check with lottery office') + '</p>';
        } else {
            winningInfo.innerHTML = '<div class="alert alert-info"><i class="fa fa-info-circle me-2"></i>No winning combinations found on this ticket.</div>';
            prizeInfo.innerHTML = '';
        }
        
        // Show results
        document.getElementById('success-content').classList.remove('d-none');
        document.getElementById('error-message').classList.add('d-none');
        resultsContainer.classList.remove('d-none');
    }
});
</script>

<style>
.ticket-drop-area {
    border: 2px dashed #dee2e6;
    border-radius: 8px;
    padding: 40px 20px;
    text-align: center;
    transition: all 0.3s ease;
    cursor: pointer;
}

.ticket-drop-area:hover, .ticket-drop-area.drag-over {
    border-color: #007bff;
    background-color: #f8f9fa;
}

.ticket-preview {
    max-width: 300px;
    max-height: 400px;
    border: 1px solid #dee2e6;
}

.numbers-display .badge {
    font-size: 14px;
    margin: 2px;
}

.spinning-loader {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>
{% endblock %}