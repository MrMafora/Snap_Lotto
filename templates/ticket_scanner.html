{% extends "base.html" %}

{% block title %}South African Lottery Ticket Scanner | Check If You've Won | Snap Lotto{% endblock %}

{% block meta_description %}Upload your South African lottery ticket and instantly check if you've won. Compatible with Lotto, PowerBall, Daily Lotto and all bonus draws. No registration required.{% endblock %}

{% block meta_keywords %}lottery ticket scanner, check lottery ticket, South African lottery checker, Lotto ticket scanner, PowerBall ticket scanner, lottery number checker{% endblock %}

{% block og_title %}Free South African Lottery Ticket Scanner | Check If You've Won{% endblock %}
{% block og_description %}Upload a photo of your lottery ticket and our AI will instantly check if you've won against the latest South African lottery results. Fast, free and secure.{% endblock %}

{% block head_content %}
<!-- Structured Data for SEO -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "WebApplication",
  "name": "Snap Lotto Ticket Scanner",
  "applicationCategory": "UtilityApplication",
  "operatingSystem": "All",
  "offers": {
    "@type": "Offer",
    "price": "0",
    "priceCurrency": "ZAR"
  },
  "featureList": [
    "Instant ticket scanning",
    "AI-powered number recognition",
    "All South African lottery games supported",
    "No registration required",
    "Free to use"
  ],
  "description": "Upload your South African lottery ticket and instantly check if you've won. Compatible with all South African lottery games."
}
</script>
{% endblock %}

{% block additional_head %}
<style>
    .ticket-scanner-container {
        max-width: 800px;
        margin: 0 auto;
    }
    
    @media (max-width: 576px) {
        .card-body {
            padding: 0.75rem;
        }
        
        .ticket-scanner-container .form-control, 
        .ticket-scanner-container .form-select {
            padding-top: 0.375rem;
            padding-bottom: 0.375rem;
        }
        
        .ticket-preview {
            max-height: 200px;
            margin: 10px 0;
        }
        
        h1 {
            font-size: 1.75rem;
        }
        
        .lead {
            font-size: 1rem;
        }
    }
    .ticket-drop-area {
        border: 2px dashed #aaa;
        border-radius: 8px;
        padding: 40px;
        text-align: center;
    }
    
    @media (max-width: 576px) {
        .ticket-drop-area {
            padding: 20px;
        }
    }
    @keyframes pulse {
        0% {
            transform: scale(1);
            box-shadow: 0 0 0 0 rgba(0, 123, 255, 0.7);
        }
        
        70% {
            transform: scale(1.05);
            box-shadow: 0 0 0 10px rgba(0, 123, 255, 0);
        }
        
        100% {
            transform: scale(1);
            box-shadow: 0 0 0 0 rgba(0, 123, 255, 0);
        }
    }
    
    /* Updated matched ball styling with glow effect */
    .ball-matched {
        border: 3px solid #28a745 !important;
        box-shadow: 0 0 10px #28a745;
    }
    
    .ticket-drop-area {
        background-color: rgba(0,0,0,0.05);
        cursor: pointer;
        transition: all 0.3s;
        margin-bottom: 20px;
    }
    .ticket-drop-area:hover, .ticket-drop-area.highlight {
        border-color: var(--sa-lottery-yellow);
        background-color: rgba(0,0,0,0.1);
    }
    .ticket-preview {
        max-width: 100%;
        max-height: 300px;
        margin: 20px 0;
    }
    .results-container {
        margin-top: 30px;
    }
    /* Position and checkmark for matched balls */
    .ball-matched {
        position: relative;
    }
    .ball-matched::after {
        content: "âœ“";
        position: absolute;
        top: -10px;
        right: -10px;
        background-color: var(--bs-success);
        color: white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        font-size: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .prize-card {
        border-left: 5px solid var(--bs-success);
    }
    #scanner-loading {
        display: none;
    }
    
    /* Advertisement - Loading overlay */
    #ad-overlay-loading {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.95);
        z-index: 9999;
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 20px;
    }
    
    /* Advertisement - Results overlay */
    #ad-overlay-results {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.95);
        z-index: 9999;
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 20px;
    }
    
    /* Button pulse animation */
    @keyframes btn-pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); box-shadow: 0 0 15px rgba(40, 167, 69, 0.7); }
        100% { transform: scale(1); }
    }
    
    .btn-pulse {
        animation: btn-pulse 1.5s infinite;
    }
</style>
{% endblock %}

{% block content %}
<!-- Ad overlay - Loading screen -->
<div id="ad-overlay-loading" class="interstitial-view">
    <h4 class="mb-4">Processing your ticket...</h4>
    <div id="ad-container-loader" class="ad-container">
        <div class="ad-placeholder">
            <p><i class="fas fa-ad mb-2"></i></p>
            <p class="mb-1">Advertisement</p>
        </div>
    </div>
    <div class="mt-3">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="loading-message">Scanning in progress...</p>
        <p class="small text-muted mt-2">This will take a few moments</p>
    </div>
</div>

<!-- Ad overlay - Results screen -->
<div id="ad-overlay-results" class="interstitial-view">
    <h3 class="mb-3 text-success">Results Ready! <i class="fas fa-check-circle"></i></h3>
    <div class="alert alert-info mb-3" style="max-width: 400px;">
        Please view this advertisement while we prepare your results
    </div>
    <div id="ad-container-interstitial" class="ad-container" style="padding: 15px; background-color: #f8f9fa; border-radius: 10px; box-shadow: 0 0 15px rgba(0,0,0,0.1);">
        <div class="ad-placeholder">
            <p><i class="fas fa-ad mb-2 fa-2x text-primary"></i></p>
            <p class="mb-1 fw-bold">Advertisement</p>
            <small class="text-muted">Your results are ready to view below</small>
        </div>
    </div>
    <button class="btn btn-success btn-lg ad-close-btn mt-3" id="view-results-btn" style="min-width: 200px;">
        <i class="fas fa-check-circle me-2"></i> View Results
    </button>
</div>

<div class="container py-3">
    <div class="row mb-3">
        <div class="col-12">
            <h1 class="d-flex align-items-center">
                <i class="fa fa-ticket-alt me-2"></i> Lottery Ticket Scanner
            </h1>
            <p class="lead mb-2">Upload your ticket to check if you've won</p>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="ticket-scanner-container">
                        <div class="alert alert-info py-2 small">
                            <i class="fa fa-info-circle me-1"></i> Take a clear photo of your lottery ticket, making sure all numbers are visible.
                        </div>

                        <form id="ticket-form" action="/scan-ticket" method="post" enctype="multipart/form-data">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <div class="mb-2">
                                <label for="lottery-type" class="form-label small">Select Lottery Type (Optional - AI will detect)</label>
                                <select class="form-select form-select-sm" id="lottery-type" name="lottery_type">
                                    <option value="">Auto-detect from ticket</option>
                                    <option value="Lotto">Lotto</option>
                                    <option value="Lotto Plus 1">Lotto Plus 1</option>
                                    <option value="Lotto Plus 2">Lotto Plus 2</option>
                                    <option value="Powerball">Powerball</option>
                                    <option value="Powerball Plus">Powerball Plus</option>
                                    <option value="Daily Lotto">Daily Lotto</option>
                                </select>
                            </div>

                            <div class="mb-2">
                                <label for="draw-number" class="form-label small">Draw Number (optional)</label>
                                <input type="text" class="form-control form-control-sm" id="draw-number" name="draw_number" 
                                    placeholder="Leave blank to check latest draw">
                            </div>

                            <div class="ticket-drop-area" id="drop-area">
                                <div class="mb-2">
                                    <i class="fa fa-upload fa-2x mb-2"></i>
                                    <h5 class="mb-2">Drag and drop your ticket image here</h5>
                                    <p class="mb-2">or</p>
                                    <input type="file" id="ticket-image" name="ticket_image" accept="image/*" class="d-none">
                                    <button type="button" id="file-select-btn" class="btn btn-primary">Select Image</button>
                                </div>
                            </div>

                            <div id="preview-container" class="text-center d-none">
                                <h6>Preview</h6>
                                <img id="ticket-preview" class="ticket-preview img-fluid rounded" src="">
                                <div class="mt-2">
                                    <button type="button" id="remove-image" class="btn btn-sm btn-outline-danger">
                                        <i class="fa fa-times"></i> Remove
                                    </button>
                                </div>
                            </div>

                            <div class="text-center mt-4">
                                <button type="submit" id="scan-button" class="btn btn-success btn-lg">
                                    <i class="fa fa-search me-2"></i> Scan Ticket
                                </button>
                                <div id="scanner-loading" class="mt-3">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p>Scanning your ticket...</p>
                                </div>
                            </div>
                        </form>

                        <div id="results-container" class="results-container d-none">
                            <hr>
                            <h3 class="mb-3 text-center">Scanning Results</h3>
                            
                            <div id="error-message" class="alert alert-danger d-none">
                                <i class="fa fa-exclamation-triangle me-2"></i>
                                <span id="error-text"></span>
                            </div>
                            
                            <div id="success-content" class="d-none">
                                <div class="card mb-4">
                                    <div class="card-header bg-light">
                                        <h5 class="mb-0" id="ticket-info-title">Your Ticket</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <p><strong>Lottery Type:</strong> <span id="result-lottery-type"></span></p>
                                                <p><strong>Draw Number:</strong> <span id="result-draw-number"></span></p>
                                                <p><strong>Draw Date:</strong> <span id="result-draw-date"></span></p>
                                                
                                                <div id="detected-info" class="mt-3 small">
                                                    <p class="text-muted mb-1"><i class="fas fa-search-plus me-1"></i> <strong>OCR Detected Information:</strong></p>
                                                    <p class="mb-1"><strong>Game Type:</strong> <span id="detected-game-type"></span></p>
                                                    <p class="mb-1"><strong>Draw Number:</strong> <span id="detected-draw-number"></span></p>
                                                    <p class="mb-1"><strong>Draw Date:</strong> <span id="detected-draw-date"></span></p>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <p><strong>Your Numbers:</strong></p>
                                                <div id="ticket-numbers" class="mb-3"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="card mb-4">
                                    <div class="card-header bg-light">
                                        <h5 class="mb-0">Winning Numbers</h5>
                                    </div>
                                    <div class="card-body">
                                        <!-- Primary game winning numbers -->
                                        <div class="mb-3">
                                            <p><strong id="primary-game-label">Main Numbers:</strong></p>
                                            <div id="winning-numbers-container">
                                                <div id="winning-numbers" class="d-inline-flex flex-wrap mb-3"></div>
                                            </div>
                                            <div id="matched-numbers-section" class="mt-2">
                                                <p><strong>Your Matches:</strong> <span id="matched-count" class="badge bg-success">0</span></p>
                                                <div id="matched-numbers"></div>
                                            </div>
                                        </div>
                                        
                                        <!-- Hidden container for bonus (this won't be displayed separately anymore) -->
                                        <div id="bonus-numbers-container" class="d-none">
                                            <div id="bonus-numbers"></div>
                                        </div>
                                        
                                        <!-- Powerball Plus winning numbers displayed in main winning numbers card -->
                                        <div id="powerball-plus-numbers-container" class="mb-3 d-none">
                                            <hr>
                                            <p><strong>Powerball Plus Numbers:</strong></p>
                                            <div id="powerball-plus-numbers" class="d-inline-flex flex-wrap mb-2"></div>
                                            <div id="pp-matched-numbers-section" class="mt-2">
                                                <p><strong>Your Matches:</strong> <span id="pp-matched-count" class="badge bg-success">0</span></p>
                                                <div id="pp-matched-numbers"></div>
                                            </div>
                                        </div>

                                        <!-- Lotto Plus 1 winning numbers section -->
                                        <div id="lotto-plus-1-numbers-container" class="mb-3 d-none">
                                            <hr>
                                            <p><strong>Lotto Plus 1 Numbers:</strong></p>
                                            <div id="lotto-plus-1-numbers" class="d-inline-flex flex-wrap mb-2"></div>
                                            <div id="lp1-matched-numbers-section" class="mt-2">
                                                <p><strong>Your Matches:</strong> <span id="lp1-matched-count" class="badge bg-success">0</span></p>
                                                <div id="lp1-matched-numbers"></div>
                                            </div>
                                        </div>
                                        
                                        <!-- Lotto Plus 2 winning numbers section -->
                                        <div id="lotto-plus-2-numbers-container" class="mb-3 d-none">
                                            <hr>
                                            <p><strong>Lotto Plus 2 Numbers:</strong></p>
                                            <div id="lotto-plus-2-numbers" class="d-inline-flex flex-wrap mb-2"></div>
                                            <div id="lp2-matched-numbers-section" class="mt-2">
                                                <p><strong>Your Matches:</strong> <span id="lp2-matched-count" class="badge bg-success">0</span></p>
                                                <div id="lp2-matched-numbers"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div id="prize-container" class="d-none">
                                    <div class="card prize-card">
                                        <div class="card-body">
                                            <h4 class="text-success mb-3"><i class="fa fa-trophy me-2"></i> Congratulations!</h4>
                                            <p class="lead">You've won a prize in <span id="prize-lottery-type"></span> Draw <span id="prize-draw-number"></span>!</p>
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <p><strong>Division:</strong> <span id="prize-division"></span></p>
                                                    <p><strong>Match Type:</strong> <span id="prize-match-type"></span></p>
                                                </div>
                                                <div class="col-md-6">
                                                    <h3 class="text-success">Prize: <span id="prize-amount"></span></h3>
                                                </div>
                                            </div>
                                            <p class="small text-muted mt-3">Visit the official South African National Lottery website or an authorized retailer to claim your prize.</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div id="no-prize-container" class="d-none">
                                    <div class="card">
                                        <div class="card-body text-center">
                                            <h4 class="text-muted mb-3"><i class="fa fa-times-circle me-2"></i> No Prize</h4>
                                            <p>Sorry, your ticket did not win a prize in this draw.</p>
                                            <p>Better luck next time!</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Container for Powerball Plus results -->
                                <div id="powerball-plus-container" class="d-none mt-4"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block additional_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const dropArea = document.getElementById('drop-area');
        const fileInput = document.getElementById('ticket-image');
        const fileSelectBtn = document.getElementById('file-select-btn');
        const previewContainer = document.getElementById('preview-container');
        const ticketPreview = document.getElementById('ticket-preview');
        const removeImageBtn = document.getElementById('remove-image');
        const scanButton = document.getElementById('scan-button');
        const ticketForm = document.getElementById('ticket-form');
        const lotteryTypeSelect = document.getElementById('lottery-type');
        const loadingIndicator = document.getElementById('scanner-loading');
        const resultsContainer = document.getElementById('results-container');
        
        // Initialize scan button state after a short delay
        setTimeout(() => {
            updateScanButton();
            console.log("Initial button state check on page load");
        }, 500);
        
        // File selection via button
        fileSelectBtn.addEventListener('click', () => {
            fileInput.click();
        });
        
        // File selection change
        fileInput.addEventListener('change', handleFileSelect);
        
        // Drag and drop events
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, preventDefaults, false);
        });
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, highlight, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, unhighlight, false);
        });
        
        function highlight() {
            dropArea.classList.add('highlight');
        }
        
        function unhighlight() {
            dropArea.classList.remove('highlight');
        }
        
        dropArea.addEventListener('drop', handleDrop, false);
        
        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            
            if (files.length > 0) {
                fileInput.files = files;
                handleFileSelect();
            }
        }
        
        function handleFileSelect() {
            const file = fileInput.files[0];
            
            if (file) {
                // Check if file is an image
                if (!file.type.match('image.*')) {
                    alert('Please select an image file');
                    fileInput.value = ''; // Clear the file input
                    return;
                }
                
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    ticketPreview.src = e.target.result;
                    previewContainer.classList.remove('d-none');
                    // Update scan button state
                    updateScanButton();
                    console.log("File loaded successfully");
                }
                
                reader.onerror = function() {
                    alert('Error reading the image file. Please try a different image.');
                    fileInput.value = ''; // Clear the file input on error
                    updateScanButton();
                }
                
                reader.readAsDataURL(file);
            } else {
                previewContainer.classList.add('d-none');
                updateScanButton();
            }
        }
        
        removeImageBtn.addEventListener('click', function() {
            ticketPreview.src = '';
            fileInput.value = '';
            previewContainer.classList.add('d-none');
            updateScanButton();
        });
        
        lotteryTypeSelect.addEventListener('change', updateScanButton);
        
        // Add a direct click handler for the scan button
        scanButton.addEventListener('click', function(e) {
            if (fileInput.files.length) {
                e.preventDefault();
                processTicketWithAds();
            }
        });
        
        function updateScanButton() {
            // Always keep the button enabled
            scanButton.disabled = false;
            console.log("Button state updated:", {
                fileCount: fileInput.files.length,
                lotteryType: lotteryTypeSelect.value,
                disabled: false
            });
        }
        
        // Function to handle showing ads and processing the ticket
        // Clear previous results to prevent mixing results from different tickets
        function clearPreviousResults() {
            // Clean up any existing countdown timers when clearing results
            if (window.countdownInterval) {
                clearInterval(window.countdownInterval);
                window.countdownInterval = null;
            }
            
            if (window.countdownTimeout) {
                clearTimeout(window.countdownTimeout);
                window.countdownTimeout = null;
            }
            
            // Reset the countdown running flag since we're starting fresh
            window.countdownRunning = false;
            
            // Hide result containers
            const resultsContainer = document.getElementById('results-container');
            if (resultsContainer) {
                resultsContainer.classList.add('d-none');
            }
            
            const successContent = document.getElementById('success-content');
            if (successContent) {
                successContent.classList.add('d-none');
            }
            
            // Clear winning numbers
            const winningNumbersContainer = document.getElementById('winning-numbers');
            if (winningNumbersContainer) {
                winningNumbersContainer.innerHTML = '';
            }
            
            // Clear ticket numbers
            const ticketNumbersContainer = document.getElementById('ticket-numbers');
            if (ticketNumbersContainer) {
                ticketNumbersContainer.innerHTML = '';
            }
            
            // Hide and clear all additional game containers
            const additionalGameContainers = [
                'powerball-plus-numbers-container',
                'lotto-plus-1-numbers-container',
                'lotto-plus-2-numbers-container'
            ];
            
            additionalGameContainers.forEach(id => {
                const container = document.getElementById(id);
                if (container) {
                    container.classList.add('d-none');
                    
                    // Also clear the numbers inside these containers
                    const numbersEl = document.getElementById(id.replace('-container', ''));
                    if (numbersEl) {
                        numbersEl.innerHTML = '';
                    }
                    
                    // Clear the matched numbers
                    const matchedId = id.replace('numbers-container', 'matched-numbers');
                    const matchedEl = document.getElementById(matchedId);
                    if (matchedEl) {
                        matchedEl.innerHTML = '';
                    }
                    
                    // Reset the matched count
                    const countId = id.replace('numbers-container', 'matched-count');
                    const countEl = document.getElementById(countId);
                    if (countEl) {
                        countEl.textContent = '0';
                    }
                }
            });
            
            // Hide related game sections if they exist
            ['powerball-plus-section', 'lotto-plus-1-section', 'lotto-plus-2-section'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.classList.add('d-none');
                }
            });
            
            console.log('Cleared previous results');
        }
        
        function processTicketWithAds() {
            // Clear any previous results first
            clearPreviousResults();
            
            // Scroll to top and disable scrolling during processing
            window.scrollTo(0, 0);
            disableScrolling();
            
            // Show loading indicator
            loadingIndicator.style.display = 'block';
            // Never disable the scan button
            scanButton.disabled = false;
            
            // Create form data for later use
            const formData = new FormData(ticketForm);
            
            // Show the loading ad overlay first
            const adOverlayLoading = document.getElementById('ad-overlay-loading');
            adOverlayLoading.style.display = 'flex';
            
            // Ensure the ad overlay stays visible for at least 2 seconds before processing
            setTimeout(() => {
                // Check if AdManager is available and use it to show ad, otherwise just process
                if (window.AdManager && typeof window.AdManager.showLoadingAd === 'function') {
                    console.log('Using AdManager to show loading ad');
                    window.AdManager.showLoadingAd(function(adShown) {
                        // Keep ad visible for at least 5 seconds total
                        setTimeout(() => {
                            // After ad is displayed for minimum time, process the ticket
                            console.log('Ad loading callback returned after minimum display time:', adShown);
                            processTicket(formData);
                        }, 3000); // 3 seconds additional display time (2s initial + 3s = 5s total)
                    });
                } else {
                    // Fallback - Ad overlay is already shown manually
                    console.log('AdManager not available, showing overlay manually');
                    
                    // Process the ticket after a minimum viewing time
                    setTimeout(() => {
                        console.log('Processing ticket without AdManager after minimum ad view time');
                        processTicket(formData);
                    }, 3000); // 3 seconds additional display time (2s initial + 3s = 5s total)
                }
            }, 2000); // Initial 2 seconds minimum display time
        }
        
        // Function to process the ticket after ad is shown
        function processTicket(formData) {
            // Add CSRF token to headers
            const csrfToken = document.querySelector('input[name="csrf_token"]').value;
            
            // Add CSRF token to request headers
            fetch('/scan-ticket', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': csrfToken
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                console.log('Success:', data);
                
                // Hide loading overlay
                const adOverlayLoading = document.getElementById('ad-overlay-loading');
                adOverlayLoading.style.display = 'none';
                
                // Ensure the results overlay is shown
                const adOverlayResults = document.getElementById('ad-overlay-results');
                
                // Always make sure the results overlay is displayed
                adOverlayResults.style.display = 'flex';
                
                // Try to use AdManager for tracking, but we'll show the overlay manually either way
                if (window.AdManager && typeof window.AdManager.showInterstitialAd === 'function') {
                    console.log('Using AdManager to show interstitial ad');
                    window.AdManager.showInterstitialAd(function(adShown) {
                        console.log('Interstitial ad shown:', adShown);
                        // Make sure the overlay is displayed even if AdManager fails
                        adOverlayResults.style.display = 'flex';
                    });
                } else {
                    console.log('AdManager not available, showing results overlay manually');
                }
                
                console.log('Showing results interstitial ad');
                
                // Get the ad container
                const adContainer = document.getElementById('ad-container-interstitial');
                
                // Auto-show the results after a short delay (simulate ad viewing)
                const viewResultsBtn = document.getElementById('view-results-btn');
                viewResultsBtn.onclick = function() {
                    adOverlayResults.style.display = 'none';
                    
                    // Clean up all timers and reset the state
                    if (window.countdownInterval) {
                        clearInterval(window.countdownInterval);
                        window.countdownInterval = null;
                    }
                    
                    if (window.countdownTimeout) {
                        clearTimeout(window.countdownTimeout);
                        window.countdownTimeout = null;
                    }
                    
                    // Reset the countdown running flag
                    window.countdownRunning = false;
                    
                    // Make sure scrolling is enabled
                    enableScrolling();
                    displayResults(data);
                    console.log('User clicked View Results, countdown state cleared');
                };
                
                // FORCEFULLY disable the view results button for 15 seconds
                // We'll use a global flag to track if countdown is already running
                if (!window.countdownRunning) {
                    console.log('Setting 15-second mandatory ad display timer...');
                    
                    // Set global flag to prevent multiple timers
                    window.countdownRunning = true;
                    
                    // Disable the View Results button
                    viewResultsBtn.disabled = true;
                    viewResultsBtn.style.opacity = '0.5';
                    viewResultsBtn.style.cursor = 'not-allowed';
                    viewResultsBtn.innerHTML = '<i class="fas fa-lock me-2"></i> View Results (Wait 15s)';
                    
                    // Add a counter display to show remaining seconds
                    // First, remove any existing countdown elements to prevent duplicates
                    const existingCountdown = document.getElementById('ad-countdown');
                    if (existingCountdown) {
                        existingCountdown.remove();
                    }
                    
                    const counterElement = document.createElement('div');
                    counterElement.id = 'ad-countdown';
                    counterElement.style.cssText = 'margin-top: 10px; font-size: 14px; color: #666; font-weight: bold;';
                    adOverlayResults.querySelector('.ad-container').appendChild(counterElement);
                    
                    // Store timer start time to prevent deviations
                    window.countdownStartTime = Date.now();
                    window.countdownDuration = 15000; // 15 seconds in milliseconds
                    
                    // Make sure to clear any existing timers first
                    if (window.countdownInterval) {
                        clearInterval(window.countdownInterval);
                    }
                    
                    if (window.countdownTimeout) {
                        clearTimeout(window.countdownTimeout);
                    }
                    
                    // Update the counter every second based on elapsed time
                    window.countdownInterval = setInterval(() => {
                        // Calculate remaining time based on actual elapsed time
                        const elapsedMs = Date.now() - window.countdownStartTime;
                        const remainingMs = Math.max(0, window.countdownDuration - elapsedMs);
                        const remainingSeconds = Math.ceil(remainingMs / 1000);
                        
                        // Update display
                        counterElement.textContent = `Results available in ${remainingSeconds} seconds...`;
                        
                        // Update button text
                        viewResultsBtn.innerHTML = `<i class="fas fa-lock me-2"></i> View Results (Wait ${remainingSeconds}s)`;
                        
                        // Check if countdown is complete
                        if (remainingSeconds <= 0) {
                            // Clear interval and reset running flag
                            clearInterval(window.countdownInterval);
                            window.countdownInterval = null;
                            window.countdownRunning = false;
                            
                            // Enable the button after time is up
                            viewResultsBtn.disabled = false;
                            viewResultsBtn.style.opacity = '1';
                            viewResultsBtn.style.cursor = 'pointer';
                            viewResultsBtn.innerHTML = '<i class="fas fa-check-circle me-2"></i> View Results Now!';
                            
                            // Make the button pulse to draw attention
                            viewResultsBtn.classList.add('btn-pulse');
                            
                            console.log('Countdown completed naturally based on elapsed time');
                        }
                    }, 1000);
                    
                    // Set a single timeout for exactly 15 seconds from now
                    // This is a backup to ensure the button is enabled after 15 seconds
                    window.countdownTimeout = setTimeout(() => {
                        // Clear any running interval
                        if (window.countdownInterval) {
                            clearInterval(window.countdownInterval);
                            window.countdownInterval = null;
                        }
                        
                        // Reset the running flag
                        window.countdownRunning = false;
                        
                        console.log('15-second ad display timer completed via timeout');
                        
                        // Make sure the button is enabled
                        if (adOverlayResults.style.display === 'flex') {
                            viewResultsBtn.disabled = false;
                            viewResultsBtn.style.opacity = '1';
                            viewResultsBtn.style.cursor = 'pointer';
                            viewResultsBtn.innerHTML = '<i class="fas fa-check-circle me-2"></i> View Results Now!';
                            viewResultsBtn.classList.add('btn-pulse');
                        }
                    }, window.countdownDuration);
                } else {
                    console.log('Countdown already running, not starting a new one');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                
                // Clean up any running timers in case of error
                if (window.countdownInterval) {
                    clearInterval(window.countdownInterval);
                    window.countdownInterval = null;
                }
                
                if (window.countdownTimeout) {
                    clearTimeout(window.countdownTimeout);
                    window.countdownTimeout = null;
                }
                
                // Reset the countdown running flag
                window.countdownRunning = false;
                
                // Hide ad loading overlay
                const adOverlayLoading = document.getElementById('ad-overlay-loading');
                adOverlayLoading.style.display = 'none';
                
                // Make sure scrolling is enabled in case of error
                enableScrolling();
                showError('An error occurred while scanning your ticket. Please try again.');
            })
            .finally(() => {
                // Hide loading indicator
                loadingIndicator.style.display = 'none';
                scanButton.disabled = false;
                console.log("Scan completed - button enabled");
            });
        }
        
        // Event listener for form submission
        ticketForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Only check if a file is selected
            if (!fileInput.files.length) {
                alert('Please select an image of your ticket');
                return;
            }
            
            // Process the ticket with ads
            processTicketWithAds();
            
            // No return false to prevent interfering with normal form submission
        });
        
        // Enable body scrolling
        function enableScrolling() {
            document.body.style.overflow = 'auto';
            document.body.style.height = 'auto';
            console.log('Scrolling enabled');
        }
        
        // Disable body scrolling
        function disableScrolling() {
            document.body.style.overflow = 'hidden';
            document.body.style.height = '100vh';
            console.log('Scrolling disabled');
        }
        
        function displayResults(data) {
            try {
                // Enable scrolling when showing results
                enableScrolling();
                
                // Prepare the results container first
                resultsContainer.classList.remove('d-none');
                
                // Hide error message by default
                document.getElementById('error-message').classList.add('d-none');
                
                if (data.error) {
                    showError(data.error);
                    return;
                }
                
                // Show success content
                const successContent = document.getElementById('success-content');
                successContent.classList.remove('d-none');
            
            // Populate ticket info
            document.getElementById('result-lottery-type').textContent = data.lottery_type;
            document.getElementById('result-draw-number').textContent = data.draw_number;
            document.getElementById('result-draw-date').textContent = data.draw_date;
            
            // Populate detected information from OCR if available
            if (data.ticket_info) {
                document.getElementById('detected-game-type').textContent = data.ticket_info.detected_game_type || 'Unknown';
                document.getElementById('detected-draw-number').textContent = data.ticket_info.detected_draw_number || 'Unknown';
                document.getElementById('detected-draw-date').textContent = data.ticket_info.detected_draw_date || 'Unknown';
            } else {
                document.getElementById('detected-info').classList.add('d-none');
            }
            
            // Display ticket numbers
            const ticketNumbersContainer = document.getElementById('ticket-numbers');
            ticketNumbersContainer.innerHTML = '';
            
            // Check if we have raw selected numbers for a better display
            if (data.ticket_info && data.ticket_info.raw_selected_numbers) {
                // Array to track rows that should be skipped (e.g., A2/B2 rows that are merged with A1/B1)
                const rowsToSkip = [];
                
                // Display numbers by rows
                Object.entries(data.ticket_info.raw_selected_numbers).forEach(([rowName, numbers]) => {
                    // Skip rows that are already handled (bonus number rows like A2, B2)
                    if (rowsToSkip.includes(rowName)) {
                        return;
                    }
                    
                    // Check if this row has any matches
                    const rowMatches = numbers.filter(num => data.winning_numbers.includes(num));
                    const rowBonusMatches = numbers.filter(num => data.bonus_numbers.includes(num));
                    const hasMatches = rowMatches.length > 0 || rowBonusMatches.length > 0;
                    
                    // Create row label with match indicator if applicable
                    const rowLabel = document.createElement('div');
                    rowLabel.classList.add('mt-2', 'mb-1');
                    
                    // Check if this is Row A1, B1, etc. with a corresponding bonus number row
                    let displayRowName = rowName;
                    if (data.lottery_type.toLowerCase().includes('powerball') && 
                        rowName.endsWith('1')) {
                        // Check if we have a corresponding Row "X2" to match this Row "X1"
                        const baseRowName = rowName.charAt(0); // Get the letter part (A, B, etc.)
                        const nextRowName = baseRowName + '2';  // Create the next row name (A2, B2, etc.)
                        
                        // If there's a bonus row, display just "Row A" instead of "Row A1"
                        if (data.ticket_info.raw_selected_numbers[nextRowName] && 
                            data.ticket_info.raw_selected_numbers[nextRowName].length === 1) {
                            displayRowName = baseRowName;
                        }
                    }
                    
                    if (hasMatches) {
                        rowLabel.innerHTML = `<strong>Row ${displayRowName}:</strong> <span class="badge bg-success ms-2">Matches: ${rowMatches.length + rowBonusMatches.length}</span>`;
                    } else {
                        rowLabel.innerHTML = `<strong>Row ${displayRowName}:</strong>`;
                    }
                    ticketNumbersContainer.appendChild(rowLabel);
                    
                    // Create row container
                    const rowContainer = document.createElement('div');
                    rowContainer.classList.add('mb-3');
                    
                    // Track if we should show Powerball/bonus number indicator
                    let isPowerball = false;
                    
                    // For Powerball tickets, if this row is a single-number row (like Row A2 with the bonus number),
                    // it should NOT have a plus sign before it. Instead, the plus sign should come AFTER
                    // the previous row's numbers.
                    
                    // Special handling for Powerball or Powerball Plus where Row A2, B2, etc. are bonus rows
                    if (data.lottery_type.toLowerCase().includes('powerball') && 
                        rowName.endsWith('2') && numbers.length === 1) {
                        isPowerball = true;
                    }
                    
                    // Add balls for this row
                    numbers.forEach((num, index) => {
                        // For Powerball tickets, add a plus sign before the last number (bonus ball)
                        // This is for Row A style display (where we keep the bonus ball on the same line)
                        if (data.lottery_type.toLowerCase().includes('powerball') && 
                            index === numbers.length - 1 && 
                            numbers.length === 6) {
                            const plusSpan = document.createElement('span');
                            plusSpan.classList.add('mx-2', 'my-auto', 'fs-4');
                            plusSpan.textContent = '+';
                            rowContainer.appendChild(plusSpan);
                        }
                        
                        const ball = document.createElement('span');
                        ball.classList.add('lottery-ball');
                        
                        // Check if this number is a match
                        const isMatch = data.winning_numbers.includes(num);
                        const isBonusMatch = data.bonus_numbers.includes(num);
                        
                        if (isMatch || isBonusMatch) {
                            ball.classList.add('ball-matched');
                        }
                        
                        // Add color classes in sequence or special color for Powerball
                        if (isPowerball) {
                            ball.classList.add('lottery-ball-blue', 'lottery-ball-bonus');
                        } else if (rowContainer.children.length % 4 === 0) {
                            ball.classList.add('lottery-ball-red');
                        } else if (rowContainer.children.length % 4 === 1) {
                            ball.classList.add('lottery-ball-yellow');
                        } else if (rowContainer.children.length % 4 === 2) {
                            ball.classList.add('lottery-ball-green');
                        } else {
                            ball.classList.add('lottery-ball-blue');
                        }
                        
                        ball.textContent = num;
                        rowContainer.appendChild(ball);
                    });
                    
                    ticketNumbersContainer.appendChild(rowContainer);
                    
                    // For Powerball tickets, if this is Row A1, B1, etc. and the next row is A2, B2, etc.
                    // We'll handle the bonus number differently - we won't display a separate row
                    if (data.lottery_type.toLowerCase().includes('powerball') && 
                        rowName.endsWith('1')) {
                        // Check if we have a corresponding Row "X2" to match this Row "X1"
                        const baseRowName = rowName.charAt(0); // Get the letter part (A, B, etc.)
                        const nextRowName = baseRowName + '2';  // Create the next row name (A2, B2, etc.)
                        
                        // Check if we have a corresponding bonus row
                        if (data.ticket_info.raw_selected_numbers[nextRowName] && 
                            data.ticket_info.raw_selected_numbers[nextRowName].length === 1) {
                            
                            // Instead of creating a new row, add a plus sign to the end of the current row
                            const plusSpan = document.createElement('span');
                            plusSpan.classList.add('mx-2');
                            plusSpan.textContent = '+';
                            rowContainer.appendChild(plusSpan);
                            
                            // Get the bonus number
                            const bonusNumber = data.ticket_info.raw_selected_numbers[nextRowName][0];
                            
                            // Create the bonus ball in the same row
                            const bonusBall = document.createElement('span');
                            bonusBall.classList.add('lottery-ball', 'lottery-ball-bonus', 'lottery-ball-yellow');
                            
                            // Check if this bonus number is a match
                            const isBonusMatch = data.bonus_numbers.includes(bonusNumber);
                            if (isBonusMatch) {
                                bonusBall.classList.add('ball-matched');
                            }
                            
                            bonusBall.textContent = bonusNumber;
                            rowContainer.appendChild(bonusBall);
                            
                            // Skip the next row since we've already added its number here
                            rowsToSkip.push(nextRowName);
                        }
                    }
                });
            } else {
                // Fallback to flat display if raw data not available
                data.ticket_numbers.forEach(num => {
                    const ball = document.createElement('span');
                    ball.classList.add('lottery-ball');
                    
                    // Add color classes in sequence
                    if (ticketNumbersContainer.children.length % 4 === 0) {
                        ball.classList.add('lottery-ball-red');
                    } else if (ticketNumbersContainer.children.length % 4 === 1) {
                        ball.classList.add('lottery-ball-yellow');
                    } else if (ticketNumbersContainer.children.length % 4 === 2) {
                        ball.classList.add('lottery-ball-green');
                    } else {
                        ball.classList.add('lottery-ball-blue');
                    }
                    
                    ball.textContent = num;
                    ticketNumbersContainer.appendChild(ball);
                });
            }
            
            // Display winning numbers (main numbers with bonus on same line)
            const winningNumbersContainer = document.getElementById('winning-numbers');
            winningNumbersContainer.innerHTML = '';
            
            // Update the game label
            const primaryGameLabel = document.getElementById('primary-game-label');
            primaryGameLabel.textContent = data.lottery_type + ' Numbers:';
            
            // Add main numbers
            data.winning_numbers.forEach(num => {
                const ball = document.createElement('span');
                ball.classList.add('lottery-ball');
                
                // Add color classes in sequence
                if (winningNumbersContainer.children.length % 4 === 0) {
                    ball.classList.add('lottery-ball-red');
                } else if (winningNumbersContainer.children.length % 4 === 1) {
                    ball.classList.add('lottery-ball-yellow');
                } else if (winningNumbersContainer.children.length % 4 === 2) {
                    ball.classList.add('lottery-ball-green');
                } else {
                    ball.classList.add('lottery-ball-blue');
                }
                
                ball.textContent = num;
                winningNumbersContainer.appendChild(ball);
            });
            
            // Add a plus sign followed immediately by bonus numbers on the same line
            if (data.bonus_numbers && data.bonus_numbers.length > 0) {
                // Add plus sign
                const plusSpan = document.createElement('span');
                plusSpan.classList.add('mx-2', 'my-auto', 'fs-4');
                plusSpan.textContent = '+';
                winningNumbersContainer.appendChild(plusSpan);
                
                // Add bonus balls to the same container as main numbers
                data.bonus_numbers.forEach(num => {
                    const ball = document.createElement('span');
                    // Make bonus balls visually distinct
                    ball.classList.add('lottery-ball', 'lottery-ball-yellow');
                    ball.textContent = num;
                    winningNumbersContainer.appendChild(ball);
                });
            }
            
            // Update the hidden bonus container (we don't display it separately anymore)
            const bonusNumbersContainer = document.getElementById('bonus-numbers');
            bonusNumbersContainer.innerHTML = '';
            document.getElementById('bonus-numbers-container').classList.add('d-none');
            
            // Display unique matched numbers under the winning numbers
            const matchedNumbersContainer = document.getElementById('matched-numbers');
            matchedNumbersContainer.innerHTML = '';
            
            // Get unique matched numbers
            const uniqueMatchedNumbers = [...new Set(data.matched_numbers)];
            document.getElementById('matched-count').textContent = uniqueMatchedNumbers.length;
            
            if (uniqueMatchedNumbers.length > 0) {
                uniqueMatchedNumbers.forEach(num => {
                    const ball = document.createElement('span');
                    ball.classList.add('lottery-ball', 'ball-matched');
                    
                    // Add color classes in sequence
                    if (matchedNumbersContainer.children.length % 4 === 0) {
                        ball.classList.add('lottery-ball-red');
                    } else if (matchedNumbersContainer.children.length % 4 === 1) {
                        ball.classList.add('lottery-ball-yellow');
                    } else if (matchedNumbersContainer.children.length % 4 === 2) {
                        ball.classList.add('lottery-ball-green');
                    } else {
                        ball.classList.add('lottery-ball-blue');
                    }
                    
                    ball.textContent = num;
                    matchedNumbersContainer.appendChild(ball);
                });
            } else {
                matchedNumbersContainer.innerHTML = '<p>No matching numbers found.</p>';
            }
            
            // Get unique matched bonus numbers and add them to the matched numbers section
            if (data.matched_bonus && data.matched_bonus.length > 0) {
                const uniqueMatchedBonus = [...new Set(data.matched_bonus)];
                
                // Add a separator if there are also matched main numbers
                if (uniqueMatchedNumbers.length > 0) {
                    const separator = document.createElement('div');
                    separator.classList.add('mt-2', 'mb-2');
                    separator.innerHTML = '<strong>Matched Bonus:</strong>';
                    matchedNumbersContainer.appendChild(separator);
                }
                
                uniqueMatchedBonus.forEach(num => {
                    const ball = document.createElement('span');
                    ball.classList.add('lottery-ball', 'ball-matched', 'lottery-ball-yellow');
                    ball.style.animation = 'pulse 2s infinite';
                    ball.textContent = num;
                    matchedNumbersContainer.appendChild(ball);
                });
            }
            
            // Display prize information if any
            const prizeContainer = document.getElementById('prize-container');
            const noPrizeContainer = document.getElementById('no-prize-container');
            
            if (data.has_prize) {
                prizeContainer.classList.remove('d-none');
                noPrizeContainer.classList.add('d-none');
                
                document.getElementById('prize-lottery-type').textContent = data.lottery_type;
                document.getElementById('prize-draw-number').textContent = data.draw_number;
                document.getElementById('prize-division').textContent = data.prize_info.division;
                document.getElementById('prize-match-type').textContent = data.prize_info.match_type;
                document.getElementById('prize-amount').textContent = data.prize_info.prize_amount;
            } else {
                prizeContainer.classList.add('d-none');
                noPrizeContainer.classList.remove('d-none');
            }
            
            // Check if ticket also plays Powerball Plus and display those results
            // Make sure we only show the Powerball Plus section if this ticket plays Powerball Plus
            if (data.lottery_type === "Powerball" && data.powerball_plus_results) {
                // Update the primary game label to include the game name
                const primaryGameLabel = document.getElementById('primary-game-label');
                primaryGameLabel.textContent = 'Powerball Numbers:';
                
                // Powerball Plus Numbers - Add to the main winning numbers card
                const ppNumbersContainer = document.getElementById('powerball-plus-numbers-container');
                const ppNumbersDiv = document.getElementById('powerball-plus-numbers');
                
                // Show the container
                ppNumbersContainer.classList.remove('d-none');
                ppNumbersDiv.innerHTML = '';
                
                // Add main numbers
                data.powerball_plus_results.winning_numbers.forEach((num, index) => {
                    const ball = document.createElement('span');
                    ball.classList.add('lottery-ball');
                    
                    // Add color classes in sequence
                    if (index % 4 === 0) {
                        ball.classList.add('lottery-ball-red');
                    } else if (index % 4 === 1) {
                        ball.classList.add('lottery-ball-yellow');
                    } else if (index % 4 === 2) {
                        ball.classList.add('lottery-ball-green');
                    } else {
                        ball.classList.add('lottery-ball-blue');
                    }
                    
                    ball.textContent = num;
                    ppNumbersDiv.appendChild(ball);
                });
                
                // Always add a plus sign between main numbers and bonus, even if there's only one bonus number
                if (data.powerball_plus_results.bonus_numbers && data.powerball_plus_results.bonus_numbers.length > 0) {
                    const plusSpan = document.createElement('span');
                    plusSpan.classList.add('mx-2', 'my-auto', 'fs-4');
                    plusSpan.textContent = '+';
                    ppNumbersDiv.appendChild(plusSpan);
                    
                    // Add bonus numbers
                    data.powerball_plus_results.bonus_numbers.forEach(num => {
                        const ball = document.createElement('span');
                        ball.classList.add('lottery-ball', 'lottery-ball-yellow');
                        ball.textContent = num;
                        ppNumbersDiv.appendChild(ball);
                    });
                }
                
                // Display Powerball Plus matches in the main card (with unique matched numbers)
                if (data.powerball_plus_results.matched_numbers.length > 0 || data.powerball_plus_results.matched_bonus.length > 0) {
                    // Show the PowerballPlus matches container
                    const ppMatchesContainer = document.getElementById('pp-matched-numbers-section');
                    
                    // Get unique matched numbers
                    const uniquePPMatchedNumbers = [...new Set(data.powerball_plus_results.matched_numbers)];
                    
                    // Update matched count
                    document.getElementById('pp-matched-count').textContent = uniquePPMatchedNumbers.length;
                    
                    // Display matched numbers
                    const ppMatchedNumbersDiv = document.getElementById('pp-matched-numbers');
                    ppMatchedNumbersDiv.innerHTML = '';
                    
                    if (uniquePPMatchedNumbers.length > 0) {
                        uniquePPMatchedNumbers.forEach(num => {
                            const ball = document.createElement('span');
                            ball.classList.add('lottery-ball', 'ball-matched');
                            
                            // Add color classes in sequence
                            if (ppMatchedNumbersDiv.children.length % 4 === 0) {
                                ball.classList.add('lottery-ball-red');
                            } else if (ppMatchedNumbersDiv.children.length % 4 === 1) {
                                ball.classList.add('lottery-ball-yellow');
                            } else if (ppMatchedNumbersDiv.children.length % 4 === 2) {
                                ball.classList.add('lottery-ball-green');
                            } else {
                                ball.classList.add('lottery-ball-blue');
                            }
                            
                            ball.textContent = num;
                            ppMatchedNumbersDiv.appendChild(ball);
                        });
                    } else {
                        ppMatchedNumbersDiv.innerHTML = '<p>No matching main numbers found for Powerball Plus.</p>';
                    }
                    
                    // Get unique matched bonus numbers and add them to the matched numbers section
                    if (data.powerball_plus_results.matched_bonus && data.powerball_plus_results.matched_bonus.length > 0) {
                        const uniquePPMatchedBonus = [...new Set(data.powerball_plus_results.matched_bonus)];
                        
                        // Add a separator if there are also matched main numbers
                        if (uniquePPMatchedNumbers.length > 0) {
                            const separator = document.createElement('div');
                            separator.classList.add('mt-2', 'mb-2');
                            separator.innerHTML = '<strong>Matched Bonus:</strong>';
                            ppMatchedNumbersDiv.appendChild(separator);
                        }
                        
                        uniquePPMatchedBonus.forEach(num => {
                            const ball = document.createElement('span');
                            ball.classList.add('lottery-ball', 'ball-matched', 'lottery-ball-yellow');
                            ball.style.animation = 'pulse 2s infinite';
                            ball.textContent = num;
                            ppMatchedNumbersDiv.appendChild(ball);
                        });
                    }
                }
                
                // Keep the separate card for prize information
                const powerballPlusContainer = document.getElementById('powerball-plus-container');
                if (powerballPlusContainer) {
                    // Show the container for prize information
                    powerballPlusContainer.classList.remove('d-none');
                    
                    // Create header for prize information
                    powerballPlusContainer.innerHTML = '';  // Clear any existing content
                    
                    // Only display prize information if there is a prize
                    if (data.powerball_plus_results.has_prize) {
                        // Create a card for Powerball Plus prize
                        const ppPrizeCard = document.createElement('div');
                        ppPrizeCard.classList.add('card', 'mb-4');
                        
                        // Card header
                        const ppCardHeader = document.createElement('div');
                        ppCardHeader.classList.add('card-header', 'bg-primary', 'text-white');
                        ppCardHeader.innerHTML = `<h5 class="mb-0">Powerball Plus Prize</h5>`;
                        ppPrizeCard.appendChild(ppCardHeader);
                        
                        // Card body
                        const ppCardBody = document.createElement('div');
                        ppCardBody.classList.add('card-body');
                        
                        // Prize information
                        const ppPrizeSection = document.createElement('div');
                        ppPrizeSection.classList.add('alert', 'alert-success', 'mt-3');
                        ppPrizeSection.innerHTML = `
                            <h6 class="alert-heading">Congratulations! You won a prize in Powerball Plus:</h6>
                            <p>Division: ${data.powerball_plus_results.prize_info.division}</p>
                            <p>Match Type: ${data.powerball_plus_results.prize_info.match_type}</p>
                            <p>Prize Amount: ${data.powerball_plus_results.prize_info.prize_amount}</p>
                        `;
                        ppCardBody.appendChild(ppPrizeSection);
                        
                        ppPrizeCard.appendChild(ppCardBody);
                        powerballPlusContainer.appendChild(ppPrizeCard);
                    }
                }
            } else {
                // Get the Powerball Plus container and hide it if it exists
                const powerballPlusContainer = document.getElementById('powerball-plus-container');
                if (powerballPlusContainer) {
                    powerballPlusContainer.classList.add('d-none');
                }
            }
            
            // Handle Lotto Plus 1 numbers if present - but only if the main game is Lotto
            if (data.lottery_type === "Lotto" && data.lotto_plus_1_results) {
                // Get the Lotto Plus 1 container
                const lp1Container = document.getElementById('lotto-plus-1-numbers-container');
                const lp1NumbersDiv = document.getElementById('lotto-plus-1-numbers');
                
                // Show the container
                lp1Container.classList.remove('d-none');
                lp1NumbersDiv.innerHTML = '';
                
                // Add main numbers
                data.lotto_plus_1_results.winning_numbers.forEach((num, index) => {
                    const ball = document.createElement('span');
                    ball.classList.add('lottery-ball');
                    
                    // Add color classes in sequence
                    if (index % 4 === 0) {
                        ball.classList.add('lottery-ball-red');
                    } else if (index % 4 === 1) {
                        ball.classList.add('lottery-ball-yellow');
                    } else if (index % 4 === 2) {
                        ball.classList.add('lottery-ball-green');
                    } else {
                        ball.classList.add('lottery-ball-blue');
                    }
                    
                    ball.textContent = num;
                    lp1NumbersDiv.appendChild(ball);
                });
                
                // Add plus sign and bonus numbers
                if (data.lotto_plus_1_results.bonus_numbers && data.lotto_plus_1_results.bonus_numbers.length > 0) {
                    const plusSpan = document.createElement('span');
                    plusSpan.classList.add('mx-2', 'my-auto', 'fs-4');
                    plusSpan.textContent = '+';
                    lp1NumbersDiv.appendChild(plusSpan);
                    
                    // Add bonus numbers
                    data.lotto_plus_1_results.bonus_numbers.forEach(num => {
                        const ball = document.createElement('span');
                        ball.classList.add('lottery-ball', 'lottery-ball-yellow');
                        ball.textContent = num;
                        lp1NumbersDiv.appendChild(ball);
                    });
                }
                
                // Display Lotto Plus 1 matches
                if (data.lotto_plus_1_results.matched_numbers.length > 0 || 
                    (data.lotto_plus_1_results.matched_bonus && data.lotto_plus_1_results.matched_bonus.length > 0)) {
                    
                    // Show the Lotto Plus 1 matches container
                    const lp1MatchesContainer = document.getElementById('lp1-matched-numbers-section');
                    
                    // Get unique matched numbers
                    const uniqueLP1MatchedNumbers = [...new Set(data.lotto_plus_1_results.matched_numbers)];
                    
                    // Update matched count
                    document.getElementById('lp1-matched-count').textContent = uniqueLP1MatchedNumbers.length;
                    
                    // Display matched numbers
                    const lp1MatchedNumbersDiv = document.getElementById('lp1-matched-numbers');
                    lp1MatchedNumbersDiv.innerHTML = '';
                    
                    if (uniqueLP1MatchedNumbers.length > 0) {
                        uniqueLP1MatchedNumbers.forEach(num => {
                            const ball = document.createElement('span');
                            ball.classList.add('lottery-ball', 'ball-matched');
                            
                            // Add color classes in sequence
                            if (lp1MatchedNumbersDiv.children.length % 4 === 0) {
                                ball.classList.add('lottery-ball-red');
                            } else if (lp1MatchedNumbersDiv.children.length % 4 === 1) {
                                ball.classList.add('lottery-ball-yellow');
                            } else if (lp1MatchedNumbersDiv.children.length % 4 === 2) {
                                ball.classList.add('lottery-ball-green');
                            } else {
                                ball.classList.add('lottery-ball-blue');
                            }
                            
                            ball.textContent = num;
                            lp1MatchedNumbersDiv.appendChild(ball);
                        });
                    } else {
                        lp1MatchedNumbersDiv.innerHTML = '<p>No matching main numbers found for Lotto Plus 1.</p>';
                    }
                    
                    // Get unique matched bonus numbers and add them to the matched numbers section
                    if (data.lotto_plus_1_results.matched_bonus && data.lotto_plus_1_results.matched_bonus.length > 0) {
                        const uniqueLP1MatchedBonus = [...new Set(data.lotto_plus_1_results.matched_bonus)];
                        
                        // Add a separator if there are also matched main numbers
                        if (uniqueLP1MatchedNumbers.length > 0) {
                            const separator = document.createElement('div');
                            separator.classList.add('mt-2', 'mb-2');
                            separator.innerHTML = '<strong>Matched Bonus:</strong>';
                            lp1MatchedNumbersDiv.appendChild(separator);
                        }
                        
                        uniqueLP1MatchedBonus.forEach(num => {
                            const ball = document.createElement('span');
                            ball.classList.add('lottery-ball', 'ball-matched', 'lottery-ball-yellow');
                            ball.style.animation = 'pulse 2s infinite';
                            ball.textContent = num;
                            lp1MatchedNumbersDiv.appendChild(ball);
                        });
                    }
                }
            }
            
            // Handle Lotto Plus 2 numbers if present - but only if the main game is Lotto
            if (data.lottery_type === "Lotto" && data.lotto_plus_2_results) {
                // Get the Lotto Plus 2 container
                const lp2Container = document.getElementById('lotto-plus-2-numbers-container');
                const lp2NumbersDiv = document.getElementById('lotto-plus-2-numbers');
                
                // Show the container
                lp2Container.classList.remove('d-none');
                lp2NumbersDiv.innerHTML = '';
                
                // Add main numbers
                data.lotto_plus_2_results.winning_numbers.forEach((num, index) => {
                    const ball = document.createElement('span');
                    ball.classList.add('lottery-ball');
                    
                    // Add color classes in sequence
                    if (index % 4 === 0) {
                        ball.classList.add('lottery-ball-red');
                    } else if (index % 4 === 1) {
                        ball.classList.add('lottery-ball-yellow');
                    } else if (index % 4 === 2) {
                        ball.classList.add('lottery-ball-green');
                    } else {
                        ball.classList.add('lottery-ball-blue');
                    }
                    
                    ball.textContent = num;
                    lp2NumbersDiv.appendChild(ball);
                });
                
                // Add plus sign and bonus numbers
                if (data.lotto_plus_2_results.bonus_numbers && data.lotto_plus_2_results.bonus_numbers.length > 0) {
                    const plusSpan = document.createElement('span');
                    plusSpan.classList.add('mx-2', 'my-auto', 'fs-4');
                    plusSpan.textContent = '+';
                    lp2NumbersDiv.appendChild(plusSpan);
                    
                    // Add bonus numbers
                    data.lotto_plus_2_results.bonus_numbers.forEach(num => {
                        const ball = document.createElement('span');
                        ball.classList.add('lottery-ball', 'lottery-ball-yellow');
                        ball.textContent = num;
                        lp2NumbersDiv.appendChild(ball);
                    });
                }
                
                // Display Lotto Plus 2 matches
                if (data.lotto_plus_2_results.matched_numbers.length > 0 || 
                    (data.lotto_plus_2_results.matched_bonus && data.lotto_plus_2_results.matched_bonus.length > 0)) {
                    
                    // Show the Lotto Plus 2 matches container
                    const lp2MatchesContainer = document.getElementById('lp2-matched-numbers-section');
                    
                    // Get unique matched numbers
                    const uniqueLP2MatchedNumbers = [...new Set(data.lotto_plus_2_results.matched_numbers)];
                    
                    // Update matched count
                    document.getElementById('lp2-matched-count').textContent = uniqueLP2MatchedNumbers.length;
                    
                    // Display matched numbers
                    const lp2MatchedNumbersDiv = document.getElementById('lp2-matched-numbers');
                    lp2MatchedNumbersDiv.innerHTML = '';
                    
                    // Display both main and bonus matches together
                    const allLP2Matches = [...uniqueLP2MatchedNumbers];
                    
                    // Add bonus matches if they exist
                    if (data.lotto_plus_2_results.matched_bonus && data.lotto_plus_2_results.matched_bonus.length > 0) {
                        // Add bonus numbers to the main matched numbers display
                        allLP2Matches.push(...data.lotto_plus_2_results.matched_bonus);
                    }
                    
                    if (allLP2Matches.length > 0) {
                        allLP2Matches.forEach(num => {
                            const ball = document.createElement('span');
                            ball.classList.add('lottery-ball', 'ball-matched');
                            
                            // Style bonus numbers differently if needed
                            if (data.lotto_plus_2_results.bonus_numbers.includes(num)) {
                                ball.classList.add('lottery-ball-yellow');
                                ball.style.animation = 'pulse 2s infinite';
                            } else {
                                // Add color classes in sequence for regular numbers
                                if (lp2MatchedNumbersDiv.children.length % 4 === 0) {
                                    ball.classList.add('lottery-ball-red');
                                } else if (lp2MatchedNumbersDiv.children.length % 4 === 1) {
                                    ball.classList.add('lottery-ball-yellow');
                                } else if (lp2MatchedNumbersDiv.children.length % 4 === 2) {
                                    ball.classList.add('lottery-ball-green');
                                } else {
                                    ball.classList.add('lottery-ball-blue');
                                }
                            }
                            
                            ball.textContent = num;
                            lp2MatchedNumbersDiv.appendChild(ball);
                        });
                    } else {
                        lp2MatchedNumbersDiv.innerHTML = '<p>No matching numbers found for Lotto Plus 2.</p>';
                    }
                }
            }
            
            // Scroll to results with a slight delay to ensure DOM is updated
            setTimeout(() => {
                window.scrollTo({
                    top: resultsContainer.offsetTop,
                    behavior: 'smooth'
                });
                // Make sure scrolling is fully enabled
                enableScrolling();
            }, 300);
            } catch (error) {
                console.error("Error displaying results:", error);
                showError("An error occurred while displaying results. Please try again.");
                enableScrolling();
            }
        }
        
        function showError(message) {
            // Ensure scrolling is enabled
            enableScrolling();
            
            const errorMessage = document.getElementById('error-message');
            const errorText = document.getElementById('error-text');
            const successContent = document.getElementById('success-content');
            
            errorText.textContent = message;
            errorMessage.classList.remove('d-none');
            successContent.classList.add('d-none');
        }
    });
</script>
{% endblock %}