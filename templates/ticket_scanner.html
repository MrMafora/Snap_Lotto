{% extends "base.html" %}

{% block title %}South African Lottery Scanner{% endblock %}

{% block content %}
<div class="container py-3">
    <div class="row mb-3">
        <div class="col-12">
            <h1 class="d-flex align-items-center">
                <i class="fa fa-ticket-alt me-2"></i> South African Lottery Scanner
            </h1>
            <p class="lead mb-2">Upload any SA lottery ticket - PowerBall, Lotto, Daily Lotto & more!</p>
            <p class="mb-3"><a href="/scanner-landing" class="text-decoration-none"><i class="fas fa-arrow-left me-1"></i> Back to Scanner Info</a></p>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-4 col-md-5 mb-4">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fa fa-upload me-2"></i>Upload Ticket</h5>
                </div>
                <div class="card-body">
                    <div class="ticket-scanner-container">
                        <div class="alert alert-info py-2 small d-flex align-items-center mb-3">
                            <i class="fa fa-info-circle me-2 flex-shrink-0"></i> 
                            <span>Take a clear photo of your lottery ticket, making sure all numbers are visible.</span>
                        </div>

                        <form id="ticket-form">
                            
                            <div class="mb-2">
                                <label for="lottery-type" class="form-label small">Select Lottery Type (Optional - AI will detect)</label>
                                <select class="form-select form-select-sm" id="lottery-type" name="lottery_type">
                                    <option value="">Auto-detect from ticket</option>
                                    <option value="Lottery">Lottery</option>
                                    <option value="Lottery Plus 1">Lottery Plus 1</option>
                                    <option value="Lottery Plus 2">Lottery Plus 2</option>
                                    <option value="Powerball">Powerball</option>
                                    <option value="Powerball Plus">Powerball Plus</option>
                                    <option value="Daily Lottery">Daily Lottery</option>
                                </select>
                            </div>

                            <div class="mb-2">
                                <label for="draw-number" class="form-label small">Draw Number (optional)</label>
                                <input type="text" class="form-control form-control-sm" id="draw-number" name="draw_number" 
                                    placeholder="Leave blank to check latest draw">
                            </div>

                            <div class="ticket-drop-area" id="drop-area">
                                <div class="mb-2 text-center">
                                    <i class="fa fa-camera fa-2x mb-2 text-primary d-block d-sm-none"></i>
                                    <i class="fa fa-upload fa-2x mb-2 text-primary d-none d-sm-block"></i>
                                    <h5 class="mb-2 d-none d-sm-block">Drag and drop your ticket image here</h5>
                                    <h5 class="mb-2 d-block d-sm-none">Take or Upload Ticket Photo</h5>
                                    <p class="mb-2 small text-muted d-none d-sm-block">or</p>
                                    <input type="file" id="ticket-image" name="ticket_image" accept="image/*" capture="environment" class="d-none">
                                    <button type="button" id="file-select-btn" class="btn btn-primary btn-lg w-100 w-sm-auto">
                                        <i class="fa fa-camera me-2 d-block d-sm-none"></i>
                                        <i class="fa fa-folder-open me-2 d-none d-sm-block"></i>
                                        <span class="d-block d-sm-none">Take or Upload Photo</span>
                                        <span class="d-none d-sm-block">Select Image</span>
                                    </button>
                                    <div class="mt-2 small text-muted">
                                        Supports: JPG, PNG, WEBP â€¢ Max: 10MB
                                    </div>
                                </div>
                            </div>

                            <div id="preview-container" class="text-center d-none">
                                <h6>Preview</h6>
                                <img id="ticket-preview" class="ticket-preview img-fluid rounded" src="">
                                <div class="mt-2">
                                    <button type="button" id="remove-image" class="btn btn-sm btn-outline-danger">
                                        <i class="fa fa-times"></i> Remove
                                    </button>
                                </div>
                            </div>

                            <div class="text-center mt-4">
                                <button type="submit" id="scan-button" class="btn btn-success btn-lg">
                                    <i class="fa fa-search me-2"></i> Scan Ticket
                                </button>
                                <div id="scanner-loading" class="mt-3" style="display: none;">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p>Scanning your ticket...</p>
                                </div>
                            </div>
                        </form>

                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-8 col-md-7">
            <div id="results-container" class="results-container d-none">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">ðŸŽ« Ticket Scanner Results</h5>
                    </div>
                    <div class="card-body">
                            
                            <div id="error-message" class="alert alert-danger d-none">
                                <i class="fa fa-exclamation-triangle me-2"></i>
                                <span id="error-text"></span>
                            </div>
                            
                            <div id="success-content" class="d-none">
                                <!-- Ticket Info Header -->
                                <div class="mb-3 p-3 bg-light rounded">
                                    <div class="row">
                                        <div class="col-md-12">
                                            <h5 class="mb-2">ðŸŽ« <span id="detected-lottery-type"></span> Ticket <span id="plus-indicator"></span></h5>
                                            <p class="mb-0"><strong>Draw:</strong> <span id="detected-draw-number"></span> â€¢ <strong>Date:</strong> <span id="detected-draw-date"></span></p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Your Numbers Section -->
                                <div class="mb-4">
                                    <div id="ticket-numbers" class="numbers-display"></div>
                                </div>

                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0" id="results-title">Results</h5>
                                    </div>
                                    <div class="card-body">
                                        <div id="winning-info"></div>
                                        <div id="prize-info" class="mt-3"></div>
                                    </div>
                                </div>

                                <div class="text-center mt-3">
                                    <button type="button" id="scan-another" class="btn btn-outline-primary">
                                        <i class="fa fa-camera me-2"></i> Scan Another Ticket
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Get DOM elements
    const ticketForm = document.getElementById('ticket-form');
    const fileInput = document.getElementById('ticket-image');
    const fileSelectBtn = document.getElementById('file-select-btn');
    const previewContainer = document.getElementById('preview-container');
    const ticketPreview = document.getElementById('ticket-preview');
    const removeImageBtn = document.getElementById('remove-image');
    const scanButton = document.getElementById('scan-button');
    const loadingIndicator = document.getElementById('scanner-loading');
    const resultsContainer = document.getElementById('results-container');
    const dropArea = document.getElementById('drop-area');
    const scanAnotherBtn = document.getElementById('scan-another');

    // File selection
    fileSelectBtn.addEventListener('click', function(e) {
        e.preventDefault();
        console.log('File select button clicked');
        fileInput.click();
    });

    // Handle file selection
    fileInput.addEventListener('change', function() {
        console.log('File input changed, files:', this.files.length);
        if (this.files.length > 0) {
            console.log('File selected:', this.files[0].name, this.files[0].type);
            handleFileSelection(this.files[0]);
        }
    });

    // Handle drag and drop
    dropArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        dropArea.classList.add('drag-over');
    });

    dropArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        dropArea.classList.remove('drag-over');
    });

    dropArea.addEventListener('drop', function(e) {
        e.preventDefault();
        dropArea.classList.remove('drag-over');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            handleFileSelection(files[0]);
        }
    });

    // Remove image
    removeImageBtn.addEventListener('click', function() {
        resetForm();
    });

    // Scan another ticket
    scanAnotherBtn.addEventListener('click', function() {
        resetForm();
        resultsContainer.classList.add('d-none');
    });

    // Form submission
    ticketForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Check if file is selected
        if (!fileInput.files.length) {
            showError('Please select a ticket image first.');
            return;
        }

        // Show loading
        loadingIndicator.style.display = 'block';
        scanButton.disabled = true;
        
        // Clear previous results
        clearResults();
        
        // Submit form
        const formData = new FormData(ticketForm);
        
        fetch('/process-ticket', {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            if (!response.ok) {
                return response.text().then(text => {
                    throw new Error('Server error: ' + response.status + ' - ' + text);
                });
            }
            return response.json();
        })
        .then(data => {
            console.log('Received response data:', data);
            
            // Hide loading
            loadingIndicator.style.display = 'none';
            scanButton.disabled = false;
            
            if (!data || !data.success) {
                console.error('Processing failed:', data);
                showError(data?.error || 'Failed to process ticket. Please try again.');
                return;
            }
            
            console.log('Processing successful, calling displayResults');
            // Extract data from nested response structure
            const ticketData = data.data || data;
            displayResults(ticketData);
        })
        .catch(error => {
            console.error('Error processing ticket:', error);
            loadingIndicator.style.display = 'none';
            scanButton.disabled = false;
            
            // Better error handling for different error types
            let errorMessage = 'Failed to process ticket. Please try again.';
            if (error && error.message) {
                errorMessage = error.message;
            } else if (typeof error === 'string') {
                errorMessage = error;
            }
            
            showError('Error processing ticket: ' + errorMessage);
        });
    });

    // Helper functions
    function handleFileSelection(file) {
        if (!file) return;
        
        if (!file.type.startsWith('image/')) {
            showError('Please select a valid image file.');
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            ticketPreview.src = e.target.result;
            previewContainer.classList.remove('d-none');
            clearResults();
        };
        reader.readAsDataURL(file);
    }

    function resetForm() {
        fileInput.value = '';
        ticketPreview.src = '';
        previewContainer.classList.add('d-none');
        clearResults();
    }

    function clearResults() {
        resultsContainer.classList.add('d-none');
        document.getElementById('error-message').classList.add('d-none');
        document.getElementById('success-content').classList.add('d-none');
    }

    function showError(message) {
        document.getElementById('error-text').textContent = message;
        document.getElementById('error-message').classList.remove('d-none');
        document.getElementById('success-content').classList.add('d-none');
        resultsContainer.classList.remove('d-none');
    }

    function displayResults(data) {
        console.log('Displaying ticket results:', data);
        
        // Show the main results container
        const resultsContainer = document.getElementById('results-container');
        const successContent = document.getElementById('success-content');
        const errorContainer = document.getElementById('error-message');
        
        // Hide error message first
        if (errorContainer) {
            errorContainer.classList.add('d-none');
        }
        
        if (resultsContainer) {
            resultsContainer.classList.remove('d-none');
        }
        if (successContent) {
            successContent.classList.remove('d-none');
        }
        
        // Display ticket info
        const lotteryTypeEl = document.getElementById('detected-lottery-type');
        const drawDateEl = document.getElementById('detected-draw-date');
        const drawNumberEl = document.getElementById('detected-draw-number');
        
        if (lotteryTypeEl) {
            lotteryTypeEl.textContent = data.lottery_type || 'Not detected';
        }
        
        // Handle Plus indicator separately
        const plusIndicatorEl = document.getElementById('plus-indicator');
        if (plusIndicatorEl) {
            if (data.powerball_plus_included === 'YES' || 
                data.lotto_plus_1_included === 'YES' || 
                data.lotto_plus_2_included === 'YES') {
                plusIndicatorEl.innerHTML = '<span class="badge bg-success ms-2"><i class="fa fa-check me-1"></i>Plus</span>';
            } else {
                plusIndicatorEl.innerHTML = '';
            }
        }
        if (drawDateEl) drawDateEl.textContent = data.draw_date || 'Not detected';
        if (drawNumberEl) drawNumberEl.textContent = data.draw_number || 'Not detected';
        
        // Display comprehensive match analysis results
        displayMatchAnalysis(data);
        
        // Display ticket numbers - show all lines if available
        const numbersContainer = document.getElementById('ticket-numbers');
        if (numbersContainer) {
            numbersContainer.innerHTML = '';
            
            if (data.all_lines && data.all_lines.length > 0) {
                // Show all lines - data.all_lines contains arrays of numbers directly
                data.all_lines.forEach((lineNumbers, index) => {
                    const lineDiv = document.createElement('div');
                    lineDiv.className = 'mb-3';
                    
                    const lineTitle = document.createElement('div');
                lineTitle.innerHTML = `<strong>Line ${index + 1} Numbers:</strong>`;
                lineTitle.className = 'mb-2';
                lineDiv.appendChild(lineTitle);
                
                // Create container for lottery balls
                const ballsContainer = document.createElement('div');
                ballsContainer.className = 'd-flex flex-wrap gap-2 mb-2';
                
                // Initialize winning numbers arrays - ensure they're always defined
                let winningNumbers = [];
                let winningPowerball = '';
                let winningPlusNumbers = [];
                let winningPlusPowerball = '';
                
                // Get PowerBall winning numbers for comparison
                if (data.powerball_results && data.powerball_results.winning_numbers) {
                    try {
                        winningNumbers = JSON.parse(data.powerball_results.winning_numbers || '[]').map(n => parseInt(n));
                    } catch (e) {
                        console.log('Could not parse PowerBall winning numbers for comparison');
                        winningNumbers = [];
                    }
                    let pbNumber = data.powerball_results.winning_powerball ? 
                        data.powerball_results.winning_powerball.toString().replace(/[\[\]"]/g, '') : '';
                    if (pbNumber.includes(',')) {
                        pbNumber = pbNumber.split(',')[0];
                    }
                    winningPowerball = pbNumber;
                }
                
                // Get PowerBall Plus winning numbers if ticket includes it
                if (data.powerball_plus_results && data.powerball_plus_results.winning_numbers && (data.powerball_plus_included === "YES" || data.ticket_data?.powerball_plus_included === "YES")) {
                    try {
                        winningPlusNumbers = JSON.parse(data.powerball_plus_results.winning_numbers || '[]').map(n => parseInt(n));
                    } catch (e) {
                        console.log('Could not parse PowerBall Plus winning numbers for comparison');
                        winningPlusNumbers = [];
                    }
                    let pbPlusNumber = data.powerball_plus_results.winning_powerball ? 
                        data.powerball_plus_results.winning_powerball.toString().replace(/[\[\]"]/g, '') : '';
                    if (pbPlusNumber.includes(',')) {
                        pbPlusNumber = pbPlusNumber.split(',')[0];
                    }
                    winningPlusPowerball = pbPlusNumber;
                }
                
                // Count matches for this line
                let lineMatches = 0;
                
                // Count matches for both PowerBall and PowerBall Plus
                let lineMatchesPB = 0;
                let lineMatchesPBPlus = 0;
                
                // Add main numbers as lottery balls with colors and match indicators
                lineNumbers.forEach((num, numIndex) => {
                    const isMatchPB = winningNumbers.includes(parseInt(num));
                    const isMatchPBPlus = winningPlusNumbers.includes(parseInt(num));
                    const isMatch = isMatchPB || isMatchPBPlus;
                    
                    if (isMatchPB) lineMatchesPB++;
                    if (isMatchPBPlus) lineMatchesPBPlus++;
                    
                    const colors = ['lottery-ball-red', 'lottery-ball-blue', 'lottery-ball-green', 'lottery-ball-yellow'];
                    const colorClass = colors[numIndex % colors.length];
                    
                    const ballWrapper = document.createElement('div');
                    ballWrapper.className = 'position-relative d-inline-block';
                    
                    const ballElement = document.createElement('div');
                    ballElement.className = `lottery-ball ${colorClass} me-1 mb-1`;
                    ballElement.textContent = num;
                    
                    // Add check mark for matches
                    if (isMatch) {
                        const checkMark = document.createElement('div');
                        checkMark.className = 'position-absolute';
                        checkMark.style.top = '-8px';
                        checkMark.style.right = '-8px';
                        checkMark.style.backgroundColor = '#28a745';
                        checkMark.style.color = 'white';
                        checkMark.style.borderRadius = '50%';
                        checkMark.style.width = '20px';
                        checkMark.style.height = '20px';
                        checkMark.style.display = 'flex';
                        checkMark.style.alignItems = 'center';
                        checkMark.style.justifyContent = 'center';
                        checkMark.style.fontSize = '12px';
                        checkMark.style.fontWeight = 'bold';
                        checkMark.innerHTML = 'âœ“';
                        ballWrapper.appendChild(checkMark);
                    }
                    
                    ballWrapper.appendChild(ballElement);
                    ballsContainer.appendChild(ballWrapper);
                });
                
                lineDiv.appendChild(ballsContainer);
                
                // Get PowerBall number for this line - check ticket_data first
                let powerballNum = null;
                
                // First try from ticket_data (most reliable source)
                if (data.ticket_data && data.ticket_data.all_powerball && data.ticket_data.all_powerball.length > index) {
                    powerballNum = data.ticket_data.all_powerball[index].toString().replace(/[\[\]"]/g, '');
                } else if (data.ticket_data && data.ticket_data.all_powerball && data.ticket_data.all_powerball.length > 0) {
                    powerballNum = data.ticket_data.all_powerball[0].toString().replace(/[\[\]"]/g, '');
                }
                
                // Fallback to other sources if needed
                if (!powerballNum && data.all_powerball && data.all_powerball.length > index) {
                    powerballNum = data.all_powerball[index].toString().replace(/[\[\]"]/g, '');
                } else if (!powerballNum && data.all_powerball && data.all_powerball.length > 0) {
                    powerballNum = data.all_powerball[0].toString().replace(/[\[\]"]/g, '');
                } else if (!powerballNum && data.powerball_number && data.powerball_number !== "Not detected") {
                    powerballNum = data.powerball_number.toString().replace(/[\[\]"]/g, '');
                }
                
                // Show "Not detected" only if really no number found
                if (!powerballNum || powerballNum === '' || powerballNum === 'Not detected') {
                    powerballNum = 'Not detected';
                }
                
                if (powerballNum) {
                    const isPowerballMatch = winningPowerball && winningPowerball === powerballNum;
                    const isPowerballPlusMatch = winningPlusPowerball && winningPlusPowerball === powerballNum;
                    const isBonusMatch = isPowerballMatch || isPowerballPlusMatch;
                    
                    // Add + sign separator
                    const plusSign = document.createElement('span');
                    plusSign.className = 'mx-2 align-self-center fs-4 fw-bold text-muted';
                    plusSign.textContent = '+';
                    ballsContainer.appendChild(plusSign);
                    
                    const powerballWrapper = document.createElement('div');
                    powerballWrapper.className = 'position-relative d-inline-block';
                    
                    const powerballBall = document.createElement('div');
                    powerballBall.className = 'lottery-ball lottery-ball-red me-1 mb-1';
                    powerballBall.style.border = '3px solid #ffd700';
                    powerballBall.textContent = powerballNum;
                    
                    // Add check mark for Bonus Ball match
                    if (isBonusMatch) {
                        const checkMark = document.createElement('div');
                        checkMark.className = 'position-absolute';
                        checkMark.style.top = '-8px';
                        checkMark.style.right = '-8px';
                        checkMark.style.backgroundColor = '#28a745';
                        checkMark.style.color = 'white';
                        checkMark.style.borderRadius = '50%';
                        checkMark.style.width = '20px';
                        checkMark.style.height = '20px';
                        checkMark.style.display = 'flex';
                        checkMark.style.alignItems = 'center';
                        checkMark.style.justifyContent = 'center';
                        checkMark.style.fontSize = '12px';
                        checkMark.style.fontWeight = 'bold';
                        checkMark.innerHTML = 'âœ“';
                        powerballWrapper.appendChild(checkMark);
                    }
                    
                    powerballWrapper.appendChild(powerballBall);
                    ballsContainer.appendChild(powerballWrapper);
                    
                    // No summary box - checkmarks on numbers will show matches instead
                }
                
                    numbersContainer.appendChild(lineDiv);
                });
            }
        } else if (data.ticket_numbers && data.ticket_numbers.length > 0) {
            // Fallback to single line display
            data.ticket_numbers.forEach(num => {
                const span = document.createElement('span');
                span.className = 'badge bg-primary me-1';
                span.textContent = num;
                numbersContainer.appendChild(span);
            });
            
            // Add PowerBall number if available
            if (data.powerball_number && data.powerball_number !== 'Not detected') {
                const powerballSpan = document.createElement('span');
                powerballSpan.className = 'badge bg-warning text-dark me-1';
                powerballSpan.textContent = `PowerBall: ${data.powerball_number}`;
                numbersContainer.appendChild(powerballSpan);
            }
        }
        
        // Display results
        const winningInfo = document.getElementById('winning-info');
        const prizeInfo = document.getElementById('prize-info');
        
        if (data.is_winner) {
            winningInfo.innerHTML = '<div class="alert alert-success"><i class="fa fa-trophy me-2"></i>Congratulations! You have a winning ticket!</div>';
            prizeInfo.innerHTML = '<p><strong>Prize:</strong> ' + (data.prize_amount || 'Check with lottery office') + '</p>';
        } else {
            winningInfo.innerHTML = '<div class="alert alert-info"><i class="fa fa-info-circle me-2"></i>No winning combinations found on this ticket.</div>';
            prizeInfo.innerHTML = '';
        }
        
        // Show results
        document.getElementById('success-content').classList.remove('d-none');
        document.getElementById('error-message').classList.add('d-none');
        resultsContainer.classList.remove('d-none');
    }
    
    function displayMatchAnalysis(data) {
        console.log('Displaying match analysis for:', data);
        
        const winningInfo = document.getElementById('winning-info');
        const prizeInfo = document.getElementById('prize-info');
        
        if (!winningInfo || !prizeInfo) return;
        
        // Clear previous content
        winningInfo.innerHTML = '';
        prizeInfo.innerHTML = '';
        
        // Display match results
        let hasMatches = false;
        let matchSummary = [];
        
        // Check main game results
        if (data.main_game_results && data.main_game_results.main_matches > 0) {
            hasMatches = true;
            matchSummary.push(`${data.main_game_results.lottery_type}: ${data.main_game_results.total_matches}`);
        }
        
        // Check Plus game results
        if (data.powerball_plus_results && data.powerball_plus_results.main_matches > 0) {
            hasMatches = true;
            matchSummary.push(`${data.powerball_plus_results.lottery_type}: ${data.powerball_plus_results.total_matches}`);
        }
        
        if (data.lotto_plus_1_results && data.lotto_plus_1_results.main_matches > 0) {
            hasMatches = true;
            matchSummary.push(`${data.lotto_plus_1_results.lottery_type}: ${data.lotto_plus_1_results.total_matches}`);
        }
        
        if (data.lotto_plus_2_results && data.lotto_plus_2_results.main_matches > 0) {
            hasMatches = true;
            matchSummary.push(`${data.lotto_plus_2_results.lottery_type}: ${data.lotto_plus_2_results.total_matches}`);
        }
        
        // Display results
        if (hasMatches) {
            winningInfo.innerHTML = `
                <div class="alert alert-success">
                    <i class="fa fa-trophy me-2"></i>
                    <strong>Congratulations! You have matching numbers!</strong>
                    <ul class="mt-2 mb-0">
                        ${matchSummary.map(match => `<li>${match}</li>`).join('')}
                    </ul>
                </div>
            `;
            prizeInfo.innerHTML = '<p class="text-info"><i class="fa fa-info-circle me-1"></i>Check with lottery office for prize details</p>';
        } else {
            winningInfo.innerHTML = `
                <div class="alert alert-info">
                    <i class="fa fa-info-circle me-2"></i>
                    No winning combinations found on this ticket for the latest draws.
                </div>
            `;
        }
        
        // Display comparison info if available
        if (data.comparison && data.comparison.message) {
            prizeInfo.innerHTML += `<p class="small text-muted mt-2">${data.comparison.message}</p>`;
        }
    }

    // Function to display winning numbers from the draw
    function displayWinningNumbers(data) {
        // Find a place to insert winning numbers - add it before the ticket numbers
        const numbersContainer = document.getElementById('ticket-numbers');
        if (!numbersContainer) return;

        // Remove any existing winning numbers display
        const existingWinning = document.getElementById('winning-numbers-display');
        if (existingWinning) {
            existingWinning.remove();
        }

        // Create winning numbers section
        const winningSection = document.createElement('div');
        winningSection.id = 'winning-numbers-display';
        winningSection.className = 'mb-3 p-3 border rounded bg-warning bg-opacity-10';

        const winningTitle = document.createElement('h6');
        winningTitle.className = 'mb-3 text-warning';
        winningTitle.innerHTML = 'ðŸ† Winning Numbers';
        winningSection.appendChild(winningTitle);

        // Display PowerBall results if available
        if (data.powerball_results) {
            const pbSection = document.createElement('div');
            pbSection.className = 'mb-2';

            const pbTitle = document.createElement('div');
            pbTitle.className = 'text-primary small mb-1';
            pbTitle.textContent = `PowerBall Draw ${data.powerball_results.draw_number}`;
            pbSection.appendChild(pbTitle);

            const pbRow = document.createElement('div');
            pbRow.className = 'd-flex align-items-center gap-2 mb-2';

            const pbBallsContainer = document.createElement('div');
            pbBallsContainer.className = 'd-flex flex-wrap gap-1';

            // Parse winning numbers - handle malformed data
            let winningNumbers = [];
            try {
                let rawNumbers = data.powerball_results.winning_numbers || '[]';
                
                // Handle malformed data like "{" or incomplete JSON
                if (typeof rawNumbers === 'string') {
                    // Clean up malformed strings
                    rawNumbers = rawNumbers.trim();
                    if (rawNumbers === '{' || rawNumbers === '}' || rawNumbers === '') {
                        rawNumbers = '[]';
                    }
                    
                    // Handle double-encoded JSON strings
                    if (rawNumbers.startsWith('"[')) {
                        rawNumbers = JSON.parse(rawNumbers);
                    }
                    
                    // Only parse valid JSON
                    if (rawNumbers.startsWith('[') && rawNumbers.endsWith(']')) {
                        winningNumbers = JSON.parse(rawNumbers);
                    }
                } else if (Array.isArray(rawNumbers)) {
                    winningNumbers = rawNumbers;
                }
                
                // Validate parsed numbers
                winningNumbers = winningNumbers.filter(num => 
                    typeof num === 'number' || (typeof num === 'string' && !isNaN(parseInt(num)))
                );
                
                console.log('Parsed PowerBall winning numbers:', winningNumbers);
            } catch (e) {
                console.log('Could not parse PowerBall winning numbers:', e);
                winningNumbers = [];
            }

            // Display winning main numbers
            winningNumbers.forEach((num, index) => {
                const colors = ['lottery-ball-red', 'lottery-ball-blue', 'lottery-ball-green', 'lottery-ball-yellow'];
                const colorClass = colors[index % colors.length];

                const ballElement = document.createElement('div');
                ballElement.className = `lottery-ball ${colorClass} me-1 mb-1`;
                ballElement.textContent = num;
                pbBallsContainer.appendChild(ballElement);
            });

            // Add + sign separator after main numbers
            const plusSign = document.createElement('span');
            plusSign.className = 'mx-2 align-self-center fs-5 fw-bold text-muted';
            plusSign.textContent = '+';
            pbBallsContainer.appendChild(plusSign);

            // Display winning PowerBall bonus ball - try multiple sources
            const winningPowerball = data.powerball_results.winning_powerball;
            let pbNumber = '';
            
            // Try to get the PowerBall number from various sources
            if (winningPowerball && winningPowerball !== '[' && winningPowerball !== '') {
                if (Array.isArray(winningPowerball)) {
                    pbNumber = winningPowerball[0];
                } else {
                    pbNumber = winningPowerball.toString().replace(/[\[\]"]/g, '');
                    if (pbNumber.includes(',')) {
                        pbNumber = pbNumber.split(',')[0];
                    }
                }
            }
            
            // If still no number, show placeholder but indicate missing data
            if (!pbNumber || pbNumber === '' || pbNumber === '[') {
                pbNumber = '?';
            }
            
            const pbBall = document.createElement('div');
            pbBall.className = 'lottery-ball lottery-ball-red';
            pbBall.style.border = '3px solid #ffd700';
            pbBall.textContent = pbNumber;
            pbBallsContainer.appendChild(pbBall);

            pbBallsContainer.appendChild(pbRow);
            pbSection.appendChild(pbRow);

            winningSection.appendChild(pbSection);
        }

        // Display PowerBall results first (main game)
        if (data.powerball_results) {
            const pbSection = document.createElement('div');
            pbSection.className = 'mb-3 p-3 border rounded bg-light';

            const pbTitle = document.createElement('h6');
            pbTitle.className = 'text-primary mb-2';
            pbTitle.textContent = `PowerBall Draw ${data.powerball_results.draw_number} (${data.powerball_results.draw_date})`;
            pbSection.appendChild(pbTitle);

            const pbBallsContainer = document.createElement('div');
            pbBallsContainer.className = 'd-flex flex-wrap gap-2 mb-2';

            // Display PowerBall main numbers
            winningNumbers.forEach((num, index) => {
                const colors = ['lottery-ball-red', 'lottery-ball-blue', 'lottery-ball-green', 'lottery-ball-yellow'];
                const colorClass = colors[index % colors.length];

                const ballElement = document.createElement('div');
                ballElement.className = `lottery-ball ${colorClass} me-1 mb-1`;
                ballElement.textContent = num;
                pbBallsContainer.appendChild(ballElement);
            });

            // Add + sign separator after main numbers
            const plusSign = document.createElement('span');
            plusSign.className = 'mx-2 align-self-center fs-5 fw-bold text-muted';
            plusSign.textContent = '+';
            pbBallsContainer.appendChild(plusSign);

            // Display winning PowerBall bonus ball
            const winningPowerball = data.powerball_results.winning_powerball;
            let pbNumber = '';
            
            if (winningPowerball && winningPowerball !== '[' && winningPowerball !== '') {
                if (Array.isArray(winningPowerball)) {
                    pbNumber = winningPowerball[0];
                } else {
                    pbNumber = winningPowerball.toString().replace(/[\[\]"]/g, '');
                    if (pbNumber.includes(',')) {
                        pbNumber = pbNumber.split(',')[0];
                    }
                }
            }
            
            if (!pbNumber || pbNumber === '' || pbNumber === '[') {
                pbNumber = '?';
            }
            
            const pbBall = document.createElement('div');
            pbBall.className = 'lottery-ball lottery-ball-red';
            pbBall.style.border = '3px solid #ffd700';
            pbBall.textContent = pbNumber;
            pbBallsContainer.appendChild(pbBall);

            pbSection.appendChild(pbBallsContainer);
            winningSection.appendChild(pbSection);
        }

        // Display PowerBall Plus results if ticket includes it
        if (data.powerball_plus_results && (data.powerball_plus_included === "YES" || data.ticket_data?.powerball_plus_included === "YES")) {
            const pbPlusSection = document.createElement('div');
            pbPlusSection.className = 'mb-3 p-2 border rounded bg-light';

            const pbPlusTitle = document.createElement('h6');
            pbPlusTitle.className = 'text-success mb-2';
            pbPlusTitle.textContent = `PowerBall Plus Draw ${data.powerball_plus_results.draw_number} (${data.powerball_plus_results.draw_date})`;
            pbPlusSection.appendChild(pbPlusTitle);

            const pbPlusBallsContainer = document.createElement('div');
            pbPlusBallsContainer.className = 'd-flex flex-wrap gap-2 mb-2';

            // Parse PowerBall Plus winning numbers - handle malformed data
            let winningPlusNumbers = [];
            try {
                let rawPlusNumbers = data.powerball_plus_results.winning_numbers || '[]';
                
                // Handle malformed data like "{" or incomplete JSON
                if (typeof rawPlusNumbers === 'string') {
                    // Clean up malformed strings
                    rawPlusNumbers = rawPlusNumbers.trim();
                    if (rawPlusNumbers === '{' || rawPlusNumbers === '}' || rawPlusNumbers === '') {
                        rawPlusNumbers = '[]';
                    }
                    
                    // Handle double-encoded JSON strings
                    if (rawPlusNumbers.startsWith('"[')) {
                        rawPlusNumbers = JSON.parse(rawPlusNumbers);
                    }
                    
                    // Only parse valid JSON
                    if (rawPlusNumbers.startsWith('[') && rawPlusNumbers.endsWith(']')) {
                        winningPlusNumbers = JSON.parse(rawPlusNumbers);
                    }
                } else if (Array.isArray(rawPlusNumbers)) {
                    winningPlusNumbers = rawPlusNumbers;
                }
                
                // Validate parsed numbers
                winningPlusNumbers = winningPlusNumbers.filter(num => 
                    typeof num === 'number' || (typeof num === 'string' && !isNaN(parseInt(num)))
                );
                
                console.log('Parsed PowerBall Plus winning numbers:', winningPlusNumbers);
            } catch (e) {
                console.log('Could not parse PowerBall Plus winning numbers for comparison:', e);
                winningPlusNumbers = [];
            }

            // Display winning main numbers for PowerBall Plus
            winningPlusNumbers.forEach((num, index) => {
                const colors = ['lottery-ball-red', 'lottery-ball-blue', 'lottery-ball-green', 'lottery-ball-yellow'];
                const colorClass = colors[index % colors.length];

                const ballElement = document.createElement('div');
                ballElement.className = `lottery-ball ${colorClass} me-1 mb-1`;
                ballElement.textContent = num;
                pbPlusBallsContainer.appendChild(ballElement);
            });

            pbPlusSection.appendChild(pbPlusBallsContainer);

            // Add + sign separator after PowerBall Plus main numbers
            const plusSignPlus = document.createElement('span');
            plusSignPlus.className = 'mx-2 align-self-center fs-5 fw-bold text-muted';
            plusSignPlus.textContent = '+';
            pbPlusBallsContainer.appendChild(plusSignPlus);

            // Display PowerBall Plus bonus ball
            const winningPlusPowerball = data.powerball_plus_results.winning_powerball;
            let pbPlusNumber = '';
            
            if (winningPlusPowerball && winningPlusPowerball !== '[' && winningPlusPowerball !== '') {
                if (Array.isArray(winningPlusPowerball)) {
                    pbPlusNumber = winningPlusPowerball[0];
                } else {
                    pbPlusNumber = winningPlusPowerball.toString().replace(/[\[\]"]/g, '');
                    if (pbPlusNumber.includes(',')) {
                        pbPlusNumber = pbPlusNumber.split(',')[0];
                    }
                }
            }
            
            // If still no number, show placeholder
            if (!pbPlusNumber || pbPlusNumber === '' || pbPlusNumber === '[') {
                pbPlusNumber = '?';
            }
            
            const pbPlusBall = document.createElement('div');
            pbPlusBall.className = 'lottery-ball lottery-ball-red';
            pbPlusBall.style.border = '3px solid #28a745';
            pbPlusBall.textContent = pbPlusNumber;
            pbPlusBallsContainer.appendChild(pbPlusBall);

            winningSection.appendChild(pbPlusSection);
        }

        // Insert before ticket numbers
        numbersContainer.parentNode.insertBefore(winningSection, numbersContainer);
    }
});
</script>

<style>
.ticket-drop-area {
    border: 2px dashed #dee2e6;
    border-radius: 8px;
    padding: 40px 20px;
    text-align: center;
    transition: all 0.3s ease;
    cursor: pointer;
}

.ticket-drop-area:hover, .ticket-drop-area.drag-over {
    border-color: #007bff;
    background-color: #f8f9fa;
}

.ticket-preview {
    max-width: 300px;
    max-height: 400px;
    border: 1px solid #dee2e6;
}

.numbers-display .badge {
    font-size: 14px;
    margin: 2px;
}

.spinning-loader {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Mobile and Desktop Responsive Optimizations */
@media (max-width: 767.98px) {
    .container {
        padding-left: 10px;
        padding-right: 10px;
    }
    
    .ticket-drop-area {
        padding: 20px 15px;
        min-height: 180px;
    }
    
    .lottery-ball {
        width: 32px;
        height: 32px;
        font-size: 12px;
        margin: 1px;
    }
    
    .ticket-preview {
        max-height: 250px;
    }
    
    .numbers-display {
        gap: 8px;
    }
    
    .card-body {
        padding: 15px;
    }
    
    h1 {
        font-size: 1.5rem;
    }
    
    .lead {
        font-size: 1rem;
    }
}

@media (min-width: 768px) {
    .ticket-drop-area {
        min-height: 200px;
        padding: 30px;
    }
    
    .lottery-ball {
        width: 40px;
        height: 40px;
        font-size: 14px;
    }
}

@media (min-width: 992px) {
    .lottery-ball {
        width: 45px;
        height: 45px;
        font-size: 16px;
    }
}

/* Touch-friendly improvements for mobile */
@media (pointer: coarse) {
    .btn {
        min-height: 44px;
        min-width: 44px;
    }
    
    .lottery-ball {
        min-width: 36px;
        min-height: 36px;
    }
    
    .form-control, .form-select {
        min-height: 44px;
    }
}
</style>
{% endblock %}