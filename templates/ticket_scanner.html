{% extends "base.html" %}

{% block title %}Lottery Ticket Scanner | Snap Lotto{% endblock %}

{% block additional_head %}
<style>
    .ticket-scanner-container {
        max-width: 800px;
        margin: 0 auto;
    }
    .ticket-drop-area {
        border: 2px dashed #aaa;
        border-radius: 8px;
        padding: 40px;
        text-align: center;
    }
    @keyframes pulse {
        0% {
            transform: scale(1);
            box-shadow: 0 0 0 0 rgba(0, 123, 255, 0.7);
        }
        
        70% {
            transform: scale(1.05);
            box-shadow: 0 0 0 10px rgba(0, 123, 255, 0);
        }
        
        100% {
            transform: scale(1);
            box-shadow: 0 0 0 0 rgba(0, 123, 255, 0);
        }
    }
    
    /* Updated matched ball styling with glow effect */
    .ball-matched {
        border: 3px solid #28a745 !important;
        box-shadow: 0 0 10px #28a745;
    }
    
    .ticket-drop-area {
        background-color: rgba(0,0,0,0.05);
        cursor: pointer;
        transition: all 0.3s;
        margin-bottom: 20px;
    }
    .ticket-drop-area:hover, .ticket-drop-area.highlight {
        border-color: var(--sa-lottery-yellow);
        background-color: rgba(0,0,0,0.1);
    }
    .ticket-preview {
        max-width: 100%;
        max-height: 300px;
        margin: 20px 0;
    }
    .results-container {
        margin-top: 30px;
    }
    /* Position and checkmark for matched balls */
    .ball-matched {
        position: relative;
    }
    .ball-matched::after {
        content: "âœ“";
        position: absolute;
        top: -10px;
        right: -10px;
        background-color: var(--bs-success);
        color: white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        font-size: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .prize-card {
        border-left: 5px solid var(--bs-success);
    }
    #scanner-loading {
        display: none;
    }
    
    /* Advertisement - Loading overlay */
    #ad-overlay-loading {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.95);
        z-index: 9999;
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 20px;
    }
    
    /* Advertisement - Results overlay */
    #ad-overlay-results {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.95);
        z-index: 9999;
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 20px;
    }
    
    /* Button pulse animation */
    @keyframes btn-pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); box-shadow: 0 0 15px rgba(40, 167, 69, 0.7); }
        100% { transform: scale(1); }
    }
    
    .btn-pulse {
        animation: btn-pulse 1.5s infinite;
    }
</style>
{% endblock %}

{% block content %}
<!-- Ad overlay - Loading screen -->
<div id="ad-overlay-loading" class="interstitial-view">
    <h4 class="mb-4">Processing your ticket...</h4>
    <div id="ad-container-loader" class="ad-container">
        <div class="ad-placeholder">
            <p><i class="fas fa-ad mb-2"></i></p>
            <p class="mb-1">Advertisement</p>
        </div>
    </div>
    <div class="mt-3">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="loading-message">Scanning in progress...</p>
        <p class="small text-muted mt-2">This will take a few moments</p>
    </div>
</div>

<!-- Ad overlay - Results screen -->
<div id="ad-overlay-results" class="interstitial-view">
    <h3 class="mb-3 text-success">Results Ready! <i class="fas fa-check-circle"></i></h3>
    <div class="alert alert-info mb-3" style="max-width: 400px;">
        Please view this advertisement while we prepare your results
    </div>
    <div id="ad-container-interstitial" class="ad-container" style="padding: 15px; background-color: #f8f9fa; border-radius: 10px; box-shadow: 0 0 15px rgba(0,0,0,0.1);">
        <div class="ad-placeholder">
            <p><i class="fas fa-ad mb-2 fa-2x text-primary"></i></p>
            <p class="mb-1 fw-bold">Advertisement</p>
            <small class="text-muted">Your results are ready to view below</small>
        </div>
    </div>
    <button class="btn btn-success btn-lg ad-close-btn mt-3" id="view-results-btn" style="min-width: 200px;">
        <i class="fas fa-check-circle me-2"></i> View Results
    </button>
</div>

<div class="container py-4">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="d-flex align-items-center">
                <i class="fa fa-ticket-alt me-3"></i> Lottery Ticket Scanner
            </h1>
            <p class="lead">Upload your lottery ticket to check if you've won a prize</p>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="ticket-scanner-container">
                        <div class="alert alert-info">
                            <i class="fa fa-info-circle me-2"></i> Take a clear photo of your lottery ticket, making sure all numbers are visible.
                        </div>

                        <form id="ticket-form" action="/scan-ticket" method="post" enctype="multipart/form-data">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <div class="mb-3">
                                <label for="lottery-type" class="form-label">Select Lottery Type (Optional - will be detected by AI)</label>
                                <select class="form-select" id="lottery-type" name="lottery_type">
                                    <option value="">Auto-detect from ticket</option>
                                    <option value="Lotto">Lotto</option>
                                    <option value="Lotto Plus 1">Lotto Plus 1</option>
                                    <option value="Lotto Plus 2">Lotto Plus 2</option>
                                    <option value="Powerball">Powerball</option>
                                    <option value="Powerball Plus">Powerball Plus</option>
                                    <option value="Daily Lotto">Daily Lotto</option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <label for="draw-number" class="form-label">Draw Number (optional)</label>
                                <input type="text" class="form-control" id="draw-number" name="draw_number" 
                                    placeholder="Leave blank to check against latest draw">
                            </div>

                            <div class="ticket-drop-area" id="drop-area">
                                <div class="mb-3">
                                    <i class="fa fa-upload fa-2x mb-3"></i>
                                    <h5>Drag and drop your ticket image here</h5>
                                    <p>or</p>
                                    <input type="file" id="ticket-image" name="ticket_image" accept="image/*" class="d-none">
                                    <button type="button" id="file-select-btn" class="btn btn-primary">Select Image</button>
                                </div>
                            </div>

                            <div id="preview-container" class="text-center d-none">
                                <h6>Preview</h6>
                                <img id="ticket-preview" class="ticket-preview img-fluid rounded" src="">
                                <div class="mt-2">
                                    <button type="button" id="remove-image" class="btn btn-sm btn-outline-danger">
                                        <i class="fa fa-times"></i> Remove
                                    </button>
                                </div>
                            </div>

                            <div class="text-center mt-4">
                                <button type="submit" id="scan-button" class="btn btn-success btn-lg">
                                    <i class="fa fa-search me-2"></i> Scan Ticket
                                </button>
                                <div id="scanner-loading" class="mt-3">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p>Scanning your ticket...</p>
                                </div>
                            </div>
                        </form>

                        <div id="results-container" class="results-container d-none">
                            <hr>
                            <h3 class="mb-4 text-center">Scanning Results</h3>
                            
                            <div id="error-message" class="alert alert-danger d-none">
                                <i class="fa fa-exclamation-triangle me-2"></i>
                                <span id="error-text"></span>
                            </div>
                            
                            <div id="success-content" class="d-none">
                                <div class="card mb-4">
                                    <div class="card-header bg-light">
                                        <h5 class="mb-0" id="ticket-info-title">Your Ticket</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <p><strong>Lottery Type:</strong> <span id="result-lottery-type"></span></p>
                                                <p><strong>Draw Number:</strong> <span id="result-draw-number"></span></p>
                                                <p><strong>Draw Date:</strong> <span id="result-draw-date"></span></p>
                                                
                                                <div id="detected-info" class="mt-3 small">
                                                    <p class="text-muted mb-1"><i class="fas fa-search-plus me-1"></i> <strong>OCR Detected Information:</strong></p>
                                                    <p class="mb-1"><strong>Game Type:</strong> <span id="detected-game-type"></span></p>
                                                    <p class="mb-1"><strong>Draw Number:</strong> <span id="detected-draw-number"></span></p>
                                                    <p class="mb-1"><strong>Draw Date:</strong> <span id="detected-draw-date"></span></p>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <p><strong>Your Numbers:</strong></p>
                                                <div id="ticket-numbers" class="mb-3"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="card mb-4">
                                    <div class="card-header bg-light">
                                        <h5 class="mb-0">Winning Numbers</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <p><strong>Main Numbers:</strong></p>
                                                <div id="winning-numbers" class="mb-3"></div>
                                            </div>
                                            <div class="col-md-6" id="bonus-numbers-container">
                                                <p><strong>Bonus Number:</strong></p>
                                                <div id="bonus-numbers" class="mb-3"></div>
                                            </div>
                                        </div>
                                        
                                        <div class="mt-4">
                                            <p><strong>Matched Numbers:</strong> <span id="matched-count" class="badge bg-success">0</span></p>
                                            <div id="matched-numbers"></div>
                                            <div class="mt-2" id="matched-bonus-section">
                                                <p><strong>Matched Bonus:</strong> <span id="matched-bonus-count" class="badge bg-warning text-dark">0</span></p>
                                                <div id="matched-bonus-numbers"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div id="prize-container" class="d-none">
                                    <div class="card prize-card">
                                        <div class="card-body">
                                            <h4 class="text-success mb-3"><i class="fa fa-trophy me-2"></i> Congratulations!</h4>
                                            <p class="lead">You've won a prize in <span id="prize-lottery-type"></span> Draw <span id="prize-draw-number"></span>!</p>
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <p><strong>Division:</strong> <span id="prize-division"></span></p>
                                                    <p><strong>Match Type:</strong> <span id="prize-match-type"></span></p>
                                                </div>
                                                <div class="col-md-6">
                                                    <h3 class="text-success">Prize: <span id="prize-amount"></span></h3>
                                                </div>
                                            </div>
                                            <p class="small text-muted mt-3">Visit the official South African National Lottery website or an authorized retailer to claim your prize.</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div id="no-prize-container" class="d-none">
                                    <div class="card">
                                        <div class="card-body text-center">
                                            <h4 class="text-muted mb-3"><i class="fa fa-times-circle me-2"></i> No Prize</h4>
                                            <p>Sorry, your ticket did not win a prize in this draw.</p>
                                            <p>Better luck next time!</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block additional_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const dropArea = document.getElementById('drop-area');
        const fileInput = document.getElementById('ticket-image');
        const fileSelectBtn = document.getElementById('file-select-btn');
        const previewContainer = document.getElementById('preview-container');
        const ticketPreview = document.getElementById('ticket-preview');
        const removeImageBtn = document.getElementById('remove-image');
        const scanButton = document.getElementById('scan-button');
        const ticketForm = document.getElementById('ticket-form');
        const lotteryTypeSelect = document.getElementById('lottery-type');
        const loadingIndicator = document.getElementById('scanner-loading');
        const resultsContainer = document.getElementById('results-container');
        
        // Initialize scan button state after a short delay
        setTimeout(() => {
            updateScanButton();
            console.log("Initial button state check on page load");
        }, 500);
        
        // File selection via button
        fileSelectBtn.addEventListener('click', () => {
            fileInput.click();
        });
        
        // File selection change
        fileInput.addEventListener('change', handleFileSelect);
        
        // Drag and drop events
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, preventDefaults, false);
        });
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, highlight, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, unhighlight, false);
        });
        
        function highlight() {
            dropArea.classList.add('highlight');
        }
        
        function unhighlight() {
            dropArea.classList.remove('highlight');
        }
        
        dropArea.addEventListener('drop', handleDrop, false);
        
        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            
            if (files.length > 0) {
                fileInput.files = files;
                handleFileSelect();
            }
        }
        
        function handleFileSelect() {
            const file = fileInput.files[0];
            
            if (file) {
                // Check if file is an image
                if (!file.type.match('image.*')) {
                    alert('Please select an image file');
                    fileInput.value = ''; // Clear the file input
                    return;
                }
                
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    ticketPreview.src = e.target.result;
                    previewContainer.classList.remove('d-none');
                    // Update scan button state
                    updateScanButton();
                    console.log("File loaded successfully");
                }
                
                reader.onerror = function() {
                    alert('Error reading the image file. Please try a different image.');
                    fileInput.value = ''; // Clear the file input on error
                    updateScanButton();
                }
                
                reader.readAsDataURL(file);
            } else {
                previewContainer.classList.add('d-none');
                updateScanButton();
            }
        }
        
        removeImageBtn.addEventListener('click', function() {
            ticketPreview.src = '';
            fileInput.value = '';
            previewContainer.classList.add('d-none');
            updateScanButton();
        });
        
        lotteryTypeSelect.addEventListener('change', updateScanButton);
        
        // Add a direct click handler for the scan button
        scanButton.addEventListener('click', function(e) {
            if (fileInput.files.length) {
                e.preventDefault();
                processTicketWithAds();
            }
        });
        
        function updateScanButton() {
            // Always keep the button enabled
            scanButton.disabled = false;
            console.log("Button state updated:", {
                fileCount: fileInput.files.length,
                lotteryType: lotteryTypeSelect.value,
                disabled: false
            });
        }
        
        // Function to handle showing ads and processing the ticket
        function processTicketWithAds() {
            // Show loading indicator
            loadingIndicator.style.display = 'block';
            // Never disable the scan button
            scanButton.disabled = false;
            
            // Create form data for later use
            const formData = new FormData(ticketForm);
            
            // Check if AdManager is available and use it to show ad, otherwise just process
            if (window.AdManager && typeof window.AdManager.showLoadingAd === 'function') {
                console.log('Using AdManager to show loading ad');
                window.AdManager.showLoadingAd(function(adShown) {
                    // After ad is loaded (or if it failed), process the ticket
                    console.log('Ad loading callback returned:', adShown);
                    processTicket(formData);
                });
            } else {
                // Fallback - Show ad loading overlay manually
                console.log('AdManager not available, showing overlay manually');
                const adOverlayLoading = document.getElementById('ad-overlay-loading');
                adOverlayLoading.style.display = 'flex';
                
                // Process the ticket immediately
                console.log('Processing ticket without AdManager');
                processTicket(formData);
            }
        }
        
        // Function to process the ticket after ad is shown
        function processTicket(formData) {
            // Add CSRF token to headers
            const csrfToken = document.querySelector('input[name="csrf_token"]').value;
            
            // Send request
            fetch('/scan-ticket', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                console.log('Success:', data);
                
                // Hide loading overlay
                const adOverlayLoading = document.getElementById('ad-overlay-loading');
                adOverlayLoading.style.display = 'none';
                
                // Try to use the AdManager to show the interstitial ad, or fallback to manual
                const adOverlayResults = document.getElementById('ad-overlay-results');
                
                if (window.AdManager && typeof window.AdManager.showInterstitialAd === 'function') {
                    console.log('Using AdManager to show interstitial ad');
                    window.AdManager.showInterstitialAd(function(adShown) {
                        console.log('Interstitial ad shown:', adShown);
                    });
                } else {
                    // Fallback - Show ad results overlay manually
                    console.log('AdManager not available, showing results overlay manually');
                    adOverlayResults.style.display = 'flex';
                }
                
                console.log('Showing results interstitial ad');
                
                // Get the ad container
                const adContainer = document.getElementById('ad-container-interstitial');
                
                // Auto-show the results after a short delay (simulate ad viewing)
                const viewResultsBtn = document.getElementById('view-results-btn');
                viewResultsBtn.onclick = function() {
                    adOverlayResults.style.display = 'none';
                    displayResults(data);
                };
                
                // FORCEFULLY disable the view results button for 30 seconds
                console.log('Setting 30-second mandatory ad display timer...');
                
                // Disable the View Results button
                viewResultsBtn.disabled = true;
                viewResultsBtn.style.opacity = '0.5';
                viewResultsBtn.style.cursor = 'not-allowed';
                viewResultsBtn.innerHTML = '<i class="fas fa-lock me-2"></i> View Results (Wait 30s)';
                
                // Add a counter display to show remaining seconds
                const counterElement = document.createElement('div');
                counterElement.id = 'ad-countdown';
                counterElement.style.cssText = 'margin-top: 10px; font-size: 14px; color: #666; font-weight: bold;';
                adOverlayResults.querySelector('.ad-container').appendChild(counterElement);
                
                let remainingSeconds = 30;
                
                // Update the counter every second
                const countdownInterval = setInterval(() => {
                    remainingSeconds--;
                    counterElement.textContent = `Results available in ${remainingSeconds} seconds...`;
                    
                    // Update button text
                    viewResultsBtn.innerHTML = `<i class="fas fa-lock me-2"></i> View Results (Wait ${remainingSeconds}s)`;
                    
                    if (remainingSeconds <= 0) {
                        clearInterval(countdownInterval);
                        // Enable the button after time is up
                        viewResultsBtn.disabled = false;
                        viewResultsBtn.style.opacity = '1';
                        viewResultsBtn.style.cursor = 'pointer';
                        viewResultsBtn.innerHTML = '<i class="fas fa-check-circle me-2"></i> View Results Now!';
                        // Make the button pulse to draw attention
                        viewResultsBtn.classList.add('btn-pulse');
                    }
                }, 1000);
                
                // After 30 seconds, enable the View Results button and update UI
                setTimeout(() => {
                    if (countdownInterval) {
                        clearInterval(countdownInterval);
                    }
                    
                    console.log('30-second ad display timer completed');
                    
                    // Make sure the button is enabled
                    if (adOverlayResults.style.display === 'flex') {
                        viewResultsBtn.disabled = false;
                        viewResultsBtn.style.opacity = '1';
                        viewResultsBtn.style.cursor = 'pointer';
                        viewResultsBtn.innerHTML = '<i class="fas fa-check-circle me-2"></i> View Results Now!';
                        viewResultsBtn.classList.add('btn-pulse');
                    }
                }, 30000);
            })
            .catch(error => {
                console.error('Error:', error);
                // Hide ad loading overlay
                const adOverlayLoading = document.getElementById('ad-overlay-loading');
                adOverlayLoading.style.display = 'none';
                showError('An error occurred while scanning your ticket. Please try again.');
            })
            .finally(() => {
                // Hide loading indicator
                loadingIndicator.style.display = 'none';
                scanButton.disabled = false;
                console.log("Scan completed - button enabled");
            });
        }
        
        // Event listener for form submission
        ticketForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Only check if a file is selected
            if (!fileInput.files.length) {
                alert('Please select an image of your ticket');
                return;
            }
            
            // Process the ticket with ads
            processTicketWithAds();
        });
        
        function displayResults(data) {
            // Show results container
            resultsContainer.classList.remove('d-none');
            
            // Hide error message by default
            document.getElementById('error-message').classList.add('d-none');
            
            if (data.error) {
                showError(data.error);
                return;
            }
            
            // Show success content
            const successContent = document.getElementById('success-content');
            successContent.classList.remove('d-none');
            
            // Populate ticket info
            document.getElementById('result-lottery-type').textContent = data.lottery_type;
            document.getElementById('result-draw-number').textContent = data.draw_number;
            document.getElementById('result-draw-date').textContent = data.draw_date;
            
            // Populate detected information from OCR if available
            if (data.ticket_info) {
                document.getElementById('detected-game-type').textContent = data.ticket_info.detected_game_type || 'Unknown';
                document.getElementById('detected-draw-number').textContent = data.ticket_info.detected_draw_number || 'Unknown';
                document.getElementById('detected-draw-date').textContent = data.ticket_info.detected_draw_date || 'Unknown';
            } else {
                document.getElementById('detected-info').classList.add('d-none');
            }
            
            // Display ticket numbers
            const ticketNumbersContainer = document.getElementById('ticket-numbers');
            ticketNumbersContainer.innerHTML = '';
            
            // Check if we have raw selected numbers for a better display
            if (data.ticket_info && data.ticket_info.raw_selected_numbers) {
                // Display numbers by rows
                Object.entries(data.ticket_info.raw_selected_numbers).forEach(([rowName, numbers]) => {
                    // Check if this row has any matches
                    const rowMatches = numbers.filter(num => data.winning_numbers.includes(num));
                    const rowBonusMatches = numbers.filter(num => data.bonus_numbers.includes(num));
                    const hasMatches = rowMatches.length > 0 || rowBonusMatches.length > 0;
                    
                    // Create row label with match indicator if applicable
                    const rowLabel = document.createElement('div');
                    rowLabel.classList.add('mt-2', 'mb-1');
                    if (hasMatches) {
                        rowLabel.innerHTML = `<strong>Row ${rowName}:</strong> <span class="badge bg-success ms-2">Matches: ${rowMatches.length + rowBonusMatches.length}</span>`;
                    } else {
                        rowLabel.innerHTML = `<strong>Row ${rowName}:</strong>`;
                    }
                    ticketNumbersContainer.appendChild(rowLabel);
                    
                    // Create row container
                    const rowContainer = document.createElement('div');
                    rowContainer.classList.add('mb-3');
                    
                    // Track if we should show Powerball/bonus number indicator
                    let isPowerball = false;
                    
                    // Add balls for this row
                    numbers.forEach((num, index) => {
                        // Special handling for the last number in rows for Powerball games
                        if (data.lottery_type.toLowerCase().includes('powerball') && 
                            index === numbers.length - 1 && 
                            numbers.length > 1) {
                            
                            // Add plus sign before the Powerball
                            const plusSpan = document.createElement('span');
                            plusSpan.classList.add('mx-2');
                            plusSpan.textContent = '+';
                            rowContainer.appendChild(plusSpan);
                            isPowerball = true;
                        }
                        
                        const ball = document.createElement('span');
                        ball.classList.add('lottery-ball');
                        
                        // Check if this number is a match
                        const isMatch = data.winning_numbers.includes(num);
                        const isBonusMatch = data.bonus_numbers.includes(num);
                        
                        if (isMatch || isBonusMatch) {
                            ball.classList.add('ball-matched');
                        }
                        
                        // Add color classes in sequence or special color for Powerball
                        if (isPowerball) {
                            ball.classList.add('lottery-ball-blue', 'lottery-ball-bonus');
                        } else if (rowContainer.children.length % 4 === 0) {
                            ball.classList.add('lottery-ball-red');
                        } else if (rowContainer.children.length % 4 === 1) {
                            ball.classList.add('lottery-ball-yellow');
                        } else if (rowContainer.children.length % 4 === 2) {
                            ball.classList.add('lottery-ball-green');
                        } else {
                            ball.classList.add('lottery-ball-blue');
                        }
                        
                        ball.textContent = num;
                        rowContainer.appendChild(ball);
                    });
                    
                    ticketNumbersContainer.appendChild(rowContainer);
                });
            } else {
                // Fallback to flat display if raw data not available
                data.ticket_numbers.forEach(num => {
                    const ball = document.createElement('span');
                    ball.classList.add('lottery-ball');
                    
                    // Add color classes in sequence
                    if (ticketNumbersContainer.children.length % 4 === 0) {
                        ball.classList.add('lottery-ball-red');
                    } else if (ticketNumbersContainer.children.length % 4 === 1) {
                        ball.classList.add('lottery-ball-yellow');
                    } else if (ticketNumbersContainer.children.length % 4 === 2) {
                        ball.classList.add('lottery-ball-green');
                    } else {
                        ball.classList.add('lottery-ball-blue');
                    }
                    
                    ball.textContent = num;
                    ticketNumbersContainer.appendChild(ball);
                });
            }
            
            // Display winning numbers (main numbers)
            const winningNumbersContainer = document.getElementById('winning-numbers');
            winningNumbersContainer.innerHTML = '';
            
            data.winning_numbers.forEach(num => {
                const ball = document.createElement('span');
                ball.classList.add('lottery-ball');
                
                // Add color classes in sequence
                if (winningNumbersContainer.children.length % 4 === 0) {
                    ball.classList.add('lottery-ball-red');
                } else if (winningNumbersContainer.children.length % 4 === 1) {
                    ball.classList.add('lottery-ball-yellow');
                } else if (winningNumbersContainer.children.length % 4 === 2) {
                    ball.classList.add('lottery-ball-green');
                } else {
                    ball.classList.add('lottery-ball-blue');
                }
                
                ball.textContent = num;
                winningNumbersContainer.appendChild(ball);
            });
            
            // Display bonus numbers in dedicated section
            const bonusNumbersContainer = document.getElementById('bonus-numbers');
            bonusNumbersContainer.innerHTML = '';
            
            // Show/hide bonus container based on whether there are bonus numbers
            const bonusContainer = document.getElementById('bonus-numbers-container');
            if (data.bonus_numbers && data.bonus_numbers.length > 0) {
                bonusContainer.classList.remove('d-none');
                
                // Add bonus balls
                data.bonus_numbers.forEach(num => {
                    const ball = document.createElement('span');
                    // Make bonus balls visually distinct
                    ball.classList.add('lottery-ball', 'lottery-ball-yellow');
                    // Add a pulsing effect to bonus balls
                    ball.style.animation = 'pulse 2s infinite';
                    ball.textContent = num;
                    bonusNumbersContainer.appendChild(ball);
                });
            } else {
                bonusContainer.classList.add('d-none');
            }
            
            // Display matched main numbers
            document.getElementById('matched-count').textContent = data.matched_numbers.length;
            
            const matchedNumbersContainer = document.getElementById('matched-numbers');
            matchedNumbersContainer.innerHTML = '';
            
            if (data.matched_numbers.length > 0) {
                data.matched_numbers.forEach(num => {
                    const ball = document.createElement('span');
                    ball.classList.add('lottery-ball', 'ball-matched');
                    
                    // Add color classes in sequence
                    if (matchedNumbersContainer.children.length % 4 === 0) {
                        ball.classList.add('lottery-ball-red');
                    } else if (matchedNumbersContainer.children.length % 4 === 1) {
                        ball.classList.add('lottery-ball-yellow');
                    } else if (matchedNumbersContainer.children.length % 4 === 2) {
                        ball.classList.add('lottery-ball-green');
                    } else {
                        ball.classList.add('lottery-ball-blue');
                    }
                    
                    ball.textContent = num;
                    matchedNumbersContainer.appendChild(ball);
                });
            } else {
                matchedNumbersContainer.innerHTML = '<p>No matching main numbers found.</p>';
            }
            
            // Display matched bonus numbers
            const matchedBonusSection = document.getElementById('matched-bonus-section');
            const matchedBonusContainer = document.getElementById('matched-bonus-numbers');
            matchedBonusContainer.innerHTML = '';
            
            if (data.matched_bonus && data.matched_bonus.length > 0) {
                matchedBonusSection.classList.remove('d-none');
                document.getElementById('matched-bonus-count').textContent = data.matched_bonus.length;
                
                data.matched_bonus.forEach(num => {
                    const ball = document.createElement('span');
                    ball.classList.add('lottery-ball', 'ball-matched', 'lottery-ball-yellow');
                    ball.style.animation = 'pulse 2s infinite';
                    ball.textContent = num;
                    matchedBonusContainer.appendChild(ball);
                });
            } else {
                matchedBonusSection.classList.add('d-none');
            }
            
            // Display prize information if any
            const prizeContainer = document.getElementById('prize-container');
            const noPrizeContainer = document.getElementById('no-prize-container');
            
            if (data.has_prize) {
                prizeContainer.classList.remove('d-none');
                noPrizeContainer.classList.add('d-none');
                
                document.getElementById('prize-lottery-type').textContent = data.lottery_type;
                document.getElementById('prize-draw-number').textContent = data.draw_number;
                document.getElementById('prize-division').textContent = data.prize_info.division;
                document.getElementById('prize-match-type').textContent = data.prize_info.match_type;
                document.getElementById('prize-amount').textContent = data.prize_info.prize_amount;
            } else {
                prizeContainer.classList.add('d-none');
                noPrizeContainer.classList.remove('d-none');
            }
            
            // Scroll to results
            resultsContainer.scrollIntoView({ behavior: 'smooth' });
        }
        
        function showError(message) {
            const errorMessage = document.getElementById('error-message');
            const errorText = document.getElementById('error-text');
            const successContent = document.getElementById('success-content');
            
            errorText.textContent = message;
            errorMessage.classList.remove('d-none');
            successContent.classList.add('d-none');
        }
    });
</script>
{% endblock %}