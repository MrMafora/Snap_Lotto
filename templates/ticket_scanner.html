{% extends "base.html" %}

{% block title %}South Africa's ONLY Lottery Ticket Scanner | Check If You've Won Instantly | Snap Lotto{% endblock %}

{% block meta_description %}The ONLY app with official Ithuba Lotto,
PowerBall &
Daily Lotto data,
Snap Scan and Win = Phanda Phusha Play. Upload your lottery ticket and get instant results. Free with no registration.{% endblock %}

{% block meta_keywords %}South Africa lottery ticket scanner, scan Lotto ticket South Africa, check lottery ticket South Africa, PowerBall ticket scanner, only lottery scanner app, instant lottery check{% endblock %}

{% block og_title %}South Africa's ONLY Lottery Ticket Scanner | Check If You've Won Instantly{% endblock %}
{% block og_description %}The ONLY app with official Ithuba Lotto,
PowerBall &
Daily Lotto data,
Snap Scan and Win = Phanda Phusha Play. Our exclusive technology gives you instant results for all lottery tickets.{% endblock %}

{% block head_content %}
<!-- CSS for optimized lottery balls display across all devices -->
<style>
    /* Lottery balls container styling for columnar layout */
    .lottery-balls-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
        grid-gap: 8px;
        margin-bottom: 1rem;
        align-items: center;
        justify-content: start;
    }
    
    @media (min-width: 576px) {
        .lottery-balls-container {
            grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
            grid-gap: 10px;
        }
    }
    
    /* Optimize for mobile screens */
    @media (max-width: 575.98px) {
        .lottery-ball {
            width: 40px !important;
            height: 40px !important;
            line-height: 40px !important;
            font-size: 16px !important;
        }
    }
    
    /* Animation for View Results button */
    @keyframes pulse {
        0% {
            transform: scale(1);
            box-shadow: 0 4px 8px rgba(40,167,69,0.2);
        }
        50% {
            transform: scale(1.05);
            box-shadow: 0 6px 12px rgba(40,167,69,0.4);
        }
        100% {
            transform: scale(1);
            box-shadow: 0 4px 8px rgba(40,167,69,0.2);
        }
    }
    
    .animate-pulse {
        animation: pulse 1.5s infinite;
    }
    
    /* Ensure all lottery balls are responsive with fixed aspect ratio */
    .lottery-ball {
        width: 50px;
        height: 50px;
        line-height: 50px;
        text-align: center;
        border-radius: 50%;
        font-weight: bold;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        display: inline-block;
        margin: 2px;
        color: #fff;
        font-size: 18px;
        position: relative;
    }
    
    .ball-matched {
        position: relative;
    }
    
    .ball-matched:after {
        content: "✓";
        position: absolute;
        top: -5px;
        right: -5px;
        background-color: #28a745;
        color: white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        font-size: 12px;
        line-height: 20px;
        text-align: center;
    }
    
    /* Ensure bonus balls and matched balls stand out */
    .lottery-ball-bonus {
        position: relative;
    }
    
    .lottery-ball-bonus:after {
        content: "★";
        position: absolute;
        top: -5px;
        right: -5px;
        color: gold;
        font-size: 14px;
        text-shadow: 0 0 2px rgba(0,0,0,0.5);
    }
</style>

<!-- Structured Data for SEO -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "WebApplication",
  "name": "Snap Lotto Ticket Scanner",
  "applicationCategory": "UtilityApplication",
  "operatingSystem": "All",
  "offers": {
    "@type": "Offer",
    "price": "0",
    "priceCurrency": "ZAR"
  },
  "featureList": [
    "Instant ticket scanning",
    "AI-powered number recognition",
    "All South African lottery games supported",
    "No registration required",
    "Free to use"
  ],
  "description": "The ONLY app with official Ithuba Lotto, PowerBall & Daily Lotto data, Snap Scan and Win = Phanda Phusha Play. Upload your lottery ticket and check if you've won instantly."
}
</script>
{% endblock %}

{% block additional_head %}
<!-- Fresh checkmark system - clean slate approach -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/fresh_checkmark.css') }}">
<style>
    .ticket-scanner-container {
        max-width: 800px;
        margin: 0 auto;
    }
    
    @media (max-width: 576px) {
        .card-body {
            padding: 0.75rem;
        }
        
        .ticket-scanner-container .form-control, 
        .ticket-scanner-container .form-select {
            padding-top: 0.375rem;
            padding-bottom: 0.375rem;
        }
        
        .ticket-preview {
            max-height: 200px;
            margin: 10px 0;
        }
        
        h1 {
            font-size: 1.75rem;
        }
        
        .lead {
            font-size: 1rem;
        }
    }
    .ticket-drop-area {
        border: 2px dashed #aaa;
        border-radius: 8px;
        padding: 40px;
        text-align: center;
    }
    
    @media (max-width: 576px) {
        .ticket-drop-area {
            padding: 20px;
        }
    }
    @keyframes pulse {
        0% {
            transform: scale(1);
            box-shadow: 0 0 0 0 rgba(0, 123, 255, 0.7);
        }
        
        70% {
            transform: scale(1.05);
            box-shadow: 0 0 0 10px rgba(0, 123, 255, 0);
        }
        
        100% {
            transform: scale(1);
            box-shadow: 0 0 0 0 rgba(0, 123, 255, 0);
        }
    }
    
    /* Updated matched ball styling - now handled in fresh_checkmark.css */
    
    /* Match indicators are now defined in fresh_checkmark.css */
    
    .ticket-drop-area {
        background-color: rgba(0,0,0,0.05);
        cursor: pointer;
        transition: all 0.3s;
        margin-bottom: 20px;
    }
    .ticket-drop-area:hover, .ticket-drop-area.highlight {
        border-color: var(--sa-lottery-yellow);
        background-color: rgba(0,0,0,0.1);
    }
    .ticket-preview {
        max-width: 100%;
        max-height: 300px;
        margin: 20px 0;
    }
    .results-container {
        margin-top: 30px;
    }
    /* Position for matched balls is handled in fresh_checkmark.css */
    /* We'll use .match-indicator elements instead of ::after pseudo-element */
    .prize-card {
        border-left: 5px solid var(--bs-success);
    }
    #scanner-loading {
        display: none;
    }
    
    /* Advertisement - Fixed Style for All Ad Overlays */
    #ad-overlay-loading, #ad-overlay-results, .interstitial-view {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        width: 100% !important;
        height: 100% !important;
        background-color: rgba(255, 255, 255, 0.98) !important;
        z-index: 999999 !important;
        flex-direction: column !important;
        align-items: center !important;
        justify-content: center !important;
        padding: 20px !important;
        overflow-y: auto !important;
    }
    
    /* Fixed additional styles */
    .ad-container-wrapper {
        width: 100% !important;
        max-width: 350px !important;
        margin: 15px auto !important;
    }
    
    .ad-container {
        width: 100% !important;
        margin: 0 auto !important;
    }
    
    .ad-placeholder {
        border: 1px solid #ddd !important;
        border-radius: 8px !important;
        padding: 15px !important;
        background-color: #f8f9fa !important;
        text-align: center !important;
    }
    
    /* Button pulse animation */
    @keyframes btn-pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); box-shadow: 0 0 15px rgba(40, 167, 69, 0.7); }
        100% { transform: scale(1); }
    }
    
    .btn-pulse {
        animation: btn-pulse 1.5s infinite;
    }
    
    /* Interstitial view controls */
    .interstitial-view {
        display: none !important; /* Force hidden by default */
        opacity: 0 !important;
        visibility: hidden !important;
        transition: opacity 0.3s ease-in-out !important;
    }
    
    /* This class will be added by JavaScript when showing is needed */
    .interstitial-view.active {
        display: flex !important;
        opacity: 1 !important;
        visibility: visible !important;
    }
    
    /* Make the View Results button more prominent */
    #view-results-btn {
        min-width: 220px !important;
        padding: 15px 30px !important;
        font-size: 20px !important;
        font-weight: bold !important;
        border-radius: 10px !important;
        box-shadow: 0 6px 10px rgba(40,167,69,0.3) !important;
        margin-top: 15px !important;
        transition: all 0.2s ease !important;
    }
    
    #view-results-btn:hover {
        transform: translateY(-3px) !important;
        box-shadow: 0 8px 15px rgba(40,167,69,0.4) !important;
    }
</style>
{% endblock %}

{% block content %}
<!-- Ad overlay - Loading screen -->
<div id="ad-overlay-loading" class="interstitial-view" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.98); z-index: 10000; flex-direction: column; justify-content: center; align-items: center; text-align: center; overflow-y: auto; padding: 20px;">
    <h4 class="mb-4">Processing your ticket...</h4>
    <div class="ad-container-wrapper">
        <div id="ad-container-loader" class="ad-container">
            <!-- FIRST AD: Yellow badge -->
            <div class="ad-placeholder" style="padding: 25px; background-color: #f3f3f3; border-radius: 8px; text-align: center; box-shadow: 0 0 15px rgba(0,0,0,0.2); width: 100%; max-width: 500px; margin: 0 auto; border: 1px solid #ddd;">
                <p><span class="badge" style="background-color: #ffde00; color: #000; font-weight: bold; padding: 3px 10px; border-radius: 4px; font-size: 14px; display: inline-block;">Ad</span></p>
                <p style="font-size: 16px; color: #6c757d; margin: 15px 0; font-weight: bold;">Advertisement</p>
                <img src="/static/ads/standard-ad-1.svg" style="max-width: 100%; height: auto; margin: 15px 0; display: block;" alt="Advertisement">
                <p style="color: #6c757d; font-size: 14px; text-align: center; margin-top: 15px; padding: 5px; background-color: #f9f9f9; border-radius: 5px;">To advertise here please contact us on:<br><strong>+27 (61) 544-8311</strong></p>
            </div>
        </div>
    </div>
    <div class="mt-3">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="loading-message">Scanning in progress...</p>
        <p class="small text-muted mt-2">This will take a few moments</p>
    </div>
</div>

<!-- Ad overlay - Results screen -->
<div id="ad-overlay-results" class="interstitial-view" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.98); z-index: 10000; flex-direction: column; justify-content: center; align-items: center; text-align: center; overflow-y: auto; padding: 20px;">
    <h3 class="mb-3 text-success">Results Ready! <i class="fas fa-check-circle"></i></h3>
    <div class="alert alert-info mb-3" style="max-width: 400px;">
        Please view this advertisement while we prepare your results
    </div>
    <div class="ad-container-wrapper">
        <div id="ad-container-interstitial" class="ad-container">
            <!-- SECOND AD: Blue badge -->
            <div class="ad-placeholder" style="padding: 25px; background-color: #f3f3f3; border-radius: 8px; text-align: center; box-shadow: 0 0 15px rgba(0,0,0,0.2); width: 100%; max-width: 500px; margin: 0 auto; border: 1px solid #ddd;">
                <p><span class="badge" style="background-color: #0d6efd; color: #fff; font-weight: bold; padding: 3px 10px; border-radius: 4px; font-size: 14px; display: inline-block;">Ad</span></p>
                <p style="font-size: 16px; color: #6c757d; margin: 15px 0; font-weight: bold;">Advertisement</p>
                <img src="/static/ads/standard-ad-2.svg" style="max-width: 100%; height: auto; margin: 15px 0; display: block;" alt="Advertisement">
                <p style="color: #6c757d; font-size: 14px; margin-bottom: 10px; font-weight: 500;">Your results are ready to view below</p>
                <p style="color: #6c757d; font-size: 14px; text-align: center; margin-top: 15px; padding: 5px; background-color: #f9f9f9; border-radius: 5px;">To advertise here please contact us on:<br><strong>+27 (61) 544-8311</strong></p>
            </div>
        </div>
    </div>
    <!-- Countdown timer will be placed here above the button -->
    <div id="countdown-container" class="text-center mt-3 mb-2" style="font-weight: bold; color: #495057; background-color: #f8f9fa; padding: 8px; border-radius: 5px; max-width: 350px; margin-left: auto; margin-right: auto;"></div>
    <div class="text-center mt-4 mb-1">
        <p class="text-muted mb-2">Click the button below when ready</p>
        <span class="d-inline-block" style="animation: bounce 1s infinite;">⬇️</span>
    </div>
    <button class="btn btn-success btn-lg ad-close-btn mt-2" id="view-results-btn" style="min-width: 220px; padding: 15px 30px; font-size: 20px; font-weight: bold; border-radius: 10px; box-shadow: 0 6px 10px rgba(40,167,69,0.3);">
        <i class="fas fa-check-circle me-2"></i> View Results
    </button>
    <style>
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .btn-pulse {
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7);
            }
            
            70% {
                transform: scale(1.05);
                box-shadow: 0 0 0 10px rgba(40, 167, 69, 0);
            }
            
            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(40, 167, 69, 0);
            }
        }
        
        #process-results-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.98);
            z-index: 10000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }
        
        #process-results-btn {
            min-width: 220px;
            padding: 15px 30px;
            font-size: 20px;
            font-weight: bold;
            border-radius: 10px;
            box-shadow: 0 6px 10px rgba(0, 123, 255, 0.3);
            animation: pulse 1.5s infinite;
        }
    </style>
</div>

<div class="container py-3">
    <div class="row mb-3">
        <div class="col-12">
            <h1 class="d-flex align-items-center">
                <i class="fa fa-ticket-alt me-2"></i> Lottery Ticket Scanner
            </h1>
            <p class="lead mb-2">Upload your ticket to check if you've won</p>
            <p class="mb-3"><a href="/scanner-landing" class="text-decoration-none"><i class="fas fa-arrow-left me-1"></i> Back to Scanner Info</a></p>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="ticket-scanner-container">
                        <div class="alert alert-info py-2 small">
                            <i class="fa fa-info-circle me-1"></i> Take a clear photo of your lottery ticket, making sure all numbers are visible.
                        </div>

                        <form id="ticket-form" action="/scan-ticket" method="post" enctype="multipart/form-data" onsubmit="return handleTicketSubmission(event)">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <div class="mb-2">
                                <label for="lottery-type" class="form-label small">Select Lottery Type (Optional - AI will detect)</label>
                                <select class="form-select form-select-sm" id="lottery-type" name="lottery_type">
                                    <option value="">Auto-detect from ticket</option>
                                    <option value="Lotto">Lotto</option>
                                    <option value="Lotto Plus 1">Lotto Plus 1</option>
                                    <option value="Lotto Plus 2">Lotto Plus 2</option>
                                    <option value="Powerball">Powerball</option>
                                    <option value="Powerball Plus">Powerball Plus</option>
                                    <option value="Daily Lotto">Daily Lotto</option>
                                </select>
                            </div>

                            <div class="mb-2">
                                <label for="draw-number" class="form-label small">Draw Number (optional)</label>
                                <input type="text" class="form-control form-control-sm" id="draw-number" name="draw_number" 
                                    placeholder="Leave blank to check latest draw">
                            </div>

                            <div class="ticket-drop-area" id="drop-area">
                                <div class="mb-2">
                                    <i class="fa fa-upload fa-2x mb-2"></i>
                                    <h5 class="mb-2">Drag and drop your ticket image here</h5>
                                    <p class="mb-2">or</p>
                                    <!-- Single file input with no capture attribute to support all devices -->
                                    <input type="file" id="ticket-image" name="ticket_image" accept="image/*" class="d-none" onchange="handleFileSelection()">
                                    
                                    <!-- Simple button with direct click handler -->
                                    <button type="button" id="file-select-btn" class="btn btn-primary btn-lg" onclick="document.getElementById('ticket-image').click();"><i class="fas fa-camera me-2"></i> Take Photo</button>
                                </div>
                            </div>

                            <div id="preview-container" class="text-center mb-4" style="display: none; margin-top: 15px; padding: 10px; border: 1px solid #ddd; border-radius: 8px; background-color: #f9f9f9;">
                                <h6>Image Preview</h6>
                                <div style="display: flex; justify-content: center; align-items: center; min-height: 200px;">
                                    <img id="ticket-preview" class="ticket-preview img-fluid rounded" style="max-height: 300px; max-width: 100%; object-fit: contain; border: 1px solid #ddd; box-shadow: 0 2px 4px rgba(0,0,0,0.1);" src="">
                                </div>
                                <div class="mt-2">
                                    <button type="button" id="remove-image" class="btn btn-sm btn-outline-danger">
                                        <i class="fa fa-times"></i> Remove
                                    </button>
                                </div>
                            </div>

                            <div class="text-center mt-4">
                                <button type="submit" id="scan-button" class="btn btn-success btn-lg w-100" style="padding: 14px; font-size: 18px; border-radius: 8px; box-shadow: 0 4px 8px rgba(40,167,69,0.2);" disabled>
                                    <i class="fa fa-search me-2"></i> Scan Ticket
                                </button>
                                <div id="scanner-loading" class="mt-3">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p>Scanning your ticket...</p>
                                </div>
                            </div>
                        </form>

                        <div id="results-container" class="results-container {% if not show_results %}d-none{% endif %}">
                            <hr>
                            <h3 class="mb-3 text-center">Scanning Results</h3>
                            
                            <div id="error-message" class="alert alert-danger {% if not scan_results or not scan_results.error %}d-none{% endif %}">
                                <i class="fa fa-exclamation-triangle me-2"></i>
                                <span id="error-text">{% if scan_results and scan_results.error %}{{ scan_results.error }}{% endif %}</span>
                            </div>
                            
                            <div id="success-content" class="{% if not scan_results or not scan_results.ticket_info %}d-none{% endif %}">
                                <div class="card mb-4">
                                    <div class="card-header bg-light">
                                        <h5 class="mb-0" id="ticket-info-title">Your Ticket</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <p><strong>Lottery Type:</strong> <span id="result-lottery-type"></span></p>
                                                <p><strong>Draw Number:</strong> <span id="result-draw-number"></span></p>
                                                <p><strong>Draw Date:</strong> <span id="result-draw-date"></span></p>
                                                
                                                <div id="detected-info" class="mt-3 small">
                                                    <p class="text-muted mb-1"><i class="fas fa-search-plus me-1"></i> <strong>OCR Detected Information:</strong></p>
                                                    <p class="mb-1"><strong>Game Type:</strong> <span id="detected-game-type"></span></p>
                                                    <p class="mb-1"><strong>Draw Number:</strong> <span id="detected-draw-number"></span></p>
                                                    <p class="mb-1"><strong>Draw Date:</strong> <span id="detected-draw-date"></span></p>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <p><strong>Your Numbers:</strong></p>
                                                <div id="ticket-numbers" class="lottery-balls-container mb-3"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="card mb-4">
                                    <div class="card-header bg-light">
                                        <h5 class="mb-0">Winning Numbers</h5>
                                    </div>
                                    <div class="card-body">
                                        <!-- Primary game winning numbers -->
                                        <div class="mb-3">
                                            <p><strong id="primary-game-label">Main Numbers:</strong></p>
                                            <div id="winning-numbers-container">
                                                <div id="winning-numbers" class="lottery-balls-container mb-3"></div>
                                            </div>
                                            <!-- Display matches for PowerBall main game -->
                                            <div id="matched-numbers-section">
                                                <p><strong>Your Matches:</strong> <span id="matched-count" class="badge bg-success">0</span></p>
                                                <div id="matched-numbers"></div>
                                            </div>
                                        </div>
                                        
                                        <!-- Hidden container for bonus (this won't be displayed separately anymore) -->
                                        <div id="bonus-numbers-container" class="d-none">
                                            <div id="bonus-numbers"></div>
                                        </div>
                                        
                                        <!-- Powerball Plus winning numbers displayed in main winning numbers card -->
                                        <div id="powerball-plus-numbers-container" class="mb-3 d-none">
                                            <hr>
                                            <p><strong>Powerball Plus Numbers:</strong></p>
                                            <div id="powerball-plus-numbers" class="lottery-balls-container mb-2"></div>
                                            <!-- Always show the Matches section for PowerBall Plus -->
                                            <div id="pp-matched-numbers-section">
                                                <p><strong>Your Matches:</strong> <span id="pp-matched-count" class="badge bg-success">0</span></p>
                                                <div id="pp-matched-numbers"></div>
                                            </div>
                                        </div>

                                        <!-- Lotto Plus 1 winning numbers section -->
                                        <div id="lotto-plus-1-numbers-container" class="mb-3 d-none">
                                            <hr>
                                            <p><strong>Lotto Plus 1 Numbers:</strong></p>
                                            <div id="lotto-plus-1-numbers" class="lottery-balls-container mb-2"></div>
                                            <!-- Hidden but needed for JavaScript to work -->
                                            <div id="lp1-matched-numbers-section" class="d-none">
                                                <p><strong>Your Matches:</strong> <span id="lp1-matched-count" class="badge bg-success">0</span></p>
                                                <div id="lp1-matched-numbers"></div>
                                            </div>
                                        </div>
                                        
                                        <!-- Lotto Plus 2 winning numbers section -->
                                        <div id="lotto-plus-2-numbers-container" class="mb-3 d-none">
                                            <hr>
                                            <p><strong>Lotto Plus 2 Numbers:</strong></p>
                                            <div id="lotto-plus-2-numbers" class="lottery-balls-container mb-2"></div>
                                            <!-- Hidden but needed for JavaScript to work -->
                                            <div id="lp2-matched-numbers-section" class="d-none">
                                                <p><strong>Your Matches:</strong> <span id="lp2-matched-count" class="badge bg-success">0</span></p>
                                                <div id="lp2-matched-numbers"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div id="prize-container" class="d-none">
                                    <div class="card prize-card">
                                        <div class="card-body">
                                            <h4 class="text-success mb-3"><i class="fa fa-trophy me-2"></i> Congratulations!</h4>
                                            <p class="lead">You've won a prize in <span id="prize-lottery-type"></span> Draw <span id="prize-draw-number"></span>!</p>
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <p><strong>Division:</strong> <span id="prize-division"></span></p>
                                                    <p><strong>Match Type:</strong> <span id="prize-match-type"></span></p>
                                                </div>
                                                <div class="col-md-6">
                                                    <h3 class="text-success">Prize: <span id="prize-amount"></span></h3>
                                                </div>
                                            </div>
                                            <p class="small text-muted mt-3">Visit the official South African National Lottery website or an authorized retailer to claim your prize.</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div id="no-prize-container" class="d-none">
                                    <div class="card">
                                        <div class="card-body text-center">
                                            <h4 class="text-muted mb-3"><i class="fa fa-times-circle me-2"></i> No Prize</h4>
                                            <p>Sorry, your ticket did not win a prize in this draw.</p>
                                            <p>Better luck next time!</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Container for Powerball Plus results -->
                                <div id="powerball-plus-container" class="d-none mt-4"></div>
                                
                                <!-- Scan Another Ticket button -->
                                <div class="text-center mt-4 mb-3">
                                    <button id="scan-another-ticket" class="btn btn-primary btn-lg w-100" style="padding: 14px; font-size: 18px; border-radius: 8px; box-shadow: 0 4px 8px rgba(13,110,253,0.2);">
                                        <i class="fas fa-camera me-2"></i> Scan Another Ticket
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block additional_scripts %}
<script src="{{ url_for('static', filename='js/ticket-scanner-fixed.js') }}"></script>
<script>
{% if scan_results and scan_results.ticket_info %}
// Populate results from server-side rendered data
document.addEventListener('DOMContentLoaded', function() {
    console.log("Populating results from server-side data");
    
    // Get the scan results from the template
    const scanResults = {{ scan_results|tojson }};
    
    // Display the results using the existing function
    if (window.displayResults) {
        window.displayResults(scanResults);
    } else {
        console.error("displayResults function not found");
    }
});
{% endif %}
// Keep these definitions for backward compatibility
function processTicketWithAds() {
    console.log("processTicketWithAds called", new Date().toISOString());
    
    // Verify we have a file
    const fileInput = document.getElementById('ticket-image');
    if (fileInput && fileInput.files.length > 0) {
        console.log("File is selected:", fileInput.files[0].name);
    } else {
        console.error("No file selected!");
        alert("Please select an image first");
        return;
    }
    
    // Clear any previous results first
    const clearPreviousResults = window.clearPreviousResults || function() {
        console.log("Using inline clearPreviousResults function");
        // Hide results container
        const resultsContainer = document.getElementById('results-container');
        if (resultsContainer) {
            resultsContainer.classList.add('d-none');
        }
        
        // Hide error message
        const errorMessage = document.getElementById('error-message');
        if (errorMessage) {
            errorMessage.classList.add('d-none');
        }
    };
    
    clearPreviousResults();
    
    // Disable scrolling during processing
    const disableScrolling = window.disableScrolling || function() {
        document.body.style.overflow = 'hidden';
    };
    
    // Enable scrolling
    const enableScrolling = window.enableScrolling || function() {
        document.body.style.overflow = '';
    };
    
    // Scroll to top and disable scrolling during processing
    window.scrollTo(0, 0);
    disableScrolling();
    
    // Get required elements
    const ticketForm = document.getElementById('ticket-form');
    const loadingIndicator = document.getElementById('scanner-loading');
    const scanButton = document.getElementById('scan-button');
    
    if (!ticketForm) {
        console.error("Ticket form not found!");
        return;
    }
    
    // Show loading indicator
    if (loadingIndicator) {
        loadingIndicator.style.display = 'block';
    }
    
    // Never disable the scan button
    if (scanButton) {
        scanButton.disabled = false;
    }
    
    // Create form data for later use
    const formData = new FormData(ticketForm);
    console.log("FormData created with file:", fileInput.files[0].name);
    
    // Show the loading ad overlay first
    const adOverlayLoading = document.getElementById('ad-overlay-loading');
    if (adOverlayLoading) {
        adOverlayLoading.style.display = 'flex';
        console.log("Ad overlay loading displayed");
    } else {
        console.error("Ad overlay loading element not found!");
    }
    
    // Process using the ad display system
    // Ensure the ad overlay stays visible for at least 2 seconds before processing
    setTimeout(() => {
        // Check if AdManager is available and use it to show ad, otherwise just process
        if (window.AdManager && typeof window.AdManager.showLoadingAd === 'function') {
            console.log('Using AdManager to show loading ad');
            window.AdManager.showLoadingAd(function(adShown) {
                // Keep ad visible for at least 5 seconds total
                setTimeout(() => {
                    // After ad is displayed for minimum time, process the ticket
                    console.log('Ad loading callback returned after minimum display time:', adShown);
                    processTicket(formData);
                }, 3000); // 3 seconds additional display time (2s initial + 3s = 5s total)
            });
        } else {
            // Fallback - Ad overlay is already shown manually
            console.log('AdManager not available, showing overlay manually');
            
            // Process the ticket after a minimum viewing time
            setTimeout(() => {
                console.log('Processing ticket without AdManager after minimum ad view time');
                processTicket(formData);
            }, 3000); // 3 seconds additional display time (2s initial + 3s = 5s total)
        }
    }, 2000); // Initial 2 seconds minimum display time
    
    // Function to process the ticket after ad is shown
    function processTicket(formData) {
        console.log("processTicket called with formData", new Date().toISOString());
        
        // Add CSRF token to headers
        const csrfToken = document.querySelector('input[name="csrf_token"]').value;
        console.log("CSRF token:", csrfToken);
        
        // Make fetch request
        console.log("Starting fetch to /scan-ticket");
        fetch('/scan-ticket', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => {
            console.log("Received response:", response.status, response.statusText);
            if (!response.ok) {
                console.error("Error response:", response.status, response.statusText);
                throw new Error('Network response was not ok: ' + response.status);
            }
            console.log("Response OK, parsing JSON");
            return response.json();
        })
        .then(data => {
            console.log("Received data from server:", data);
            
            // Hide loading overlay
            const adOverlayLoading = document.getElementById('ad-overlay-loading');
            if (adOverlayLoading) {
                adOverlayLoading.style.display = 'none';
            }
            
            // Ensure the results overlay is shown
            const adOverlayResults = document.getElementById('ad-overlay-results');
            if (adOverlayResults) {
                // Always make sure the results overlay is displayed
                adOverlayResults.style.display = 'flex';
                
                // Try to use AdManager for tracking, but we'll show the overlay manually either way
                if (window.AdManager && typeof window.AdManager.showInterstitialAd === 'function') {
                    console.log('Using AdManager to show interstitial ad');
                    window.AdManager.showInterstitialAd(function(adShown) {
                        console.log('Interstitial ad shown:', adShown);
                        // Make sure the overlay is displayed even if AdManager fails
                        adOverlayResults.style.display = 'flex';
                    });
                } else {
                    console.log('AdManager not available, showing results overlay manually');
                }
                
                console.log('Showing results interstitial ad');
                
                // Display results when the "View Results" button is clicked
                const displayResults = window.displayResults || function(data) {
                    console.log("Using inline displayResults function");
                    console.log("Would display results for:", data);
                    
                    // Show the results container
                    const resultsContainer = document.getElementById('results-container');
                    if (resultsContainer) {
                        resultsContainer.classList.remove('d-none');
                    }
                    
                    // Add core results display
                    const ticketInfo = document.getElementById('ticket-info');
                    if (ticketInfo) {
                        let infoHTML = `
                            <div class="alert alert-info">
                                <h4>${data.ticket_info.game_type} Draw #${data.ticket_info.draw_number}</h4>
                                <p>Draw Date: ${data.ticket_info.draw_date}</p>
                            </div>
                        `;
                        ticketInfo.innerHTML = infoHTML;
                    }
                };
                
                // View Results button handling
                const viewResultsBtn = document.getElementById('view-results-btn');
                if (viewResultsBtn) {
                    viewResultsBtn.onclick = function(e) {
                        // Prevent any default actions
                        e.preventDefault();
                        e.stopPropagation();
                        
                        console.log('View Results button clicked at ' + new Date().toISOString());
                        
                        // Force hide all overlays immediately
                        const allOverlays = document.querySelectorAll('[id^="ad-overlay"]');
                        allOverlays.forEach(overlay => {
                            overlay.style.display = 'none';
                        });
                        
                        // Make sure body scrolling is enabled
                        enableScrolling();
                        
                        console.log('About to display results after clicked View Results');
                        
                        // Display the results immediately
                        displayResults(data);
                    };
                    
                    // FORCEFULLY disable the view results button for 15 seconds
                    viewResultsBtn.disabled = true;
                    viewResultsBtn.style.opacity = '0.5';
                    viewResultsBtn.style.cursor = 'not-allowed';
                    viewResultsBtn.innerHTML = '<i class="fas fa-lock me-2"></i> View Results (Wait 15s)';
                    
                    // Set a timer to enable the button after 15 seconds
                    setTimeout(() => {
                        viewResultsBtn.disabled = false;
                        viewResultsBtn.style.opacity = '1';
                        viewResultsBtn.style.cursor = 'pointer';
                        viewResultsBtn.innerHTML = '<i class="fas fa-check-circle me-2"></i> View Results Now';
                    }, 15000); // 15 seconds
                }
            }
        })
        .catch(error => {
            console.error("Error in fetch:", error);
            
            // Hide loading overlay
            const adOverlayLoading = document.getElementById('ad-overlay-loading');
            if (adOverlayLoading) {
                adOverlayLoading.style.display = 'none';
            }
            
            // Re-enable scrolling
            enableScrolling();
            
            // Show error to user
            const errorMessage = document.getElementById('error-message');
            const errorText = document.getElementById('error-text');
            if (errorMessage && errorText) {
                errorText.textContent = "Error processing your ticket: " + error.message;
                errorMessage.classList.remove('d-none');
            }
            
            // Show the results container for error display
            const resultsContainer = document.getElementById('results-container');
            if (resultsContainer) {
                resultsContainer.classList.remove('d-none');
            }
        });
    }
}
}

// Simplified file handling function - completely rewritten
function handleFileSelection() {
    console.log("SimpleFileSelect: Function called");
    
    // Get all required elements
    const fileInput = document.getElementById('ticket-image');
    const previewContainer = document.getElementById('preview-container');
    const ticketPreview = document.getElementById('ticket-preview');
    const scanButton = document.getElementById('scan-button');
    
    if (!fileInput || !previewContainer || !ticketPreview || !scanButton) {
        console.error("SimpleFileSelect: One or more elements not found!");
        alert("Error: Some page elements were not found. Please refresh the page.");
        return;
    }
    
    // Get the selected file
    const file = fileInput.files[0];
    
    if (file) {
        console.log("SimpleFileSelect: File selected - Name: " + file.name + ", Type: " + file.type + ", Size: " + file.size + " bytes");
        
        // Validate file type
        if (!file.type.match('image.*')) {
            alert('Please select an image file (JPG, PNG, etc.).');
            fileInput.value = '';
            scanButton.disabled = true;
            return;
        }
        
        try {
            // Create a direct object URL instead of using FileReader for better compatibility
            const objectUrl = URL.createObjectURL(file);
            console.log("SimpleFileSelect: Created object URL");
            
            // Set the image source directly
            ticketPreview.onload = function() {
                console.log("SimpleFileSelect: Image loaded successfully");
                
                // Show the preview container - using multiple methods for maximum compatibility
                previewContainer.style.display = 'block';
                previewContainer.classList.remove('d-none');
                
                // Enable the scan button - MUST do this both ways for cross-browser compatibility
                scanButton.disabled = false;
                scanButton.removeAttribute('disabled');
                
                console.log("SimpleFileSelect: Preview displayed and scan button enabled");
            };
            
            ticketPreview.onerror = function() {
                console.error("SimpleFileSelect: Error loading image");
                alert('Error displaying the image. Please try another file.');
                fileInput.value = '';
                scanButton.disabled = true;
            };
            
            // Set the source to trigger the onload event
            ticketPreview.src = objectUrl;
            
        } catch (e) {
            console.error("SimpleFileSelect: Error creating object URL:", e);
            alert('Error processing the image file. Please try a different image.');
            fileInput.value = '';
            scanButton.disabled = true;
        }
    } else {
        console.log("SimpleFileSelect: No file selected");
        previewContainer.style.display = 'none';
        scanButton.disabled = true;
    }
    
    // Set up remove button handler
    const removeImageBtn = document.getElementById('remove-image');
    if (removeImageBtn) {
        removeImageBtn.onclick = function() {
            console.log("SimpleFileSelect: Remove button clicked");
            
            // Clear the file input
            fileInput.value = '';
            
            // Clear the image source and revoke the object URL to free memory
            if (ticketPreview.src && ticketPreview.src.startsWith('blob:')) {
                URL.revokeObjectURL(ticketPreview.src);
            }
            ticketPreview.src = '';
            
            // Hide the preview container
            previewContainer.style.display = 'none';
            
            // Disable the scan button
            scanButton.disabled = true;
            
            console.log("SimpleFileSelect: Image removed and preview hidden");
        };
    }
}
</script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Add event listener for "Scan Another Ticket" button
        const scanAnotherButton = document.getElementById('scan-another-ticket');
        if (scanAnotherButton) {
            scanAnotherButton.addEventListener('click', function(e) {
                e.preventDefault();
                console.log('Scan Another Ticket button clicked');
                
                // Reset the file input
                const fileInput = document.getElementById('ticket-image');
                if (fileInput) {
                    fileInput.value = '';
                }
                
                // Reset the preview if present
                const previewContainer = document.getElementById('preview-container');
                if (previewContainer) {
                    previewContainer.classList.add('d-none');
                }
                
                // iOS-specific fixes for camera access
                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
                if (isIOS) {
                    console.log("iOS device detected, refreshing camera access");
                    // Force refresh camera button to ensure it works on subsequent tries
                    setTimeout(function() {
                        const fileSelectBtn = document.getElementById('file-select-btn');
                        if (fileSelectBtn) {
                            // Refresh button state to trigger iOS to clear camera permissions
                            fileSelectBtn.style.opacity = "0.99";
                            setTimeout(() => {
                                fileSelectBtn.style.opacity = "1";
                            }, 50);
                        }
                    }, 100);
                }
                
                // Hide results container
                const resultsContainer = document.getElementById('results-container');
                if (resultsContainer) {
                    resultsContainer.classList.add('d-none');
                    
                    // Reset results display flags
                    window.inResultsMode = false;
                    window.lastResultsData = null;
                    
                    // Remove any results mode classes from the body
                    document.body.classList.remove('showing-results');
                    document.body.classList.remove('results-mode');
                }
                
                // Ensure scrolling is fully enabled
                enableScrolling();
                
                // Hide any ad overlays that might still be visible
                const adOverlay = document.getElementById('ad-overlay');
                if (adOverlay) {
                    adOverlay.style.display = 'none';
                }
                
                const adOverlayResults = document.getElementById('ad-overlay-results');
                if (adOverlayResults) {
                    adOverlayResults.style.display = 'none';
                }
                
                // Update scan button status in case a file was already selected
                const scanButton = document.getElementById('scan-button');
                if (scanButton) {
                    scanButton.disabled = true;
                }
                
                // Clean up any running countdown or timer
                if (window.countdownTimeout) {
                    clearTimeout(window.countdownTimeout);
                    window.countdownTimeout = null;
                }
                
                if (window.countdownInterval) {
                    clearInterval(window.countdownInterval);
                    window.countdownInterval = null;
                }
                
                window.countdownRunning = false;
                
                // Scroll to the upload form
                const ticketForm = document.getElementById('ticket-form');
                if (ticketForm) {
                    ticketForm.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            });
        }
        // Helper function to create checkmark for match indicators
        // This ensures consistent checkmarks across all match indicators
        window.createCheckmark = function() {
            return ''; // We're now using CSS to create the checkmark visually
        };
        
        const dropArea = document.getElementById('drop-area');
        const fileInput = document.getElementById('ticket-image');
        const fileSelectBtn = document.getElementById('file-select-btn');
        const previewContainer = document.getElementById('preview-container');
        const ticketPreview = document.getElementById('ticket-preview');
        const removeImageBtn = document.getElementById('remove-image');
        const scanButton = document.getElementById('scan-button');
        const ticketForm = document.getElementById('ticket-form');
        const lotteryTypeSelect = document.getElementById('lottery-type');
        const loadingIndicator = document.getElementById('scanner-loading');
        const resultsContainer = document.getElementById('results-container');
        
        // Initialize scan button state after a short delay
        setTimeout(() => {
            // Disable scan button by default
            if (scanButton) {
                scanButton.disabled = !fileInput || !fileInput.files || fileInput.files.length === 0;
                console.log("Initial scan button state set:", !scanButton.disabled);
            }
        }, 500);
        
        // Make sure scanner loading is hidden initially
        if (loadingIndicator) {
            loadingIndicator.style.display = 'none';
        }
        
        // The button click handling is now fully managed by the inline handlers
        // This prevents duplicate event listeners
        
        // File selection change is handled directly on the input element using inline onchange
        // We don't need this event listener anymore as it might cause duplicate event handling
        
        // Drag and drop events
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, preventDefaults, false);
        });
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, highlight, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, unhighlight, false);
        });
        
        function highlight() {
            dropArea.classList.add('highlight');
        }
        
        function unhighlight() {
            dropArea.classList.remove('highlight');
        }
        
        dropArea.addEventListener('drop', handleDrop, false);
        
        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            
            if (files.length > 0) {
                fileInput.files = files;
                handleFileSelection();
            }
        }
        
        function handleFileSelect() {
            console.log("handleFileSelect called with fileInput:", fileInput);
            const file = fileInput.files[0];
            console.log("Selected file:", file);
            
            if (file) {
                console.log("File details - Type:", file.type, "Size:", file.size, "bytes");
                // Check if file is an image
                if (!file.type.match('image.*')) {
                    alert('Please select an image file');
                    fileInput.value = ''; // Clear the file input
                    return;
                }
                
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    console.log("FileReader onload event triggered");
                    ticketPreview.src = e.target.result;
                    previewContainer.classList.remove('d-none');
                    // Update scan button state
                    updateScanButton();
                    console.log("File loaded successfully and preview displayed");
                }
                
                reader.onerror = function(e) {
                    console.error("FileReader error:", e);
                    alert('Error reading the image file. Please try a different image.');
                    fileInput.value = ''; // Clear the file input on error
                    updateScanButton();
                }
                
                console.log("Starting FileReader.readAsDataURL");
                reader.readAsDataURL(file);
            } else {
                console.log("No file selected");
                previewContainer.classList.add('d-none');
                updateScanButton();
            }
        }
        
        removeImageBtn.addEventListener('click', function() {
            ticketPreview.src = '';
            fileInput.value = '';
            previewContainer.classList.add('d-none');
            updateScanButton();
        });
        
        lotteryTypeSelect.addEventListener('change', updateScanButton);
        
        // Scan button has direct inline onclick handler now, removing to avoid duplicates
        
        function updateScanButton() {
            // Always keep the button enabled
            scanButton.disabled = false;
            console.log("Button state updated:", {
                fileCount: fileInput.files.length,
                lotteryType: lotteryTypeSelect.value,
                disabled: false
            });
        }
        
        // Function to handle showing ads and processing the ticket
        // Clear previous results to prevent mixing results from different tickets
        function clearPreviousResults() {
            // Clean up any existing countdown timers when clearing results
            if (window.countdownInterval) {
                clearInterval(window.countdownInterval);
                window.countdownInterval = null;
            }
            
            if (window.countdownTimeout) {
                clearTimeout(window.countdownTimeout);
                window.countdownTimeout = null;
            }
            
            // Reset the countdown running flag since we're starting fresh
            window.countdownRunning = false;
            
            // Hide result containers
            const resultsContainer = document.getElementById('results-container');
            if (resultsContainer) {
                resultsContainer.classList.add('d-none');
            }
            
            const successContent = document.getElementById('success-content');
            if (successContent) {
                successContent.classList.add('d-none');
            }
            
            // Clear winning numbers
            const winningNumbersContainer = document.getElementById('winning-numbers');
            if (winningNumbersContainer) {
                winningNumbersContainer.innerHTML = '';
            }
            
            // Clear ticket numbers
            const ticketNumbersContainer = document.getElementById('ticket-numbers');
            if (ticketNumbersContainer) {
                ticketNumbersContainer.innerHTML = '';
            }
            
            // Hide and clear all additional game containers
            const additionalGameContainers = [
                'powerball-plus-numbers-container',
                'lotto-plus-1-numbers-container',
                'lotto-plus-2-numbers-container'
            ];
            
            additionalGameContainers.forEach(id => {
                const container = document.getElementById(id);
                if (container) {
                    container.classList.add('d-none');
                    
                    // Also clear the numbers inside these containers
                    const numbersEl = document.getElementById(id.replace('-container', ''));
                    if (numbersEl) {
                        numbersEl.innerHTML = '';
                    }
                    
                    // Clear the matched numbers
                    const matchedId = id.replace('numbers-container', 'matched-numbers');
                    const matchedEl = document.getElementById(matchedId);
                    if (matchedEl) {
                        matchedEl.innerHTML = '';
                    }
                    
                    // Reset the matched count
                    const countId = id.replace('numbers-container', 'matched-count');
                    const countEl = document.getElementById(countId);
                    if (countEl) {
                        countEl.textContent = '0';
                    }
                }
            });
            
            // Hide related game sections if they exist
            ['powerball-plus-section', 'lotto-plus-1-section', 'lotto-plus-2-section'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.classList.add('d-none');
                }
            });
            
            console.log('Cleared previous results');
        }
        
        // Using the globally defined processTicketWithAds function
        // Do not redefine it here to avoid conflicts
            
            // Scroll to top and disable scrolling during processing
            window.scrollTo(0, 0);
            disableScrolling();
            
            // Show loading indicator
            loadingIndicator.style.display = 'block';
            // Never disable the scan button
            scanButton.disabled = false;
            
            // Create form data for later use
            const formData = new FormData(ticketForm);
            console.log("FormData created with file:", fileInput.files[0].name);
            
            // Show the loading ad overlay first
            const adOverlayLoading = document.getElementById('ad-overlay-loading');
            if (adOverlayLoading) {
                adOverlayLoading.style.display = 'flex';
                console.log("Ad overlay loading displayed");
            } else {
                console.error("Ad overlay loading element not found!");
            }
            
            // For quick testing, process the ticket directly
            console.log("BYPASSING ADS FOR DEBUGGING - Processing ticket immediately");
            processTicket(formData);
            // Ensure the ad overlay stays visible for at least 2 seconds before processing
            setTimeout(() => {
                // Check if AdManager is available and use it to show ad, otherwise just process
                if (window.AdManager && typeof window.AdManager.showLoadingAd === 'function') {
                    console.log('Using AdManager to show loading ad');
                    window.AdManager.showLoadingAd(function(adShown) {
                        // Keep ad visible for at least 5 seconds total
                        setTimeout(() => {
                            // After ad is displayed for minimum time, process the ticket
                            console.log('Ad loading callback returned after minimum display time:', adShown);
                            processTicket(formData);
                        }, 3000); // 3 seconds additional display time (2s initial + 3s = 5s total)
                    });
                } else {
                    // Fallback - Ad overlay is already shown manually
                    console.log('AdManager not available, showing overlay manually');
                    
                    // Process the ticket after a minimum viewing time
                    setTimeout(() => {
                        console.log('Processing ticket without AdManager after minimum ad view time');
                        processTicket(formData);
                    }, 3000); // 3 seconds additional display time (2s initial + 3s = 5s total)
                }
            }, 2000); // Initial 2 seconds minimum display time
            */
        }
        
        // Function to process the ticket after ad is shown
        function processTicket(formData) {
            console.log("processTicket called with formData", new Date().toISOString());
            
            // Log form data contents
            console.log("FormData entries:");
            for (let pair of formData.entries()) {
                console.log(pair[0] + ': ' + pair[1]);
            }
            
            // Add CSRF token to headers
            const csrfToken = document.querySelector('input[name="csrf_token"]').value;
            console.log("CSRF token:", csrfToken);
            
            // Add CSRF token to request headers
            console.log("Starting fetch to /scan-ticket");
            fetch('/scan-ticket', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': csrfToken
                }
            })
            .then(response => {
                console.log("Received response:", response.status, response.statusText);
                if (!response.ok) {
                    console.error("Error response:", response.status, response.statusText);
                    throw new Error('Network response was not ok: ' + response.status);
                }
                console.log("Response OK, parsing JSON");
                return response.json();
            })
            .catch(error => {
                console.error("Error in fetch:", error);
                alert("Error processing ticket: " + error.message);
                
                // Hide loading overlay
                const adOverlayLoading = document.getElementById('ad-overlay-loading');
                if (adOverlayLoading) {
                    adOverlayLoading.style.display = 'none';
                }
                
                // Re-enable scrolling
                enableScrolling();
                
                // Show error to user
                const errorMessage = document.getElementById('error-message');
                const errorText = document.getElementById('error-text');
                if (errorMessage && errorText) {
                    errorText.textContent = "Error processing your ticket: " + error.message;
                    errorMessage.classList.remove('d-none');
                    resultsContainer.classList.remove('d-none');
                }
            })
            .then(data => {
                console.log("Received data from server:", data);
                console.log('Success:', data);
                
                // Hide loading overlay
                const adOverlayLoading = document.getElementById('ad-overlay-loading');
                adOverlayLoading.style.display = 'none';
                
                // Ensure the results overlay is shown
                const adOverlayResults = document.getElementById('ad-overlay-results');
                
                // Always make sure the results overlay is displayed
                adOverlayResults.style.display = 'flex';
                
                // Try to use AdManager for tracking, but we'll show the overlay manually either way
                if (window.AdManager && typeof window.AdManager.showInterstitialAd === 'function') {
                    console.log('Using AdManager to show interstitial ad');
                    window.AdManager.showInterstitialAd(function(adShown) {
                        console.log('Interstitial ad shown:', adShown);
                        // Make sure the overlay is displayed even if AdManager fails
                        adOverlayResults.style.display = 'flex';
                    });
                } else {
                    console.log('AdManager not available, showing results overlay manually');
                }
                
                console.log('Showing results interstitial ad');
                
                // Get the ad container
                const adContainer = document.getElementById('ad-container-interstitial');
                
                // View Results button handling
                const viewResultsBtn = document.getElementById('view-results-btn');
                viewResultsBtn.onclick = function(e) {
                    // Prevent any default actions
                    e.preventDefault();
                    e.stopPropagation();
                    
                    console.log('View Results button clicked at ' + new Date().toISOString());
                    
                    // Clear ALL possible timers to prevent any conflicts
                    // This is important to prevent any hidden callbacks from running later
                    for (let i = 1; i < 10000; i++) {
                        clearTimeout(i);
                        clearInterval(i);
                    }
                    
                    // Clear our named timers
                    if (window.countdownInterval) {
                        clearInterval(window.countdownInterval);
                        window.countdownInterval = null;
                    }
                    
                    if (window.countdownTimeout) {
                        clearTimeout(window.countdownTimeout);
                        window.countdownTimeout = null;
                    }
                    
                    // Reset other possible timeout variables
                    if (window.adDisplayTimeout) {
                        clearTimeout(window.adDisplayTimeout);
                        window.adDisplayTimeout = null;
                    }
                    
                    if (window.resultDisplayTimeout) {
                        clearTimeout(window.resultDisplayTimeout);
                        window.resultDisplayTimeout = null;
                    }
                    
                    // Set state flags immediately
                    window.countdownRunning = false;
                    window.inResultsMode = true;
                    window.showingResultsAfterAd = true;
                    window.adClosed = true;
                    window.viewResultsBtnClicked = true; // New flag for tracking this specific click
                    
                    // Get the ad overlay for transition effects
                    const adOverlay = document.getElementById('ad-overlay');
                    if (adOverlay) {
                        adOverlay.classList.add('closing');
                    }
                    
                    // Apply closing animation to ad overlay results
                    adOverlayResults.classList.add('closing');
                    
                    // Save the data for reuse if needed
                    window.lastTicketData = data;
                    
                    console.log('Processing view results click, closing overlay');
                    
                    // Add the results-in-progress class to body immediately
                    document.body.classList.add('results-mode');
                    document.body.classList.add('showing-results');
                    document.body.classList.add('ad-closed');
                    
                    // Force hide all overlays immediately (don't wait for animation)
                    const allOverlays = document.querySelectorAll('[id^="ad-overlay"]');
                    allOverlays.forEach(overlay => {
                        overlay.style.display = 'none';
                        overlay.style.opacity = '0';
                        overlay.style.visibility = 'hidden';
                    });
                    
                    // Make sure body scrolling is enabled
                    enableScrolling();
                    
                    console.log('About to display results after clicked View Results');
                    
                    // Display the results immediately
                    displayResults(data);
                    
                    // Create a persistent monitor to keep results visible
                    // This ensures our results stay visible even if something tries to hide them
                    window.resultsMonitorInterval = setInterval(() => {
                        const resultsContainer = document.getElementById('results-container');
                        if (resultsContainer && resultsContainer.classList.contains('d-none')) {
                            console.log('Results container was hidden, making visible again');
                            resultsContainer.classList.remove('d-none');
                            resultsContainer.style.display = 'block';
                            
                            // Force all ad overlays to stay hidden
                            const allOverlays = document.querySelectorAll('[id^="ad-overlay"]');
                            allOverlays.forEach(overlay => {
                                overlay.style.display = 'none';
                            });
                        }
                    }, 1000); // Check every second
                };
                
                // FORCEFULLY disable the view results button for 15 seconds
                // We'll use a global flag to track if countdown is already running
                if (!window.countdownRunning) {
                    console.log('Setting 15-second mandatory ad display timer...');
                    
                    // Set global flag to prevent multiple timers
                    window.countdownRunning = true;
                    
                    // COMPLETELY DISABLE the View Results button at start - including all click events and handlers
                    // This creates a fresh button that will have zero accidental handlers
                    if (viewResultsBtn && viewResultsBtn.parentNode) {
                        // Create a new button from scratch to ensure it has no lingering handlers
                        const newBtn = document.createElement('button');
                        newBtn.id = 'view-results-btn';
                        newBtn.className = viewResultsBtn.className;
                        newBtn.type = 'button';
                        newBtn.disabled = true;
                        newBtn.style.opacity = '0.5';
                        newBtn.style.cursor = 'not-allowed';
                        newBtn.innerHTML = '<i class="fas fa-lock me-2"></i> View Results (Wait 15s)';
                        
                        // Replace the old button
                        viewResultsBtn.parentNode.replaceChild(newBtn, viewResultsBtn);
                        viewResultsBtn = newBtn;
                        console.log('Created fresh View Results button at countdown start');
                    } else {
                        // Fallback to just disabling the existing button
                        viewResultsBtn.disabled = true;
                        viewResultsBtn.style.opacity = '0.5';
                        viewResultsBtn.style.cursor = 'not-allowed';
                        viewResultsBtn.innerHTML = '<i class="fas fa-lock me-2"></i> View Results (Wait 15s)';
                    }
                    
                    // Add a counter display to show remaining seconds - completely fresh element
                    const existingCountdown = document.getElementById('ad-countdown');
                    if (existingCountdown) {
                        existingCountdown.remove();
                    }
                    
                    // Get the countdown container
                    const countdownContainer = adOverlayResults.querySelector('#countdown-container');
                    
                    // Completely rebuild the countdown UI to avoid any stale state
                    if (countdownContainer) {
                        // First clear out any existing content
                        countdownContainer.innerHTML = '';
                        
                        // Create fresh counter element
                        const counterElement = document.createElement('div');
                        counterElement.id = 'ad-countdown';
                        counterElement.style.cssText = 'font-size: 18px; color: #0d6efd; font-weight: bold;';
                        counterElement.innerHTML = '<i class="fas fa-clock me-2"></i><span id="countdown-number">Results available in 15 seconds...</span>';
                        
                        // Append to the countdown container above the button
                        countdownContainer.appendChild(counterElement);
                        console.log('Created fresh countdown display');
                    } else {
                        console.warn('Countdown container not found in the DOM');
                    }
                    
                    // SIMPLIFIED APPROACH: Use fixed seconds counting down
                    window.countdownSeconds = 15;
                    
                    // Get UI elements
                    const countdownNumber = document.getElementById('countdown-number');
                    
                    // Update the UI with starting state
                    if (countdownNumber) {
                        countdownNumber.textContent = `Results available in ${window.countdownSeconds} seconds...`;
                    }
                    
                    if (viewResultsBtn) {
                        viewResultsBtn.innerHTML = `<i class="fas fa-lock me-2"></i> View Results (Wait ${window.countdownSeconds}s)`;
                        viewResultsBtn.disabled = true;
                        viewResultsBtn.style.opacity = '0.7';
                        viewResultsBtn.style.cursor = 'not-allowed';
                    }
                    
                    // Clear any existing timers
                    if (window.countdownInterval) {
                        clearInterval(window.countdownInterval);
                    }
                    
                    if (window.countdownTimeout) {
                        clearTimeout(window.countdownTimeout);
                    }
                    
                    // Simple approach: Just count down whole seconds
                    window.countdownInterval = setInterval(() => {
                        try {
                            // Decrement the counter
                            window.countdownSeconds--;
                            
                            // Update display
                            if (window.countdownSeconds <= 0) {
                                // Time's up - show completion state
                                if (countdownNumber) {
                                    countdownNumber.textContent = 'Results available now!';
                                }
                                
                                // Enable the button
                                const viewResultsBtn = document.getElementById('view-results-btn');
                                if (viewResultsBtn) {
                                    viewResultsBtn.innerHTML = '<i class="fas fa-check-circle me-2"></i> View Results Now!';
                                    viewResultsBtn.disabled = false;
                                    viewResultsBtn.style.opacity = '1';
                                    viewResultsBtn.style.cursor = 'pointer';
                                    viewResultsBtn.classList.add('btn-pulse');
                                }
                            } else {
                                // Still counting - update display
                                if (countdownNumber) {
                                    countdownNumber.textContent = `Results available in ${window.countdownSeconds} seconds...`;
                                }
                                
                                const viewResultsBtn = document.getElementById('view-results-btn');
                                if (viewResultsBtn) {
                                    viewResultsBtn.innerHTML = `<i class="fas fa-lock me-2"></i> View Results (Wait ${window.countdownSeconds}s)`;
                                }
                            }
                            
                            // Check if countdown is complete
                            if (window.countdownSeconds <= 0) {
                                // Clear interval and reset running flag
                                clearInterval(window.countdownInterval);
                                window.countdownInterval = null;
                                window.countdownRunning = false;
                                
                                // Get the button element
                                const viewResultsBtn = document.getElementById('view-results-btn');
                                if (viewResultsBtn) {
                                    // Enable the button after time is up
                                    viewResultsBtn.disabled = false;
                                    viewResultsBtn.style.opacity = '1';
                                    viewResultsBtn.style.cursor = 'pointer';
                                    viewResultsBtn.innerHTML = '<i class="fas fa-check-circle me-2"></i> View Results Now!';
                                    
                                    // Make the button pulse to draw attention
                                    viewResultsBtn.classList.add('btn-pulse');
                                }
                                
                                // CRITICAL FIX: Use a safer approach to reset event handlers
                                try {
                                    // Only try to replace if the button has a parent node
                                    if (viewResultsBtn && viewResultsBtn.parentNode) {
                                        // Clone and replace to remove existing handlers
                                        const newBtn = viewResultsBtn.cloneNode(true);
                                        viewResultsBtn.parentNode.replaceChild(newBtn, viewResultsBtn);
                                        viewResultsBtn = newBtn; // Update reference
                                        console.log('Successfully replaced button with clone');
                                    } else {
                                        // Just make sure the button is truly enabled
                                        console.log('Button replacement skipped - ensuring enabled state');
                                        if (viewResultsBtn) {
                                            viewResultsBtn.disabled = false;
                                            viewResultsBtn.style.pointerEvents = 'auto';
                                            viewResultsBtn.style.opacity = '1';
                                        }
                                    }
                                } catch (e) {
                                    console.error('Error replacing button:', e);
                                    // Fall back to just enabling the button
                                    if (viewResultsBtn) {
                                        viewResultsBtn.disabled = false;
                                        viewResultsBtn.style.pointerEvents = 'auto';
                                        viewResultsBtn.style.opacity = '1';
                                    }
                                }
                                
                                // IMPORTANT: Add the inline onclick handler first - this is the most reliable method
                                viewResultsBtn.setAttribute('onclick', 'this.disabled=false; document.querySelector("#results-container").style.display="block"; document.querySelector("#results-container").classList.remove("d-none"); document.querySelectorAll("[id^=ad-overlay]").forEach(o => o.style.display="none"); window.inResultsMode=true; window.viewResultsBtnClicked=true; window.hasCompletedAdFlow=true; window.resultsShown=true; return false;');
                                
                                // BACKUP: Also add event listener using addEventListener
                                viewResultsBtn.addEventListener('click', function directClickHandler(e) {
                                    console.log('DIRECT CLICK from addEventListener: Button clicked at ' + new Date().toISOString());
                                    
                                    // Set flags
                                    window.inResultsMode = true;
                                    window.viewResultsBtnClicked = true;
                                    window.hasCompletedAdFlow = true;
                                    window.resultsShown = true;
                                    
                                    // Force hide overlays - any and all
                                    document.querySelectorAll('[id^="ad-overlay"]').forEach(overlay => {
                                        overlay.style.display = 'none';
                                    });
                                    
                                    // Force show results
                                    const resultsContainer = document.getElementById('results-container');
                                    if (resultsContainer) {
                                        resultsContainer.classList.remove('d-none');
                                        resultsContainer.style.display = 'block';
                                    }
                                    
                                    // Hide scan form
                                    const scanForm = document.getElementById('scan-form-container');
                                    if (scanForm) {
                                        scanForm.classList.add('d-none');
                                        scanForm.style.display = 'none';
                                    }
                                    
                                    // Stop propagation and prevent default
                                    e.stopPropagation();
                                    e.preventDefault();
                                    return false;
                                }, true); // Use capture phase to ensure this handler runs first
                                
                                console.log('Countdown completed naturally based on elapsed time');
                            }
                        } catch (e) {
                            console.error('Error updating countdown:', e);
                            // Clear the interval if there's an error
                            clearInterval(window.countdownInterval);
                        }
                    }, 1000);
                    
                    // Triple redundant backup system:
                    
                    // 1. PRIMARY TIMEOUT: Standard 15-second timeout
                    window.countdownTimeout = setTimeout(() => {
                        console.log('🔥 BACKUP TIMER #1: 15-second fixed duration completed');
                        
                        // Force the counter to 0 in case the interval is still running
                        window.countdownSeconds = 0;
                        
                        // Clear any running interval
                        if (window.countdownInterval) {
                            clearInterval(window.countdownInterval);
                            window.countdownInterval = null;
                        }
                        
                        // Reset the running flag
                        window.countdownRunning = false;
                        
                        // Skip if button already clicked
                        if (window.viewResultsBtnClicked) {
                            console.log('View Results already clicked, skipping backup timer actions');
                            return;
                        }
                        
                        // Force update countdown text
                        const countdownNumber = document.getElementById('countdown-number');
                        if (countdownNumber) {
                            countdownNumber.textContent = 'Results available now!';
                        }
                        
                        // Get the button directly from the DOM to ensure we have the latest element
                        const viewResultsBtn = document.getElementById('view-results-btn');
                        
                        // Make sure the button is enabled
                        if (viewResultsBtn) {
                            // ABSOLUTELY FORCE the button to be enabled
                            viewResultsBtn.disabled = false;
                            viewResultsBtn.style.opacity = '1';
                            viewResultsBtn.style.cursor = 'pointer';
                            viewResultsBtn.innerHTML = '<i class="fas fa-check-circle me-2"></i> View Results Now!';
                            viewResultsBtn.classList.add('btn-pulse');
                            
                            // Add HTML onClick attribute as most reliable method
                            viewResultsBtn.setAttribute('onclick', 'this.disabled=false; document.querySelector("#results-container").style.display="block"; document.querySelector("#results-container").classList.remove("d-none"); document.querySelectorAll("[id^=ad-overlay]").forEach(o => o.style.display="none"); window.inResultsMode=true; window.viewResultsBtnClicked=true; console.log("Inline handler executed"); return false;');
                        }
                    }, 15000); // Hardcoded 15 seconds
                    
                    // 2. SECONDARY TIMEOUT: 15.5 seconds as a redundant fallback
                    window.countdownTimeout2 = setTimeout(() => {
                        console.log('🔥🔥 BACKUP TIMER #2: 15.5-second redundant backup timer completed');
                        
                        // Get the button directly from the DOM
                        const viewResultsBtn = document.getElementById('view-results-btn');
                        
                        // FORCE button to be enabled with no replacement - just direct property changes
                        if (viewResultsBtn) {
                            viewResultsBtn.disabled = false;
                            viewResultsBtn.style.opacity = '1';
                            viewResultsBtn.style.pointerEvents = 'auto';
                            viewResultsBtn.style.cursor = 'pointer';
                            
                            // Add redundant onclick handler
                            viewResultsBtn.setAttribute('onclick', 'this.disabled=false; document.querySelector("#results-container").style.display="block"; document.querySelector("#results-container").classList.remove("d-none"); document.querySelectorAll("[id^=ad-overlay]").forEach(o => o.style.display="none"); window.inResultsMode=true; window.viewResultsBtnClicked=true; return false;');
                        }
                    }, 15500); // 15.5 seconds as fallback
                    
                    // 3. EMERGENCY TIMEOUT: 16 seconds as final last-resort
                    window.countdownTimeout3 = setTimeout(() => {
                        console.log('⚠️⚠️⚠️ EMERGENCY BACKUP: 16-second last resort emergency timer');
                        
                        try {
                            // Direct DOM manipulation to ensure the results are actually shown
                            document.getElementById('results-container').style.display = 'block';
                            document.getElementById('results-container').classList.remove('d-none');
                            
                            // Force hide all overlays
                            document.querySelectorAll('[id^="ad-overlay"]').forEach(overlay => {
                                overlay.style.display = 'none';
                            });
                            
                            // Set global flags 
                            window.inResultsMode = true;
                            window.viewResultsBtnClicked = true;
                            window.resultsShown = true;
                            window.hasCompletedAdFlow = true;
                            window.permanentResultsMode = true;
                            
                            console.log('Emergency backup completed - results should be visible');
                        } catch (e) {
                            console.error('Emergency backup failed:', e);
                        }
                    }, 16000); // 16 seconds as emergency fallback
                                
                                // CRITICAL FIX: Use a safer approach to reset event handlers
                                try {
                                    // Only try to replace if the button has a parent node
                                    if (viewResultsBtn && viewResultsBtn.parentNode) {
                                        // Clone and replace to remove existing handlers
                                        const newBtn = viewResultsBtn.cloneNode(true);
                                        viewResultsBtn.parentNode.replaceChild(newBtn, viewResultsBtn);
                                        viewResultsBtn = newBtn; // Update reference
                                        console.log('Successfully replaced button with clone (backup timer)');
                                    } else {
                                        // Just make sure the button is truly enabled
                                        console.log('Button replacement skipped in backup timer - ensuring enabled state');
                                        if (viewResultsBtn) {
                                            viewResultsBtn.disabled = false;
                                            viewResultsBtn.style.pointerEvents = 'auto';
                                            viewResultsBtn.style.opacity = '1';
                                        }
                                    }
                                } catch (e) {
                                    console.error('Error replacing button in backup timer:', e);
                                    // Fall back to just enabling the button
                                    if (viewResultsBtn) {
                                        viewResultsBtn.disabled = false;
                                        viewResultsBtn.style.pointerEvents = 'auto';
                                        viewResultsBtn.style.opacity = '1';
                                    }
                                }
                                
                                // Add a direct click handler that will ALWAYS fire
                                viewResultsBtn.addEventListener('click', function directClickHandler(e) {
                                    console.log('⚡ DIRECT CLICK HANDLER: View Results button clicked at ' + new Date().toISOString());
                                    
                                    // Set all the required flags
                                    window.inResultsMode = true;
                                    window.viewResultsBtnClicked = true;
                                    window.resultsShown = true;
                                    window.hasCompletedAdFlow = true;
                                    window.permanentResultsMode = true;
                                    
                                    // Force hide overlays
                                    document.querySelectorAll('[id^="ad-overlay"]').forEach(overlay => {
                                        overlay.style.display = 'none';
                                    });
                                    
                                    // Force show results
                                    const resultsContainer = document.getElementById('results-container');
                                    if (resultsContainer) {
                                        resultsContainer.classList.remove('d-none');
                                        resultsContainer.style.display = 'block';
                                    }
                                    
                                    // Hide scan form
                                    const scanForm = document.getElementById('scan-form-container');
                                    if (scanForm) {
                                        scanForm.classList.add('d-none');
                                        scanForm.style.display = 'none';
                                    }
                                    
                                    // Stop propagation and prevent default
                                    e.stopPropagation();
                                    e.preventDefault();
                                    return false;
                                }, true); // Capture phase to execute first
                            }
                        }
                    }, 15000); // Hardcoded 15 seconds, don't rely on window variable
                } else {
                    console.log('Countdown already running, not starting a new one');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                
                // Clean up ALL running timers and intervals in case of error
                if (window.countdownInterval) {
                    clearInterval(window.countdownInterval);
                    window.countdownInterval = null;
                    console.log('Cleared countdown interval');
                }
                
                // Clear all timeout objects
                if (window.countdownTimeout) {
                    clearTimeout(window.countdownTimeout);
                    window.countdownTimeout = null;
                    console.log('Cleared countdown primary timeout');
                }
                
                if (window.countdownTimeout2) {
                    clearTimeout(window.countdownTimeout2);
                    window.countdownTimeout2 = null;
                    console.log('Cleared countdown secondary timeout');
                }
                
                if (window.countdownTimeout3) {
                    clearTimeout(window.countdownTimeout3);
                    window.countdownTimeout3 = null;
                    console.log('Cleared countdown emergency timeout');
                }
                
                // Reset the countdown running flag
                window.countdownRunning = false;
                
                // Hide ad loading overlay
                const adOverlayLoading = document.getElementById('ad-overlay-loading');
                adOverlayLoading.style.display = 'none';
                
                // Make sure scrolling is enabled in case of error
                enableScrolling();
                showError('An error occurred while scanning your ticket. Please try again.');
            })
            .finally(() => {
                // Hide loading indicator
                loadingIndicator.style.display = 'none';
                scanButton.disabled = false;
                console.log("Scan completed - button enabled");
            });
        }
        
        // Event listener for form submission
        ticketForm.addEventListener('submit', function(e) {
            // Always prevent the default form submission
            e.preventDefault();
            
            console.log('Form submitted at ' + new Date().toISOString());
            
            // Check if we're in results mode and prevent resetting unless explicitly requested
            if (window.inResultsMode && !window.resetRequested) {
                console.log('Already showing results, not processing new scan');
                
                // Show a confirmation dialog
                if (confirm('You already have results displayed. Do you want to scan a new ticket?')) {
                    console.log('User confirmed new scan');
                    // Allow the form to proceed by setting reset flag
                    window.resetRequested = true;
                    
                    // Reset state flags
                    window.inResultsMode = false;
                    window.showingResultsAfterAd = false;
                    window.adClosed = false;
                    window.viewResultsBtnClicked = false;
                    
                    // Clear monitor interval if it exists
                    if (window.resultsMonitorInterval) {
                        clearInterval(window.resultsMonitorInterval);
                        window.resultsMonitorInterval = null;
                    }
                    
                    // Clear all the body classes
                    document.body.classList.remove('results-mode');
                    document.body.classList.remove('showing-results');
                    document.body.classList.remove('ad-completed');
                    document.body.classList.remove('ad-closed');
                    
                    // Resubmit the form with the flag set
                    setTimeout(() => {
                        ticketForm.dispatchEvent(new Event('submit'));
                        
                        // Reset the flag after processing
                        setTimeout(() => {
                            window.resetRequested = false;
                        }, 500);
                    }, 100);
                    
                    return false;
                } else {
                    console.log('User cancelled new scan, keeping results visible');
                    
                    // Make sure results are still visible
                    const resultsContainer = document.getElementById('results-container');
                    if (resultsContainer) {
                        resultsContainer.classList.remove('d-none');
                        resultsContainer.style.display = 'block';
                    }
                    
                    return false;
                }
            }
            
            // Only check if a file is selected
            if (!fileInput.files.length) {
                alert('Please select an image of your ticket');
                return false;
            }
            
            // Hide any currently displayed results
            const resultsContainer = document.getElementById('results-container');
            if (resultsContainer && !resultsContainer.classList.contains('d-none')) {
                resultsContainer.classList.add('d-none');
            }
            
            // Process the ticket with ads
            processTicketWithAds();
            
            // Return false to ensure the form never submits to prevent page reloads
            return false;
        });
        
        // Enable body scrolling
        function enableScrolling() {
            // Get the scroll position before removing fixed positioning
            const scrollY = document.body.style.top ? 
                parseInt(document.body.style.top || '0', 10) * -1 : 
                window.scrollY;
            
            // Reset all styles
            document.body.style.overflow = '';
            document.body.style.height = '';
            document.body.style.position = '';
            document.body.style.top = '';
            document.body.style.width = '';
            document.documentElement.style.overflow = '';
            document.documentElement.style.height = '';
            document.documentElement.style.position = '';
            
            // Restore scroll position
            window.scrollTo(0, scrollY);
            
            console.log('Scrolling enabled, restored to position:', scrollY);
        }
        
        // Disable body scrolling
        function disableScrolling() {
            // Don't disable scrolling in Replit IDE to avoid scroll wheel issues
            if (window.location.hostname.includes('replit.dev')) {
                console.log('Scrolling kept enabled for Replit IDE');
                return;
            }
            
            // Store current scroll position
            const scrollY = window.scrollY;
            
            document.body.style.overflow = 'hidden';
            document.body.style.height = '100%';
            document.body.style.position = 'fixed';
            document.body.style.top = `-${scrollY}px`;
            document.body.style.width = '100%';
            
            document.documentElement.style.overflow = 'hidden';
            document.documentElement.style.height = '100%';
            
            console.log('Scrolling disabled');
        }
        
        // Use a simple global flag to prevent redirects
        window.resultsShown = false;
        
        function displayResults(data) {
            try {
                console.log('Displaying ticket scanning results', new Date().toISOString());
                
                // Set flag to indicate we've shown results - this helps prevent redirects
                window.resultsShown = true;

                // Store the scan data permanently in window object
                window.lastResultsData = data;
                window.inResultsMode = true; 
                window.resultsBeingDisplayed = true;
                window.hasCompletedAdFlow = true;
                
                // Make sure scrolling is fully enabled and restored when showing results
                enableScrolling();
                
                // Make sure body and document are still properly reset to avoid mobile scrolling issues
                document.body.style.overflow = '';
                document.body.style.height = '';
                document.body.style.position = '';
                document.body.style.width = '';
                document.body.style.touchAction = 'auto';
                document.documentElement.style.overflow = '';
                document.documentElement.style.height = '';
                
                // Close any ad overlays first to ensure clean state
                const adOverlay = document.getElementById('ad-overlay');
                if (adOverlay) {
                    adOverlay.style.display = 'none';
                }
                const adOverlayLoading = document.getElementById('ad-overlay-loading');
                if (adOverlayLoading) {
                    adOverlayLoading.style.display = 'none';
                }
                const adOverlayResults = document.getElementById('ad-overlay-results');
                if (adOverlayResults) {
                    adOverlayResults.style.display = 'none';
                }
                
                // Add all state classes to body
                document.body.classList.add('showing-results');
                document.body.classList.add('results-mode');
                document.body.classList.add('ad-completed');
                
                // Hide scan form container
                const scanFormContainer = document.getElementById('scan-form-container');
                if (scanFormContainer) {
                    scanFormContainer.classList.add('d-none');
                    scanFormContainer.style.display = 'none';
                }
                
                // Prepare the results container first
                if (resultsContainer) {
                    // Show the results container - force it to be visible
                    resultsContainer.classList.remove('d-none');
                    resultsContainer.style.display = 'block';
                    
                    // Scroll to the results container with a delay to ensure it's rendered
                    setTimeout(() => {
                        // Double-check that the results container is still visible
                        resultsContainer.classList.remove('d-none');
                        resultsContainer.style.display = 'block';
                        
                        // Force scroll to it in case we lost position
                        try {
                            resultsContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                            console.log('Scrolled to results container');
                        } catch (scrollError) {
                            console.warn('Error scrolling to results:', scrollError);
                        }
                    }, 300);
                } else {
                    console.error('Results container not found!');
                    return;
                }
                
                // Hide error message by default
                const errorMessage = document.getElementById('error-message');
                if (errorMessage) {
                    errorMessage.classList.add('d-none');
                }
                
                if (data.error) {
                    showError(data.error);
                    return;
                }
                
                // Show success content
                const successContent = document.getElementById('success-content');
                if (successContent) {
                    successContent.classList.remove('d-none');
                } else {
                    console.error('Success content container not found!');
                    return;
                }
            
            // Populate ticket info - with null checks
            const resultLotteryType = document.getElementById('result-lottery-type');
            if (resultLotteryType) resultLotteryType.textContent = data.lottery_type || 'Unknown';
            
            const resultDrawNumber = document.getElementById('result-draw-number');
            if (resultDrawNumber) resultDrawNumber.textContent = data.draw_number || 'Unknown';
            
            const resultDrawDate = document.getElementById('result-draw-date');
            if (resultDrawDate) resultDrawDate.textContent = data.draw_date || 'Unknown';
            
            // Populate detected information from OCR if available
            if (data.ticket_info) {
                const detectedGameType = document.getElementById('detected-game-type');
                if (detectedGameType) {
                    detectedGameType.textContent = data.ticket_info.detected_game_type || 'Unknown';
                }
                
                const detectedDrawNumber = document.getElementById('detected-draw-number');
                if (detectedDrawNumber) {
                    detectedDrawNumber.textContent = data.ticket_info.detected_draw_number || 'Unknown';
                }
                
                const detectedDrawDate = document.getElementById('detected-draw-date');
                if (detectedDrawDate) {
                    detectedDrawDate.textContent = data.ticket_info.detected_draw_date || 'Unknown';
                }
            } else {
                const detectedInfo = document.getElementById('detected-info');
                if (detectedInfo) {
                    detectedInfo.classList.add('d-none');
                }
            }
            
            // Display ticket numbers
            const ticketNumbersContainer = document.getElementById('ticket-numbers');
            ticketNumbersContainer.innerHTML = '';
            
            // Check if we have raw selected numbers for a better display
            if (data.ticket_info && data.ticket_info.raw_selected_numbers) {
                // Array to track rows that should be skipped (e.g., A2/B2 rows that are merged with A1/B1)
                const rowsToSkip = [];
                
                // First, let's organize and combine the row data 
                // to display main numbers and bonus balls on the same line
                const organizedRows = {};
                
                // First pass: Identify all row pairs (A1/A2, B1/B2, etc.)
                Object.entries(data.ticket_info.raw_selected_numbers).forEach(([rowName, numbers]) => {
                    // Check if this is a main row (like A1, B1) or bonus row (like A2, B2)
                    if (rowName.match(/^[A-Z]1/) || rowName.match(/^[A-Z]1\(\d+\)/)) {
                        // This is a main row (A1, B1, etc.)
                        const baseRowName = rowName.charAt(0); // Get A, B, C, etc.
                        
                        // Initialize the combined row data
                        organizedRows[baseRowName] = {
                            mainRowName: rowName,
                            mainNumbers: numbers,
                            bonusRowName: null,
                            bonusNumbers: []
                        };
                    }
                    else if (rowName.match(/^[A-Z]2/) || rowName.match(/^[A-Z]2\(\d+\)/)) {
                        // This is a bonus row (A2, B2, etc.)
                        const baseRowName = rowName.charAt(0); // Get A, B, C, etc.
                        
                        // If we already have this base row, add as bonus
                        if (organizedRows[baseRowName]) {
                            organizedRows[baseRowName].bonusRowName = rowName;
                            organizedRows[baseRowName].bonusNumbers = numbers;
                            
                            // Add this row to the skip list since we're handling it with its main row
                            rowsToSkip.push(rowName);
                        }
                    }
                });
                
                // Display numbers by rows
                Object.entries(data.ticket_info.raw_selected_numbers).forEach(([rowName, numbers]) => {
                    // Skip rows that are already handled (bonus number rows like A2, B2)
                    if (rowsToSkip.includes(rowName)) {
                        return;
                    }
                    
                    // Check if this is a main row that has a corresponding bonus row
                    const baseRowName = rowName.charAt(0);
                    const combinedRow = organizedRows[baseRowName];
                    
                    // If this is a main row with a bonus ball, use the combined data
                    // Otherwise, just use the original row data
                    const combinedNumbers = combinedRow && combinedRow.mainRowName === rowName && combinedRow.bonusNumbers.length > 0 ? 
                        [...numbers, ...combinedRow.bonusNumbers] : numbers;
                    
                    // Check if this row has any matches - use game_type to ensure matches are from the correct game
                    let rowMatches = [];
                    let rowBonusMatches = [];
                    
                    // Find the row with matches specifically for this game type
                    if (data.rows_with_matches) {
                        const matchingRow = data.rows_with_matches.find(match => 
                            match.row === rowName && match.game_type === data.lottery_type);
                        
                        if (matchingRow) {
                            rowMatches = matchingRow.matched_numbers || [];
                            rowBonusMatches = matchingRow.matched_bonus || [];
                        }
                    } else {
                        // Fallback to the old method if rows_with_matches isn't available
                        rowMatches = numbers.filter(num => data.winning_numbers.includes(num));
                        rowBonusMatches = numbers.filter(num => data.bonus_numbers.includes(num));
                    }
                    
                    const hasMatches = rowMatches.length > 0 || rowBonusMatches.length > 0;
                    
                    // Create row label with match indicator if applicable
                    const rowLabel = document.createElement('div');
                    rowLabel.classList.add('mt-2', 'mb-1');
                    
                    // Check if this is Row A1, B1, etc. with a corresponding bonus number row
                    let displayRowName = rowName;
                    if (data.lottery_type.toLowerCase().includes('powerball') && 
                        rowName.endsWith('1')) {
                        // Check if we have a corresponding Row "X2" to match this Row "X1"
                        const baseRowName = rowName.charAt(0); // Get the letter part (A, B, etc.)
                        const nextRowName = baseRowName + '2';  // Create the next row name (A2, B2, etc.)
                        
                        // If there's a bonus row, display just "Row A" instead of "Row A1"
                        if (data.ticket_info.raw_selected_numbers[nextRowName] && 
                            data.ticket_info.raw_selected_numbers[nextRowName].length === 1) {
                            displayRowName = baseRowName;
                        }
                    }
                    
                    if (hasMatches) {
                        // Find the correct game-specific row with matches
                        let matchCount = 0;
                        const gameSpecificMatches = data.rows_with_matches ? 
                            data.rows_with_matches.find(match => 
                                match.row === rowName && match.game_type === data.lottery_type) : null;
                                
                        if (gameSpecificMatches) {
                            // Use the total_matched from the game-specific data
                            matchCount = gameSpecificMatches.total_matched;
                        } else {
                            // Fallback to counting matches manually
                            matchCount = rowMatches.length + rowBonusMatches.length;
                        }
                        
                        // Only show the badge if there are matches for this specific game
                        if (matchCount > 0) {
                            rowLabel.innerHTML = `<strong>Row ${displayRowName}:</strong> <span class="badge bg-success ms-2">Matches: ${matchCount}</span>`;
                        } else {
                            rowLabel.innerHTML = `<strong>Row ${displayRowName}:</strong>`;
                        }
                    } else {
                        rowLabel.innerHTML = `<strong>Row ${displayRowName}:</strong>`;
                    }
                    ticketNumbersContainer.appendChild(rowLabel);
                    
                    // Create row container
                    const rowContainer = document.createElement('div');
                    rowContainer.classList.add('mb-3');
                    
                    // Track if we should show Powerball/bonus number indicator
                    let isPowerball = false;
                    
                    // For Powerball tickets, if this row is a single-number row (like Row A2 with the bonus number),
                    // it should NOT have a plus sign before it. Instead, the plus sign should come AFTER
                    // the previous row's numbers.
                    
                    // Special handling for Powerball or Powerball Plus where Row A2, B2, etc. are bonus rows
                    if (data.lottery_type.toLowerCase().includes('powerball') && 
                        rowName.endsWith('2') && numbers.length === 1) {
                        isPowerball = true;
                    }
                    
                    // Add balls for this row
                    // Use combined numbers array if available (main numbers + bonus numbers)
                    // This displays the bonus balls on the same line as the main numbers
                    const allNumbers = combinedNumbers || numbers;
                    
                    allNumbers.forEach((num, index) => {
                        // For all lottery tickets, add a plus sign before the last number (bonus ball)
                        // Check if this is the last number in the row
                        if (index === allNumbers.length - 1) {
                            // Add a plus sign before the last number (which is the bonus ball)
                            const plusSpan = document.createElement('span');
                            plusSpan.classList.add('mx-2', 'my-auto', 'fs-4');
                            plusSpan.textContent = '+';
                            plusSpan.style.color = '#FF5500'; // Orange for visibility
                            rowContainer.appendChild(plusSpan);
                        }
                        
                        // For legacy compatibility - keep the old bonus handling code
                        const hasBonus = combinedRow && combinedRow.bonusNumbers.length > 0;
                        const mainNumberCount = combinedRow ? combinedRow.mainNumbers.length : numbers.length;
                        
                        // Only add in special cases where the new approach doesn't work
                        if (hasBonus && index === mainNumberCount && mainNumberCount !== allNumbers.length - 1) {
                            const plusSpan = document.createElement('span');
                            plusSpan.classList.add('mx-2', 'my-auto', 'fs-4');
                            plusSpan.textContent = '+';
                            plusSpan.style.color = '#FF5500'; // Orange for visibility
                            rowContainer.appendChild(plusSpan);
                        }
                        
                        const ball = document.createElement('span');
                        ball.classList.add('lottery-ball');
                        
                        // Check if this number is a match in the current game type
                        let isMatch = false;
                        let isBonusMatch = false;
                        
                        // Use rowMatches array which is specific to this game type
                        if (rowMatches.includes(num)) {
                            isMatch = true;
                        }
                        
                        if (rowBonusMatches.includes(num)) {
                            isBonusMatch = true;
                        }
                        
                        if (isMatch || isBonusMatch) {
                            ball.classList.add('ball-matched');
                            
                            // Create match indicator with game-specific styling
                            const matchIcon = document.createElement('div');
                            matchIcon.classList.add('match-indicator');
                            matchIcon.textContent = '✓'; // Direct text checkmark
                            
                            // Color code the match indicator based on game type
                            if (data.lottery_type === "Powerball") {
                                // Main Powerball game
                                if (isBonusMatch) {
                                    matchIcon.classList.add('match-powerball-bonus');
                                    ball.setAttribute('title', 'Bonus match in Powerball');
                                } else {
                                    matchIcon.classList.add('match-powerball');
                                    ball.setAttribute('title', 'Match in Powerball');
                                }
                            } else if (data.lottery_type === "Powerball Plus") {
                                // Powerball Plus game
                                if (isBonusMatch) {
                                    matchIcon.classList.add('match-powerball-plus-bonus');
                                    ball.setAttribute('title', 'Bonus match in Powerball Plus');
                                } else {
                                    matchIcon.classList.add('match-powerball-plus');
                                    ball.setAttribute('title', 'Match in Powerball Plus');
                                }
                            } else if (data.lottery_type === "Lotto Plus 1") {
                                // Lotto Plus 1 game
                                if (isBonusMatch) {
                                    matchIcon.classList.add('match-lotto-plus-1-bonus');
                                    ball.setAttribute('title', 'Bonus match in Lotto Plus 1');
                                } else {
                                    matchIcon.classList.add('match-lotto-plus-1');
                                    ball.setAttribute('title', 'Match in Lotto Plus 1');
                                }
                            } else if (data.lottery_type === "Lotto Plus 2") {
                                // Lotto Plus 2 game
                                if (isBonusMatch) {
                                    matchIcon.classList.add('match-lotto-plus-2-bonus');
                                    ball.setAttribute('title', 'Bonus match in Lotto Plus 2');
                                } else {
                                    matchIcon.classList.add('match-lotto-plus-2');
                                    ball.setAttribute('title', 'Match in Lotto Plus 2');
                                }
                            } else {
                                // Default for other game types like Lotto or Daily Lotto
                                matchIcon.classList.add('match-powerball'); // Use green by default
                                ball.setAttribute('title', 'Match in ' + data.lottery_type);
                            }
                            
                            // Add the match indicator to the ball
                            ball.appendChild(matchIcon);
                        }
                        
                        // Add color classes in sequence or special color for Powerball/bonus balls
                        if (isPowerball) {
                            ball.classList.add('lottery-ball-blue', 'lottery-ball-bonus');
                        } 
                        // If this is the last ball in the row (bonus number), make it yellow
                        else if (index === allNumbers.length - 1) {
                            ball.classList.add('lottery-ball-yellow');
                        }
                        // Otherwise add colors in sequence
                        else if (rowContainer.children.length % 4 === 0) {
                            ball.classList.add('lottery-ball-red');
                        } else if (rowContainer.children.length % 4 === 1) {
                            ball.classList.add('lottery-ball-yellow');
                        } else if (rowContainer.children.length % 4 === 2) {
                            ball.classList.add('lottery-ball-green');
                        } else {
                            ball.classList.add('lottery-ball-blue');
                        }
                        
                        ball.textContent = num;
                        rowContainer.appendChild(ball);
                    });
                    
                    ticketNumbersContainer.appendChild(rowContainer);
                    
                    // For Powerball tickets, if this is Row A1, B1, etc. and the next row is A2, B2, etc.
                    // We'll handle the bonus number differently - we won't display a separate row
                    if (data.lottery_type.toLowerCase().includes('powerball') && 
                        rowName.endsWith('1')) {
                        // Check if we have a corresponding Row "X2" to match this Row "X1"
                        const baseRowName = rowName.charAt(0); // Get the letter part (A, B, etc.)
                        const nextRowName = baseRowName + '2';  // Create the next row name (A2, B2, etc.)
                        
                        // Check if we have a corresponding bonus row
                        if (data.ticket_info.raw_selected_numbers[nextRowName] && 
                            data.ticket_info.raw_selected_numbers[nextRowName].length === 1) {
                            
                            // Instead of creating a new row, add a plus sign to the end of the current row
                            const plusSpan = document.createElement('span');
                            plusSpan.classList.add('mx-2', 'my-auto', 'fs-4');
                            plusSpan.textContent = '+';
                            plusSpan.style.color = '#FF5500'; // Orange for visibility
                            rowContainer.appendChild(plusSpan);
                            
                            // Get the bonus number
                            const bonusNumber = data.ticket_info.raw_selected_numbers[nextRowName][0];
                            
                            // Create the bonus ball in the same row
                            const bonusBall = document.createElement('span');
                            bonusBall.classList.add('lottery-ball', 'lottery-ball-bonus', 'lottery-ball-yellow');
                            
                            // Check if this bonus number is a match specific to this game
                            let isBonusMatch = false;
                            
                            // Look for matches in the same game type
                            if (data.rows_with_matches) {
                                // Find any row with this bonus number matched in the current game
                                const bonusMatchRow = data.rows_with_matches.find(match => 
                                    match.game_type === data.lottery_type && 
                                    match.matched_bonus && 
                                    match.matched_bonus.includes(parseInt(bonusNumber)));
                                
                                if (bonusMatchRow) {
                                    isBonusMatch = true;
                                }
                            } else {
                                // Fallback to simple check if rows_with_matches isn't available
                                isBonusMatch = data.bonus_numbers.includes(parseInt(bonusNumber));
                            }
                            
                            if (isBonusMatch) {
                                bonusBall.classList.add('ball-matched');
                                bonusBall.setAttribute('title', `Bonus match in ${data.lottery_type}`);
                                
                                // Create match indicator with game-specific styling
                                const matchIcon = document.createElement('div');
                                matchIcon.classList.add('match-indicator');
                                matchIcon.textContent = '✓'; // Direct text checkmark
                                
                                // Color code based on game type
                                if (data.lottery_type === "Powerball") {
                                    matchIcon.classList.add('match-powerball-bonus');
                                } else if (data.lottery_type === "Powerball Plus") {
                                    matchIcon.classList.add('match-powerball-plus-bonus');
                                }
                                
                                // Add the match indicator to the ball
                                bonusBall.appendChild(matchIcon);
                            }
                            
                            bonusBall.textContent = bonusNumber;
                            rowContainer.appendChild(bonusBall);
                            
                            // Skip the next row since we've already added its number here
                            rowsToSkip.push(nextRowName);
                        }
                    }
                });
            } else {
                // Fallback to flat display if raw data not available
                data.ticket_numbers.forEach(num => {
                    const ball = document.createElement('span');
                    ball.classList.add('lottery-ball');
                    
                    // Add color classes in sequence
                    if (ticketNumbersContainer.children.length % 4 === 0) {
                        ball.classList.add('lottery-ball-red');
                    } else if (ticketNumbersContainer.children.length % 4 === 1) {
                        ball.classList.add('lottery-ball-yellow');
                    } else if (ticketNumbersContainer.children.length % 4 === 2) {
                        ball.classList.add('lottery-ball-green');
                    } else {
                        ball.classList.add('lottery-ball-blue');
                    }
                    
                    ball.textContent = num;
                    ticketNumbersContainer.appendChild(ball);
                });
            }
            
            // Display winning numbers (main numbers with bonus on same line)
            const winningNumbersContainer = document.getElementById('winning-numbers');
            winningNumbersContainer.innerHTML = '';
            
            // Update the game label
            const primaryGameLabel = document.getElementById('primary-game-label');
            primaryGameLabel.textContent = data.lottery_type + ' Numbers:';
            
            // Add main numbers
            data.winning_numbers.forEach(num => {
                const ball = document.createElement('span');
                ball.classList.add('lottery-ball');
                
                // Add color classes in sequence
                if (winningNumbersContainer.children.length % 4 === 0) {
                    ball.classList.add('lottery-ball-red');
                } else if (winningNumbersContainer.children.length % 4 === 1) {
                    ball.classList.add('lottery-ball-yellow');
                } else if (winningNumbersContainer.children.length % 4 === 2) {
                    ball.classList.add('lottery-ball-green');
                } else {
                    ball.classList.add('lottery-ball-blue');
                }
                
                ball.textContent = num;
                winningNumbersContainer.appendChild(ball);
            });
            
            // Add a plus sign followed immediately by bonus numbers on the same line
            if (data.bonus_numbers && data.bonus_numbers.length > 0) {
                // Create a container to hold the plus sign with better visibility
                const plusContainer = document.createElement('div');
                plusContainer.classList.add('d-inline-block', 'mx-3', 'position-relative', 'align-middle');
                plusContainer.style.width = '60px'; // Even wider container for larger plus sign
                plusContainer.style.height = '60px'; // Ensure height is also sufficient
                plusContainer.style.textAlign = 'center';
                plusContainer.style.backgroundColor = 'rgba(255, 255, 255, 0.2)'; // Light background for better visibility
                plusContainer.style.borderRadius = '50%'; // Make it circular
                plusContainer.style.display = 'inline-flex';
                plusContainer.style.justifyContent = 'center';
                plusContainer.style.alignItems = 'center';
                
                // Add plus sign with high visibility
                const plusSpan = document.createElement('span');
                plusSpan.classList.add('fw-bolder', 'fs-1'); // Larger font size
                plusSpan.textContent = '+';
                plusSpan.style.color = '#FF5500'; // Orange for visibility
                plusSpan.style.textShadow = '1px 1px 2px rgba(0,0,0,0.5)'; // Light shadow
                plusSpan.style.display = 'inline-block';
                
                plusContainer.appendChild(plusSpan);
                winningNumbersContainer.appendChild(plusContainer);
                
                // Add bonus balls to the same container as main numbers
                data.bonus_numbers.forEach(num => {
                    const ball = document.createElement('span');
                    // Make bonus balls visually distinct
                    ball.classList.add('lottery-ball', 'lottery-ball-yellow');
                    ball.textContent = num;
                    winningNumbersContainer.appendChild(ball);
                });
            }
            
            // Debug to ensure we're getting bonus numbers
            console.log("Main numbers: ", data.winning_numbers, "Bonus numbers: ", data.bonus_numbers || 'None');
            console.log("Plus sign container added:", !!document.querySelector(".d-inline-block[style*='backgroundColor: rgba(255, 255, 255, 0.2)']"));
            
            // Log the element dimensions for debugging
            setTimeout(() => {
                const plusContainers = document.querySelectorAll(".d-inline-block[style*='backgroundColor: rgba(255, 255, 255, 0.2)']");
                if (plusContainers.length > 0) {
                    plusContainers.forEach((container, index) => {
                        console.log(`Plus container ${index} dimensions:`, {
                            width: container.offsetWidth,
                            height: container.offsetHeight,
                            visible: container.offsetWidth > 0 && container.offsetHeight > 0,
                            display: window.getComputedStyle(container).display
                        });
                    });
                } else {
                    console.log("No plus containers found on the page");
                }
            }, 500);
            
            // Update the hidden bonus container (we don't display it separately anymore)
            const bonusNumbersContainer = document.getElementById('bonus-numbers');
            bonusNumbersContainer.innerHTML = '';
            document.getElementById('bonus-numbers-container').classList.add('d-none');
            
            // Update matched count for display without showing matched balls
            const matchedNumbersContainer = document.getElementById('matched-numbers');
            matchedNumbersContainer.innerHTML = '';
            
            // Get unique matched numbers for the count
            const uniqueMatchedNumbers = [...new Set(data.matched_numbers)];
            document.getElementById('matched-count').textContent = uniqueMatchedNumbers.length;
            
            // Don't display matched balls here - we'll just show them in the rows below
            // This makes Powerball and Powerball Plus sections match in appearance
            
            // Get unique matched bonus numbers and add them to the matched numbers section
            if (data.matched_bonus && data.matched_bonus.length > 0) {
                const uniqueMatchedBonus = [...new Set(data.matched_bonus)];
                
                // Add a separator if there are also matched main numbers
                if (uniqueMatchedNumbers.length > 0) {
                    const separator = document.createElement('div');
                    separator.classList.add('mt-2', 'mb-2');
                    separator.innerHTML = '<strong>Matched Bonus:</strong>';
                    matchedNumbersContainer.appendChild(separator);
                }
                
                uniqueMatchedBonus.forEach(num => {
                    const ball = document.createElement('span');
                    ball.classList.add('lottery-ball', 'ball-matched', 'lottery-ball-yellow');
                    ball.style.animation = 'pulse 2s infinite';
                    ball.setAttribute('title', `Bonus match in ${data.lottery_type}`);
                    ball.textContent = num;
                    matchedNumbersContainer.appendChild(ball);
                });
            }
            
            // Display matches by row for the main game type
            if (data.ticket_info && data.ticket_info.raw_selected_numbers && data.rows_with_matches) {
                // Add a section header for row-specific matches
                const rowMatchesHeader = document.createElement('div');
                rowMatchesHeader.classList.add('mt-4', 'mb-3');
                rowMatchesHeader.innerHTML = `<h6>${data.lottery_type} Matches by Row:</h6>`;
                matchedNumbersContainer.appendChild(rowMatchesHeader);
                
                // Find rows with matches for this specific game type
                const rowsWithMatches = data.rows_with_matches.filter(row => row.game_type === data.lottery_type);
                
                if (rowsWithMatches.length > 0) {
                    // Create rows with matches for the main game
                    rowsWithMatches.forEach(rowData => {
                        // Create row label with match indicator
                        const rowLabel = document.createElement('div');
                        rowLabel.classList.add('mt-3', 'mb-1');
                        
                        // Display row name with match count
                        let displayRowName = rowData.row;
                        
                        // Show match count only if there are matches
                        const matchCount = rowData.total_matched;
                        if (matchCount > 0) {
                            rowLabel.innerHTML = `<strong>Row ${displayRowName}:</strong> <span class="badge bg-success ms-2">Matches: ${matchCount}</span>`;
                        } else {
                            rowLabel.innerHTML = `<strong>Row ${displayRowName}:</strong>`;
                        }
                        matchedNumbersContainer.appendChild(rowLabel);
                        
                        // Create row container
                        const rowContainer = document.createElement('div');
                        rowContainer.classList.add('mb-3');
                        
                        // Add balls for this row
                        rowData.numbers.forEach((num, index) => {
                            // If this is the last number (bonus ball), add a plus sign before it
                            if (index === rowData.numbers.length - 1) {
                                // Add plus sign with high visibility
                                const plusContainer = document.createElement('div');
                                plusContainer.classList.add('d-inline-block', 'mx-2', 'align-middle');
                                
                                const plusSpan = document.createElement('span');
                                plusSpan.classList.add('fw-bolder', 'fs-4');
                                plusSpan.textContent = '+';
                                plusSpan.style.color = '#FF5500'; // Orange for visibility
                                
                                plusContainer.appendChild(plusSpan);
                                rowContainer.appendChild(plusContainer);
                            }
                            
                            const ball = document.createElement('span');
                            ball.classList.add('lottery-ball');
                            
                            // Check if this number is a match
                            if (rowData.matched_numbers.includes(num)) {
                                ball.classList.add('ball-matched');
                                
                                // Create match indicator with game-specific styling
                                const matchIcon = document.createElement('div');
                                matchIcon.classList.add('match-indicator');
                                matchIcon.textContent = '✓'; // Direct text checkmark
                                
                                // Color code based on game type
                                if (data.lottery_type === "Powerball") {
                                    matchIcon.classList.add('match-powerball');
                                    ball.setAttribute('title', 'Match in Powerball');
                                } else if (data.lottery_type === "Powerball Plus") {
                                    matchIcon.classList.add('match-powerball-plus');
                                    ball.setAttribute('title', 'Match in Powerball Plus');
                                } else if (data.lottery_type === "Lotto Plus 1") {
                                    matchIcon.classList.add('match-lotto-plus-1');
                                    ball.setAttribute('title', 'Match in Lotto Plus 1');
                                } else if (data.lottery_type === "Lotto Plus 2") {
                                    matchIcon.classList.add('match-lotto-plus-2');
                                    ball.setAttribute('title', 'Match in Lotto Plus 2');
                                } else {
                                    matchIcon.classList.add('match-powerball'); // Default green
                                    ball.setAttribute('title', `Match in ${data.lottery_type}`);
                                }
                                
                                // Add the match indicator to the ball
                                ball.appendChild(matchIcon);
                            }
                            
                            // Check if this number is a bonus match
                            if (rowData.matched_bonus && rowData.matched_bonus.includes(num)) {
                                ball.classList.add('ball-matched', 'lottery-ball-yellow');
                                ball.style.animation = 'pulse 2s infinite';
                                
                                // Create match indicator with game-specific styling
                                const bonusIcon = document.createElement('span');
                                bonusIcon.classList.add('match-indicator');
                                bonusIcon.textContent = '✓'; // Direct text checkmark
                                
                                // Color code based on game type
                                if (data.lottery_type === "Powerball") {
                                    bonusIcon.classList.add('match-powerball-bonus');
                                    ball.setAttribute('title', 'Bonus match in Powerball');
                                } else if (data.lottery_type === "Powerball Plus") {
                                    bonusIcon.classList.add('match-powerball-plus-bonus');
                                    ball.setAttribute('title', 'Bonus match in Powerball Plus');
                                } else if (data.lottery_type === "Lotto Plus 1") {
                                    bonusIcon.classList.add('match-lotto-plus-1-bonus');
                                    ball.setAttribute('title', 'Bonus match in Lotto Plus 1');
                                } else if (data.lottery_type === "Lotto Plus 2") {
                                    bonusIcon.classList.add('match-lotto-plus-2-bonus');
                                    ball.setAttribute('title', 'Bonus match in Lotto Plus 2');
                                } else {
                                    bonusIcon.classList.add('match-powerball-bonus'); // Default blue
                                    ball.setAttribute('title', `Bonus match in ${data.lottery_type}`);
                                }
                                
                                // Add the match indicator to the ball
                                ball.appendChild(bonusIcon);
                            }
                            
                            // If this is the last number, make it yellow to identify as bonus
                            if (index === rowData.numbers.length - 1) {
                                ball.classList.add('lottery-ball-yellow');
                            } 
                            // Otherwise add color classes in sequence
                            else if (!ball.classList.contains('lottery-ball-yellow')) {
                                if (rowContainer.children.length % 4 === 0) {
                                    ball.classList.add('lottery-ball-red');
                                } else if (rowContainer.children.length % 4 === 1) {
                                    ball.classList.add('lottery-ball-yellow');
                                } else if (rowContainer.children.length % 4 === 2) {
                                    ball.classList.add('lottery-ball-green');
                                } else {
                                    ball.classList.add('lottery-ball-blue');
                                }
                            }
                            
                            ball.textContent = num;
                            rowContainer.appendChild(ball);
                        });
                        
                        matchedNumbersContainer.appendChild(rowContainer);
                    });
                } else {
                    const noMatchesMsg = document.createElement('p');
                    noMatchesMsg.textContent = `No rows with ${data.lottery_type} matches found.`;
                    matchedNumbersContainer.appendChild(noMatchesMsg);
                }
            }
            
            // Display prize information if any
            const prizeContainer = document.getElementById('prize-container');
            const noPrizeContainer = document.getElementById('no-prize-container');
            
            if (data.has_prize) {
                prizeContainer.classList.remove('d-none');
                noPrizeContainer.classList.add('d-none');
                
                document.getElementById('prize-lottery-type').textContent = data.lottery_type;
                document.getElementById('prize-draw-number').textContent = data.draw_number;
                document.getElementById('prize-division').textContent = data.prize_info.division;
                document.getElementById('prize-match-type').textContent = data.prize_info.match_type;
                document.getElementById('prize-amount').textContent = data.prize_info.prize_amount;
            } else {
                prizeContainer.classList.add('d-none');
                noPrizeContainer.classList.remove('d-none');
            }
            
            // Check if ticket also plays Powerball Plus and display those results
            // Make sure we only show the Powerball Plus section if this ticket plays Powerball Plus
            // Using case-insensitive comparison for "Powerball" to handle OCR variations
            if (data.lottery_type.toLowerCase() === "powerball".toLowerCase() && 
                (data.powerball_plus_results || (data.ticket_info && data.ticket_info.plays_powerball_plus))) {
                console.log("PowerBall Plus section should be visible");
                // Update the primary game label to include the game name
                const primaryGameLabel = document.getElementById('primary-game-label');
                primaryGameLabel.textContent = 'Powerball Numbers:';
                
                // Powerball Plus Numbers - Add to the main winning numbers card
                const ppNumbersContainer = document.getElementById('powerball-plus-numbers-container');
                const ppNumbersDiv = document.getElementById('powerball-plus-numbers');
                
                // Show the container
                ppNumbersContainer.classList.remove('d-none');
                ppNumbersDiv.innerHTML = '';
                
                // Add main numbers if we have results
                if (data.powerball_plus_results && data.powerball_plus_results.winning_numbers) {
                    data.powerball_plus_results.winning_numbers.forEach((num, index) => {
                    const ball = document.createElement('span');
                    ball.classList.add('lottery-ball');
                    
                    // Add color classes in sequence
                    if (index % 4 === 0) {
                        ball.classList.add('lottery-ball-red');
                    } else if (index % 4 === 1) {
                        ball.classList.add('lottery-ball-yellow');
                    } else if (index % 4 === 2) {
                        ball.classList.add('lottery-ball-green');
                    } else {
                        ball.classList.add('lottery-ball-blue');
                    }
                    
                    ball.textContent = num;
                    ppNumbersDiv.appendChild(ball);
                });
                
                // Always add a plus sign between main numbers and bonus, even if there's only one bonus number
                if (data.powerball_plus_results.bonus_numbers && data.powerball_plus_results.bonus_numbers.length > 0) {
                    // Create a container to hold the plus sign with better visibility
                    const plusContainer = document.createElement('div');
                    plusContainer.classList.add('d-inline-block', 'mx-3', 'position-relative', 'align-middle');
                    plusContainer.style.width = '60px'; // Even wider container for larger plus sign
                    plusContainer.style.height = '60px'; // Ensure height is also sufficient
                    plusContainer.style.textAlign = 'center';
                    plusContainer.style.backgroundColor = 'rgba(255, 255, 255, 0.2)'; // Light background for better visibility
                    plusContainer.style.borderRadius = '50%'; // Make it circular
                    plusContainer.style.display = 'inline-flex';
                    plusContainer.style.justifyContent = 'center';
                    plusContainer.style.alignItems = 'center';
                    
                    // Add plus sign with high visibility
                    const plusSpan = document.createElement('span');
                    plusSpan.classList.add('fw-bolder', 'fs-1'); // Larger font size
                    plusSpan.textContent = '+';
                    plusSpan.style.color = '#FF5500'; // Orange for visibility
                    plusSpan.style.textShadow = '1px 1px 2px rgba(0,0,0,0.5)'; // Light shadow
                    plusSpan.style.display = 'inline-block';
                    
                    plusContainer.appendChild(plusSpan);
                    ppNumbersDiv.appendChild(plusContainer);
                    
                    // Add bonus numbers
                    data.powerball_plus_results.bonus_numbers.forEach(num => {
                        const ball = document.createElement('span');
                        ball.classList.add('lottery-ball', 'lottery-ball-yellow');
                        ball.textContent = num;
                        ppNumbersDiv.appendChild(ball);
                    });
                }
                }
                
                // Display Powerball Plus matches in the main card (with unique matched numbers)
                if (data.powerball_plus_results && data.powerball_plus_results.matched_numbers && data.powerball_plus_results.matched_numbers.length > 0 || 
                    (data.powerball_plus_results && data.powerball_plus_results.matched_bonus && data.powerball_plus_results.matched_bonus.length > 0)) {
                    
                    // PowerballPlus matches container is now always visible
                    const ppMatchesContainer = document.getElementById('pp-matched-numbers-section');
                    // No need to remove d-none class because the section is always visible now
                    
                    // Check if we have multiple rows with matches for Powerball Plus
                    if (data.ticket_info && data.ticket_info.raw_selected_numbers && data.powerball_plus_results.rows_with_matches) {
                        // Display matches by row for Powerball Plus
                        const ppMatchedNumbersDiv = document.getElementById('pp-matched-numbers');
                        ppMatchedNumbersDiv.innerHTML = '<h6 class="mb-3">Powerball Plus Matches by Row:</h6>';
                        
                        // Get unique matched numbers to update the count
                        const uniquePPMatchedNumbers = [...new Set(data.powerball_plus_results.matched_numbers)];
                        document.getElementById('pp-matched-count').textContent = uniquePPMatchedNumbers.length;
                        
                        // Create rows with matches for Powerball Plus game only
                        const rowsToDisplay = data.powerball_plus_results.rows_with_matches || [];
                        
                        if (rowsToDisplay.length > 0) {
                            // Rows with matches
                            rowsToDisplay.forEach(rowData => {
                                // Create row label with match indicator
                                const rowLabel = document.createElement('div');
                                rowLabel.classList.add('mt-3', 'mb-1');
                                
                                // Display row name with match count
                                let displayRowName = rowData.row;
                                
                                // Show match count only if there are matches specific to this game type
                                const matchCount = rowData.total_matched;
                                if (matchCount > 0) {
                                    rowLabel.innerHTML = `<strong>Row ${displayRowName}:</strong> <span class="badge bg-success ms-2">Matches: ${matchCount}</span>`;
                                } else {
                                    rowLabel.innerHTML = `<strong>Row ${displayRowName}:</strong>`;
                                }
                                ppMatchedNumbersDiv.appendChild(rowLabel);
                                
                                // Create row container
                                const rowContainer = document.createElement('div');
                                rowContainer.classList.add('mb-3');
                                
                                // Add balls for this row
                                rowData.numbers.forEach((num, index) => {
                                    // If this is the last number (bonus ball), add a plus sign before it
                                    if (index === rowData.numbers.length - 1) {
                                        // Add plus sign with high visibility
                                        const plusContainer = document.createElement('div');
                                        plusContainer.classList.add('d-inline-block', 'mx-2', 'align-middle');
                                        
                                        const plusSpan = document.createElement('span');
                                        plusSpan.classList.add('fw-bolder', 'fs-4');
                                        plusSpan.textContent = '+';
                                        plusSpan.style.color = '#FF5500'; // Orange for visibility
                                        
                                        plusContainer.appendChild(plusSpan);
                                        rowContainer.appendChild(plusContainer);
                                    }
                                    
                                    const ball = document.createElement('span');
                                    ball.classList.add('lottery-ball');
                                    
                                    // Check if this number is a match
                                    if (rowData.matched_numbers.includes(num)) {
                                        ball.classList.add('ball-matched');
                                        
                                        // Create match indicator with game-specific styling
                                        const matchIcon = document.createElement('div');
                                        matchIcon.classList.add('match-indicator');
                                        matchIcon.textContent = '✓'; // Direct text checkmark
                                        matchIcon.style.position = 'absolute';
                                        matchIcon.style.top = '-5px';
                                        matchIcon.style.right = '-5px';
                                        matchIcon.style.zIndex = '2';
                                        
                                        matchIcon.classList.add('match-powerball-plus');
                                        ball.setAttribute('title', 'Match in Powerball Plus');
                                        ball.style.position = 'relative';
                                        
                                        // Add the match indicator to the ball
                                        ball.appendChild(matchIcon);
                                    }
                                    
                                    // Check if this number is a bonus match
                                    if (rowData.matched_bonus && rowData.matched_bonus.includes(num)) {
                                        ball.classList.add('ball-matched', 'lottery-ball-yellow');
                                        ball.style.animation = 'pulse 2s infinite';
                                        
                                        // Create match indicator with game-specific styling
                                        const bonusIcon = document.createElement('span');
                                        bonusIcon.classList.add('match-indicator');
                                        bonusIcon.textContent = '✓'; // Direct text checkmark
                                        bonusIcon.style.position = 'absolute';
                                        bonusIcon.style.top = '-5px';
                                        bonusIcon.style.right = '-5px';
                                        bonusIcon.style.zIndex = '2';
                                        bonusIcon.classList.add('match-powerball-plus-bonus');
                                        ball.setAttribute('title', 'Bonus match in Powerball Plus');
                                        ball.style.position = 'relative';
                                        
                                        // Add the match indicator to the ball
                                        ball.appendChild(bonusIcon);
                                    }
                                    
                                    // If this is the last number, make it yellow to identify as bonus
                                    if (index === rowData.numbers.length - 1) {
                                        ball.classList.add('lottery-ball-yellow');
                                    } 
                                    // Otherwise add color classes in sequence
                                    else if (!ball.classList.contains('lottery-ball-yellow')) {
                                        if (rowContainer.children.length % 4 === 0) {
                                            ball.classList.add('lottery-ball-red');
                                        } else if (rowContainer.children.length % 4 === 1) {
                                            ball.classList.add('lottery-ball-yellow');
                                        } else if (rowContainer.children.length % 4 === 2) {
                                            ball.classList.add('lottery-ball-green');
                                        } else {
                                            ball.classList.add('lottery-ball-blue');
                                        }
                                    }
                                    
                                    ball.textContent = num;
                                    rowContainer.appendChild(ball);
                                });
                                
                                ppMatchedNumbersDiv.appendChild(rowContainer);
                            });
                        } else {
                            ppMatchedNumbersDiv.innerHTML += '<p>No rows with Powerball Plus matches found.</p>';
                        }
                    } else {
                        // Legacy display method - for backward compatibility
                        // Get unique matched numbers
                        const uniquePPMatchedNumbers = [...new Set(data.powerball_plus_results.matched_numbers)];
                        
                        // Update matched count
                        document.getElementById('pp-matched-count').textContent = uniquePPMatchedNumbers.length;
                        
                        // Display matched numbers
                        const ppMatchedNumbersDiv = document.getElementById('pp-matched-numbers');
                        ppMatchedNumbersDiv.innerHTML = '';
                        
                        if (uniquePPMatchedNumbers.length > 0) {
                            uniquePPMatchedNumbers.forEach(num => {
                                const ball = document.createElement('span');
                                ball.classList.add('lottery-ball', 'ball-matched');
                                ball.setAttribute('title', 'Match in Powerball Plus'); // Add game type indicator
                                
                                // Create match indicator with game-specific styling
                                
                                const matchIcon = document.createElement('div');
                                matchIcon.classList.add('match-indicator');
                                matchIcon.textContent = '✓'; // Direct text checkmark
                                matchIcon.style.position = 'absolute';
                                matchIcon.style.top = '-5px';
                                matchIcon.style.right = '-5px';
                                matchIcon.style.zIndex = '2';
                                
                                matchIcon.classList.add('match-powerball-plus');
                                ball.style.position = 'relative';
                                
                                // Add the match indicator to the ball
                                ball.appendChild(matchIcon);
                                
                                // Add color classes in sequence
                                if (ppMatchedNumbersDiv.children.length % 4 === 0) {
                                    ball.classList.add('lottery-ball-red');
                                } else if (ppMatchedNumbersDiv.children.length % 4 === 1) {
                                    ball.classList.add('lottery-ball-yellow');
                                } else if (ppMatchedNumbersDiv.children.length % 4 === 2) {
                                    ball.classList.add('lottery-ball-green');
                                } else {
                                    ball.classList.add('lottery-ball-blue');
                                }
                                
                                ball.textContent = num;
                                ppMatchedNumbersDiv.appendChild(ball);
                            });
                        } else {
                            ppMatchedNumbersDiv.innerHTML = '<p>No matching main numbers found for Powerball Plus.</p>';
                        }
                        
                        // Get unique matched bonus numbers and add them to the matched numbers section
                        if (data.powerball_plus_results.matched_bonus && data.powerball_plus_results.matched_bonus.length > 0) {
                            const uniquePPMatchedBonus = [...new Set(data.powerball_plus_results.matched_bonus)];
                            
                            // Add a separator if there are also matched main numbers
                            if (uniquePPMatchedNumbers.length > 0) {
                                const separator = document.createElement('div');
                                separator.classList.add('mt-2', 'mb-2');
                                separator.innerHTML = '<strong>Matched Bonus:</strong>';
                                ppMatchedNumbersDiv.appendChild(separator);
                            }
                            
                            uniquePPMatchedBonus.forEach(num => {
                                const ball = document.createElement('span');
                                ball.classList.add('lottery-ball', 'ball-matched', 'lottery-ball-yellow');
                                ball.style.animation = 'pulse 2s infinite';
                                ball.setAttribute('title', 'Bonus match in Powerball Plus'); // Add game type indicator
                                
                                // Create match indicator with game-specific styling for bonus match
                                const bonusIcon = document.createElement('span');
                                bonusIcon.classList.add('match-indicator');
                                bonusIcon.textContent = '✓'; // Direct text checkmark
                                bonusIcon.style.position = 'absolute';
                                bonusIcon.style.top = '-5px';
                                bonusIcon.style.right = '-5px';
                                bonusIcon.style.zIndex = '2';
                                bonusIcon.classList.add('match-powerball-plus-bonus');
                                ball.style.position = 'relative';
                                
                                // Add the match indicator to the ball
                                ball.appendChild(bonusIcon);
                                
                                ball.textContent = num;
                                ppMatchedNumbersDiv.appendChild(ball);
                            });
                        }
                    }
                }
                
                // Keep the separate card for prize information
                const powerballPlusContainer = document.getElementById('powerball-plus-container');
                if (powerballPlusContainer) {
                    // Show the container for prize information
                    powerballPlusContainer.classList.remove('d-none');
                    
                    // Create header for prize information
                    powerballPlusContainer.innerHTML = '';  // Clear any existing content
                    
                    // Only display prize information if there is a prize
                    if (data.powerball_plus_results.has_prize) {
                        // Create a card for Powerball Plus prize
                        const ppPrizeCard = document.createElement('div');
                        ppPrizeCard.classList.add('card', 'mb-4');
                        
                        // Card header
                        const ppCardHeader = document.createElement('div');
                        ppCardHeader.classList.add('card-header', 'bg-primary', 'text-white');
                        ppCardHeader.innerHTML = `<h5 class="mb-0">Powerball Plus Prize</h5>`;
                        ppPrizeCard.appendChild(ppCardHeader);
                        
                        // Card body
                        const ppCardBody = document.createElement('div');
                        ppCardBody.classList.add('card-body');
                        
                        // Prize information
                        const ppPrizeSection = document.createElement('div');
                        ppPrizeSection.classList.add('alert', 'alert-success', 'mt-3');
                        ppPrizeSection.innerHTML = `
                            <h6 class="alert-heading">Congratulations! You won a prize in Powerball Plus:</h6>
                            <p>Division: ${data.powerball_plus_results.prize_info.division}</p>
                            <p>Match Type: ${data.powerball_plus_results.prize_info.match_type}</p>
                            <p>Prize Amount: ${data.powerball_plus_results.prize_info.prize_amount}</p>
                        `;
                        ppCardBody.appendChild(ppPrizeSection);
                        
                        ppPrizeCard.appendChild(ppCardBody);
                        powerballPlusContainer.appendChild(ppPrizeCard);
                    }
                }
            } else {
                // Get the Powerball Plus container and hide it if it exists
                const powerballPlusContainer = document.getElementById('powerball-plus-container');
                if (powerballPlusContainer) {
                    powerballPlusContainer.classList.add('d-none');
                }
            }
            
            // Handle Lotto Plus 1 numbers if present - but only if the main game is Lotto
            if (data.lottery_type === "Lotto" && (data.lotto_plus_1_results || (data.ticket_info && data.ticket_info.plays_lotto_plus_1))) {
                // Get the Lotto Plus 1 container
                const lp1Container = document.getElementById('lotto-plus-1-numbers-container');
                const lp1NumbersDiv = document.getElementById('lotto-plus-1-numbers');
                
                // Show the container
                lp1Container.classList.remove('d-none');
                lp1NumbersDiv.innerHTML = '';
                
                // Add main numbers if we have results
                if (data.lotto_plus_1_results && data.lotto_plus_1_results.winning_numbers) {
                    data.lotto_plus_1_results.winning_numbers.forEach((num, index) => {
                    const ball = document.createElement('span');
                    ball.classList.add('lottery-ball');
                    
                    // Add color classes in sequence
                    if (index % 4 === 0) {
                        ball.classList.add('lottery-ball-red');
                    } else if (index % 4 === 1) {
                        ball.classList.add('lottery-ball-yellow');
                    } else if (index % 4 === 2) {
                        ball.classList.add('lottery-ball-green');
                    } else {
                        ball.classList.add('lottery-ball-blue');
                    }
                    
                    ball.textContent = num;
                    lp1NumbersDiv.appendChild(ball);
                });
                
                // Add plus sign and bonus numbers
                if (data.lotto_plus_1_results.bonus_numbers && data.lotto_plus_1_results.bonus_numbers.length > 0) {
                    const plusSpan = document.createElement('span');
                    plusSpan.classList.add('mx-2', 'my-auto', 'fs-4');
                    plusSpan.textContent = '+';
                    lp1NumbersDiv.appendChild(plusSpan);
                    
                    // Add bonus numbers
                    data.lotto_plus_1_results.bonus_numbers.forEach(num => {
                        const ball = document.createElement('span');
                        ball.classList.add('lottery-ball', 'lottery-ball-yellow');
                        ball.textContent = num;
                        lp1NumbersDiv.appendChild(ball);
                    });
                }
                }
                
                // Display Lotto Plus 1 matches
                if (data.lotto_plus_1_results && data.lotto_plus_1_results.matched_numbers && data.lotto_plus_1_results.matched_numbers.length > 0 || 
                    (data.lotto_plus_1_results && data.lotto_plus_1_results.matched_bonus && data.lotto_plus_1_results.matched_bonus.length > 0)) {
                    
                    // Show the Lotto Plus 1 matches container
                    const lp1MatchesContainer = document.getElementById('lp1-matched-numbers-section');
                    if (lp1MatchesContainer) {
                        lp1MatchesContainer.classList.remove('d-none');
                    }
                    
                    // Check if we have multiple rows with matches for Lotto Plus 1
                    if (data.ticket_info && data.ticket_info.raw_selected_numbers && data.lotto_plus_1_results.rows_with_matches) {
                        // Display matches by row for Lotto Plus 1
                        const lp1MatchedNumbersDiv = document.getElementById('lp1-matched-numbers');
                        lp1MatchedNumbersDiv.innerHTML = '<h6 class="mb-3">Lotto Plus 1 Matches by Row:</h6>';
                        
                        // Get unique matched numbers to update the count
                        const uniqueLP1MatchedNumbers = [...new Set(data.lotto_plus_1_results.matched_numbers)];
                        document.getElementById('lp1-matched-count').textContent = uniqueLP1MatchedNumbers.length;
                        
                        // Create rows with matches for Lotto Plus 1 game only
                        const rowsToDisplay = data.lotto_plus_1_results.rows_with_matches || [];
                        
                        if (rowsToDisplay.length > 0) {
                            // Rows with matches
                            rowsToDisplay.forEach(rowData => {
                                // Create row label with match indicator
                                const rowLabel = document.createElement('div');
                                rowLabel.classList.add('mt-3', 'mb-1');
                                
                                // Display row name with match count
                                let displayRowName = rowData.row;
                                
                                // Show match count only if there are matches specific to this game type
                                const matchCount = rowData.total_matched;
                                if (matchCount > 0) {
                                    rowLabel.innerHTML = `<strong>Row ${displayRowName}:</strong> <span class="badge bg-success ms-2">Matches: ${matchCount}</span>`;
                                } else {
                                    rowLabel.innerHTML = `<strong>Row ${displayRowName}:</strong>`;
                                }
                                lp1MatchedNumbersDiv.appendChild(rowLabel);
                                
                                // Create row container
                                const rowContainer = document.createElement('div');
                                rowContainer.classList.add('mb-3');
                                
                                // Add balls for this row
                                rowData.numbers.forEach(num => {
                                    const ball = document.createElement('span');
                                    ball.classList.add('lottery-ball');
                                    
                                    // Check if this number is a match
                                    if (rowData.matched_numbers.includes(num)) {
                                        ball.classList.add('ball-matched');
                                        
                                        
                                        // Create match indicator with game-specific styling
                                        const matchIcon = document.createElement('div');
                                        matchIcon.classList.add('match-indicator');
                                        matchIcon.textContent = '✓'; // Direct text checkmark
                                        
                                        matchIcon.classList.add('match-lotto-plus-1');
                                        ball.setAttribute('title', 'Match in Lotto Plus 1');
                                        
                                        // Add the match indicator to the ball
                                        ball.appendChild(matchIcon);
                                    }
                                    
                                    // Check if this number is a bonus match
                                    if (rowData.matched_bonus && rowData.matched_bonus.includes(num)) {
                                        ball.classList.add('ball-matched', 'lottery-ball-yellow');
                                        ball.style.animation = 'pulse 2s infinite';
                                        
                                        // Create match indicator with game-specific styling
                                        const bonusIcon = document.createElement('span');
                                        bonusIcon.classList.add('match-indicator');
                                        bonusIcon.textContent = '✓'; // Direct text checkmark
                                        bonusIcon.classList.add('match-lotto-plus-1-bonus');
                                        ball.setAttribute('title', 'Bonus match in Lotto Plus 1');
                                        
                                        // Add the match indicator to the ball
                                        ball.appendChild(bonusIcon);
                                    }
                                    
                                    // Add color classes in sequence
                                    if (!ball.classList.contains('lottery-ball-yellow')) {
                                        if (rowContainer.children.length % 4 === 0) {
                                            ball.classList.add('lottery-ball-red');
                                        } else if (rowContainer.children.length % 4 === 1) {
                                            ball.classList.add('lottery-ball-yellow');
                                        } else if (rowContainer.children.length % 4 === 2) {
                                            ball.classList.add('lottery-ball-green');
                                        } else {
                                            ball.classList.add('lottery-ball-blue');
                                        }
                                    }
                                    
                                    ball.textContent = num;
                                    rowContainer.appendChild(ball);
                                });
                                
                                lp1MatchedNumbersDiv.appendChild(rowContainer);
                            });
                        } else {
                            lp1MatchedNumbersDiv.innerHTML += '<p>No rows with Lotto Plus 1 matches found.</p>';
                        }
                    } else {
                        // Legacy display method - for backward compatibility
                        // Get unique matched numbers
                        const uniqueLP1MatchedNumbers = [...new Set(data.lotto_plus_1_results.matched_numbers)];
                        
                        // Update matched count
                        document.getElementById('lp1-matched-count').textContent = uniqueLP1MatchedNumbers.length;
                        
                        // Display matched numbers
                        const lp1MatchedNumbersDiv = document.getElementById('lp1-matched-numbers');
                        lp1MatchedNumbersDiv.innerHTML = '';
                        
                        if (uniqueLP1MatchedNumbers.length > 0) {
                            uniqueLP1MatchedNumbers.forEach(num => {
                                const ball = document.createElement('span');
                                ball.classList.add('lottery-ball', 'ball-matched');
                                ball.setAttribute('title', 'Match in Lotto Plus 1'); // Add game type indicator
                                
                                
                                // Create match indicator with game-specific styling
                                const matchIcon = document.createElement('div');
                                matchIcon.classList.add('match-indicator');
                                matchIcon.textContent = '✓'; // Direct text checkmark
                                
                                matchIcon.classList.add('match-lotto-plus-1');
                                
                                // Add the match indicator to the ball
                                ball.appendChild(matchIcon);
                                
                                // Add color classes in sequence
                                if (lp1MatchedNumbersDiv.children.length % 4 === 0) {
                                    ball.classList.add('lottery-ball-red');
                                } else if (lp1MatchedNumbersDiv.children.length % 4 === 1) {
                                    ball.classList.add('lottery-ball-yellow');
                                } else if (lp1MatchedNumbersDiv.children.length % 4 === 2) {
                                    ball.classList.add('lottery-ball-green');
                                } else {
                                    ball.classList.add('lottery-ball-blue');
                                }
                                
                                ball.textContent = num;
                                lp1MatchedNumbersDiv.appendChild(ball);
                            });
                        } else {
                            lp1MatchedNumbersDiv.innerHTML = '<p>No matching main numbers found for Lotto Plus 1.</p>';
                        }
                        
                        // Get unique matched bonus numbers and add them to the matched numbers section
                        if (data.lotto_plus_1_results.matched_bonus && data.lotto_plus_1_results.matched_bonus.length > 0) {
                            const uniqueLP1MatchedBonus = [...new Set(data.lotto_plus_1_results.matched_bonus)];
                            
                            // Add a separator if there are also matched main numbers
                            if (uniqueLP1MatchedNumbers.length > 0) {
                                const separator = document.createElement('div');
                                separator.classList.add('mt-2', 'mb-2');
                                separator.innerHTML = '<strong>Matched Bonus:</strong>';
                                lp1MatchedNumbersDiv.appendChild(separator);
                            }
                            
                            uniqueLP1MatchedBonus.forEach(num => {
                                const ball = document.createElement('span');
                                ball.classList.add('lottery-ball', 'ball-matched', 'lottery-ball-yellow');
                                ball.style.animation = 'pulse 2s infinite';
                                ball.setAttribute('title', 'Bonus match in Lotto Plus 1'); // Add game type indicator
                                
                                // Create match indicator with game-specific styling for bonus match
                                const bonusIcon = document.createElement('span');
                                bonusIcon.classList.add('match-indicator');
                                bonusIcon.textContent = '✓'; // Direct text checkmark
                                bonusIcon.classList.add('match-lotto-plus-1-bonus');
                                
                                // Add the match indicator to the ball
                                ball.appendChild(bonusIcon);
                                
                                ball.textContent = num;
                                lp1MatchedNumbersDiv.appendChild(ball);
                            });
                        }
                    }
                }
            }
            
            // Handle Lotto Plus 2 numbers if present - but only if the main game is Lotto
            if (data.lottery_type === "Lotto" && (data.lotto_plus_2_results || (data.ticket_info && data.ticket_info.plays_lotto_plus_2))) {
                // Get the Lotto Plus 2 container
                const lp2Container = document.getElementById('lotto-plus-2-numbers-container');
                const lp2NumbersDiv = document.getElementById('lotto-plus-2-numbers');
                
                // Show the container
                lp2Container.classList.remove('d-none');
                lp2NumbersDiv.innerHTML = '';
                
                // Add main numbers if we have results
                if (data.lotto_plus_2_results && data.lotto_plus_2_results.winning_numbers) {
                    data.lotto_plus_2_results.winning_numbers.forEach((num, index) => {
                    const ball = document.createElement('span');
                    ball.classList.add('lottery-ball');
                    
                    // Add color classes in sequence
                    if (index % 4 === 0) {
                        ball.classList.add('lottery-ball-red');
                    } else if (index % 4 === 1) {
                        ball.classList.add('lottery-ball-yellow');
                    } else if (index % 4 === 2) {
                        ball.classList.add('lottery-ball-green');
                    } else {
                        ball.classList.add('lottery-ball-blue');
                    }
                    
                    ball.textContent = num;
                    lp2NumbersDiv.appendChild(ball);
                });
                
                // Add plus sign and bonus numbers
                if (data.lotto_plus_2_results.bonus_numbers && data.lotto_plus_2_results.bonus_numbers.length > 0) {
                    const plusSpan = document.createElement('span');
                    plusSpan.classList.add('mx-2', 'my-auto', 'fs-4');
                    plusSpan.textContent = '+';
                    lp2NumbersDiv.appendChild(plusSpan);
                    
                    // Add bonus numbers
                    data.lotto_plus_2_results.bonus_numbers.forEach(num => {
                        const ball = document.createElement('span');
                        ball.classList.add('lottery-ball', 'lottery-ball-yellow');
                        ball.textContent = num;
                        lp2NumbersDiv.appendChild(ball);
                    });
                }
                }
                
                // Display Lotto Plus 2 matches
                if (data.lotto_plus_2_results && data.lotto_plus_2_results.matched_numbers && data.lotto_plus_2_results.matched_numbers.length > 0 || 
                    (data.lotto_plus_2_results && data.lotto_plus_2_results.matched_bonus && data.lotto_plus_2_results.matched_bonus.length > 0)) {
                    
                    // Show the Lotto Plus 2 matches container
                    const lp2MatchesContainer = document.getElementById('lp2-matched-numbers-section');
                    if (lp2MatchesContainer) {
                        lp2MatchesContainer.classList.remove('d-none');
                    }
                    
                    // Check if we have multiple rows with matches for Lotto Plus 2
                    if (data.ticket_info && data.ticket_info.raw_selected_numbers && data.lotto_plus_2_results.rows_with_matches) {
                        // Display matches by row for Lotto Plus 2
                        const lp2MatchedNumbersDiv = document.getElementById('lp2-matched-numbers');
                        lp2MatchedNumbersDiv.innerHTML = '<h6 class="mb-3">Lotto Plus 2 Matches by Row:</h6>';
                        
                        // Get unique matched numbers to update the count
                        const uniqueLP2MatchedNumbers = [...new Set(data.lotto_plus_2_results.matched_numbers)];
                        document.getElementById('lp2-matched-count').textContent = uniqueLP2MatchedNumbers.length;
                        
                        // Create rows with matches for Lotto Plus 2 game only
                        const rowsToDisplay = data.lotto_plus_2_results.rows_with_matches || [];
                        
                        if (rowsToDisplay.length > 0) {
                            // Rows with matches
                            rowsToDisplay.forEach(rowData => {
                                // Create row label with match indicator
                                const rowLabel = document.createElement('div');
                                rowLabel.classList.add('mt-3', 'mb-1');
                                
                                // Display row name with match count
                                let displayRowName = rowData.row;
                                
                                // Show match count only if there are matches specific to this game type
                                const matchCount = rowData.total_matched;
                                if (matchCount > 0) {
                                    rowLabel.innerHTML = `<strong>Row ${displayRowName}:</strong> <span class="badge bg-success ms-2">Matches: ${matchCount}</span>`;
                                } else {
                                    rowLabel.innerHTML = `<strong>Row ${displayRowName}:</strong>`;
                                }
                                lp2MatchedNumbersDiv.appendChild(rowLabel);
                                
                                // Create row container
                                const rowContainer = document.createElement('div');
                                rowContainer.classList.add('mb-3');
                                
                                // Add balls for this row
                                rowData.numbers.forEach(num => {
                                    const ball = document.createElement('span');
                                    ball.classList.add('lottery-ball');
                                    
                                    // Check if this number is a match
                                    if (rowData.matched_numbers.includes(num)) {
                                        
                                        ball.classList.add('ball-matched');
                                        
                                        // Create match indicator with game-specific styling
                                        const matchIcon = document.createElement('div');
                                        matchIcon.classList.add('match-indicator');
                                        matchIcon.textContent = '✓'; // Direct text checkmark
                                        
                                        matchIcon.classList.add('match-lotto-plus-2');
                                        ball.setAttribute('title', 'Match in Lotto Plus 2');
                                        
                                        // Add the match indicator to the ball
                                        ball.appendChild(matchIcon);
                                    }
                                    
                                    // Check if this number is a bonus match
                                    if (rowData.matched_bonus && rowData.matched_bonus.includes(num)) {
                                        ball.classList.add('ball-matched', 'lottery-ball-yellow');
                                        ball.style.animation = 'pulse 2s infinite';
                                        
                                        // Create match indicator with game-specific styling
                                        const bonusIcon = document.createElement('span');
                                        bonusIcon.classList.add('match-indicator');
                                        bonusIcon.textContent = '✓'; // Direct text checkmark
                                        bonusIcon.classList.add('match-lotto-plus-2-bonus');
                                        ball.setAttribute('title', 'Bonus match in Lotto Plus 2');
                                        
                                        // Add the match indicator to the ball
                                        ball.appendChild(bonusIcon);
                                    }
                                    
                                    // Add color classes in sequence
                                    if (!ball.classList.contains('lottery-ball-yellow')) {
                                        if (rowContainer.children.length % 4 === 0) {
                                            ball.classList.add('lottery-ball-red');
                                        } else if (rowContainer.children.length % 4 === 1) {
                                            ball.classList.add('lottery-ball-yellow');
                                        } else if (rowContainer.children.length % 4 === 2) {
                                            ball.classList.add('lottery-ball-green');
                                        } else {
                                            ball.classList.add('lottery-ball-blue');
                                        }
                                    }
                                    
                                    ball.textContent = num;
                                    rowContainer.appendChild(ball);
                                });
                                
                                lp2MatchedNumbersDiv.appendChild(rowContainer);
                            });
                        } else {
                            lp2MatchedNumbersDiv.innerHTML += '<p>No rows with Lotto Plus 2 matches found.</p>';
                        }
                    } else {
                        // Legacy display method - for backward compatibility
                        // Get unique matched numbers
                        const uniqueLP2MatchedNumbers = [...new Set(data.lotto_plus_2_results.matched_numbers)];
                        
                        // Update matched count
                        document.getElementById('lp2-matched-count').textContent = uniqueLP2MatchedNumbers.length;
                        
                        // Display matched numbers
                        const lp2MatchedNumbersDiv = document.getElementById('lp2-matched-numbers');
                        lp2MatchedNumbersDiv.innerHTML = '';
                        
                        // Display both main and bonus matches together
                        const allLP2Matches = [...uniqueLP2MatchedNumbers];
                        
                        // Add bonus matches if they exist
                        if (data.lotto_plus_2_results.matched_bonus && data.lotto_plus_2_results.matched_bonus.length > 0) {
                            // Add bonus numbers to the main matched numbers display
                            allLP2Matches.push(...data.lotto_plus_2_results.matched_bonus);
                        }
                        
                        if (allLP2Matches.length > 0) {
                            allLP2Matches.forEach(num => {
                                const ball = document.createElement('span');
                                ball.classList.add('lottery-ball', 'ball-matched');
                                
                                // Style bonus numbers differently if needed
                                if (data.lotto_plus_2_results.bonus_numbers.includes(num)) {
                                    ball.classList.add('lottery-ball-yellow');
                                    ball.style.animation = 'pulse 2s infinite';
                                    ball.setAttribute('title', 'Bonus match in Lotto Plus 2'); // Add game type indicator
                                    
                                    // Create match indicator with game-specific styling for bonus match
                                    const bonusIcon = document.createElement('span');
                                    bonusIcon.classList.add('match-indicator');
                                    bonusIcon.textContent = '✓'; // Direct text checkmark
                                    bonusIcon.classList.add('match-lotto-plus-2-bonus');
                                    
                                    // Add the match indicator to the ball
                                    ball.appendChild(bonusIcon);
                                    
                                } else {
                                    ball.setAttribute('title', 'Match in Lotto Plus 2'); // Add game type indicator
                                    
                                    // Create match indicator with game-specific styling
                                    const matchIcon = document.createElement('div');
                                    matchIcon.classList.add('match-indicator');
                                    matchIcon.textContent = '✓'; // Direct text checkmark
                                    
                                    matchIcon.classList.add('match-lotto-plus-2');
                                    
                                    // Add the match indicator to the ball
                                    ball.appendChild(matchIcon);
                                    // Add color classes in sequence for regular numbers
                                    if (lp2MatchedNumbersDiv.children.length % 4 === 0) {
                                        ball.classList.add('lottery-ball-red');
                                    } else if (lp2MatchedNumbersDiv.children.length % 4 === 1) {
                                        ball.classList.add('lottery-ball-yellow');
                                    } else if (lp2MatchedNumbersDiv.children.length % 4 === 2) {
                                        ball.classList.add('lottery-ball-green');
                                    } else {
                                        ball.classList.add('lottery-ball-blue');
                                    }
                                }
                                
                                ball.textContent = num;
                                lp2MatchedNumbersDiv.appendChild(ball);
                            });
                        } else {
                            lp2MatchedNumbersDiv.innerHTML = '<p>No matching numbers found for Lotto Plus 2.</p>';
                        }
                    }
                }
            }
            
            // Scroll to results with a slight delay to ensure DOM is updated
            setTimeout(() => {
                window.scrollTo({
                    top: resultsContainer.offsetTop,
                    behavior: 'smooth'
                });
                // Make sure scrolling is fully enabled
                enableScrolling();
            }, 300);
        } catch (error) {
            console.error("Error displaying results:", error);
            showError("An error occurred while displaying results. Please try again.");
            enableScrolling();
        }
        }
        
        function showError(message) {
            // Ensure scrolling is enabled
            enableScrolling();
            
            const errorMessage = document.getElementById('error-message');
            const errorText = document.getElementById('error-text');
            const successContent = document.getElementById('success-content');
            
            errorText.textContent = message;
            errorMessage.classList.remove('d-none');
            successContent.classList.add('d-none');
        }
    });
</script>
<!-- Fresh checkmark system - clean slate approach -->
<script src="{{ url_for('static', filename='js/fresh_checkmark.js') }}"></script>
<script src="{{ url_for('static', filename='js/getAdsByPlacement.js') }}"></script>
<script src="{{ url_for('static', filename='js/countdown-timer.js') }}"></script>
<script src="{{ url_for('static', filename='js/ticket-submission-handler-fixed.js') }}"></script>
{% endblock %}