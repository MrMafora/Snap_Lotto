{% extends "base.html" %}

{% block title %}Compact Lottery Scanner{% endblock %}

{% block content %}
<div class="container py-3">
    <div class="row">
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5>🎫 Upload Ticket</h5>
                </div>
                <div class="card-body">
                    <form id="ticket-form" enctype="multipart/form-data">
                        <div class="mb-3">
                            <input type="file" class="form-control" id="ticket-image" name="ticket_image" 
                                   accept="image/*" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-search"></i> Scan Ticket
                        </button>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-md-8">
            <div id="results-container" class="d-none">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">🎯 Results</h5>
                        <span id="ticket-info" class="small text-muted"></span>
                    </div>
                    <div class="card-body">
                        <!-- Winning Numbers Section -->
                        <div id="winning-numbers-section" class="mb-4"></div>
                        
                        <!-- Compact Lines Summary -->
                        <div id="lines-summary" class="mb-4">
                            <h6 class="mb-2">Your Lines</h6>
                            <div class="table-responsive">
                                <table class="table table-sm table-striped">
                                    <thead>
                                        <tr>
                                            <th>Line</th>
                                            <th>Numbers</th>
                                            <th>Matches</th>
                                        </tr>
                                    </thead>
                                    <tbody id="lines-table-body">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Overall Summary -->
                        <div id="overall-summary" class="alert alert-primary">
                            <div class="row text-center">
                                <div class="col-4">
                                    <div class="h4 mb-0" id="total-lines">0</div>
                                    <small>Total Lines</small>
                                </div>
                                <div class="col-4">
                                    <div class="h4 mb-0" id="total-matches">0</div>
                                    <small>Total Matches</small>
                                </div>
                                <div class="col-4">
                                    <div class="h4 mb-0" id="winning-lines">0</div>
                                    <small>Winning Lines</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.getElementById('ticket-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData();
    const fileInput = document.getElementById('ticket-image');
    formData.append('ticket_image', fileInput.files[0]);
    
    try {
        const response = await fetch('/process-ticket', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        console.log('Response data:', data);
        
        if (data.success) {
            displayCompactResults(data);
            document.getElementById('results-container').classList.remove('d-none');
        }
    } catch (error) {
        console.error('Error:', error);
    }
});

function displayCompactResults(data) {
    // Update ticket info
    document.getElementById('ticket-info').textContent = 
        `${data.lottery_type} • Draw ${data.draw_number} • ${data.draw_date}`;
    
    // Display winning numbers
    displayWinningNumbers(data);
    
    // Display lines in compact table
    displayLinesTable(data);
    
    // Update summary stats
    updateSummaryStats(data);
}

function displayWinningNumbers(data) {
    const container = document.getElementById('winning-numbers-section');
    container.innerHTML = '';
    
    if (data.powerball_results) {
        const winningDiv = document.createElement('div');
        winningDiv.className = 'p-3 bg-warning bg-opacity-10 rounded mb-3';
        
        const title = document.createElement('h6');
        title.className = 'mb-2';
        title.innerHTML = '🏆 Winning Numbers';
        winningDiv.appendChild(title);
        
        // Display winning numbers in compact format
        const numbersRow = document.createElement('div');
        numbersRow.className = 'd-flex align-items-center gap-2';
        
        const gameLabel = document.createElement('span');
        gameLabel.className = 'small fw-bold me-2';
        gameLabel.textContent = 'PowerBall:';
        numbersRow.appendChild(gameLabel);
        
        // Add winning numbers as small balls
        try {
            const winningNumbers = JSON.parse(data.powerball_results.winning_numbers || '[]');
            winningNumbers.forEach((num, index) => {
                const ball = document.createElement('span');
                ball.className = 'badge rounded-pill bg-primary me-1';
                ball.textContent = num;
                numbersRow.appendChild(ball);
            });
        } catch (e) {
            console.log('Could not parse winning numbers');
        }
        
        winningDiv.appendChild(numbersRow);
        container.appendChild(winningDiv);
    }
}

function displayLinesTable(data) {
    const tbody = document.getElementById('lines-table-body');
    tbody.innerHTML = '';
    
    if (data.all_lines && data.all_lines.length > 0) {
        data.all_lines.forEach((line, index) => {
            const row = document.createElement('tr');
            
            // Line number
            const lineCell = document.createElement('td');
            lineCell.textContent = `Line ${index + 1}`;
            row.appendChild(lineCell);
            
            // Numbers with colors and matches
            const numbersCell = document.createElement('td');
            const numbersContainer = document.createElement('div');
            numbersContainer.className = 'd-flex align-items-center gap-1';
            
            const colors = ['text-danger', 'text-primary', 'text-success', 'text-warning'];
            line.forEach((num, numIndex) => {
                const numSpan = document.createElement('span');
                numSpan.className = `badge ${colors[numIndex % colors.length]}`;
                numSpan.style.backgroundColor = 'transparent';
                numSpan.style.border = '1px solid currentColor';
                
                // Check if this number matches winning numbers
                let isMatch = false;
                try {
                    const winningNumbers = JSON.parse(data.powerball_results?.winning_numbers || '[]');
                    if (winningNumbers.includes(num.toString())) {
                        numSpan.innerHTML = `${num} ✓`;
                        numSpan.classList.add('bg-success', 'text-white');
                        isMatch = true;
                    } else {
                        numSpan.textContent = num;
                    }
                } catch (e) {
                    numSpan.textContent = num;
                }
                
                numbersContainer.appendChild(numSpan);
            });
            
            // Add PowerBall number
            const powerballNum = data.all_powerball && data.all_powerball[index] ? 
                data.all_powerball[index] : data.powerball_number;
            if (powerballNum) {
                const plusSpan = document.createElement('span');
                plusSpan.className = 'mx-1';
                plusSpan.textContent = '+';
                numbersContainer.appendChild(plusSpan);
                
                const pbSpan = document.createElement('span');
                pbSpan.className = 'badge bg-warning text-dark';
                pbSpan.textContent = powerballNum;
                numbersContainer.appendChild(pbSpan);
            }
            
            numbersCell.appendChild(numbersContainer);
            row.appendChild(numbersCell);
            
            // Matches count
            const matchesCell = document.createElement('td');
            let matchCount = 0;
            try {
                const winningNumbers = JSON.parse(data.powerball_results?.winning_numbers || '[]');
                matchCount = line.filter(num => winningNumbers.includes(num.toString())).length;
            } catch (e) {
                matchCount = 0;
            }
            
            if (matchCount > 0) {
                matchesCell.innerHTML = `<span class="badge bg-success">${matchCount}</span>`;
            } else {
                matchesCell.innerHTML = `<span class="text-muted">0</span>`;
            }
            row.appendChild(matchesCell);
            
            tbody.appendChild(row);
        });
    }
}

function updateSummaryStats(data) {
    const totalLines = data.all_lines ? data.all_lines.length : 0;
    let totalMatches = 0;
    let winningLines = 0;
    
    if (data.all_lines) {
        data.all_lines.forEach(line => {
            let lineMatches = 0;
            try {
                const winningNumbers = JSON.parse(data.powerball_results?.winning_numbers || '[]');
                lineMatches = line.filter(num => winningNumbers.includes(num.toString())).length;
            } catch (e) {
                lineMatches = 0;
            }
            totalMatches += lineMatches;
            if (lineMatches > 0) winningLines++;
        });
    }
    
    document.getElementById('total-lines').textContent = totalLines;
    document.getElementById('total-matches').textContent = totalMatches;
    document.getElementById('winning-lines').textContent = winningLines;
}
</script>
{% endblock %}