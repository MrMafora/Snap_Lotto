{% extends 'base.html' %}

{% block title %}Scan Lottery Ticket{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h1 class="h3 mb-0">Scan Your Lottery Ticket</h1>
                </div>
                <div class="card-body">
                    {% if api_available %}
                    <div class="alert alert-info">
                        <p><strong>How it works:</strong></p>
                        <ol>
                            <li>Take a clear photo of your lottery ticket</li>
                            <li>Upload the image below</li>
                            <li>Our system will automatically:
                                <ul>
                                    <li>Extract your ticket information</li>
                                    <li>Check it against official draw results</li>
                                    <li>Tell you if you've won!</li>
                                </ul>
                            </li>
                        </ol>
                        <p class="mb-0"><small>Powered by advanced AI analysis from {% if gemini_available %}Google Gemini{% endif %}{% if gemini_available and openai_available %} and {% endif %}{% if openai_available %}OpenAI{% endif %}</small></p>
                    </div>
                    
                    <form action="{{ url_for('scanner.scan_ticket') }}" method="post" enctype="multipart/form-data" class="mt-4">
                        <div class="mb-4 text-center">
                            <div class="upload-area p-5 border rounded position-relative">
                                <input type="file" id="ticket_image" name="ticket_image" class="d-none" accept=".jpg, .jpeg, .png, .gif, .bmp">
                                <label for="ticket_image" class="btn btn-outline-primary mb-3">
                                    <i class="fas fa-upload me-2"></i> Select Ticket Image
                                </label>
                                <div id="preview" class="mt-3 d-none">
                                    <img src="" id="preview-image" class="img-fluid rounded mb-2 max-height-300">
                                    <p id="file-name" class="text-muted small"></p>
                                </div>
                                <p class="text-muted small mb-0">Supported formats: JPG, PNG, GIF, BMP (Max 10MB)</p>
                            </div>
                        </div>
                        
                        <div class="text-center">
                            <button type="submit" id="scan-button" class="btn btn-primary btn-lg" disabled>
                                <i class="fas fa-search me-2"></i> Scan Ticket
                            </button>
                        </div>
                    </form>
                    
                    <div class="loading-overlay text-center d-none" id="loading-overlay">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-3">Processing your ticket...</p>
                        <p class="text-muted small">This may take a few moments</p>
                        
                        <!-- Ad container -->
                        <div id="ad-container-scanner" class="mt-4">
                            <!-- Ads will be dynamically inserted here -->
                        </div>
                    </div>
                    {% else %}
                    <div class="alert alert-warning">
                        <h4 class="alert-heading">Scanner Temporarily Unavailable</h4>
                        <p>Our ticket scanning service is currently unavailable. Please check back later.</p>
                        <hr>
                        <p class="mb-0">In the meantime, you can check the latest results on our <a href="{{ url_for('index') }}">homepage</a>.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <div class="card mt-4 shadow-sm">
                <div class="card-header bg-light">
                    <h2 class="h5 mb-0">Tips for Best Results</h2>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h5><i class="fas fa-check-circle text-success me-2"></i> DO</h5>
                            <ul class="ps-3">
                                <li>Take a clear, well-lit photo</li>
                                <li>Ensure the entire ticket is visible</li>
                                <li>Make sure all numbers are readable</li>
                                <li>Place ticket on a flat, plain surface</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h5><i class="fas fa-times-circle text-danger me-2"></i> DON'T</h5>
                            <ul class="ps-3">
                                <li>Use blurry or dark images</li>
                                <li>Cover important information</li>
                                <li>Take photos at an angle</li>
                                <li>Use images with glare or reflections</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const fileInput = document.getElementById('ticket_image');
        const previewArea = document.getElementById('preview');
        const previewImage = document.getElementById('preview-image');
        const fileName = document.getElementById('file-name');
        const scanButton = document.getElementById('scan-button');
        const form = document.querySelector('form');
        const loadingOverlay = document.getElementById('loading-overlay');
        
        // Handle file selection
        fileInput.addEventListener('change', function() {
            if (fileInput.files && fileInput.files[0]) {
                const file = fileInput.files[0];
                
                // Check file size (max 10MB)
                if (file.size > 10 * 1024 * 1024) {
                    alert('File is too large. Maximum file size is 10MB.');
                    fileInput.value = '';
                    previewArea.classList.add('d-none');
                    scanButton.disabled = true;
                    return;
                }
                
                // Create object URL for preview
                const objectUrl = URL.createObjectURL(file);
                previewImage.src = objectUrl;
                fileName.textContent = file.name;
                previewArea.classList.remove('d-none');
                scanButton.disabled = false;
            }
        });
        
        // Show loading overlay when form is submitted
        form.addEventListener('submit', function() {
            // Only proceed if a file is selected
            if (fileInput.files && fileInput.files[0]) {
                form.classList.add('d-none');
                loadingOverlay.classList.remove('d-none');
                
                // Try to load an ad if ad manager is available
                if (typeof AdManager !== 'undefined') {
                    AdManager.showAd('scanner');
                }
            }
        });
    });
</script>
{% endblock %}