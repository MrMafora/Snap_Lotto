{% extends "admin/base.html" %}

{% block title %}Process Monitoring Dashboard{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4">Process Monitoring Dashboard</h1>
            <p class="text-muted">View real-time performance metrics and process data for various components of the application.</p>
            
            <!-- System Metrics Card -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">System Metrics <small class="float-end">Last updated: <span id="last-update-time">{{ system_metrics.timestamp }}</span></small></h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <div class="card h-100">
                                <div class="card-body text-center">
                                    <h6 class="card-title text-muted">CPU Usage</h6>
                                    <div class="progress mb-2" style="height: 20px;">
                                        <div class="progress-bar" role="progressbar" id="cpu-bar"
                                            style="width: {{ system_metrics.cpu.percent }}%;" 
                                            aria-valuenow="{{ system_metrics.cpu.percent }}" 
                                            aria-valuemin="0" aria-valuemax="100">
                                            <span id="cpu-text">{{ system_metrics.cpu.percent|round(1) }}%</span>
                                        </div>
                                    </div>
                                    <small class="text-muted">System: <span id="cpu-system-text">{{ system_metrics.cpu.system_percent|round(1) }}%</span></small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card h-100">
                                <div class="card-body text-center">
                                    <h6 class="card-title text-muted">Memory Usage</h6>
                                    <div class="progress mb-2" style="height: 20px;">
                                        <div class="progress-bar bg-success" role="progressbar" id="memory-bar"
                                            style="width: {{ system_metrics.memory.percent }}%;" 
                                            aria-valuenow="{{ system_metrics.memory.percent }}" 
                                            aria-valuemin="0" aria-valuemax="100">
                                            <span id="memory-text">{{ system_metrics.memory.percent|round(1) }}%</span>
                                        </div>
                                    </div>
                                    <small class="text-muted">
                                        RSS: <span id="memory-rss">{{ (system_metrics.memory.rss / 1024 / 1024)|round(1) }} MB</span>
                                    </small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card h-100">
                                <div class="card-body text-center">
                                    <h6 class="card-title text-muted">Disk Usage</h6>
                                    <div class="progress mb-2" style="height: 20px;">
                                        <div class="progress-bar bg-warning" role="progressbar" id="disk-bar"
                                            style="width: {{ system_metrics.disk.percent }}%;" 
                                            aria-valuenow="{{ system_metrics.disk.percent }}" 
                                            aria-valuemin="0" aria-valuemax="100">
                                            <span id="disk-text">{{ system_metrics.disk.percent|round(1) }}%</span>
                                        </div>
                                    </div>
                                    <small class="text-muted">
                                        Free: <span id="disk-free">{{ (system_metrics.disk.free / 1024 / 1024 / 1024)|round(1) }} GB</span>
                                    </small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card h-100">
                                <div class="card-body text-center">
                                    <h6 class="card-title text-muted">Network I/O</h6>
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <i class="fas fa-arrow-down text-success"></i>
                                            <span id="network-recv">{{ (system_metrics.network.bytes_recv / 1024 / 1024)|round(2) }} MB</span>
                                        </div>
                                        <div>
                                            <i class="fas fa-arrow-up text-danger"></i>
                                            <span id="network-sent">{{ (system_metrics.network.bytes_sent / 1024 / 1024)|round(2) }} MB</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <button id="refresh-metrics" class="btn btn-sm btn-outline-primary mt-2">
                        <i class="fas fa-sync-alt"></i> Refresh Metrics
                    </button>
                </div>
            </div>
            
            <!-- Performance Stats Card -->
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">Performance Summary (Last 24 Hours)</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <div class="card h-100">
                                <div class="card-body text-center">
                                    <h5 class="display-4">{{ stats.count }}</h5>
                                    <h6 class="text-muted">Total Processes</h6>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card h-100">
                                <div class="card-body text-center">
                                    <h5 class="display-4">{{ stats.avg_duration|round(2) }}s</h5>
                                    <h6 class="text-muted">Average Duration</h6>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card h-100">
                                <div class="card-body text-center">
                                    <h5 class="display-4">{{ stats.success_rate|round(1) }}%</h5>
                                    <h6 class="text-muted">Success Rate</h6>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card h-100">
                                <div class="card-body text-center">
                                    <h5 class="display-4">{{ stats.error_count }}</h5>
                                    <h6 class="text-muted">Total Errors</h6>
                                </div>
                            </div>
                        </div>
                    </div>

                    {% if stats.by_name %}
                    <div class="mt-4">
                        <h5>Process Performance by Name</h5>
                        <div class="table-responsive">
                            <table class="table table-striped table-bordered">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Process Name</th>
                                        <th>Count</th>
                                        <th>Avg. Duration (s)</th>
                                        <th>Min Duration (s)</th>
                                        <th>Max Duration (s)</th>
                                        <th>Success Rate</th>
                                        <th>Errors</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for name, data in stats.by_name.items() %}
                                    <tr>
                                        <td>{{ name }}</td>
                                        <td>{{ data.count }}</td>
                                        <td>{{ data.avg_duration|round(3) }}</td>
                                        <td>{{ data.min_duration|round(3) }}</td>
                                        <td>{{ data.max_duration|round(3) }}</td>
                                        <td>{{ data.success_rate|round(1) }}%</td>
                                        <td>{{ data.error_count }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Recent Processes Tab Card -->
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">Recent Processes</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Category</th>
                                    <th>Name</th>
                                    <th>Timestamp</th>
                                    <th>Duration</th>
                                    <th>Status</th>
                                    <th>Details</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for process in processes %}
                                <tr>
                                    <td>{{ process.category }}</td>
                                    <td>{{ process.name }}</td>
                                    <td>{{ process.timestamp }}</td>
                                    <td>
                                        {% if process.data.duration %}
                                            {{ process.data.duration|round(3) }}s
                                        {% else %}
                                            <span class="badge bg-warning">Running</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if process.data.success is defined %}
                                            {% if process.data.success %}
                                                <span class="badge bg-success">Success</span>
                                            {% else %}
                                                <span class="badge bg-danger">Error</span>
                                            {% endif %}
                                        {% else %}
                                            <span class="badge bg-secondary">Unknown</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary process-details-btn" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#processDetailsModal"
                                                data-process="{{ process|tojson }}">
                                            <i class="fas fa-info-circle"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <a href="{{ url_for('process_monitor.monitor_processes') }}" class="btn btn-outline-info">
                        <i class="fas fa-list"></i> View All Processes
                    </a>
                </div>
            </div>
            
            <!-- Recent Events Tab Card -->
            <div class="card mb-4">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">Recent Events</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Event Name</th>
                                    <th>Timestamp</th>
                                    <th>Severity</th>
                                    <th>Details</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for event in events %}
                                <tr>
                                    <td>{{ event.name }}</td>
                                    <td>{{ event.timestamp }}</td>
                                    <td>
                                        {% if event.severity == 'error' %}
                                            <span class="badge bg-danger">Error</span>
                                        {% elif event.severity == 'warning' %}
                                            <span class="badge bg-warning">Warning</span>
                                        {% elif event.severity == 'critical' %}
                                            <span class="badge bg-dark">Critical</span>
                                        {% else %}
                                            <span class="badge bg-info">Info</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-secondary event-details-btn" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#eventDetailsModal"
                                                data-event="{{ event|tojson }}">
                                            <i class="fas fa-info-circle"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <a href="{{ url_for('process_monitor.monitor_events') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-list"></i> View All Events
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Process Details Modal -->
<div class="modal fade" id="processDetailsModal" tabindex="-1" aria-labelledby="processDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="processDetailsModalLabel">Process Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <p><strong>Category:</strong> <span id="process-category"></span></p>
                        <p><strong>Name:</strong> <span id="process-name"></span></p>
                        <p><strong>ID:</strong> <span id="process-id"></span></p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Timestamp:</strong> <span id="process-timestamp"></span></p>
                        <p><strong>Duration:</strong> <span id="process-duration"></span></p>
                        <p><strong>Status:</strong> <span id="process-status"></span></p>
                    </div>
                </div>
                
                <h6>Process Data</h6>
                <pre id="process-data" class="bg-light p-3" style="max-height: 300px; overflow-y: auto;"></pre>
                
                <div id="process-error-container" class="d-none">
                    <h6 class="text-danger">Error Information</h6>
                    <p id="process-error-message"></p>
                    <pre id="process-error-traceback" class="bg-light p-3" style="max-height: 200px; overflow-y: auto;"></pre>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Event Details Modal -->
<div class="modal fade" id="eventDetailsModal" tabindex="-1" aria-labelledby="eventDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="eventDetailsModalLabel">Event Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <p><strong>Name:</strong> <span id="event-name"></span></p>
                        <p><strong>ID:</strong> <span id="event-id"></span></p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Timestamp:</strong> <span id="event-timestamp"></span></p>
                        <p><strong>Severity:</strong> <span id="event-severity"></span></p>
                    </div>
                </div>
                
                <h6>Event Details</h6>
                <pre id="event-details" class="bg-light p-3" style="max-height: 300px; overflow-y: auto;"></pre>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Process Details Modal
        const processButtons = document.querySelectorAll('.process-details-btn');
        processButtons.forEach(button => {
            button.addEventListener('click', function() {
                const process = JSON.parse(this.getAttribute('data-process'));
                
                // Populate modal fields
                document.getElementById('process-category').textContent = process.category || 'N/A';
                document.getElementById('process-name').textContent = process.name || 'N/A';
                document.getElementById('process-id').textContent = process.id || 'N/A';
                document.getElementById('process-timestamp').textContent = process.timestamp || 'N/A';
                
                // Duration
                if (process.data && process.data.duration !== undefined) {
                    document.getElementById('process-duration').textContent = (process.data.duration).toFixed(3) + ' seconds';
                } else {
                    document.getElementById('process-duration').textContent = 'Running or unknown';
                }
                
                // Status
                const statusElement = document.getElementById('process-status');
                if (process.data && process.data.success !== undefined) {
                    if (process.data.success) {
                        statusElement.textContent = 'Success';
                        statusElement.className = 'badge bg-success';
                    } else {
                        statusElement.textContent = 'Error';
                        statusElement.className = 'badge bg-danger';
                    }
                } else {
                    statusElement.textContent = 'Unknown';
                    statusElement.className = 'badge bg-secondary';
                }
                
                // Process data (prettified JSON)
                const dataElement = document.getElementById('process-data');
                try {
                    dataElement.textContent = JSON.stringify(process.data || {}, null, 2);
                } catch (e) {
                    dataElement.textContent = 'Error displaying data';
                }
                
                // Error information if available
                const errorContainer = document.getElementById('process-error-container');
                if (process.data && process.data.error) {
                    errorContainer.classList.remove('d-none');
                    document.getElementById('process-error-message').textContent = process.data.error;
                    
                    if (process.data.traceback) {
                        document.getElementById('process-error-traceback').textContent = process.data.traceback;
                    } else {
                        document.getElementById('process-error-traceback').textContent = 'No traceback available';
                    }
                } else {
                    errorContainer.classList.add('d-none');
                }
            });
        });
        
        // Event Details Modal
        const eventButtons = document.querySelectorAll('.event-details-btn');
        eventButtons.forEach(button => {
            button.addEventListener('click', function() {
                const event = JSON.parse(this.getAttribute('data-event'));
                
                // Populate modal fields
                document.getElementById('event-name').textContent = event.name || 'N/A';
                document.getElementById('event-id').textContent = event.id || 'N/A';
                document.getElementById('event-timestamp').textContent = event.timestamp || 'N/A';
                
                // Severity
                const severityElement = document.getElementById('event-severity');
                severityElement.textContent = event.severity || 'info';
                
                if (event.severity === 'error') {
                    severityElement.className = 'badge bg-danger';
                } else if (event.severity === 'warning') {
                    severityElement.className = 'badge bg-warning';
                } else if (event.severity === 'critical') {
                    severityElement.className = 'badge bg-dark';
                } else {
                    severityElement.className = 'badge bg-info';
                }
                
                // Event details (prettified JSON)
                const detailsElement = document.getElementById('event-details');
                try {
                    detailsElement.textContent = JSON.stringify(event.details || {}, null, 2);
                } catch (e) {
                    detailsElement.textContent = 'Error displaying details';
                }
            });
        });
        
        // Refresh system metrics
        document.getElementById('refresh-metrics').addEventListener('click', function() {
            fetch('/api/process-monitor/system-metrics')
                .then(response => response.json())
                .then(data => {
                    const metrics = data.metrics;
                    
                    // Update CPU
                    document.getElementById('cpu-bar').style.width = metrics.cpu.percent + '%';
                    document.getElementById('cpu-text').textContent = metrics.cpu.percent.toFixed(1) + '%';
                    document.getElementById('cpu-system-text').textContent = metrics.cpu.system_percent.toFixed(1) + '%';
                    
                    // Update memory
                    document.getElementById('memory-bar').style.width = metrics.memory.percent + '%';
                    document.getElementById('memory-text').textContent = metrics.memory.percent.toFixed(1) + '%';
                    document.getElementById('memory-rss').textContent = (metrics.memory.rss / 1024 / 1024).toFixed(1) + ' MB';
                    
                    // Update disk
                    document.getElementById('disk-bar').style.width = metrics.disk.percent + '%';
                    document.getElementById('disk-text').textContent = metrics.disk.percent.toFixed(1) + '%';
                    document.getElementById('disk-free').textContent = (metrics.disk.free / 1024 / 1024 / 1024).toFixed(1) + ' GB';
                    
                    // Update network
                    document.getElementById('network-recv').textContent = (metrics.network.bytes_recv / 1024 / 1024).toFixed(2) + ' MB';
                    document.getElementById('network-sent').textContent = (metrics.network.bytes_sent / 1024 / 1024).toFixed(2) + ' MB';
                    
                    // Update timestamp
                    document.getElementById('last-update-time').textContent = metrics.timestamp;
                })
                .catch(error => console.error('Error refreshing metrics:', error));
        });
    });
</script>
{% endblock %}