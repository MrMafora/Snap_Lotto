{% extends "layout.html" %}

{% block title %} - Data Visualizations{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header lottery-header">
                <h4 class="card-title mb-0">LOTTERY DATA ANALYTICS</h4>
            </div>
            <div class="card-body">
                <p class="lead">
                    Analyze lottery data through interactive visualizations to identify patterns, frequencies, 
                    and distribution of winners and prizes.
                </p>
                
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="lottery-type-select" class="fw-bold">Filter by Lottery Type:</label>
                            <select id="lottery-type-select" class="form-select">
                                <option value="">All Types</option>
                                {% for type in lottery_types %}
                                <option value="{{ type }}">{{ type }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="chart-type-select" class="fw-bold">Visualization Type:</label>
                            <select id="chart-type-select" class="form-select">
                                <option value="numbers_frequency">Number Frequency</option>
                                <option value="winners_by_division">Winners by Division</option>
                                <option value="prize_amounts">Prize Amounts</option>
                                <option value="draw_dates">Draw Date Distribution</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Visualization Charts -->
<div class="row">
    <div class="col-12">
        <div class="card mb-4">
            <div class="card-header lottery-header">
                <h5 class="card-title mb-0" id="chart-title">NUMBER FREQUENCY ANALYSIS</h5>
            </div>
            <div class="card-body">
                <div class="chart-container" style="position: relative; height:50vh; width:100%">
                    <canvas id="main-chart"></canvas>
                </div>
                <div class="text-center mt-3 d-none" id="no-data-message">
                    <div class="alert alert-warning">
                        No data available for the selected filters. Try a different lottery type or visualization.
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Analysis and Insights -->
<div class="row">
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header lottery-header">
                <h5 class="card-title mb-0">KEY INSIGHTS</h5>
            </div>
            <div class="card-body">
                <div id="insights-container">
                    <ul class="list-group list-group-flush" id="insights-list">
                        <li class="list-group-item">Select a lottery type and visualization to see insights.</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header lottery-header">
                <h5 class="card-title mb-0">LATEST DRAW RESULTS</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-lottery" id="latest-results-table">
                        <thead>
                            <tr>
                                <th>GAME TYPE</th>
                                <th>DRAW ID</th>
                                <th>DATE</th>
                                <th>NUMBERS</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for result in latest_results %}
                            <tr>
                                <td>
                                    {% if 'Lotto Plus' in result.lottery_type %}
                                        <span class="game-type-badge game-type-lotto">{{ result.lottery_type }}</span>
                                    {% elif 'Powerball' in result.lottery_type %}
                                        <span class="game-type-badge game-type-powerball">{{ result.lottery_type }}</span>
                                    {% elif 'Daily' in result.lottery_type %}
                                        <span class="game-type-badge game-type-daily">{{ result.lottery_type }}</span>
                                    {% else %}
                                        <span class="game-type-badge game-type-lotto">{{ result.lottery_type }}</span>
                                    {% endif %}
                                </td>
                                <td><strong>{{ result.draw_number }}</strong></td>
                                <td>{{ result.draw_date.strftime('%Y-%m-%d') }}</td>
                                <td>
                                    {% for num in result.get_numbers_list() %}
                                        {% set ball_class = 'lottery-ball ' %}
                                        
                                        {% if loop.index0 % 4 == 0 %}
                                            {% set ball_class = ball_class + 'lottery-ball-red' %}
                                        {% elif loop.index0 % 4 == 1 %}
                                            {% set ball_class = ball_class + 'lottery-ball-yellow' %}
                                        {% elif loop.index0 % 4 == 2 %}
                                            {% set ball_class = ball_class + 'lottery-ball-green' %}
                                        {% else %}
                                            {% set ball_class = ball_class + 'lottery-ball-blue' %}
                                        {% endif %}
                                        
                                        <span class="{{ ball_class }}">{{ num }}</span>
                                    {% endfor %}
                                    {% if result.bonus_numbers %}
                                        {% for num in result.get_bonus_numbers_list() %}
                                            <span class="lottery-ball lottery-ball-blue lottery-ball-bonus">{{ num }}</span>
                                        {% endfor %}
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize variables
    let mainChart = null;
    const chartContainer = document.getElementById('main-chart');
    const chartTitle = document.getElementById('chart-title');
    const noDataMessage = document.getElementById('no-data-message');
    const insightsList = document.getElementById('insights-list');
    const lotteryTypeSelect = document.getElementById('lottery-type-select');
    const chartTypeSelect = document.getElementById('chart-type-select');
    
    // Function to update the chart
    async function updateChart() {
        // Get selected values
        const lotteryType = lotteryTypeSelect.value;
        const chartType = chartTypeSelect.value;
        
        // Update chart title
        updateChartTitle(chartType, lotteryType);
        
        // Fetch data from API
        try {
            const response = await fetch(`/api/visualization-data?lottery_type=${lotteryType}&data_type=${chartType}`);
            if (!response.ok) {
                console.error('Server returned error:', response.status);
                showNoDataMessage();
                clearInsights();
                return;
            }
            
            const data = await response.json();
            
            // Check if we have valid data
            if (data.error || !data.labels || data.labels.length === 0) {
                console.log('No valid data received:', data.message || data.error || 'Unknown error');
                showNoDataMessage();
                clearInsights();
                return;
            }
            
            // Hide no data message if it was previously shown
            hideNoDataMessage();
            
            // Create or update chart
            createOrUpdateChart(data, chartType);
            
            // Generate insights
            generateInsights(data, chartType, lotteryType);
        } catch (error) {
            console.error('Error fetching data:', error);
            showNoDataMessage();
            clearInsights();
        }
    }
    
    // Function to update chart title
    function updateChartTitle(chartType, lotteryType) {
        const lotteryName = lotteryType ? lotteryType : 'All Lottery Types';
        
        switch (chartType) {
            case 'numbers_frequency':
                chartTitle.textContent = `NUMBER FREQUENCY ANALYSIS - ${lotteryName.toUpperCase()}`;
                break;
            case 'winners_by_division':
                chartTitle.textContent = `WINNERS BY DIVISION - ${lotteryName.toUpperCase()}`;
                break;
            case 'prize_amounts':
                chartTitle.textContent = `AVERAGE PRIZE AMOUNTS - ${lotteryName.toUpperCase()}`;
                break;
            case 'draw_dates':
                chartTitle.textContent = `DRAW DATE DISTRIBUTION - ${lotteryName.toUpperCase()}`;
                break;
            default:
                chartTitle.textContent = `LOTTERY DATA ANALYSIS - ${lotteryName.toUpperCase()}`;
        }
    }
    
    // Function to show no data message
    function showNoDataMessage() {
        if (mainChart) {
            mainChart.destroy();
            mainChart = null;
        }
        noDataMessage.classList.remove('d-none');
    }
    
    // Function to hide no data message
    function hideNoDataMessage() {
        noDataMessage.classList.add('d-none');
    }
    
    // Function to create or update the chart
    function createOrUpdateChart(data, chartType) {
        // Create color arrays that match lottery ball colors
        const backgroundColors = data.labels.map((_, index) => {
            if (index % 4 === 0) return 'rgba(224, 50, 55, 0.7)'; // Red
            if (index % 4 === 1) return 'rgba(255, 225, 29, 0.7)'; // Yellow
            if (index % 4 === 2) return 'rgba(25, 160, 58, 0.7)'; // Green
            return 'rgba(103, 198, 237, 0.7)'; // Blue
        });
        
        const borderColors = data.labels.map((_, index) => {
            if (index % 4 === 0) return 'rgba(224, 50, 55, 1)'; // Red
            if (index % 4 === 1) return 'rgba(255, 225, 29, 1)'; // Yellow
            if (index % 4 === 2) return 'rgba(25, 160, 58, 1)'; // Green
            return 'rgba(103, 198, 237, 1)'; // Blue
        });
        
        // Update dataset colors
        if (data.datasets && data.datasets.length > 0) {
            data.datasets[0].backgroundColor = backgroundColors;
            data.datasets[0].borderColor = borderColors;
        }
        
        // Format Y-axis ticks for prize amounts to use currency format
        let yAxisTicksCallback = undefined;
        if (chartType === 'prize_amounts') {
            yAxisTicksCallback = function(value) {
                // Format as South African Rand (R) with appropriate formatting for large numbers
                return value.toLocaleString('en-ZA', { 
                    style: 'currency', 
                    currency: 'ZAR',
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                }).replace('ZAR', 'R');
            };
        }
        
        // Determine chart type based on the data
        let chartConfig = {
            type: 'bar',
            data: data,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            color: '#333',
                            font: {
                                weight: 'bold'
                            }
                        }
                    },
                    title: {
                        display: false,
                        color: '#333',
                        font: {
                            size: 16,
                            weight: 'bold'
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            color: '#333',
                            font: {
                                weight: 'bold'
                            }
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.1)'
                        }
                    },
                    x: {
                        ticks: {
                            color: '#333',
                            font: {
                                weight: 'bold'
                            }
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.1)'
                        }
                    }
                }
            }
        };
        
        // Customize chart based on data type
        if (chartType === 'draw_dates') {
            chartConfig.type = 'line';
            if (data.datasets && data.datasets.length > 0) {
                data.datasets[0].borderColor = 'rgba(255, 225, 29, 1)';
                data.datasets[0].backgroundColor = 'rgba(255, 225, 29, 0.3)';
                data.datasets[0].fill = true;
                data.datasets[0].tension = 0.3;
            }
        }
        
        // Apply currency formatting for prize amounts
        if (chartType === 'prize_amounts') {
            chartConfig.options.scales.y.ticks.callback = yAxisTicksCallback;
            // Add tooltip formatting for prize amounts
            chartConfig.options.plugins.tooltip = {
                callbacks: {
                    label: function(context) {
                        let label = context.dataset.label || '';
                        if (label) {
                            label += ': ';
                        }
                        if (context.parsed.y !== null) {
                            label += context.parsed.y.toLocaleString('en-ZA', { 
                                style: 'currency', 
                                currency: 'ZAR',
                                minimumFractionDigits: 0,
                                maximumFractionDigits: 0
                            }).replace('ZAR', 'R');
                        }
                        return label;
                    }
                }
            };
        }
        
        // Create new chart or update existing one
        if (mainChart) {
            mainChart.data = data;
            mainChart.config.type = chartConfig.type;
            mainChart.config.options = chartConfig.options;
            mainChart.update();
        } else {
            mainChart = new Chart(chartContainer, chartConfig);
        }
    }
    
    // Function to generate insights
    function generateInsights(data, chartType, lotteryType) {
        // Clear previous insights
        clearInsights();
        
        // Generate insights based on chart type
        switch (chartType) {
            case 'numbers_frequency':
                generateNumberFrequencyInsights(data, lotteryType);
                break;
            case 'winners_by_division':
                generateWinnersByDivisionInsights(data);
                break;
            case 'prize_amounts':
                generatePrizeAmountsInsights(data);
                break;
            case 'draw_dates':
                generateDrawDatesInsights(data);
                break;
        }
    }
    
    // Function to clear insights
    function clearInsights() {
        insightsList.innerHTML = '';
    }
    
    // Function to add an insight
    function addInsight(text) {
        const li = document.createElement('li');
        li.className = 'list-group-item';
        li.textContent = text;
        insightsList.appendChild(li);
    }
    
    // Insight generator functions
    function generateNumberFrequencyInsights(data, lotteryType) {
        let numberFrequencies;
        
        // Use the pre-calculated frequencies if available
        if (data.frequencies) {
            numberFrequencies = [...data.frequencies];
        } else {
            // Legacy handling for older data format
            const numbers = data.labels;
            const frequencies = data.datasets[0].data;
            
            // Combine numbers and frequencies into an array of objects
            numberFrequencies = numbers.map((num, i) => ({ number: num, frequency: frequencies[i] }));
        }
        
        // Sort by frequency (descending)
        numberFrequencies.sort((a, b) => b.frequency - a.frequency);
        
        // Filter to only include numbers that have appeared at least once
        const appearedNumbers = numberFrequencies.filter(item => item.frequency > 0);
        
        // Most frequent numbers (top 3)
        if (appearedNumbers.length > 0) {
            const mostFrequent = appearedNumbers.slice(0, 3);
            addInsight(`Most frequent numbers: ${mostFrequent.map(item => `${item.number} (${item.frequency} times)`).join(', ')}`);
        
            // Least frequent numbers (bottom 3)
            if (appearedNumbers.length >= 3) {
                const leastFrequent = appearedNumbers.slice(-3).reverse();
                addInsight(`Least frequent numbers: ${leastFrequent.map(item => `${item.number} (${item.frequency} times)`).join(', ')}`);
            }
            
            // Average frequency of numbers that have appeared
            const totalFrequency = appearedNumbers.reduce((sum, item) => sum + item.frequency, 0);
            const averageFrequency = totalFrequency / appearedNumbers.length;
            addInsight(`Average number frequency: ${averageFrequency.toFixed(2)} times`);
        }
        
        // Numbers that never appeared
        const maxPossibleNumber = getLotteryMaxNumber(lotteryType); // Get appropriate range based on lottery type
        const missingNumbers = [];
        for (let i = 1; i <= maxPossibleNumber; i++) {
            // Check if number exists in the frequencies data
            const numStr = i.toString();
            const found = numberFrequencies.some(item => item.number === numStr);
            if (!found) {
                missingNumbers.push(i);
            }
        }
        
        // Helper function to determine max number based on lottery type
        function getLotteryMaxNumber(lotteryType) {
            if (lotteryType && lotteryType.toLowerCase().includes('daily')) {
                return 36; // Daily Lotto uses numbers 1-36
            } else {
                return 49; // Regular Lotto uses numbers 1-49
            }
        }
        
        if (missingNumbers.length > 0) {
            addInsight(`Numbers that never appeared: ${missingNumbers.join(', ')}`);
        }
    }
    
    function generateWinnersByDivisionInsights(data) {
        // Calculate total winners
        const totalWinners = data.datasets[0].data.reduce((sum, winners) => sum + winners, 0);
        addInsight(`Total winners across all divisions: ${totalWinners}`);
        
        // Find division with most winners
        const divisions = data.labels;
        const winners = data.datasets[0].data;
        
        // Combine divisions and winners into an array of objects
        const divisionWinners = divisions.map((div, i) => ({ division: div, winners: winners[i] }));
        
        // Sort by winners (descending)
        divisionWinners.sort((a, b) => b.winners - a.winners);
        
        // Division with most winners
        const mostWinners = divisionWinners[0];
        addInsight(`Division with most winners: ${mostWinners.division} (${mostWinners.winners} winners)`);
        
        // Division with least winners
        const leastWinners = divisionWinners[divisionWinners.length - 1];
        addInsight(`Division with least winners: ${leastWinners.division} (${leastWinners.winners} winners)`);
        
        // Percentage of winners in top division
        const topDivisionPercentage = (mostWinners.winners / totalWinners) * 100;
        addInsight(`${mostWinners.division} accounts for ${topDivisionPercentage.toFixed(2)}% of all winners`);
    }
    
    function generatePrizeAmountsInsights(data) {
        // Find highest and lowest average prizes
        const divisions = data.labels;
        const prizes = data.datasets[0].data;
        
        // Combine divisions and prizes into an array of objects
        const divisionPrizes = divisions.map((div, i) => ({ division: div, prize: prizes[i] }));
        
        // Sort by prize (descending)
        divisionPrizes.sort((a, b) => b.prize - a.prize);
        
        // Helper function to format currency with commas as thousands separators
        function formatCurrency(amount) {
            return amount.toLocaleString('en-ZA', { 
                style: 'currency', 
                currency: 'ZAR',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).replace('ZAR', 'R');
        }
        
        // Division with highest average prize
        const highestPrize = divisionPrizes[0];
        addInsight(`Highest average prize: ${highestPrize.division} (${formatCurrency(highestPrize.prize)})`);
        
        // Division with lowest average prize
        const lowestPrize = divisionPrizes[divisionPrizes.length - 1];
        addInsight(`Lowest average prize: ${lowestPrize.division} (${formatCurrency(lowestPrize.prize)})`);
        
        // Calculate prize difference between highest and lowest division
        const priceDifference = highestPrize.prize - lowestPrize.prize;
        addInsight(`Prize difference between highest and lowest: ${formatCurrency(priceDifference)}`);
        
        // Check for outliers (prizes significantly higher than others)
        const averagePrize = prizes.reduce((sum, prize) => sum + prize, 0) / prizes.length;
        const outliers = divisionPrizes.filter(item => item.prize > averagePrize * 2);
        
        if (outliers.length > 0) {
            addInsight(`Divisions with unusually high prizes: ${outliers.map(item => item.division).join(', ')}`);
        }
    }
    
    function generateDrawDatesInsights(data) {
        // For draw dates, we'll focus on general patterns
        addInsight("Draw date distribution shows the frequency of lottery draws over time.");
        addInsight("Peaks in the chart indicate days with more lottery draws.");
        addInsight("This can help identify patterns in draw scheduling.");
    }
    
    // Set up event listeners for select boxes
    lotteryTypeSelect.addEventListener('change', updateChart);
    chartTypeSelect.addEventListener('change', updateChart);
    
    // Initial chart load
    updateChart();
});
</script>
{% endblock %}
