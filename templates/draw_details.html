{% extends "base.html" %}

{% block title %}{{ result.lottery_type }} - Draw {{ result.draw_number }} - {{ config.APP_NAME }}{% endblock %}

{% block content %}
<div class="container-fluid py-3">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="mb-0">{{ result.lottery_type }} - Draw {{ result.draw_number }}</h4>
                <a href="{{ url_for('results') }}" class="btn btn-secondary btn-sm">
                    <i class="fa fa-arrow-left"></i> Back to Results
                </a>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Left Column -->
        <div class="col-md-6">
            <!-- Draw Information -->
            <div class="card mb-3">
                <div class="card-header py-2">
                    <h6 class="mb-0">Draw Information</h6>
                </div>
                <div class="card-body py-2">
                    <div class="row">
                        <div class="col-6">
                            <p class="mb-1"><strong>Game Type:</strong><br>{{ result.lottery_type }}</p>
                            <p class="mb-1"><strong>Draw Number:</strong><br>{{ result.draw_number }}</p>
                        </div>
                        <div class="col-6">
                            <p class="mb-1"><strong>Draw Date:</strong><br>{{ result.draw_date.strftime('%A, %B %d, %Y') if result.draw_date else 'Date not available' }}</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Stats -->
            <div class="card mb-3">
                <div class="card-header py-2">
                    <h6 class="mb-0">Quick Stats</h6>
                </div>
                <div class="card-body py-2">
                    <div class="row text-center">
                        <div class="col-4">
                            <div class="stat-box">
                                <div class="stat-number">{{ result.get_numbers_list()|length }}</div>
                                <div class="stat-label">Numbers</div>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="stat-box">
                                <div class="stat-number">{{ result.get_bonus_numbers_list()|length }}</div>
                                <div class="stat-label">Bonus</div>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="stat-box">
                                <div class="stat-number">{{ result.draw_date.strftime('%d') if result.draw_date else '00' }}</div>
                                <div class="stat-label">{{ result.draw_date.strftime('%b').upper() if result.draw_date else 'MON' }}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Financial Information -->
            {% if result.rollover_amount or result.next_jackpot or result.total_pool_size or result.total_sales or result.draw_machine %}
            <div class="card">
                <div class="card-header py-2">
                    <h6 class="mb-0">Financial Information</h6>
                </div>
                <div class="card-body py-2">
                    <div class="row g-2">
                        {% if result.rollover_amount and result.rollover_amount != 'R0.00' %}
                        <div class="col-6">
                            <div class="financial-info-card compact">
                                <div class="financial-label">Rollover Amount</div>
                                <div class="financial-value">{{ result.rollover_amount }}</div>
                            </div>
                        </div>
                        {% endif %}
                        {% if result.next_jackpot and result.next_jackpot != 'R0.00' %}
                        <div class="col-6">
                            <div class="financial-info-card compact">
                                <div class="financial-label">Next Estimated Jackpot</div>
                                <div class="financial-value">{{ result.next_jackpot }}</div>
                            </div>
                        </div>
                        {% endif %}
                        {% if result.total_pool_size and result.total_pool_size != 'R0.00' %}
                        <div class="col-6">
                            <div class="financial-info-card compact">
                                <div class="financial-label">Total Prize Pool</div>
                                <div class="financial-value">{{ result.total_pool_size }}</div>
                            </div>
                        </div>
                        {% endif %}
                        {% if result.total_sales and result.total_sales != 'R0.00' %}
                        <div class="col-6">
                            <div class="financial-info-card compact">
                                <div class="financial-label">Total Sales</div>
                                <div class="financial-value">{{ result.total_sales }}</div>
                            </div>
                        </div>
                        {% endif %}
                        {% if result.draw_machine %}
                        <div class="col-6">
                            <div class="financial-info-card compact">
                                <div class="financial-label">Draw Machine</div>
                                <div class="financial-value">{{ result.draw_machine }}</div>
                            </div>
                        </div>
                        {% endif %}
                        {% if result.next_draw_date %}
                        <div class="col-6">
                            <div class="financial-info-card compact">
                                <div class="financial-label">Next Draw Date</div>
                                <div class="financial-value">{{ result.next_draw_date if result.next_draw_date else 'TBD' }}</div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
        
        <!-- Right Column -->
        <div class="col-md-6">
            <!-- Winning Numbers -->
            <div class="card mb-3">
                <div class="card-header py-2">
                    <h6 class="mb-0">Winning Numbers</h6>
                </div>
                <div class="card-body py-3">
                    <div class="winning-numbers-container">
                        <div class="main-numbers">
                            {% for num in result.get_numbers_list() %}
                                <span class="lottery-ball lottery-ball-lg lottery-ball-{{ 'red' if num <= 10 else 'yellow' if num <= 20 else 'green' if num <= 30 else 'blue' if num <= 40 else 'red' }}">{{ num }}</span>
                            {% endfor %}
                            
                            <!-- Bonus numbers in same row (only for games that have bonus numbers) -->
                            {% if result.get_bonus_numbers_list() and result.get_bonus_numbers_list()|length > 0 %}
                                <span style="margin: 0 10px; font-size: 1.2rem; color: #6c757d; font-weight: bold;">+</span>
                                {% for num in result.get_bonus_numbers_list() %}
                                    <span class="lottery-ball lottery-ball-lg lottery-ball-bonus">{{ num }}</span>
                                {% endfor %}
                            {% endif %}
                        </div>
                        
                        <!-- Prediction Validation Results Section -->
                        {% if validation_result %}
                        <div class="prediction-validation mt-3">
                            <div class="validation-header">
                                <i class="fas fa-brain"></i> AI Prediction Performance
                            </div>
                            <div class="validation-content">
                                <!-- AI Predicted Numbers -->
                                {% if validation_result.predicted_numbers and validation_result.predicted_numbers|length > 0 %}
                                <div class="predicted-numbers-display mb-2">
                                    <span class="predicted-label">AI Predicted Numbers:</span>
                                    {% for num in validation_result.predicted_numbers %}
                                        <span class="predicted-ball-small {% if validation_result.matched_numbers and num in validation_result.matched_numbers %}matched{% endif %}">{{ num }}</span>
                                    {% endfor %}
                                    
                                    <!-- Predicted bonus numbers for PowerBall games only -->
                                    {% if validation_result.predicted_bonus and validation_result.predicted_bonus|length > 0 and result.lottery_type in ['POWERBALL', 'POWERBALL PLUS'] %}
                                        <span style="margin: 0 8px; font-size: 0.9rem; color: #6c757d; font-weight: bold;">+</span>
                                        {% for num in validation_result.predicted_bonus %}
                                            <span class="predicted-ball-small predicted-bonus {% if validation_result.matched_bonus and num in validation_result.matched_bonus %}matched{% endif %}">{{ num }}</span>
                                        {% endfor %}
                                    {% endif %}
                                </div>
                                {% endif %}
                                
                                <div class="validation-stats-horizontal">
                                    <div class="validation-stat-item">
                                        <span class="stat-label">Accuracy:</span>
                                        <span class="stat-value accuracy-{{ 'good' if validation_result.accuracy_percentage >= 30 else 'fair' if validation_result.accuracy_percentage >= 15 else 'poor' }}">
                                            {{ "%.0f"|format(validation_result.accuracy_percentage) }}%
                                        </span>
                                    </div>
                                    <div class="validation-stat-item">
                                        <span class="stat-label">Matches:</span>
                                        <span class="stat-value">{{ validation_result.main_number_matches }}/{{ validation_result.predicted_numbers|length if validation_result.predicted_numbers else 'N/A' }}</span>
                                    </div>
                                    {% if validation_result.prize_tier %}
                                    <div class="validation-stat-item">
                                        <span class="stat-label">Prize Tier:</span>
                                        <span class="stat-value prize-tier">{{ validation_result.prize_tier }}</span>
                                    </div>
                                    {% endif %}
                                </div>
                                {% if validation_result.matched_numbers and validation_result.matched_numbers|length > 0 %}
                                    <div class="matched-numbers-display mt-2">
                                        <span class="matched-label">Matched Numbers:</span>
                                        {% for num in validation_result.matched_numbers %}
                                            <span class="matched-ball-small">{{ num }}</span>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        {% else %}
                        <!-- No AI Prediction Available -->
                        <div class="no-prediction-info mt-3">
                            <div class="alert alert-info mb-0" style="border-left: 4px solid #2196f3;">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-info-circle me-2" style="color: #2196f3;"></i>
                                    <div>
                                        <strong>No AI Prediction Available</strong><br>
                                        <small class="text-muted">
                                            Our AI system only predicts future draws. No prediction was made for this historical draw.
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Prize Divisions -->
            {% if result.divisions and result.divisions != '[]' and result.divisions != 'null' %}
                {% set division_data = result.get_parsed_divisions() %}
                {% if division_data %}
            <div class="card">
                <div class="card-header py-2">
                    <h6 class="mb-0">Prize Divisions</h6>
                </div>
                <div class="card-body py-2">
                    <div class="table-responsive">
                        <table class="table table-lottery table-sm mb-0 compact-prize-table">
                            <thead>
                                <tr>
                                    <th class="col-narrow">DIVISION</th>
                                    <th class="col-narrow">MATCH</th>
                                    <th class="col-narrow">WINNERS</th>
                                    <th class="col-wide">PRIZE PER WINNER</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for division in division_data %}
                                    <tr>
                                        <td><strong>{{ division.division if division.division else 'DIV ' + loop.index|string }}</strong></td>
                                        <td class="match-compact">
                                            {% if division.match %}
                                                {{ division.match }}
                                            {% elif division.description %}
                                                {% if 'FIVE CORRECT NUMBERS + POWERBALL' in division.description %}5+PB
                                                {% elif 'FOUR CORRECT NUMBERS + POWERBALL' in division.description %}4+PB
                                                {% elif 'THREE CORRECT NUMBERS + POWERBALL' in division.description %}3+PB
                                                {% elif 'TWO CORRECT NUMBERS + POWERBALL' in division.description %}2+PB
                                                {% elif 'ONE CORRECT NUMBERS + POWERBALL' in division.description %}1+PB
                                                {% elif 'MATCH POWERBALL' in division.description %}PB
                                                {% elif 'SIX CORRECT NUMBERS' in division.description %}6
                                                {% elif 'FIVE CORRECT NUMBERS + BONUS' in division.description %}5+B
                                                {% elif 'FOUR CORRECT NUMBERS + BONUS' in division.description %}4+B
                                                {% elif 'THREE CORRECT NUMBERS + BONUS' in division.description %}3+B
                                                {% elif 'TWO CORRECT NUMBERS + BONUS' in division.description %}2+B
                                                {% elif 'BONUS BALL' in division.description %}
                                                    {% if 'FIVE CORRECT NUMBERS' in division.description %}5+B
                                                    {% elif 'FOUR CORRECT NUMBERS' in division.description %}4+B
                                                    {% elif 'THREE CORRECT NUMBERS' in division.description %}3+B
                                                    {% elif 'TWO CORRECT NUMBERS' in division.description %}2+B
                                                    {% else %}{{ division.description[:10] }}{% endif %}
                                                {% elif 'FIVE CORRECT NUMBERS' in division.description %}5
                                                {% elif 'FOUR CORRECT NUMBERS' in division.description %}4
                                                {% elif 'THREE CORRECT NUMBERS' in division.description %}3
                                                {% elif 'TWO CORRECT NUMBERS' in division.description %}2
                                                {% else %}{{ division.description[:10] }}{% endif %}
                                            {% else %}N/A{% endif %}
                                        </td>
                                        <td>{{ division.winners if division.winners is defined else '0' }}</td>
                                        <td>{{ division.amount if division.amount else 'R0.00' }}</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
                {% else %}
                    <div class="alert alert-info">
                        Division data is being processed. Please check back shortly for complete prize breakdown.
                    </div>
                {% endif %}
            {% else %}
                <div class="alert alert-info">
                    No division data available for this draw.
                </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
/* Compact Prize Table Styling */
.compact-prize-table {
    table-layout: fixed;
    width: 100%;
}

.compact-prize-table .col-narrow {
    width: 18%;
    padding: 6px 4px !important;
    text-align: center;
    font-size: 0.8rem;
}

.compact-prize-table .col-wide {
    width: 46%;
    padding: 6px 8px !important;
    text-align: right;
    font-size: 0.8rem;
}

.compact-prize-table td {
    padding: 8px 4px !important;
    text-align: center;
    font-size: 0.85rem;
}

.compact-prize-table td:last-child {
    text-align: right;
    padding: 8px 8px !important;
    font-weight: 500;
}

.compact-prize-table th {
    padding: 6px 4px !important;
    font-size: 0.75rem;
    font-weight: 600;
    white-space: nowrap;
}

.compact-prize-table th:last-child {
    padding: 6px 8px !important;
}

/* Prediction Validation Styles */
.prediction-validation {
    background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
    border-radius: 8px;
    padding: 15px;
    border: 2px solid #2196f3;
    box-shadow: 0 2px 8px rgba(33, 150, 243, 0.1);
    margin-top: 15px !important;
    margin-bottom: 15px !important;
}

.validation-header {
    font-weight: 700;
    color: #1976d2;
    font-size: 1.0rem;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 8px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.validation-stats-horizontal {
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
    align-items: center;
}

.validation-stat-item {
    display: flex;
    align-items: center;
    gap: 6px;
}

.stat-label {
    font-size: 0.8rem;
    color: #6c757d;
    font-weight: 500;
}

.stat-value {
    font-size: 0.9rem;
    font-weight: 600;
}

.accuracy-good {
    color: #28a745;
}

.accuracy-fair {
    color: #ffc107;
}

.accuracy-poor {
    color: #dc3545;
}

.prize-tier {
    color: #28a745;
}

.matched-numbers-display {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
}

.matched-label {
    font-size: 0.8rem;
    color: #6c757d;
    font-weight: 500;
}

.matched-ball-small {
    width: 24px;
    height: 24px;
    background: #28a745;
    color: white;
    border-radius: 50%;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 0.7rem;
}

/* Green highlighting for matching prediction balls */
.predicted-ball-small.matched {
    background: #28a745 !important;
    border: 2px solid #1e7e34 !important;
    box-shadow: 0 0 10px rgba(40, 167, 69, 0.5);
    transform: scale(1.1);
}

.predicted-ball-small {
    width: 28px;
    height: 28px;
    background: #6c757d;
    color: white;
    border-radius: 50%;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 0.75rem;
    margin: 2px;
    transition: all 0.3s ease;
}
</style>
{% endblock %}