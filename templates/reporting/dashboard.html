<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Reporting Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .report-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .chart-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .prediction-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .predicted-number {
            display: inline-block;
            width: 40px;
            height: 40px;
            line-height: 40px;
            text-align: center;
            background: rgba(255,255,255,0.3);
            border-radius: 50%;
            margin: 5px;
            font-weight: bold;
        }
        .filter-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .insight-box {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin: 10px 0;
            border-radius: 0 5px 5px 0;
        }
    </style>
</head>
<body class="bg-light">
    <nav class="navbar navbar-dark bg-dark">
        <div class="container-fluid">
            <span class="navbar-brand">üìä Advanced Reporting Dashboard</span>
            <div class="d-flex">
                <button class="btn btn-outline-light me-2" onclick="exportReport()">üìÑ Export Excel</button>
                <button class="btn btn-outline-light" onclick="refreshData()">üîÑ Refresh</button>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Filters Section -->
        <div class="filter-section">
            <div class="row">
                <div class="col-md-3">
                    <label class="form-label">Lottery Type</label>
                    <select class="form-control" id="lotteryTypeFilter">
                        <option value="">All Types</option>
                        <option value="LOTTO">Lotto</option>
                        <option value="LOTTO PLUS 1">Lotto Plus 1</option>
                        <option value="LOTTO PLUS 2">Lotto Plus 2</option>
                        <option value="PowerBall">PowerBall</option>
                        <option value="POWERBALL PLUS">PowerBall Plus</option>
                        <option value="DAILY LOTTO">Daily Lotto</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Date Range (Days)</label>
                    <select class="form-control" id="dateRangeFilter">
                        <option value="30">Last 30 Days</option>
                        <option value="90">Last 90 Days</option>
                        <option value="180">Last 180 Days</option>
                        <option value="365" selected>Last Year</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">&nbsp;</label>
                    <button class="btn btn-primary d-block" onclick="generateReport()">Generate Report</button>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Report Status</label>
                    <div id="reportStatus" class="text-muted">Ready to generate</div>
                </div>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="row" id="summaryCards">
            <div class="col-md-3">
                <div class="report-card">
                    <h5>Total Draws</h5>
                    <h2 id="totalDraws">--</h2>
                    <small>In selected period</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="report-card">
                    <h5>Lottery Types</h5>
                    <h2 id="lotteryTypes">--</h2>
                    <small>Active games</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="report-card">
                    <h5>Unique Numbers</h5>
                    <h2 id="uniqueNumbers">--</h2>
                    <small>Different numbers drawn</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="report-card">
                    <h5>Analysis Period</h5>
                    <h2 id="analysisPeriod">--</h2>
                    <small>Days of data</small>
                </div>
            </div>
        </div>

        <!-- AI Predictions Section -->
        <div class="row" id="predictionsSection" style="display: none;">
            <div class="col-12">
                <div class="prediction-card">
                    <h5>ü§ñ AI-Powered Predictions</h5>
                    <div id="predictionsContent">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Predicted Numbers</h6>
                                <div id="predictedNumbers">
                                    <!-- Predicted numbers will be inserted here -->
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6>Prediction Insights</h6>
                                <div id="predictionInsights">
                                    <p><strong>Confidence Score:</strong> <span id="confidenceScore">--</span>%</p>
                                    <p><strong>Model:</strong> <span id="modelType">--</span></p>
                                    <p><strong>Training Samples:</strong> <span id="trainingSamples">--</span></p>
                                </div>
                            </div>
                        </div>
                        <div class="alert alert-warning mt-3">
                            <small>‚ö†Ô∏è <strong>Disclaimer:</strong> Predictions are for entertainment purposes only. Lottery drawings are random events.</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="row">
            <div class="col-md-6">
                <div class="chart-container">
                    <h5>Number Frequency Analysis</h5>
                    <canvas id="frequencyChart"></canvas>
                </div>
            </div>
            <div class="col-md-6">
                <div class="chart-container">
                    <h5>Draw Timeline</h5>
                    <canvas id="timelineChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Pattern Insights -->
        <div class="row">
            <div class="col-md-6">
                <div class="chart-container">
                    <h5>Pattern Insights</h5>
                    <div id="patternInsights">
                        <p class="text-muted">Generate a report to see pattern analysis</p>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="chart-container">
                    <h5>Hot & Cold Numbers</h5>
                    <div id="hotColdNumbers">
                        <p class="text-muted">Generate a report to see hot and cold numbers</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detailed Analytics -->
        <div class="row">
            <div class="col-12">
                <div class="chart-container">
                    <h5>Detailed Analytics</h5>
                    <div id="detailedAnalytics">
                        <p class="text-muted">Select filters and generate a report to see detailed analytics</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let frequencyChart, timelineChart;
        let currentReportData = null;

        // Initialize charts
        function initCharts() {
            // Frequency chart
            const freqCtx = document.getElementById('frequencyChart').getContext('2d');
            frequencyChart = new Chart(freqCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Frequency',
                        data: [],
                        backgroundColor: 'rgba(54, 162, 235, 0.8)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // Timeline chart
            const timeCtx = document.getElementById('timelineChart').getContext('2d');
            timelineChart = new Chart(timeCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Draws per Period',
                        data: [],
                        borderColor: 'rgba(255, 99, 132, 1)',
                        backgroundColor: 'rgba(255, 99, 132, 0.1)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Generate comprehensive report
        async function generateReport() {
            const lotteryType = document.getElementById('lotteryTypeFilter').value;
            const dateRange = document.getElementById('dateRangeFilter').value;
            
            document.getElementById('reportStatus').textContent = 'Generating report...';
            
            try {
                const url = `/reporting/api/generate-report?lottery_type=${lotteryType}&date_range=${dateRange}`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                currentReportData = data;
                updateDashboard(data);
                document.getElementById('reportStatus').textContent = 'Report generated successfully';
                
            } catch (error) {
                console.error('Error generating report:', error);
                document.getElementById('reportStatus').textContent = 'Error: ' + error.message;
            }
        }

        // Update dashboard with report data
        function updateDashboard(data) {
            // Update summary cards
            if (data.summary_statistics) {
                document.getElementById('totalDraws').textContent = data.summary_statistics.total_draws || 0;
                document.getElementById('lotteryTypes').textContent = Object.keys(data.summary_statistics.lottery_types || {}).length;
                document.getElementById('analysisPeriod').textContent = document.getElementById('dateRangeFilter').value;
            }

            // Update frequency chart
            if (data.charts && data.charts.frequency) {
                updateFrequencyChart(data.charts.frequency);
            }

            // Update timeline chart
            if (data.charts && data.charts.timeline) {
                updateTimelineChart(data.charts.timeline);
            }

            // Update pattern insights
            if (data.pattern_insights) {
                updatePatternInsights(data.pattern_insights);
            }

            // Update frequency analysis display
            if (data.frequency_analysis) {
                updateFrequencyDisplay(data.frequency_analysis);
            }

            // Update predictions if available
            if (data.predictive_insights) {
                updatePredictions(data.predictive_insights);
            }

            // Update unique numbers count
            let totalUniqueNumbers = 0;
            if (data.frequency_analysis) {
                Object.values(data.frequency_analysis).forEach(analysis => {
                    if (analysis.total_unique_numbers) {
                        totalUniqueNumbers = Math.max(totalUniqueNumbers, analysis.total_unique_numbers);
                    }
                });
            }
            document.getElementById('uniqueNumbers').textContent = totalUniqueNumbers;
        }

        // Update frequency chart
        function updateFrequencyChart(frequencyData) {
            const lotteryType = document.getElementById('lotteryTypeFilter').value || Object.keys(frequencyData)[0];
            
            if (lotteryType && frequencyData[lotteryType]) {
                const data = frequencyData[lotteryType];
                frequencyChart.data.labels = data.numbers.slice(0, 15);
                frequencyChart.data.datasets[0].data = data.frequencies.slice(0, 15);
                frequencyChart.update();
            }
        }

        // Update timeline chart
        function updateTimelineChart(timelineData) {
            const lotteryType = document.getElementById('lotteryTypeFilter').value || Object.keys(timelineData)[0];
            
            if (lotteryType && timelineData[lotteryType]) {
                const data = timelineData[lotteryType];
                timelineChart.data.labels = data.dates;
                timelineChart.data.datasets[0].data = data.counts;
                timelineChart.update();
            }
        }

        // Update pattern insights
        function updatePatternInsights(patterns) {
            const container = document.getElementById('patternInsights');
            let html = '';
            
            Object.entries(patterns).forEach(([lotteryType, pattern]) => {
                html += `<div class="insight-box">
                    <h6>${lotteryType}</h6>
                    <p><strong>Consecutive Frequency:</strong> ${(pattern.consecutive_frequency * 100).toFixed(1)}%</p>
                    <p><strong>Even/Odd Distribution:</strong></p>
                    <ul>
                        <li>Even Dominant: ${pattern.even_odd_distribution.even_dominant}</li>
                        <li>Odd Dominant: ${pattern.even_odd_distribution.odd_dominant}</li>
                        <li>Balanced: ${pattern.even_odd_distribution.balanced}</li>
                    </ul>
                </div>`;
            });
            
            container.innerHTML = html || '<p class="text-muted">No pattern data available</p>';
        }

        // Update frequency display (hot/cold numbers)
        function updateFrequencyDisplay(frequencyData) {
            const container = document.getElementById('hotColdNumbers');
            let html = '';
            
            Object.entries(frequencyData).forEach(([lotteryType, analysis]) => {
                if (analysis.most_frequent && analysis.least_frequent) {
                    html += `<div class="insight-box">
                        <h6>${lotteryType}</h6>
                        <div class="row">
                            <div class="col-6">
                                <strong>üî• Hot Numbers:</strong><br>
                                ${analysis.most_frequent.slice(0, 5).map(([num, freq]) => 
                                    `<span class="badge bg-danger me-1">${num} (${freq})</span>`
                                ).join('')}
                            </div>
                            <div class="col-6">
                                <strong>‚ùÑÔ∏è Cold Numbers:</strong><br>
                                ${analysis.least_frequent.slice(0, 5).map(([num, freq]) => 
                                    `<span class="badge bg-info me-1">${num} (${freq})</span>`
                                ).join('')}
                            </div>
                        </div>
                    </div>`;
                }
            });
            
            container.innerHTML = html || '<p class="text-muted">No frequency data available</p>';
        }

        // Update predictions
        function updatePredictions(predictions) {
            const lotteryType = document.getElementById('lotteryTypeFilter').value;
            
            if (lotteryType && predictions[lotteryType]) {
                const pred = predictions[lotteryType];
                
                if (pred.predicted_numbers) {
                    const numbersHtml = pred.predicted_numbers.map(num => 
                        `<span class="predicted-number">${num}</span>`
                    ).join('');
                    
                    document.getElementById('predictedNumbers').innerHTML = numbersHtml;
                    document.getElementById('confidenceScore').textContent = pred.confidence_score || '--';
                    document.getElementById('modelType').textContent = pred.model_type || '--';
                    document.getElementById('trainingSamples').textContent = pred.training_samples || '--';
                    
                    document.getElementById('predictionsSection').style.display = 'block';
                } else {
                    document.getElementById('predictionsSection').style.display = 'none';
                }
            } else if (Object.keys(predictions).length > 0) {
                // Show first available prediction
                const firstType = Object.keys(predictions)[0];
                const pred = predictions[firstType];
                
                if (pred.predicted_numbers) {
                    const numbersHtml = pred.predicted_numbers.map(num => 
                        `<span class="predicted-number">${num}</span>`
                    ).join('');
                    
                    document.getElementById('predictedNumbers').innerHTML = `
                        <small class="text-muted">Predictions for ${firstType}:</small><br>
                        ${numbersHtml}
                    `;
                    document.getElementById('confidenceScore').textContent = pred.confidence_score || '--';
                    document.getElementById('modelType').textContent = pred.model_type || '--';
                    document.getElementById('trainingSamples').textContent = pred.training_samples || '--';
                    
                    document.getElementById('predictionsSection').style.display = 'block';
                }
            } else {
                document.getElementById('predictionsSection').style.display = 'none';
            }
        }

        // Export report to Excel
        async function exportReport() {
            if (!currentReportData) {
                alert('Please generate a report first');
                return;
            }
            
            const lotteryType = document.getElementById('lotteryTypeFilter').value;
            const dateRange = document.getElementById('dateRangeFilter').value;
            
            try {
                const url = `/reporting/api/export-excel?lottery_type=${lotteryType}&date_range=${dateRange}`;
                const response = await fetch(url);
                
                if (response.ok) {
                    const blob = await response.blob();
                    const downloadUrl = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = downloadUrl;
                    a.download = `lottery_report_${new Date().toISOString().split('T')[0]}.xlsx`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(downloadUrl);
                    a.remove();
                } else {
                    throw new Error('Export failed');
                }
            } catch (error) {
                alert('Error exporting report: ' + error.message);
            }
        }

        // Refresh data
        function refreshData() {
            generateReport();
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initCharts();
            
            // Auto-generate initial report
            generateReport();
            
            // Add event listeners for filter changes
            document.getElementById('lotteryTypeFilter').addEventListener('change', generateReport);
            document.getElementById('dateRangeFilter').addEventListener('change', generateReport);
        });
    </script>
</body>
</html>