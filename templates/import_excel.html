{% extends "base.html" %}

{% block title %}Import Excel Data | Admin Dashboard{% endblock %}

{% block meta_description %}Import lottery data from Excel spreadsheets. Admin access only.{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Home</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('admin') }}">Admin</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Import Excel Data</li>
                </ol>
            </nav>
            
            <h1>Import Excel Data</h1>
            <p class="lead">Upload Excel files to import lottery data</p>
        </div>
    </div>

    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Excel File Upload</h5>
                </div>
                <div class="card-body">
                    <form method="post" enctype="multipart/form-data" id="excel-form">
                        <div class="mb-3">
                            <label for="excel_file" class="form-label">Select an Excel file to import</label>
                            <input class="form-control" type="file" id="excel_file" name="excel_file" accept=".xlsx, .xls">
                            <div class="form-text">
                                Select an Excel file (.xlsx or .xls) containing lottery data.
                            </div>
                        </div>
                        
                        <div class="mb-3" id="sheet-selector" style="display: none;">
                            <label for="sheet_name" class="form-label">Select Sheet (Optional)</label>
                            <select class="form-select" id="sheet_name" name="sheet_name">
                                <option value="">Auto-detect</option>
                                <!-- Sheets will be populated here -->
                            </select>
                            <div class="form-text">
                                Leave as "Auto-detect" to use the first sheet, or select a specific sheet to import.
                            </div>
                        </div>
                        
                        <div id="preview-container" class="mb-3" style="display: none;">
                            <label class="form-label">Data Preview</label>
                            <div id="preview-data" class="table-responsive">
                                <!-- Preview data will be shown here -->
                            </div>
                            <div class="form-text">
                                Preview of the first 10 rows of data. The system will attempt to map columns automatically.
                            </div>
                        </div>
                        
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <button type="button" id="preview-button" class="btn btn-secondary me-md-2" disabled>
                                <i class="fas fa-eye me-1"></i> Preview Data
                            </button>
                            <button type="submit" id="submit-button" class="btn btn-primary" disabled>
                                <i class="fas fa-upload me-1"></i> Import Data
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">Instructions</h5>
                </div>
                <div class="card-body">
                    <h6>Excel Format Requirements:</h6>
                    <ul>
                        <li>Supported formats: .xlsx, .xls</li>
                        <li>File should contain lottery data with appropriate columns</li>
                        <li>First few rows can contain headers or other metadata</li>
                    </ul>
                    
                    <h6>Required Columns:</h6>
                    <ul>
                        <li>Game Name/Type (e.g., "Lottery", "Powerball")</li>
                        <li>Draw Number</li>
                        <li>Draw Date</li>
                        <li>Winning Numbers</li>
                    </ul>
                    
                    <h6>Optional Columns:</h6>
                    <ul>
                        <li>Bonus Ball</li>
                        <li>Division Winners</li>
                        <li>Division Prizes</li>
                        <li>And many more...</li>
                    </ul>
                    
                    <div class="alert alert-warning mt-3">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Important:</strong> You must be an admin to import data. The import process may take some time depending on the size of the file.
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">Need a Template?</h5>
                </div>
                <div class="card-body">
                    <p>Download an empty Excel template to get started:</p>
                    <a href="{{ url_for('export_template') }}" class="btn btn-outline-success w-100">
                        <i class="fas fa-download me-1"></i> Download Template
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="position-fixed top-0 start-0 w-100 h-100 d-flex justify-content-center align-items-center" style="display: none !important; background-color: rgba(0,0,0,0.5); z-index: 9999;">
        <div class="card p-4 text-center" style="max-width: 400px;">
            <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">Loading...</span>
            </div>
            <h4 id="loading-text">Processing...</h4>
            <p id="loading-subtext" class="text-muted">This may take a few moments</p>
        </div>
    </div>
</div>
{% endblock %}

{% block additional_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const excelFile = document.getElementById('excel_file');
    const sheetSelector = document.getElementById('sheet-selector');
    const sheetName = document.getElementById('sheet_name');
    const previewButton = document.getElementById('preview-button');
    const submitButton = document.getElementById('submit-button');
    const previewContainer = document.getElementById('preview-container');
    const previewData = document.getElementById('preview-data');
    const excelForm = document.getElementById('excel-form');
    const loadingOverlay = document.getElementById('loading-overlay');
    const loadingText = document.getElementById('loading-text');
    const loadingSubtext = document.getElementById('loading-subtext');
    
    // Enable/disable buttons based on file selection
    excelFile.addEventListener('change', function() {
        if (excelFile.files.length > 0) {
            previewButton.disabled = false;
            submitButton.disabled = false;
            
            // Get the sheets in the Excel file
            const formData = new FormData();
            formData.append('excel_file', excelFile.files[0]);
            
            // Show loading overlay
            loadingText.textContent = 'Reading Excel File...';
            loadingSubtext.textContent = 'Detecting sheets and structure';
            loadingOverlay.style.display = 'flex';
            
            fetch('{{ url_for("excel_import.list_excel_sheets") }}', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                // Hide loading overlay
                loadingOverlay.style.display = 'none';
                
                if (data.error) {
                    console.error('Error reading sheets:', data.error);
                    alert('Error reading Excel file: ' + data.error);
                    return;
                }
                
                // Populate sheet selector
                if (data.sheets && data.sheets.length > 0) {
                    sheetName.innerHTML = '<option value="">Auto-detect</option>';
                    data.sheets.forEach(sheet => {
                        const option = document.createElement('option');
                        option.value = sheet;
                        option.textContent = sheet;
                        sheetName.appendChild(option);
                    });
                    
                    // Show sheet selector
                    sheetSelector.style.display = 'block';
                }
            })
            .catch(error => {
                loadingOverlay.style.display = 'none';
                console.error('Error:', error);
                alert('Error reading Excel file. See console for details.');
            });
        } else {
            previewButton.disabled = true;
            submitButton.disabled = true;
            sheetSelector.style.display = 'none';
            previewContainer.style.display = 'none';
        }
    });
    
    // Preview button click handler
    previewButton.addEventListener('click', function() {
        if (excelFile.files.length === 0) {
            alert('Please select an Excel file first.');
            return;
        }
        
        const formData = new FormData();
        formData.append('excel_file', excelFile.files[0]);
        if (sheetName.value) {
            formData.append('sheet_name', sheetName.value);
        }
        
        // Show loading overlay
        loadingText.textContent = 'Generating Preview...';
        loadingSubtext.textContent = 'Analyzing Excel data';
        loadingOverlay.style.display = 'flex';
        
        fetch('{{ url_for("excel_import.preview_excel") }}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            // Hide loading overlay
            loadingOverlay.style.display = 'none';
            
            if (data.error) {
                console.error('Error previewing data:', data.error);
                alert('Error previewing Excel data: ' + data.error);
                return;
            }
            
            if (!data.success) {
                console.error('Preview failed:', data.error || 'Unknown error');
                alert('Preview failed: ' + (data.error || 'Unknown error'));
                return;
            }
            
            // Create preview table
            let tableHtml = '<table class="table table-sm table-striped">';
            
            // Add header row
            tableHtml += '<thead><tr>';
            if (data.columns) {
                data.columns.forEach(column => {
                    // Highlight mapped columns
                    let isMatched = false;
                    let matchedName = '';
                    
                    if (data.column_mapping) {
                        for (const [key, value] of Object.entries(data.column_mapping)) {
                            if (value === column) {
                                isMatched = true;
                                matchedName = key;
                                break;
                            }
                        }
                    }
                    
                    if (isMatched) {
                        tableHtml += `<th class="bg-success bg-opacity-25" data-bs-toggle="tooltip" title="Mapped to ${matchedName}">${column} <i class="fas fa-check text-success"></i></th>`;
                    } else {
                        tableHtml += `<th>${column}</th>`;
                    }
                });
            }
            tableHtml += '</tr></thead>';
            
            // Add data rows
            tableHtml += '<tbody>';
            if (data.preview) {
                data.preview.forEach(row => {
                    tableHtml += '<tr>';
                    if (data.columns) {
                        data.columns.forEach(column => {
                            tableHtml += `<td>${row[column] || ''}</td>`;
                        });
                    }
                    tableHtml += '</tr>';
                });
            }
            tableHtml += '</tbody>';
            tableHtml += '</table>';
            
            // Add summary information
            if (data.total_rows) {
                tableHtml += `<div class="mt-2"><strong>Total Rows:</strong> ${data.total_rows}</div>`;
            }
            
            // Add column mapping information
            if (data.column_mapping) {
                let mappingHtml = '<div class="mt-3"><strong>Detected Columns:</strong><ul class="list-group list-group-flush">';
                for (const [key, value] of Object.entries(data.column_mapping)) {
                    mappingHtml += `<li class="list-group-item py-1"><span class="badge bg-success me-2">${key}</span> mapped to <strong>${value}</strong></li>`;
                }
                mappingHtml += '</ul></div>';
                tableHtml += mappingHtml;
            }
            
            // Show preview
            previewData.innerHTML = tableHtml;
            previewContainer.style.display = 'block';
            
            // Initialize tooltips
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        })
        .catch(error => {
            loadingOverlay.style.display = 'none';
            console.error('Error:', error);
            alert('Error previewing Excel data. See console for details.');
        });
    });
    
    // Form submit handler
    excelForm.addEventListener('submit', function(event) {
        if (excelFile.files.length === 0) {
            event.preventDefault();
            alert('Please select an Excel file first.');
            return;
        }
        
        // Show loading overlay
        loadingText.textContent = 'Importing Data...';
        loadingSubtext.textContent = 'This may take several minutes for large files';
        loadingOverlay.style.display = 'flex';
    });
});
</script>
{% endblock %}